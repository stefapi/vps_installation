<?xml version="1.0" encoding="UTF-8"?>
<?asciidoc-toc?>
<?asciidoc-numbered?>
<article xmlns="http://docbook.org/ns/docbook" xmlns:xl="http://www.w3.org/1999/xlink" version="5.0" xml:lang="en">
<info>
<title>Installation d&#8217;un VPS</title>
<date>2024-04-17</date>
<author>
<personname>
<firstname>Stéphane</firstname>
<surname>Apiou</surname>
</personname>
<email>stephane@apiou.org</email>
</author>
<authorinitials>SA</authorinitials>
<revhistory>
<revision>
<revnumber>1.7</revnumber>
<date>2024-04-17</date>
<authorinitials>SA</authorinitials>
</revision>
</revhistory>
</info>
<section xml:id="_avant_propos">
<title>Avant propos</title>
<simpara>Ce document est disponible sur le site <link xl:href="https://vps-installation.readthedocs.io">ReadTheDocs</link></simpara>
<informalfigure>
<mediaobject>
<imageobject>
<imagedata fileref="diag-qrcode-md5-2f25aa1bfe51bea549aae03153e4fdb9.svg"/>
</imageobject>
<textobject><phrase>Diagram</phrase></textobject>
</mediaobject>
</informalfigure>
<simpara>et sur <link xl:href="https://github.com/stefapi/vps_installation">Github</link>. Sur Github vous trouverez aussi les versions PDF, EPUB, HTML, Docbook et Asciidoc de ce document.</simpara>
<simpara>Cette documentation décrit la méthode que j&#8217;ai utilisé pour installer un serveur VPS sur la plate-forme OVH.
Elle est le résultat de très nombreuses heures de travail pour collecter la documentation nécessaire.
Sur mon serveur, j&#8217;ai installé un Linux Debian 10. Cette documentation est facilement transposable pour des versions différentes de Debian ou à Ubuntu ou toute autre distribution basée sur l&#8217;un ou l&#8217;autre.
En revanche si vous utilisez CentOS, il y aura des différences beaucoup plus importantes notamment liées au gestionnaire de paquets <literal>yum</literal>, le nommage des paquets, les configurations par défaut et aux différences dans l&#8217;arborescence présente dans /etc.</simpara>
<simpara>Dans ce document, je montre la configuration de nombreux types de sites web et services dans un domaine en utilisant ISPConfig.</simpara>
<simpara>Sont installés:</simpara>
<itemizedlist>
<listitem>
<simpara>un panel <link xl:href="https://www.ispconfig.org/">ISPConfig</link>,</simpara>
</listitem>
<listitem>
<simpara>un configurateur <link xl:href="http://www.webmin.com/">Webmin</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur apache avec sa configuration let&#8217;s encrypt et les plugins PHP, Python et Ruby,</simpara>
</listitem>
<listitem>
<simpara>un serveur de mail avec antispam, sécurisation d&#8217;envoi des mails et autoconfiguration pour Outlook, Thunderbird, Android,</simpara>
</listitem>
<listitem>
<simpara>un webmail <link xl:href="https://roundcube.net">roundcube</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur de mailing list <link xl:href="https://www.list.org">mailman</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur ftp et sftp sécurisé,</simpara>
</listitem>
<listitem>
<simpara>un serveur de base de données MariaDB et son interface web d&#8217;administration <link xl:href="https://www.phpmyadmin.net/">phpmyadmin</link>,</simpara>
</listitem>
<listitem>
<simpara>des outils de sécurisation, de mise à jour automatique et d&#8217;audit du serveur,</simpara>
</listitem>
<listitem>
<simpara>un outil de Monitoring <link xl:href="http://munin-monitoring.org/">Munin</link>,</simpara>
</listitem>
<listitem>
<simpara>un outil de Monitoring <link xl:href="http://mmonit.com/monit/">Monit</link>,</simpara>
</listitem>
<listitem>
<simpara>l&#8217;installation de <link xl:href="https://hub.docker.com/">Docker</link> et des outils <link xl:href="https://portainer.io">Portainer</link> et <link xl:href="https://yacht.sh">Yacht</link>,</simpara>
</listitem>
<listitem>
<simpara>un sous domaine pointant sur un site auto-hébergé (l’installation du site n&#8217;est pas décrite ici; Se référer à <link xl:href="https://yunohost.org">Yunohost</link> ) par exemple,</simpara>
</listitem>
<listitem>
<simpara>un site CMS sous <link xl:href="https://www.joomla.fr/">Joomla</link>,</simpara>
</listitem>
<listitem>
<simpara>un site CMS sous <link xl:href="https://www.concrete5.org/">Concrete5</link>,</simpara>
</listitem>
<listitem>
<simpara>un site WIKI sous <link xl:href="https://www.mediawiki.org">Mediawiki</link>,</simpara>
</listitem>
<listitem>
<simpara>un site de blog <link xl:href="https://wordpress.com">Wordpress</link>,</simpara>
</listitem>
<listitem>
<simpara>un site <link xl:href="https://microweber.org/">Microweber</link>,</simpara>
</listitem>
<listitem>
<simpara>un site Photo sous <link xl:href="https://piwigo.org/">Piwigo</link>,</simpara>
</listitem>
<listitem>
<simpara>un site de partage de recettes de cuisine <link xl:href="https://hay-kot.github.io/mealie/">Mealie</link></simpara>
</listitem>
<listitem>
<simpara>un site Collaboratif sous <link xl:href="https://nextcloud.com">Nextcloud</link>,</simpara>
</listitem>
<listitem>
<simpara>un site <link xl:href="https://gitea.io">Gitea</link> et son repository GIT,</simpara>
</listitem>
<listitem>
<simpara>un serveur de mots de passe <link xl:href="https://bitwarden.com/">Bitwarden</link>,</simpara>
</listitem>
<listitem>
<simpara>un dashboard pour vos sites web <link xl:href="https://heimdall.site/">Heimdall</link>,</simpara>
</listitem>
<listitem>
<simpara>un site de stockage des bookmarks de vos navigateurs <link xl:href="https://www.xbrowsersync.org">XBrowserSync</link></simpara>
</listitem>
<listitem>
<simpara>un serveur et un site  de partage de fichiers <link xl:href="https://www.seafile.com">Seafile</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur <link xl:href="https://grafana.com/">Grafana</link>, <link xl:href="https://prometheus.io/">Prometheus</link>, <link xl:href="https://github.com/grafana/loki">Loki</link>, Promtail pour gérer les statistiques et les logs du serveur,</simpara>
</listitem>
<listitem>
<simpara>un serveur de sauvegardes <link xl:href="https://borgbackup.readthedocs.io/">BorgBackup</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur de VPN <link xl:href="https://github.com/wg-easy/wg-easy">Wireguard (wg-easy)</link>,</simpara>
</listitem>
<listitem>
<simpara>un serveur de bureau à distance <link xl:href="https://guacamole.apache.org">Guacamole</link></simpara>
</listitem>
</itemizedlist>
<simpara>Dans ce document nous configurons un nom de domaine principal. Pour la clarté du texte, il sera nommé "example.com". Il est à remplacer évidemment par votre nom de domaine principal.</simpara>
<simpara>Je suppose dans ce document que vous savez vous connecter à distance sur un serveur en mode terminal, que vous savez vous servir de <literal>ssh</literal> pour Linux ou de <literal>putty</literal> pour Windows, que vous avez des notions élémentaires de Shell Unix et que vous savez vous servir de l&#8217;éditeur <literal>vi</literal>. Si <literal>vi</literal> est trop compliqué pour vous, je vous suggère d&#8217;utiliser l&#8217;éditeur de texte <literal>nano</literal> à la place et de remplacer <literal>vi</literal> par <literal>nano</literal> dans toutes les lignes de commande.</simpara>
<simpara>Dans le document, on peut trouver des textes entourés de &lt;texte&gt;. Cela signifie que vous devez mettre ici votre propre texte selon vos préférences.</simpara>
<simpara>Le coût pour mettre en oeuvre ce type de serveur est relativement faible:
* Compter 25-30€TTC/an pour un nom de domaine classique (mais il peut y avoir des promos)
* Compter 6€TTC/mois pour un VPS chez un hébergeur de type Contabo (6Go de Ram, 4 coeurs, 400Go de SSD).les.</simpara>
<simpara>Le budget est donc de 8-10€TTC/mois pour une offre d&#8217;entrée de gamme. Il faut plus sérieusement compter sur 10-15€/mois tout compris.</simpara>
</section>
<section xml:id="_choix_du_vps">
<title>Choix du VPS</title>
<simpara>Cette partie du guide s&#8217;adresse aux utilisateurs de Contabo.
J&#8217;ai pour ma part choisi un serveur VPS SSD chez Contabo avec 6Go de RAM. Au moment ou j&#8217;écris ce paragraphe (02-2024) il possède deux coeurs et 400 Go de disque.</simpara>
<simpara>Choisissez d&#8217;installer une image Linux seule avec Debian 12.
Une fois l&#8217;installation effectuée, vous recevez un Email sur l&#8217;adresse mail de votre compte Contabo avec vos identifiants de login root. Ils serviront à vous connecter sur le serveur.</simpara>
<simpara>En vous loguant sur la <link xl:href="https://my.contabo.com">plateforme d&#8217;administration</link>, vous accéderez aux informations de votre serveur dans le menu <literal>Your services</literal>. A cet endroit votre VPS doit y être indiqué.</simpara>
<simpara>En cliquant dessus un ensemble de menus doivent apparaître pour administrer celui-ci. Vous y trouverez notamment:</simpara>
<itemizedlist>
<listitem>
<simpara>Son adresse &lt;IP&gt; et le nom de la machine. Elle est du type "vmixxxxxx.contaboserver.net".</simpara>
</listitem>
<listitem>
<simpara>La possibilité de le redémarrer</simpara>
</listitem>
<listitem>
<simpara>La possibilité de le réinstaller (avec perte complète de données)</simpara>
</listitem>
<listitem>
<simpara>un KVM pour en prendre le contrôle console directement dans le navigateur</simpara>
</listitem>
<listitem>
<simpara>un menu de configuration de reverse DNS (qui nous sera utile par la suite) pour définir le domaine par défaut</simpara>
</listitem>
<listitem>
<simpara>le statut des services principaux (http, ftp, ssh &#8230;&#8203;)</simpara>
</listitem>
<listitem>
<simpara>enfin des choix pour souscrire à un backup régulier, ajouter des disques ou effectuer un snapshot de la VM associée au VPS.</simpara>
</listitem>
</itemizedlist>
</section>
<section xml:id="root_login">
<title>Se loguer root sur le serveur</title>
<simpara>A de nombreux endroit dans la documentation, il est demandé de se loguer root sur le serveur.
Pour se loguer root, et dans l’hypothèse que vous avez mis en place un compte sudo:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>De votre machine locale, loguez vous avec votre compte <literal>&lt;sudo_username&gt;</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh &lt;sudo_username&gt;@&lt;example.com&gt; <co xml:id="CO1-1"/></programlisting>
<calloutlist>
<callout arearefs="CO1-1">
<para>Mettez ici &lt;sudo_username&gt; par votre nom de login et &lt;example.com&gt; par votre nom de domaine ou son adresse IP. Au début votre nom de domaine acheté n&#8217;est pas encore configuré. Il faut donc utiliser le nom de machine ( par exemple pour un VPS OVH: VPSxxxxxx.ovh.net ou pour un raspberry: raspberrypi.local ) ou votre adresse IP.</para>
<simpara>ou utilisez putty si vous êtes sous Windows.</simpara>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Tapez votre mot de passe s&#8217;il est demandé. Si vous avez installé une clé de connexion ce ne devrait pas être le cas.</simpara>
</listitem>
<listitem>
<simpara>Loguez-vous <literal>root</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">sudo bash</programlisting>
<simpara>Un mot de passe vous est demandé. Tapez le mot de passe demandé.</simpara>
</listitem>
<listitem>
<simpara>Dans le cas contraire (pas de sudo créé et connexion en root directe sur le serveur):</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Se loguer root sur le serveur distant. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh root@&lt;example.com&gt; <co xml:id="CO2-1"/></programlisting>
<calloutlist>
<callout arearefs="CO2-1">
<para>remplacer ici &lt;example.com&gt; par votre nom de domaine.</para>
<simpara>Tapez ensuite votre mot de passe root</simpara>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="pass_gen">
<title>Gestion des mots de passe</title>
<simpara>A propos des mots de passe: il est conseillé de saisir des mots de passe de 12 caractères contenant des majuscules/minuscules/nombres/caractères spéciaux. Une autre façon de faire est de saisir de longues phrases. Par exemple: 'J&#8217;aime manger de la mousse au chocolat parfumée à la menthe'. Ce dernier exemple a un taux de complexité bien meilleur qu&#8217;un mot de passe classique. Il est aussi plus facile à retenir que 'Az3~1ym_a&amp;'.</simpara>
<simpara>Cependant, si vous êtes en manque d&#8217;inspiration et que vous souhaitez générer des mots de passe, voici quelques méthodes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>En se basant sur la date. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">date +%s | sha256sum | base64 | head -c 32 ; echo <co xml:id="CO3-1"/></programlisting>
<calloutlist>
<callout arearefs="CO3-1">
<para>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>En se basant sur les nombres aléatoires système. Tapez l&#8217;une des deux lignes ci dessous :</simpara>
<programlisting language="bash" linenumbering="unnumbered">tr -cd '[:graph:]' &lt; /dev/urandom | head -c 32; echo <co xml:id="CO4-1"/>
tr -cd A-Za-z0-9 &lt; /dev/urandom | head -c 32;echo <co xml:id="CO4-2"/></programlisting>
<calloutlist>
<callout arearefs="CO4-1 CO4-2">
<para>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>En utilisant Openssl. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">openssl rand -base64 32 | cut -c-32 <co xml:id="CO5-1"/></programlisting>
<calloutlist>
<callout arearefs="CO5-1">
<para>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>En utilisant gpg. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">gpg --gen-random --armor 1 32 | cut -c-32 <co xml:id="CO6-1"/></programlisting>
<calloutlist>
<callout arearefs="CO6-1">
<para>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>En utilisant pwgen pour générer des mots de passe qui suivent des règles de longueur et types de caractères.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Pour installer l&#8217;outil, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install pwgen</programlisting>
</listitem>
<listitem>
<simpara>Ensuite tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">pwgen -Bcny 32 -1 <co xml:id="CO7-1"/></programlisting>
<calloutlist>
<callout arearefs="CO7-1">
<para>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères. La commande crée un mot de passe non ambigue avec au moins une majuscule , une valeur numérique, un symbole.</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>En utilisant apg pour générer des mots de passe prononcables tel que: <literal>7quiGrikCod+ (SEVEN-qui-Grik-Cod-PLUS_SIGN)</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Pour installer l&#8217;outil, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install apg</programlisting>
</listitem>
<listitem>
<simpara>Ensuite tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apg</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>En utilisant xkcdpass pour générer des passphrases comme: <literal>context smashup spiffy cuddly throttle landfall</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Pour installer l&#8217;outil, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install xkcdpass</programlisting>
</listitem>
<listitem>
<simpara>Ensuite tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">xkcdpass</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_choix_du_registrar">
<title>Choix du registrar</title>
<simpara>Pour rappel, un registrar est une société auprès de laquelle vous pourrez acheter un nom de domaine sur une durée déterminée. Vous devrez fournir pour votre enregistrement un ensemble de données personnelles qui permettront de vous identifier en tant que propriétaire de ce nom de domaine.</simpara>
<simpara>Pour ma part j&#8217;ai choisi Gandi car il ne sont pas très cher et leur interface d&#8217;administration est simple d&#8217;usage. Vous pouvez très bien prendre aussi vos DNS chez OVH.</simpara>
<simpara>Une fois votre domaine enregistré et votre compte créé vous pouvez vous loguer sur la <link xl:href="https://admin.gandi.net/dashboard">plateforme de gestion de Gandi</link>.</simpara>
<simpara>Allez dans Nom de domaine et sélectionnez le nom de domaine que vous voulez administrer.
La vue générale vous montre les services actifs. Il faut une fois la configuration des DNS effectuée être dans le mode suivant:</simpara>
<itemizedlist>
<listitem>
<simpara>Serveurs de noms: Externes</simpara>
</listitem>
<listitem>
<simpara>Emails: Inactif</simpara>
</listitem>
<listitem>
<simpara>DNSSEC: Inactif (cela sera activé dans une seconde étape de ce guide)</simpara>
</listitem>
</itemizedlist>
<simpara>Vous ne devez avoir aucune boite mail active sur ce domaine. A regardez dans le menu "Boites &amp; redirections Mails".</simpara>
<simpara>Ajoutez des Glue records:</simpara>
<itemizedlist>
<listitem>
<simpara>un pour ns1.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</simpara>
</listitem>
<listitem>
<simpara>un pour ns2.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</simpara>
</listitem>
</itemizedlist>
<simpara>Vous devez reconfigurer les 'Enregistrements DNS' en mode externes.
Dans le menu "serveurs de noms", vous devez configurer les serveurs de noms externe. Mettre 3 DNS:</simpara>
<itemizedlist>
<listitem>
<simpara>les deux DNS de votre domaine: ns1.&lt;example.com&gt; et ns2.&lt;example.com&gt;</simpara>
</listitem>
<listitem>
<simpara>puis enfin le nom de votre machine définie par votre hébergeur de VPS: <literal>vmixxxxxx.contaboserver.net</literal></simpara>
</listitem>
</itemizedlist>
<simpara>Ajoutez des Glue records:</simpara>
<itemizedlist>
<listitem>
<simpara>un pour ns1.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</simpara>
</listitem>
<listitem>
<simpara>un pour ns2.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</simpara>
</listitem>
</itemizedlist>
<note>
<simpara>Il y a la possibilité chez OVH d&#8217;utiliser un DNS secondaire. Dans ce cas, enregistrez votre nom de domaine sur le serveur de dns secondaire de votre hébergeur. Notez ensuite le nom de domaine de ce DNS secondaire et ajoutez une entrée supplémentaire sur le serveur de votre registrar avec l&#8217;adresse DNS secondaire.</simpara>
</note>
<note>
<simpara>Avoir un DNS sur au moins deux machines distinctes est la configuration recommandée.</simpara>
</note>
<simpara>Le menu restant est associé à DNSSEC; nous y reviendrons plus tard.</simpara>
</section>
<section xml:id="_configuration_basique">
<title>Configuration basique</title>
<section xml:id="domain_config">
<title>Vérification du nom de serveur</title>
<simpara>Cette partie consiste à vérifier que le serveur a un hostname correctement configuré.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>vérifier que le hostname est bien celui attendu (c&#8217;est à dire configuré par votre hébergeur). Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cat /etc/hostname</programlisting>
<simpara>Le nom du hostname (sans le domaine) doit s&#8217;afficher.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Si ce n&#8217;est pas le cas, changer ce nom en éditant le fichier. Tapez :</simpara>
<programlisting language="shell" linenumbering="unnumbered">vi /etc/hostname</programlisting>
<simpara>Changez la valeur, sauvegardez et rebootez. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">reboot</programlisting>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Vérifier le fichier <literal>hosts</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cat /etc/hosts</programlisting>
<simpara>Si le fichier contient plusieurs lignes avec la même adresse de loopback en <literal>127.x.y.z</literal>, en gardez une seule et celle avec le hostname et le nom de domaine complet.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>si ce n&#8217;est pas le cas, changer les lignes en éditant le fichier. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/hosts</programlisting>
</listitem>
<listitem>
<simpara>Changez la ou les lignes, sauvegardez.</simpara>
<note>
<simpara>Le FQDN (nom de machine avec le nom de domaine) doit être déclaré avant le hostname simple dans le fichier <literal>hosts</literal>.  Pour que la configuration de votre serveur de mail soit correcte vous devez installer un FQDN contenant l&#8217;adresse de mail comme <literal>mail.example.com</literal></simpara>
</note>
</listitem>
<listitem>
<simpara>Rebootez. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">reboot</programlisting>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Vérifiez que tout est correctement configuré.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">hostname</programlisting>
<simpara>La sortie doit afficher le nom de host.</simpara>
</listitem>
<listitem>
<simpara>Tapez ensuite :</simpara>
<programlisting language="bash" linenumbering="unnumbered">hostname -f</programlisting>
<simpara>La sortie doit afficher le nom de host avec le nom de domaine.</simpara>
</listitem>
<listitem>
<simpara>Reconfigurez les clés SSH server si vous avez changé le Hostname. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">rm -v /etc/ssh/ssh_host_*
dpkg-reconfigure openssh-server</programlisting>
</listitem>
<listitem>
<simpara>Les nouvelles clés vont être regénérées.</simpara>
</listitem>
<listitem>
<simpara>Déconnectez vous de votre session SSH et reconnectez vous.</simpara>
</listitem>
<listitem>
<simpara>Sur votre poste de travail, la clé d&#8217;authentification du serveur aura changée. il vous faudra annuler l&#8217;ancien puis accepter la nouvelle.</simpara>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh-keygen -f "$HOME/.ssh/known_hosts" -R hostname <co xml:id="CO8-1"/></programlisting>
<calloutlist>
<callout arearefs="CO8-1">
<para>remplacer hostname par l&#8217;adresse IP ou le nom de machine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Reloguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_mettre_léditeur_de_votre_choix">
<title>Mettre l&#8217;éditeur de votre choix</title>
<simpara>En fonction de vos préférences en terme d&#8217;éditeur, choisissez celui qui vous convient pour les outils utilisant un éditeur de façon automatique tels que <literal>crontab</literal>.</simpara>
<simpara>Pour les débutants, il est conseillé d&#8217;utiliser <literal>nano</literal> pour les utilisateurs avancés, vous pouvez utiliser <literal>vim</literal></simpara>
<simpara><link linkend="root_login">Loguez vous comme root </link>.</simpara>
<simpara>Si vous voulez installer <literal>vim</literal>, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install vim</programlisting>
<simpara>Pour Sélectionner votre éditeur par défaut, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">update-alternatives  --config editor</programlisting>
<simpara>choisissez le chiffre correspondant à Nano ou Vim.basic et quittez.</simpara>
</section>
<section xml:id="_installation_dun_repository_pour_etc">
<title>Installation d&#8217;un repository pour <literal>/etc</literal></title>
<simpara>Si vous souhaitez gérer en gestion de configuration le contenu de votre répertoire <literal>/etc</literal>, installez <literal>etckeeper</literal>.</simpara>
<simpara>Cette installation est optionnelle. Elle permet de garder dans un repository GIT toutes les modifications qui sont effectuées dans /etc soit par vous soit au moment de l&#8217;installation de paquets.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update
apt install etckeeper</programlisting>
</listitem>
<listitem>
<simpara>Vous pouvez créer un repository privé dans le cloud pour stocker votre configuration de serveur (autre serveur privé de confiance ou repository privé  <literal>Gitlab</literal> ou <literal>Github</literal>).</simpara>
</listitem>
<listitem>
<simpara>Ajoutez ce repository distant. Pour <literal>Gitlab</literal> et <literal>Github</literal>, une fois le repository créé, demandez l&#8217;affichage de la commande git pour une communication en ssh. Tapez ensuite sur votre serveur :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc
git remote add origin git@github.com:username/etc_keeper.git <co xml:id="CO9-1"/></programlisting>
<calloutlist>
<callout arearefs="CO9-1">
<para>remplacer l&#8217;url par celle qui correspond au chemin de votre repository</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>modifier le fichier de configuration de <literal>etckeeper</literal>. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/etckeeper/etckeeper.conf</programlisting>
</listitem>
<listitem>
<simpara>Recherchez la ligne contenant <literal>PUSH_REMOTE</literal> et ajoutez y tous les repositories distant sur lesquels vous souhaitez pousser les modifications. Pour notre configuration, mettez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">PUSH_REMOTE="origin"</programlisting>
</listitem>
<listitem>
<simpara>Pour éviter des demandes de mot de passe de la part de <literal>github</literal> ou <literal>gitlab</literal>, il est nécessaire de déclarer une clé publique sur leur site. Créez une clé sur votre serveur pour l&#8217;utilisateur root:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Créer un répertoire <literal>/root/.ssh</literal> s&#8217;il n&#8217;existe pas. tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /root
mkdir -p .ssh</programlisting>
</listitem>
<listitem>
<simpara>Allez dans le répertoire. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /root/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Générez vous clés. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh-keygen -t rsa</programlisting>
</listitem>
<listitem>
<simpara>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</simpara>
</listitem>
<listitem>
<simpara>Allez sur <literal>gitlab</literal> ou <literal>github</literal> dans la rubriques "settings" et le menu "SSH keys". Ajoutez la clé que vous aurez affiché avec la commande suivante:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cat /root/.ssh/id_rsa.pub</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Effectuez un premier push. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc
git push -u origin master</programlisting>
</listitem>
<listitem>
<simpara>aucun mot de passe ne doit vous être demandé. Si ce n&#8217;est pas le cas, re-vérifier les étapes précédentes.</simpara>
</listitem>
<listitem>
<simpara>Lancer <literal>etckeeper</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">etckeeper commit</programlisting>
</listitem>
<listitem>
<simpara>Tout le contenu de <literal>/etc</literal> est poussé sur le repository. Saisissez un commentaire.</simpara>
</listitem>
<listitem>
<simpara>C&#8217;est fait !</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_mise_à_jour_des_sources_de_paquets_debian">
<title>Mise à jour des sources de paquets Debian</title>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Modifier la liste standard de paquets</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Éditer le fichier <literal>/etc/apt/sources.list</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/apt/sources.list</programlisting>
</listitem>
<listitem>
<simpara>Dé-commenter les lignes débutant par <literal>deb</literal> et contenant le terme <literal>backports</literal>. Par exemple pour <literal>#deb <link xl:href="http://deb.debian.org/debian">http://deb.debian.org/debian</link> bookworm-backports main contrib non-free</literal> enlever le # en début de ligne</simpara>
</listitem>
<listitem>
<simpara>Ajouter sur toutes les lignes les paquets <literal>contrib</literal> et <literal>non-free</literal> . en ajoutant ces textes après chaque mot <literal>main</literal> du fichier <literal>source.list</literal></simpara>
</listitem>
<listitem>
<simpara>Le fichier doit ressembler à ceci:</simpara>
<programlisting language="ini" linenumbering="unnumbered">deb http://deb.debian.org/debian bookworm main contrib non-free non-free-firmware

## Major bug fix updates produced after the final release of the
## distribution.
deb http://security.debian.org/debian-security bookworm-security main contrib non-free non-free-firmware
deb http://deb.debian.org/debian bookworm-updates main contrib non-free non-free-firmware

## N.B. software from this repository may not have been tested as
## extensively as that contained in the main release, although it includes
## newer versions of some applications which may provide useful features.
deb http://deb.debian.org/debian bookworm-backports main contrib non-free non-free-firmware</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Effectuer une mise à niveau du système</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Mettez à jour la liste des paquets. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update</programlisting>
</listitem>
<listitem>
<simpara>Installez les nouveautés. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt dist-upgrade</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Effectuez du ménage. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt autoremove</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_des_paquets_de_base">
<title>Installation des paquets de base</title>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
</listitem>
</orderedlist>
<programlisting language="bash" linenumbering="unnumbered">apt install curl wget ntpdate apt-transport-https apt-listchanges apt-file apt-rdepends man</programlisting>
</section>
<section xml:id="_passage_de_la_locale_en_fr">
<title>Passage de la locale en FR</title>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
</listitem>
</orderedlist>
<programlisting language="bash" linenumbering="unnumbered">apt install locales</programlisting>
<orderedlist numeration="arabic">
<listitem>
<simpara>Tapez ensuite:</simpara>
</listitem>
</orderedlist>
<screen> dpkg-reconfigure locales</screen>
<orderedlist numeration="arabic">
<listitem>
<simpara>Dans l&#8217;écran qui apparait, sélectionnez: <literal>fr_FR.UTF_8</literal></simpara>
</listitem>
<listitem>
<simpara>Tapez ensuite sur la ligne de commande: <literal>locale</literal></simpara>
</listitem>
<listitem>
<simpara>Le texte suivant apparait:</simpara>
</listitem>
</orderedlist>
<screen>LANG=fr_FR.UTF-8
LC_CTYPE="fr_FR.UTF-8"
LC_NUMERIC="fr_FR.UTF-8"
LC_TIME="fr_FR.UTF-8"
LC_COLLATE="fr_FR.UTF-8"
LC_MONETARY="fr_FR.UTF-8"
LC_MESSAGES="fr_FR.UTF-8"
LC_PAPER="fr_FR.UTF-8"
LC_NAME="fr_FR.UTF-8"
LC_ADDRESS="fr_FR.UTF-8"
LC_TELEPHONE="fr_FR.UTF-8"
LC_MEASUREMENT="fr_FR.UTF-8"
LC_IDENTIFICATION="fr_FR.UTF-8"
LC_ALL=</screen>
<orderedlist numeration="arabic">
<listitem>
<simpara>Tapez ensuite la ligne suivante pour installer l&#8217;environnement en français:</simpara>
</listitem>
</orderedlist>
<programlisting language="bash" linenumbering="unnumbered">apt install task-french</programlisting>
</section>
<section xml:id="_installer_loutil_debfoster">
<title>Installer l&#8217;outil Debfoster</title>
<simpara>L&#8217;outil <literal>debfoster</literal> permet de ne conserver que les paquets essentiels.</simpara>
<simpara>Cette installation est optionnelle.</simpara>
<simpara>Il maintient un fichier <literal>keepers</literal> présent dans <literal>/var/lib/debfoster</literal></simpara>
<simpara>En répondant aux questions de conservations de paquets, <literal>debfoster</literal> maintient la liste des paquets uniques nécessaires au système.
Tous les autres paquets seront supprimés.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Ajouter le paquet <literal>debfoster</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install debfoster</programlisting>
</listitem>
<listitem>
<simpara>Lancez <literal>debfoster</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">debfoster</programlisting>
</listitem>
<listitem>
<simpara>Répondez au questions pour chaque paquet</simpara>
</listitem>
<listitem>
<simpara>Acceptez la liste des modifications proposées à la fin. Les paquets superflus seront supprimés</simpara>
</listitem>
</orderedlist>
<simpara>Ci dessous une petite liste de paquets à conserver sur une installation basique:</simpara>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="4">
<colspec colname="col_1" colwidth="25*"/>
<colspec colname="col_2" colwidth="25*"/>
<colspec colname="col_3" colwidth="25*"/>
<colspec colname="col_4" colwidth="25*"/>
<tbody>
<row>
<entry align="left" valign="top"><simpara>aptitude</simpara></entry>
<entry align="left" valign="top"><simpara>cloud-init</simpara></entry>
<entry align="left" valign="top"><simpara>cloud-utils</simpara></entry>
<entry align="left" valign="top"><simpara>curl</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>debfoster</simpara></entry>
<entry align="left" valign="top"><simpara>etckeeper</simpara></entry>
<entry align="left" valign="top"><simpara>euca2ools</simpara></entry>
<entry align="left" valign="top"><simpara>gdbm-l10n</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>grub-pc</simpara></entry>
<entry align="left" valign="top"><simpara>ifenslave</simpara></entry>
<entry align="left" valign="top"><simpara>kbd</simpara></entry>
<entry align="left" valign="top"><simpara>linux-image-cloud-amd64</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>locales-all</simpara></entry>
<entry align="left" valign="top"><simpara>most</simpara></entry>
<entry align="left" valign="top"><simpara>ntp</simpara></entry>
<entry align="left" valign="top"><simpara>openssh-server</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>screen</simpara></entry>
<entry align="left" valign="top"><simpara>unscd</simpara></entry>
<entry align="left" valign="top"><simpara>whiptail</simpara></entry>
<entry align="left" valign="top"></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_création_dun_fichier_keeper_dans_etc">
<title>Création d&#8217;un fichier keeper dans /etc</title>
<simpara>Vous pourriez être intéressé après l&#8217;installation de <literal>debfoster</literal> et de <literal>etckeeper</literal> de construire automatiquement un fichier qui contient la liste des paquets qui permettent de réinstaller le système:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/etckeeper/pre-commit.d/35debfoster</programlisting>
</listitem>
<listitem>
<simpara>Saisissez dans le fichier:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
set -e

# Make sure sort always sorts in same order.
LANG=C
export LANG

shellquote() {
        # Single quotes text, escaping existing single quotes.
        sed -e "s/'/'\"'\"'/g" -e "s/^/'/" -e "s/$/'/"
}


if [ "$VCS" = git ] || [ "$VCS" = hg ] || [ "$VCS" = bzr ] || [ "$VCS" = darcs ]; then
        # Make sure the file is not readable by others, since it can leak
        # information about contents of non-readable directories in /etc.
        debfoster -q -k /etc/keepers
        chmod 600 /etc/keepers
        sed -i "1i\\# debfoster file" /etc/keepers
        sed -i "1i\\# Generated by etckeeper.  Do not edit."  /etc/keepers

        # stage the file as part of the current commit
        if [ "$VCS" = git ]; then
                # this will do nothing if the keepers file is unchanged.
                git add keepers
        fi
        # hg, bzr and darcs add not done, they will automatically
        # include the file in the current commit
fi</programlisting>
</listitem>
<listitem>
<simpara>Sauvez et tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 755 /etc/etckeeper/pre-commit.d/35debfoster</programlisting>
</listitem>
<listitem>
<simpara>Exécutez maintenant <literal>etckeeper</literal></simpara>
<programlisting language="bash" linenumbering="unnumbered">etckeeper commit</programlisting>
</listitem>
<listitem>
<simpara>Le fichier keepers est créé et sauvegardé automatiquement.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_des_mises_à_jours_automatiques">
<title>Installation des mises à jours automatiques</title>
<simpara>Si vous souhaitez installer automatiquement les paquets Debian de correction de bugs de sécurité, cette installation est pour vous.</simpara>
<simpara>Cette installation est optionnelle.</simpara>
<warning>
<simpara>L&#8217;installation automatique de paquets peut conduire dans certains cas
très rare à des dysfonctionnements du serveur. Il est important de
regarder périodiquement les logs d&#8217;installation.</simpara>
</warning>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install unattended-upgrades</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_configurer_une_ipv6">
<title>Configurer une IPV6</title>
<simpara>Contabo propose des adresses IPV6 sur les VPS. Ces adresses sont indiquées sur le panneau de synthèse du VPS (Dashboard).</simpara>
<simpara>il est nécessaire d&#8217;activer en tapant: <literal>enable_ipv6</literal> en tant que <link linkend="root_login">root</link></simpara>
<simpara>Votre hébergeur peut vous proposer la même chose.</simpara>
<simpara>De même pour votre raspberry vous pouvez être tenté d&#8217;utiliser l&#8217;adresse IPV6 proposée par votre fournisseur d&#8217;accès internet.</simpara>
<simpara>La résolution par DHCP ne semble pas fonctionner. Il faut donc configurer l&#8217;adresse à la main:</simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/network/interfaces.d/99-ipv6-init.cfg</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez ces lignes dans le fichier:</simpara>
<programlisting language="ini" linenumbering="unnumbered">iface eth0 inet6 static
address &lt;IPV6_ADDRESS&gt; <co xml:id="CO10-1"/>
post-up /sbin/ip -6 route add &lt;GW_ADDRESS&gt; dev eth0 <co xml:id="CO10-2"/>
post-up /sbin/ip -6 route add default via &lt;GW_ADDRESS&gt; dev eth0 <co xml:id="CO10-3"/>
pre-down /sbin/ip -6 route del default via &lt;GW_ADDRESS&gt; dev eth0 <co xml:id="CO10-4"/>
pre-down /sbin/ip -6 route del &lt;GW_ADDRESS&gt; dev eth0 <co xml:id="CO10-5"/></programlisting>
<calloutlist>
<callout arearefs="CO10-1">
<para>Mettre ici l&#8217;adresse IPV6 proposée pour le serveur</para>
</callout>
<callout arearefs="CO10-2 CO10-3 CO10-4 CO10-5">
<para>Mettre ici l&#8217;adresse IPV6 du gateway proposé pour le serveur</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_interdire_le_login_direct_en_root">
<title>Interdire le login direct en root</title>
<simpara>Il est toujours vivement déconseillé d&#8217;autoriser la possibilité de se connecter directement en SSH en tant que root.</simpara>
<simpara>Avec les versions récentes de Debian Bookworm pour raspberry pi, il n&#8217;est plus nécessaire de créer le compte sudo qui est créé par défaut lors de la procédure d&#8217;installation standard. Cette procédure est cependant  indispensable pour l&#8217;installation d&#8217;une distribution debian standard.</simpara>
<simpara>Une remarque tout de même pour le raspberry pi: le compte sudo permet de se logger root sans aucun mot de passe. C&#8217;est considéré comme une faille de sécurité. Pour corriger cela, <link linkend="root_login">Loguez vous comme root sur le serveur</link> et tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">rm -f /etc/sudoers.d/010_pi-nopasswd</programlisting>
<simpara>La procédure suivante s&#8217;applique pour la création du compte sudo sur une debian standard.</simpara>
<simpara>Notre première action sera de désactiver le login direct en root  et d&#8217;autoriser le sudo.</simpara>
<simpara>Respectez bien les étapes de cette procédure:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez l&#8217;outil <literal>sudo</literal> s&#8217;il n&#8217;est pas déjà présent. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install sudo</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez un utilisateur standard qui sera nommé par la suite en tant que &lt;sudo_username&gt;</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">adduser &lt;sudo_username&gt; <co xml:id="CO11-1"/></programlisting>
<calloutlist>
<callout arearefs="CO11-1">
<para>remplacer ici &lt;sudo_username&gt; par votre login</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Répondez aux questions qui vont sont posées: habituellement le nom complet d&#8217;utilisateur et le mot de passe.</simpara>
</listitem>
<listitem>
<simpara>Donner les attributs sudo à l&#8217;utilisateur <literal>&lt;sudo_username&gt;</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">usermod -a -G sudo &lt;sudo_username&gt; <co xml:id="CO12-1"/></programlisting>
<calloutlist>
<callout arearefs="CO12-1">
<para>remplacer ici &lt;sudo_username&gt; par votre login</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Dans une autre fenêtre, se connecter sur le serveur avec votre nouveau compte <literal>&lt;sudo_username&gt;</literal>:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh &lt;sudo_username&gt;@&lt;example.com&gt; <co xml:id="CO13-1"/></programlisting>
<calloutlist>
<callout arearefs="CO13-1">
<para>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>une fois logué, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">sudo bash</programlisting>
<simpara>Tapez le mot de passe de votre utilisateur. Vous devez avoir accès au compte root. Si ce n&#8217;est pas le cas, revérifiez la procédure et repassez toutes les étapes.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<important>
<simpara>Tout pendant que ces premières étapes ne donnent pas satisfaction ne passez pas à la suite sous peine de perdre la possibilité d’accéder à votre serveur.</simpara>
</important>
<orderedlist numeration="arabic">
<listitem>
<simpara>Il faut maintenant modifier la configuration de sshd.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Editez le fichier <literal>/etc/ssh/sshd_config</literal>, Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/ssh/sshd_config</programlisting>
<simpara>il faut rechercher la ligne: <literal>PermitRootLogin yes</literal> et la remplacer par:</simpara>
<programlisting language="ini" linenumbering="unnumbered">PermitRootLogin no</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez le serveur ssh. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">service sshd restart</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Faites maintenant l&#8217;essai de vous re-loguer avec le compte root.Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh root@&lt;example.com&gt; <co xml:id="CO14-1"/></programlisting>
<calloutlist>
<callout arearefs="CO14-1">
<para>Remplacer ici &lt;example.com&gt; par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Ce ne devrait plus être possible: le serveur vous l&#8217;indique par un message <literal>Permission denied, please try again.</literal></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_dune_clé_de_connexion_ssh_locale">
<title>Création d&#8217;une clé de connexion ssh locale</title>
<simpara>Pour créer une clé et la déployer:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une clé sur votre machine locale (et pas sur le serveur distant!):</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Ouvrir un terminal</simpara>
</listitem>
<listitem>
<simpara>Créer un répertoire <literal>~/.ssh</literal> s&#8217;il n&#8217;existe pas. tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p $HOME/.ssh
chmod 700 ~/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Allez dans le répertoire. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd ~/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Générez vous clés. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh-keygen -t rsa</programlisting>
</listitem>
<listitem>
<simpara>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Sur votre PC local afficher la clé à l&#8217;écran. Elle sera copiée-collée par la suite:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cat ~/.ssh/id_rsa.pub</programlisting>
</listitem>
<listitem>
<simpara>Déployez votre clé:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Loguez vous sur votre serveur distant. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh &lt;sudo_username&gt;@&lt;example.com&gt; <co xml:id="CO15-1"/></programlisting>
<calloutlist>
<callout arearefs="CO15-1">
<para>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</para>
<simpara>Entrez votre mot de passe</simpara>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Créer un répertoire <literal>~/.ssh</literal> s&#8217;il n&#8217;existe pas. tapez: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p $HOME/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Éditez le fichier <literal>~/.ssh/authorized_keys</literal> tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi ~/.ssh/authorized_keys</programlisting>
<simpara>et coller dans ce fichier le texte contenu dans le votre fichier local <literal>~/.ssh/id_rsa.pub</literal>. Remarque: il peut y avoir déjà des clés dans le fichier <literal>authorized_keys</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sécurisez votre fichier de clés. Tapez: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 600 ~/.ssh/authorized_keys</programlisting>
</listitem>
<listitem>
<simpara>Sécurisez le répertoire SSH; Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 ~/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Déconnectez vous de votre session</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Vérifiez que tout fonctionne en vous connectant. Tapez: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh &lt;sudo_username&gt;@&lt;example.com&gt; <co xml:id="CO16-1"/></programlisting>
<calloutlist>
<callout arearefs="CO16-1">
<para>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</para>
<simpara>La session doit s&#8217;ouvrir sans demander de mot de passe.</simpara>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_sudo_sans_mot_de_passe">
<title>Sudo sans mot de passe</title>
<simpara>Avant tout, il faut bien se rendre compte que cela constitue potentiellement une faille de sécurité et qu&#8217;en conséquence, le compte possédant cette propriété devra être autant sécurisé qu&#8217;un compte root.
L’intérêt étant d&#8217;interdire le compte root en connexion ssh tout en gardant la facilité de se loguer root sur le système au travers d&#8217;un super-compte.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Ajoutez un groupe sudonp et y affecter un utilisateur. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">addgroup --system sudonp</programlisting>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Ajouter l&#8217;utilisateur: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">usermod -a -G sudonp &lt;sudo_username&gt;</programlisting>
</listitem>
<listitem>
<simpara>Éventuellement retirez l&#8217;utilisateur du groupe sudo s&#8217;il a été ajouté auparavant :</simpara>
<programlisting language="bash" linenumbering="unnumbered">gpasswd -d &lt;sudo_username&gt; sudo</programlisting>
</listitem>
<listitem>
<simpara>Éditez le fichier sudoers. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/sudoers.d/010_sudonp</programlisting>
</listitem>
<listitem>
<simpara>Ajouter dans le fichier la ligne suivante:</simpara>
<programlisting language="ini" linenumbering="unnumbered">%sudonp ALL=(ALL:ALL) NOPASSWD: ALL</programlisting>
<simpara>L&#8217;utilisateur nom_d_utilisateur pourra se logger root sans mot de passe au travers de la commande <literal>sudo bash</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_du_motd">
<title>Configuration du Motd</title>
<simpara>Le motd est affiché au moment ou l&#8217;utilisateur se loggue en ssh. Nous allons configurer l&#8217;affichage de plusieurs informations importantes.</simpara>
<section xml:id="_installation_de_neofetch">
<title>Installation de Neofetch</title>
<simpara>Neofetch affiche au démarrage de votre système des informations sur le fonctionnement de celui-ci.</simpara>
<simpara>Nous allons créer une configuration système:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez le package neofetch. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install neofetch</programlisting>
</listitem>
<listitem>
<simpara>Editez ensuite le fichier <literal>/etc/neofetch.conf</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/neofetch.conf</programlisting>
</listitem>
<listitem>
<simpara>Mettez ensuite dans le fichier la configuration suivante:</simpara>
<programlisting language="bash" linenumbering="unnumbered">print_info() {
    info title
    info underline

    info "OS" distro
    info "Host" model
    info "Kernel" kernel
    info "Uptime" uptime
    info "Packages" packages
    info "Shell" shell
    info "Resolution" resolution
    info "DE" de
    info "WM" wm
    info "WM Theme" wm_theme
    info "Theme" theme
    info "Icons" icons
    info "Terminal" term
    info "Terminal Font" term_font
    info "CPU" cpu
    info "CPU Usage" cpu_usage
    prin "CPU Temp" "$(vcgencmd measure_temp | awk -F '=' '{print $2}')" <co xml:id="CO17-1"/>
    prin "Load" "$(cat /proc/loadavg | awk '{print $1, $2, $3}')"
    info "GPU" gpu
    info "GPU Driver" gpu_driver  # Linux/macOS only
    info "Memory" memory
    info "Disk" disk
    info "Local IP" local_ip
    info "Public IP" public_ip
    info "Users" users
    info "Locale" locale  # This only works on glibc systems.

    info cols
}

title_fqdn="on"
memory_percent="on"
memory_unit="mib"
package_managers="on"
image_backend="ascii"
cpu_temp="on"</programlisting>
<calloutlist>
<callout arearefs="CO17-1">
<para>Cette ligne est à retirer si vous n&#8217;utilisez pas de Raspberry PI 4 ou 5</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_du_motd_avec_neofetch">
<title>Configuration du MOTD avec Neofetch</title>
<simpara>Pour afficher les informations au moment du login ssh, vous devez modifier le fichier Motd:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Editez le fichier Neofetch du MOTD</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/update-motd.d/20-neofetch</programlisting>
</listitem>
<listitem>
<simpara>Mettez ensuite dans le fichier la configuration suivante:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
neofetch --config /etc/neofetch.conf</programlisting>
</listitem>
<listitem>
<simpara>Changez les permissions du fichier <literal>20-neofetch</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 755 /etc/update-motd.d/20-neofetch</programlisting>
</listitem>
<listitem>
<simpara>A notez que vous pouvez utiliser Neofetch pour votre fichier <literal>.bash_profile</literal></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_mise_à_jour_de_packages">
<title>Mise à jour de packages</title>
<simpara>Vous pouvez ajouter la liste des mises à jours dans le fichier MOTD:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Installez le package python de gestion APT. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install python3-apt</programlisting>
</listitem>
<listitem>
<simpara>Editez le fichier MOTD</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/update-motd.d/30-updates</programlisting>
</listitem>
<listitem>
<simpara>Dans le fichier mettez le contenu suivant:</simpara>
<programlisting language="python" linenumbering="unnumbered">#!/usr/bin/python3
import sys
import subprocess
import apt_pkg

DISTRO = subprocess.Popen(["lsb_release", "-c", "-s"],
                          stdout=subprocess.PIPE).communicate()[0].strip()

class OpNullProgress(object):
    '''apt progress handler which supresses any output.'''
    def update(self):
        pass
    def done(self):
        pass

def is_security_upgrade(pkg):
    '''
    Checks to see if a package comes from a DISTRO-security source.
    '''
    security_package_sources = [("Ubuntu", "%s-security" % DISTRO),
                               ("Debian", "%s-security" % DISTRO)]

    for (file, index) in pkg.file_list:
        for origin, archive in security_package_sources:
            if (file.archive == archive and file.origin == origin):
                return True
    return False

# init apt and config
apt_pkg.init()

# open the apt cache
try:
    cache = apt_pkg.Cache(OpNullProgress())
except SystemError as e:
    sys.stderr.write("Error: Opening the cache (%s)" % e)
    sys.exit(-1)

# setup a DepCache instance to interact with the repo
depcache = apt_pkg.DepCache(cache)

# take into account apt policies
depcache.read_pinfile()

# initialise it
depcache.init()

# give up if packages are broken
if depcache.broken_count &gt; 0:
    sys.stderr.write("Error: Broken packages exist.")
    sys.exit(-1)

# mark possible packages
try:
    # run distro-upgrade
    depcache.upgrade(True)
    # reset if packages get marked as deleted -&gt; we don't want to break anything
    if depcache.del_count &gt; 0:
        depcache.init()

    # then a standard upgrade
    depcache.upgrade()
except SystemError as e:
    sys.stderr.write("Error: Couldn't mark the upgrade (%s)" % e)
    sys.exit(-1)

# run around the packages
upgrades = 0
security_upgrades = 0
for pkg in cache.packages:
    candidate = depcache.get_candidate_ver(pkg)
    current = pkg.current_ver

    # skip packages not marked as upgraded/installed
    if not (depcache.marked_install(pkg) or depcache.marked_upgrade(pkg)):
        continue

    # increment the upgrade counter
    upgrades += 1

    # keep another count for security upgrades
    if is_security_upgrade(candidate):
        security_upgrades += 1

    # double check for security upgrades masked by another package
    for version in pkg.version_list:
        if (current and apt_pkg.version_compare(version.ver_str, current.ver_str) &lt;= 0):
            continue
        if is_security_upgrade(version):
            security_upgrades += 1
            break

print("%d updates to install." % upgrades)
print("%d are security updates." % security_upgrades)
print("")  # leave a trailing blank line</programlisting>
</listitem>
<listitem>
<simpara>Changez les permissions du fichier <literal>30-updates</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 755 /etc/update-motd.d/30-updates</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installer_loutil_dselect">
<title>Installer l&#8217;outil dselect</title>
<simpara>L&#8217;outil <literal>dselect</literal> permet de choisir de façon interactive les paquets que l&#8217;on souhaite installer.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Ajouter le paquet <literal>dselect</literal>. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install dselect</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="swap_create">
<title>Ajouter un fichier de swap</title>
<simpara>Pour un serveur VPS ou Raspberry Pi de 2 Go de RAM, la taille du fichier de swap sera de 2 Go.
Si vous avez beaucoup d&#8217;outils et de serveurs à installer il peut être nécessaire d&#8217;avoir 4 Go de RAM au total + 2 Go de swap.</simpara>
<simpara>Enfin pour un Raspberry PI 3 avec 1 Go de Ram, il faut ajouter 1 Go de swap.</simpara>
<simpara>Tapez :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tout d&#8217;abord, si l&#8217;outil <literal>dphys-swapfile</literal> est installé et configuré sur la machine, commencez par désactiver le swap. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">dphys-swapfile uninstall</programlisting>
</listitem>
<listitem>
<simpara>Pour installer un swap de 4Go, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /
fallocate -l 4G /swapfile
chmod 600 /swapfile
mkswap /swapfile
swapon /swapfile</programlisting>
</listitem>
<listitem>
<simpara>Enfin ajoutez une entrée dans le fichier fstab. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/fstab</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez la ligne:</simpara>
<screen>/swapfile swap swap defaults 0 0</screen>
</listitem>
<listitem>
<simpara>Enfin vous pouvez être tenté de limiter le swap (surtout utile sur les systèmes avec peu de RAM et du SSD. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/sysctl.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez ou modifiez la ligne:</simpara>
<screen>vm.swappiness = 5</screen>
</listitem>
<listitem>
<simpara>Le paramètre sera actif au prochain reboot</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_initiale_des_outils">
<title>Installation initiale des outils</title>
<simpara>La procédure d&#8217;installation ci-dessous configure ISPconfig avec les fonctionnalités suivantes: Postfix, Dovecot, MariaDB, rkHunter, Apache, PHP, Let&#8217;s Encrypt, PureFTPd, Bind, Webalizer, AWStats, fail2Ban, UFW Firewall, PHPMyadmin, RoundCube.</simpara>
<simpara>L&#8217;installation est simplifiée grâce à l&#8217;utilisation de l&#8217;autoinstalleur d&#8217;ISPConfig.</simpara>
<simpara>cet installeur fonction pour les version de Debian 10, 11 et 12 et  Ubuntu 20.04 à 24.04</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
<section xml:id="_installation_et_configuration_de_ispconfig">
<title>Installation et configuration de ISPConfig</title>
<simpara>ISPConfig est un système de configuration de sites web totalement compatible avec Webmin.</simpara>
<simpara>Pour installer ISPConfig, vous devez suivre la procédure ci-dessous. ISPConfig 3 a été utilisé dans ce tutoriel.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">hostname -f</programlisting>
</listitem>
<listitem>
<simpara>La sortie doit être du type:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mail.example.com</programlisting>
</listitem>
<listitem>
<simpara>Si ce n&#8217;est pas le cas corrigez le FQDN en vous référant au chapitre <xref linkend="domain_config"/>.</simpara>
</listitem>
<listitem>
<simpara>Nous allons maintenant installer <link xl:href="https://www.ispconfig.org/ispconfig/download/">ISPConfig</link> avec l&#8217;autoinstalleur.</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le système. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update &amp;&amp; apt dist-upgrade</programlisting>
</listitem>
<listitem>
<simpara>Exécutez l&#8217;autoinstalleur en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">wget -O - https://get.ispconfig.org | sh -s -- --use-ftp-ports=40110-40210 --unattended-upgrades <co xml:id="CO18-1"/></programlisting>
<calloutlist>
<callout arearefs="CO18-1">
<para>vous pouvez remplacer l&#8217;éventail de ports FTP par d&#8217;autres si vous voulez.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Au bout d&#8217;un moment vous verrez s&#8217;afficher:</simpara>
<programlisting language="bash" linenumbering="unnumbered">WARNING! This script will reconfigure your complete server!
It should be run on a freshly installed server and all current configuration that you have done will most likely be lost!
Type 'yes' if you really want to continue</programlisting>
</listitem>
<listitem>
<simpara>Répondez 'yes'. L&#8217;installation démarre.</simpara>
</listitem>
<listitem>
<simpara>Lorsque l&#8217;installation se termine vous verrez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">[INFO] Your ISPConfig admin password is: 5GvfSSSYsdfdYC
[INFO] Your MySQL root password is: kkAkft82d!kafMwqxdtYs</programlisting>
</listitem>
<listitem>
<simpara>Notez ces informations, elles vous serviront pour vous connecter au panel ISPConfig ou à votre base mysql (PhpMyAdmin).</simpara>
</listitem>
<listitem>
<simpara>L&#8217;installation est terminée. Vous accédez au serveur à l&#8217;adresse: <link xl:href="https://example.com:8080/">https://example.com:8080/</link> .</simpara>
<note>
<simpara>Lors de votre première connexion, votre domaine n&#8217;est pas encore configuré. Il faudra alors utiliser le nom DNS donné par votre hébergeur pour votre machine. Pour Contabo, elle s&#8217;écrit <literal>vmixxxxx.contaboserver.net</literal>.</simpara>
</note>
</listitem>
<listitem>
<simpara>. Loguez vous avec le login <literal>admin</literal> et le mot de passe que vous avez récupéré plus haut.</simpara>
<note>
<simpara>Si le message "Possible attack detected. This action has been logged.". Cela signifie que vous avez des cookies d&#8217;une précédente installation qui sont configurés. Effacer les cookies de ce site de votre navigateur.</simpara>
</note>
</listitem>
</orderedlist>
<simpara>Vous pouvez passer maintenant à la suite de la configuration.</simpara>
</section>
</section>
<section xml:id="_configuration_manuelle_des_outils">
<title>Configuration Manuelle des outils</title>
<simpara>Ce chapitre décrit comment configurer manuellement Postfix, Mariadb, Apache, Awstats, Fail2ban, Pureftp, Phpmyadmin, Roundcube, Letsencrypt manuellement.</simpara>
<simpara>Ce chapitre est à sauter si vous avez installé ISPConfig. Vous devez poursuivre vers <xref linkend="After_manual_install"/></simpara>
<simpara>Commencez l&#8217;installation:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez quelques outils de base. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install packages ssh, openssh-server, nano, vim-nox, lsb-release, apt-transport-https, ca-certificates, wget, git, gnupg, software-properties-common, curl, cron, ntp</programlisting>
</listitem>
<listitem>
<simpara>Installez ensuite:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install dbconfig-common, postfix, postfix-mysql, mariadb-client, mariadb-server, openssl, rkhunter, binutils, sudo, getmail6, rsyslog dovecot-imapd, dovecot-pop3d, dovecot-mysql, dovecot-sieve, dovecot-managesieved, dovecot-lmtpd</programlisting>
</listitem>
<listitem>
<simpara>Puis installez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install software-properties-common update-inetd dnsutils resolvconf clamav clamav-daemon zip unzip bzip2 xz-utils lzip borgbackup arj nomarch lzop cabextract apt-listchanges libnet-ldap-perl libauthen-sasl-perl daemon libio-string-perl libio-socket-ssl-perl libnet-ident-perl libnet-dns-perl libdbd-mysql-perl bind9 rspamd redis-server postgrey p7zip p7zip-full unrar-free lrzip</programlisting>
</listitem>
<listitem>
<simpara>Installez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install apache2 apache2-utils libapache2-mod-fcgid apache2-suexec-pristine libapache2-mod-python libapache2-mod-passenger</programlisting>
</listitem>
<listitem>
<simpara>Installez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install php php-pear php-memcache php-imagick mcrypt imagemagick libruby memcached php-apcu jailkit</programlisting>
</listitem>
<listitem>
<simpara>Déterminer votre version de php. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">LC_ALL='C' apt list -a 'php*' | grep -E 'php[0-9]+.[0-9]+/' | grep '\[installed\]' | sed 's/\(.*\)\/.*/\1/'</programlisting>
</listitem>
<listitem>
<simpara>En fonction de la version affichée Installez les packages PHP :</simpara>
<programlisting language="bash" linenumbering="unnumbered">for i in php#-gd php#-mysql php#-imap php#-cli php#-curl php#-intl php#-pspell php#-sqlite3 php#-tidy php#-xsl php#-zip php#-mbstring php#-soap php#-opcache php#-cgi php#-fpm php#-xmlrpc
do
echo $i | sed 's/#/version/' <co xml:id="CO19-1"/>
done | xargs apt install -y</programlisting>
<calloutlist>
<callout arearefs="CO19-1">
<para>remplacer ici version par la version affichée plus haut. Par exemple 8.3</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Installez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install haveged geoip-database libclass-dbi-mysql-perl libtimedate-perl build-essential autoconf automake libtool flex bison debhelper binutils quota quotatool</programlisting>
</listitem>
<listitem>
<simpara>Installez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install pure-ftpd-common pure-ftpd-mysql awstats goaccess awffull</programlisting>
</listitem>
</orderedlist>
<section xml:id="_configuration_manuelle_de_postfix">
<title>Configuration manuelle de Postfix</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Editez le master.cf file de postfix. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/postfix/main.cf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez ou modifiez dans le fichier:</simpara>
<screen>append_dot_mydomain = yes
mydestination = mail.example.com, localhost, localhost.localdomain <co xml:id="CO20-1"/></screen>
</listitem>
<listitem>
<simpara>Editez le master.cf file de postfix. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/postfix/master.cf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier:</simpara>
<screen>submission inet n       -       y       -       -       smtpd
 -o syslog_name=postfix/submission
 -o smtpd_tls_security_level=encrypt
 -o smtpd_sasl_auth_enable=yes
 -o smtpd_client_restrictions=permit_sasl_authenticated,reject

submissions     inet  n       -       y       -       -       smtpd
 -o syslog_name=postfix/submissions
 -o smtpd_tls_wrappermode=yes
 -o smtpd_sasl_auth_enable=yes
 -o smtpd_client_restrictions=permit_sasl_authenticated,reject</screen>
</listitem>
<listitem>
<simpara>Sauvegardez et relancez Postfix:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart postfix</programlisting>
</listitem>
<listitem>
<simpara>Si vous avez installé <literal>SpamAssassin</literal>, désactiver <literal>SpamAssassin</literal> puisque <literal>amavisd</literal> utilise celui ci en sous jacent. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl stop spamassassin
systemctl disable spamassassin</programlisting>
</listitem>
</orderedlist>
<note>
<simpara>Notez que si vous créez une adresse mail nommée <literal>homeserver@example.com</literal>, vous pouvez utilisez toutes les variantes (nommées tag) derrière le caractère "+". Ainsi <literal>homeserver+nospam@example.com</literal> sera bien redirigé vers votre boite et l&#8217;extension <literal>+nospam</literal> vous permettre de trier automatiquement les mails que vous ne voulez pas recevoir.</simpara>
</note>
<note>
<simpara>Il est possible de changer ce caractère spécial en le modifiant dans le fichier <literal>/etc/postfix/main.cf</literal> sur la ligne commençant par <literal>recipient_delimiter</literal>.</simpara>
</note>
</section>
<section xml:id="_configuration_manuelle_de_mariadb">
<title>Configuration manuelle de MariaDB</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Sécurisez votre installation MariaDB. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql_secure_installation</programlisting>
<simpara>Répondez au questions ainsi:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara><literal>Enter current password for root</literal>: &#8592; Tapez Entrée</simpara>
</listitem>
<listitem>
<simpara><literal>Set root password? [Y/n]</literal>: &#8592; Tapez <literal>Y</literal></simpara>
</listitem>
<listitem>
<simpara><literal>New password:</literal>: &#8592; Tapez votre mot de passe root MariaDB</simpara>
</listitem>
<listitem>
<simpara><literal>Re-enter New password:</literal>: &#8592; Tapez votre mot de passe root MariaDB</simpara>
</listitem>
<listitem>
<simpara><literal>Remove anonymous users? [Y/n]</literal>: &#8592; Tapez <literal>Y</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Disallow root login remotely? [Y/n]</literal>: &#8592; Tapez <literal>Y</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Remove test database and access to it? [Y/n]</literal>: &#8592; Tapez <literal>Y</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Reload privilege tables now? [Y/n]</literal>: &#8592; Tapez <literal>Y</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>MariaDB doit pouvoir être atteint par toutes les interfaces et pas seulement localhost.</simpara>
</listitem>
<listitem>
<simpara>Éditez le fichier de configuration. :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/mysql/mariadb.conf.d/50-server.cnf</programlisting>
</listitem>
<listitem>
<simpara>Commentez la ligne <literal>bind-address</literal>:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#bind-address           = 127.0.0.1</programlisting>
</listitem>
<listitem>
<simpara>Modifiez la méthode d&#8217;accès à la base MariaDB pour utiliser la méthode de login native.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "update mysql.user set plugin = 'mysql_native_password' where user='root';" | mysql -u root</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Editez le fichier debian.cnf. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/mysql/debian.cnf</programlisting>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aux deux endroits du fichier ou le mot clé <literal>password</literal> est présent, mettez le mot de passe root de votre base de données.</simpara>
<programlisting language="ini" linenumbering="unnumbered">password = votre_mot_de_passe</programlisting>
<note>
<simpara>Dans les versions récentes de Debian et Ubuntu, le mot clé password n&#8217;est pas présent. Il n&#8217;y a rien à faire.</simpara>
</note>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Pour éviter l&#8217;erreur <literal>Error in accept: Too many open files</literal>, augmenter la limite du nombre de fichiers ouverts.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Editer le fichier: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/security/limits.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez à la fin du fichier les deux lignes:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql soft nofile 65535
mysql hard nofile 65535</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créez ensuite un nouveau répertoire. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /etc/systemd/system/mysql.service.d/</programlisting>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Editer le fichier limits.conf. :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/systemd/system/mysql.service.d/limits.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier les lignes suivantes:</simpara>
<screen>[Service]
LimitNOFILE=infinity</screen>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Redémarrez votre serveur MariaDB. Tapez: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl daemon-reload
systemctl restart mariadb</programlisting>
</listitem>
<listitem>
<simpara>vérifiez maintenant que MariaDB est accessible sur toutes les interfaces réseau. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">netstat -tap | grep mysql</programlisting>
</listitem>
<listitem>
<simpara>La sortie doit être du type:</simpara>
</listitem>
</orderedlist>
<screen>tcp        0      0 0.0.0.0:mysql  0.0.0.0:*  LISTEN  1146/mariadbd
tcp6       0      0    [::]:mysql     [::]:*  LISTEN  1146/mariadbd</screen>
</section>
<section xml:id="_configuration_manuelle_dapache">
<title>Configuration manuelle d&#8217;Apache</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez les modules Apache nécessaires. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2enmod suexec rewrite ssl proxy_http actions include dav_fs dav auth_digest cgi headers actions proxy_fcgi alias speling</programlisting>
</listitem>
<listitem>
<simpara>Pour ne pas être confronté aux problèmes de sécurité  de type <link xl:href="https://www.howtoforge.com/tutorial/httpoxy-protect-your-server/">HTTPOXY</link>, il est nécessaire de créer un petit module dans apache.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Éditez le fichier <literal>httpoxy.conf</literal> :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/apache2/conf-available/httpoxy.conf</programlisting>
</listitem>
<listitem>
<simpara>Collez les lignes suivantes:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;IfModule mod_headers.c&gt;
    RequestHeader unset Proxy early
&lt;/IfModule&gt;</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Activez le module en tapant :</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2enconf httpoxy
systemctl restart apache2</programlisting>
</listitem>
<listitem>
<simpara>Désactiver la documentation apache en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2disconf apache2-doc
systemctl restart apache2</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_manuelle_d_awstats">
<title>Configuration manuelle d' Awstats</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Configurer la tache cron d&#8217;awstats: Éditez le fichier :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/cron.d/awstats</programlisting>
</listitem>
<listitem>
<simpara>Et commentez toutes les lignes:</simpara>
<screen>#MAILTO=root
#*/10 * * * * www-data [ -x /usr/share/awstats/tools/update.sh ] &amp;&amp; /usr/share/awstats/tools/update.sh
# Generate static reports:
#10 03 * * * www-data [ -x /usr/share/awstats/tools/buildstatic.sh ] &amp;&amp; /usr/share/awstats/tools/buildstatic.sh</screen>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_manuelle_de_fail2ban">
<title>Configuration manuelle de Fail2ban</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Editez le fichier jail.local :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/fail2ban/jail.local</programlisting>
<simpara>Ajoutez les lignes suivantes:</simpara>
<programlisting language="ini" linenumbering="unnumbered">[pure-ftpd]
enabled = true
port = ftp
filter = pure-ftpd
logpath = /var/log/syslog
maxretry = 3


[dovecot]
enabled = true
filter = dovecot
logpath = /var/log/mail.log
maxretry = 5

[postfix-sasl]
enabled = true
port = smtp
filter = postfix[mode=auth]
logpath = /var/log/mail.log
maxretry = 3</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez Fail2ban: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart fail2ban</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_et_configuration_manuelle_de_pureftpd">
<title>Installation et configuration manuelle de PureFTPd</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install pure-ftpd-common pure-ftpd-mysql</programlisting>
</listitem>
<listitem>
<simpara>Éditez le fichier de conf: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/default/pure-ftpd-common</programlisting>
</listitem>
<listitem>
<simpara>Changez les lignes ainsi:</simpara>
<programlisting language="ini" linenumbering="unnumbered">STANDALONE_OR_INETD=standalone
VIRTUALCHROOT=true</programlisting>
</listitem>
<listitem>
<simpara>Autorisez les connexions TLS. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo 1 &gt; /etc/pure-ftpd/conf/TLS</programlisting>
</listitem>
<listitem>
<simpara>Créez un certificat SSL.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /etc/ssl/private/</programlisting>
</listitem>
<listitem>
<simpara>Puis créez le certificat auto signé. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">openssl req -x509 -nodes -days 7300 -newkey rsa:2048 -keyout /etc/ssl/private/pure-ftpd.pem -out /etc/ssl/private/pure-ftpd.pem</programlisting>
<simpara>et répondez aux questions de la manière suivante:</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara><literal>Country Name (2 letter code) [AU]:</literal> &#8592; Entrez le code pays à 2 lettres</simpara>
</listitem>
<listitem>
<simpara><literal>State or Province Name (full name) [Some-State]:</literal> &#8592; Entrer le nom d&#8217;état</simpara>
</listitem>
<listitem>
<simpara><literal>Locality Name (eg, city) []:</literal> &#8592; Entrer votre ville</simpara>
</listitem>
<listitem>
<simpara><literal>Organization Name (eg, company) [Internet Widgits Pty Ltd]:</literal> &#8592; Entrez votre entreprise ou tapez entrée</simpara>
</listitem>
<listitem>
<simpara><literal>Organizational Unit Name (eg, section) []:</literal> &#8592; Tapez entrée</simpara>
</listitem>
<listitem>
<simpara><literal>Common Name (e.g. server FQDN or YOUR name) []:</literal> &#8592; Enter le nom d&#8217;hôte de votre serveur. Dans notre cas: <literal>server1.example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Email Address []:</literal> &#8592; Tapez entrée</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Puis tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 600 /etc/ssl/private/pure-ftpd.pem</programlisting>
</listitem>
<listitem>
<simpara>et redémarrez pure-ftpd en tapant: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart pure-ftpd-mysql</programlisting>
</listitem>
<listitem>
<simpara>En Option: Activer les quotas si votre kernel le permet.</simpara>
<itemizedlist>
<listitem>
<simpara>Installez les paquets de gestion des quotas. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install quota quotatool</programlisting>
</listitem>
<listitem>
<simpara>Editez <literal>fstab</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/fstab</programlisting>
</listitem>
<listitem>
<simpara>Inserez le texte ci dessous pour chaque directive de montage autre que <literal>/proc</literal> ou <literal>/swapfile</literal> :</simpara>
<screen linenumbering="unnumbered">usrjquota=quota.user,grpjquota=quota.group,jqfmt=vfsv0</screen>
</listitem>
<listitem>
<simpara>Par exemple pour une ligne de la table contenant:</simpara>
<screen linenumbering="unnumbered">UUID=45576b38-39e8-4994-b8c1-ea4870e2e614 / ext4 errors=remount-ro  0 1</screen>
</listitem>
<listitem>
<simpara>Vous obtiendrez:</simpara>
<screen linenumbering="unnumbered">UUID=45576b38-39e8-4994-b8c1-ea4870e2e614 / ext4 errors=remount-ro,usrjquota=quota.user,grpjquota=quota.group,jqfmt=vfsv0 0 1</screen>
</listitem>
<listitem>
<simpara>Pour une Raspbian:</simpara>
<itemizedlist>
<listitem>
<simpara>Editez le fichier rc.local pour créer /dev/root à chaque reboot:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ln -s /dev/mmblk0p7 /dev/root
vi /etc/rc.local</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez avant <literal>exit 0</literal>:</simpara>
<screen linenumbering="unnumbered">ln -s /dev/mmcblk0p7 /dev/root</screen>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Pour activer les quotas, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mount -o remount /
quotacheck -avugm
quotaon -avug</programlisting>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_et_configuration_manuelle_de_phpmyadmin">
<title>Installation et configuration manuelle de Phpmyadmin</title>
<section xml:id="_installation_de_phpmyadmin">
<title>Installation de Phpmyadmin</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://www.phpmyadmin.net/downloads/">phpMyAdmin</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil.</simpara>
</listitem>
<listitem>
<simpara>Installez phpmyadmin. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir /usr/share/phpmyadmin
mkdir /etc/phpmyadmin
mkdir -p /var/lib/phpmyadmin/tmp
chown -R www-data:www-data /var/lib/phpmyadmin
touch /etc/phpmyadmin/htpasswd.setup
cd /tmp
version=`wget -O - https://www.phpmyadmin.net/home_page/version.txt 2&gt; /dev/null | head -n 1`
echo https://files.phpmyadmin.net/phpMyAdmin/#/phpMyAdmin-#-all-languages.tar.gz | sed 's/#/'$version'/g' | xargs wget -O phpmyadmin.tar.gz
tar xfz phpmyadmin.tar.gz
mv phpMyAdmin-$version-all-languages/* /usr/share/phpmyadmin/
rm phpMyAdmin-$version-all-languages.tar.gz
rm -rf phpMyAdmin-$version-all-languages
cp /usr/share/phpmyadmin/config.sample.inc.php  /usr/share/phpmyadmin/config.inc.php</programlisting>
</listitem>
<listitem>
<simpara>Créez votre chaîne aléatoire en base64. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">tr -dc A-Za-z0-9 &lt; /dev/urandom | head -c${1:-32};echo;</programlisting>
</listitem>
<listitem>
<simpara>Copiez le texte généré</simpara>
</listitem>
<listitem>
<simpara>Éditez le fichier :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/share/phpmyadmin/config.inc.php</programlisting>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Modifier l’entrée <literal>blowfish_secret</literal> en ajoutant votre propre chaîne de 32 caractères générée juste avant.</simpara>
</listitem>
<listitem>
<simpara>Éditez le fichier: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/apache2/conf-available/phpmyadmin.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez les lignes suivantes:</simpara>
<programlisting language="apache" linenumbering="unnumbered"># phpMyAdmin default Apache configuration

Alias /phpmyadmin /usr/share/phpmyadmin

&lt;Directory /usr/share/phpmyadmin&gt;
        Options SymLinksIfOwnerMatch
        DirectoryIndex index.php

        # limit libapache2-mod-php to files and directories necessary by pma
        &lt;IfModule mod_php7.c&gt;
                php_admin_value upload_tmp_dir /var/lib/phpmyadmin/tmp
                php_admin_value open_basedir /usr/share/phpmyadmin/:/etc/phpmyadmin/:/var/lib/phpmyadmin/:/usr/share/php/:/usr/share/javascript/
        &lt;/IfModule&gt;

        # PHP 8+
        &lt;IfModule mod_php.c&gt;
                php_admin_value upload_tmp_dir /var/lib/phpmyadmin/tmp
                php_admin_value open_basedir /usr/share/phpmyadmin/:/etc/phpmyadmin/:/var/lib/phpmyadmin/:/usr/share/php/:/usr/share/javascript/
        &lt;/IfModule&gt;

&lt;/Directory&gt;

# Authorize for setup
&lt;Directory /usr/share/phpmyadmin/setup&gt;
        &lt;IfModule mod_authz_core.c&gt;
                &lt;IfModule mod_authn_file.c&gt;
                        AuthType Basic
                        AuthName "phpMyAdmin Setup"
                        AuthUserFile /etc/phpmyadmin/htpasswd.setup
                &lt;/IfModule&gt;
                Require valid-user
        &lt;/IfModule&gt;
&lt;/Directory&gt;

# Disallow web access to directories that don't need it
&lt;Directory /usr/share/phpmyadmin/templates&gt;
        Require all denied
&lt;/Directory&gt;
&lt;Directory /usr/share/phpmyadmin/libraries&gt;
        Require all denied
&lt;/Directory&gt;
&lt;Directory /usr/share/phpmyadmin/setup/lib&gt;
        Require all denied
&lt;/Directory&gt;</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Activez le module et redémarrez apache. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2enconf phpmyadmin
systemctl restart apache2</programlisting>
</listitem>
<listitem>
<simpara>Créer la base de donnée phpmyadmin.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql -u root -p</programlisting>
<simpara>puis entrer le mot de passe root</simpara>
</listitem>
<listitem>
<simpara>Créez une base phpmyadmin. Tapez :</simpara>
<programlisting language="sql" linenumbering="unnumbered">CREATE DATABASE phpmyadmin;</programlisting>
</listitem>
<listitem>
<simpara>Créez un utilisateur phpmyadmin. Tapez :</simpara>
<programlisting language="sql" linenumbering="unnumbered">CREATE USER 'pma'@'localhost' IDENTIFIED BY 'mypassword'; <co xml:id="CO20-2"/></programlisting>
<calloutlist>
<callout arearefs="CO20-1 CO20-2">
<para><literal>mypassword</literal> doit être remplacé par <link linkend="pass_gen">un mot de passe choisi.</link></para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Accordez des privilèges et sauvez:</simpara>
<programlisting language="sql" linenumbering="unnumbered">GRANT ALL PRIVILEGES ON phpmyadmin.* TO 'pma'@'localhost' IDENTIFIED BY 'mypassword' WITH GRANT OPTION; <co xml:id="CO21-1"/></programlisting>
<calloutlist>
<callout arearefs="CO21-1">
<para><literal>mypassword</literal> doit être remplacé par le mot de passe choisi plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Flusher les privilèges:</simpara>
<programlisting language="sql" linenumbering="unnumbered">FLUSH PRIVILEGES;</programlisting>
</listitem>
<listitem>
<simpara>et enfin</simpara>
<programlisting language="sql" linenumbering="unnumbered">EXIT;</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Chargez les tables sql dans la base phpmyadmin:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql -u root -p phpmyadmin &lt; /usr/share/phpmyadmin/sql/create_tables.sql</programlisting>
</listitem>
<listitem>
<simpara>Enfin ajoutez les mots de passe nécessaires dans le fichier de config.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/share/phpmyadmin/config.inc.php</programlisting>
</listitem>
<listitem>
<simpara>Rechercher le texte contenant <literal>controlpass</literal> .  Ci-dessous, un exemple:</simpara>
<programlisting language="php" linenumbering="unnumbered">/* User used to manipulate with storage */
$cfg['Servers'][$i]['controlhost'] = 'localhost';
$cfg['Servers'][$i]['controlport'] = '';
$cfg['Servers'][$i]['controluser'] = 'pma';
$cfg['Servers'][$i]['controlpass'] = 'mypassword'; <co xml:id="CO22-1"/></programlisting>
<calloutlist>
<callout arearefs="CO22-1">
<para>A tous les endroit ou vous voyez dans le texte ci dessus le mot <literal>mypassword</literal> mettez celui choisi. N&#8217;oubliez pas de dé-commenter les lignes.</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_phpmyadmin">
<title>Upgrade de Phpmyadmin</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://www.phpmyadmin.net/downloads/">phpMyAdmin</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil.</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour phpmyadmin. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mv /usr/share/phpmyadmin /usr/share/phpmyadmin.old
mkdir /usr/share/phpmyadmin
cd /tmp
version=`wget -O - https://www.phpmyadmin.net/home_page/version.txt 2&gt; /dev/null | head -n 1`
echo https://files.phpmyadmin.net/phpMyAdmin/#/phpMyAdmin-#-all-languages.tar.gz | sed 's/#/'$version'/g' | xargs wget -O phpmyadmin.tar.gz
tar xfz phpmyadmin.tar.gz
mv phpMyAdmin-$version-all-languages/* /usr/share/phpmyadmin/
rm phpMyAdmin-$version-all-languages.tar.gz
rm -rf phpMyAdmin-$version-all-languages
cp /usr/share/phpmyadmin.old/config.inc.php  /usr/share/phpmyadmin/config.inc.php</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez apache. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart apache2</programlisting>
</listitem>
<listitem>
<simpara>Vérifiez que tout fonctionne correctement sur le site phpmyadmin</simpara>
</listitem>
<listitem>
<simpara>Supprimez l&#8217;ancien répertoire</simpara>
<programlisting language="bash" linenumbering="unnumbered">rm -rf /usr/share/phpmyadmin.old</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_manuelle_du_webmail_roundcube">
<title>Installation manuelle du webmail Roundcube</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install roundcube roundcube-core roundcube-mysql roundcube-plugins</programlisting>
</listitem>
<listitem>
<simpara>Répondez aux question</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Utiliser dbconfig_common</literal> &#8592; Répondre <literal>Oui</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe Mysql pour db Roundcube</literal> &#8592; Tapez un mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Éditez le fichier php de roundcube :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/roundcube/config.inc.php</programlisting>
</listitem>
<listitem>
<simpara>Et chercher les éléments de $config si dessous, et s&#8217;ils sont trouvés, remplacez les par les valeurs indiquées :</simpara>
<programlisting language="php" linenumbering="unnumbered">$config['default_host'] = 'localhost';
$config['smtp_server'] = 'localhost';
$config['imap_host'] = ["localhost:143"];
$config['smtp_host'] = 'localhost:25';</programlisting>
</listitem>
<listitem>
<simpara>Éditez la configuration apache pour roundcube: :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/apache2/conf-enabled/roundcube.conf</programlisting>
<simpara>et ajouter au début les lignes suivantes:</simpara>
<programlisting language="apache" linenumbering="unnumbered">Alias /roundcube /var/lib/roundcube/public_html
Alias /webmail /var/lib/roundcube/public_html</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez Apache:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl reload apache2</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_manuelle_de_lets_encrypt">
<title>Installation manuelle de Let&#8217;s Encrypt</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez Let&#8217;s Encrypt. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp ; wget -O -  https://get.acme.sh 2&gt;/dev/null | sh 2&gt;/dev/null</programlisting>
</listitem>
<listitem>
<simpara>Une façon alternative de l&#8217;installer est:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install certbot</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="After_manual_install">
<title>Suite de l&#8217;installation</title>
<simpara>Les chapitres suivants doivent être suivis que ISPConfig soit installé ou pas.</simpara>
<section xml:id="firewall">
<title>Déblocage de port de firewall</title>
<simpara>Par défaut, une fois le firewall activé, TOUS les ports sont bloqués en entrée de votre équipement. Cela veut dire qu&#8217;il ne sera pas possible de connecter une machine externe sur votre équipement sans avoir effectué une opération de déblocage du port du firewall.</simpara>
<simpara>Il existe deux manière de débloquer un port. Elle dépend de ce que vous avez configuré.</simpara>
<section xml:id="_déblocage_et_suppression_de_règles_de_firewall_avec_ispconfig">
<title>Déblocage et suppression de règles de Firewall avec ISPconfig</title>
<simpara>Appliquez les opérations suivantes pour Débloquez le firewall:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez sur le site ispconfig <link xl:href="https://example.com:8080/">https://example.com:8080/</link></simpara>
</listitem>
<listitem>
<simpara>Loguez-vous et cliquez sur la rubrique <literal>System</literal> et le menu <literal>Firewall</literal>. Cliquez sur votre serveur.</simpara>
</listitem>
<listitem>
<simpara>dans la rubrique <literal>Open TCP ports:</literal>, ajoutez le numero de port xxxx que vous souhaitez débloquer</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
<simpara>Appliquez les opérations suivantes bloquer (en lever une règle de déblocage) de firewall:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez sur le site ispconfig <link xl:href="https://example.com:8080/">https://example.com:8080/</link></simpara>
</listitem>
<listitem>
<simpara>Loguez-vous et cliquez sur la rubrique <literal>System</literal> et le menu <literal>Firewall</literal>. Cliquez sur votre serveur.</simpara>
</listitem>
<listitem>
<simpara>dans la rubrique <literal>Open TCP ports:</literal>, Supprimer le port xxxx</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
<simpara>Remarque: si vous utilisez VNC, il faut débloquer le port dans le firewall de ISPConfig. Appliquez la méthode de déblocage pour le port 5900.</simpara>
<simpara>Remarque: si vous avez besoin de débloquer un port UDP vous devez allez dans la rubrique Open UDP Ports.</simpara>
</section>
<section xml:id="_déblocage_de_firewall_ufw">
<title>Déblocage de Firewall UFW</title>
<important>
<simpara>Si vous avez installé ISPconfig vous ne devez pas utiliser cette méthode !</simpara>
</important>
<simpara>Tout d&#8217;abord, à la première utilisation, il vous faut appliquer la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Installez <literal>ufw</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install ufw</programlisting>
</listitem>
<listitem>
<simpara>Autorisez SSH si vous ne voulez pas perdre votre connexion SSH à l&#8217;activation du  firewall. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ufw allow 22/tcp
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 5900/tcp <co xml:id="CO23-1"/></programlisting>
<calloutlist>
<callout arearefs="CO23-1">
<para>Cette ligne autorise VNC et est utile si vous utilisez ce protocole sur votre Système. Il est fortement déconseillé pour un serveur visible sur internet d&#8217;autoriser ce protocole.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Activez le firewall. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ufw enable</programlisting>
</listitem>
<listitem>
<simpara>C&#8217;est prêt !</simpara>
</listitem>
</orderedlist>
<simpara>Appliquez les opérations suivantes pour Débloquez le firewall:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ufw allow xxxx/tcp <co xml:id="CO24-1"/></programlisting>
<calloutlist>
<callout arearefs="CO24-1">
<para>remplacez xxxx par le numero de port que vous souhaitez débloquer</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
<simpara>Appliquez les opérations suivantes bloquer (en lever une règle de déblocage) de firewall:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ufw delete allow xxxx/tcp <co xml:id="CO25-1"/></programlisting>
<calloutlist>
<callout arearefs="CO25-1">
<para>remplacez xxxx par le numero de port que vous souhaitez débloquer</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_scan_des_vulnérabilités">
<title>Scan des vulnérabilités</title>
<section xml:id="_installation_dun_scanner_de_vulnérabilités_lynis">
<title>Installation d&#8217;un scanner de vulnérabilités Lynis</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>installer Git. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install git</programlisting>
</listitem>
<listitem>
<simpara>installer Lynis</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd
git clone https://github.com/CISOfy/lynis</programlisting>
</listitem>
<listitem>
<simpara>Executez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd lynis;./lynis audit system</programlisting>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>L&#8217;outil vous listera dans une forme très synthétique la liste des vulnérabilités et des améliorations de sécurité à appliquer.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_lynis">
<title>Upgrade de Lynis</title>
<simpara>Pour effectuer la mise à jour de Lynis appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd
cd lynis
git pull</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_du_système_dadministration_webmin">
<title>Installation du système d&#8217;administration Webmin</title>
<simpara>Webmin est un outil généraliste de configuration de votre serveur. Son usage peut être assez complexe mais il permet une configuration plus précise des fonctionnalités.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Lancez le script de configuration de webmin:</simpara>
<programlisting language="bash" linenumbering="unnumbered">curl -o setup-repos.sh https://raw.githubusercontent.com/webmin/webmin/master/setup-repos.sh
sh setup-repos.sh
rm setup-repos.sh</programlisting>
</listitem>
<listitem>
<simpara>Mise à jour. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update</programlisting>
</listitem>
<listitem>
<simpara>Installation de Webmin. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install webmin</programlisting>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 10000 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Changer le nom du user admin</simpara>
</listitem>
<listitem>
<simpara>Editez le fichier <literal>miniserv.users</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/webmin/miniserv.users</programlisting>
</listitem>
<listitem>
<simpara>Dans le fichier remplacer le texte <literal>root</literal> par le nom de votre &lt;sudo_username&gt;.</simpara>
</listitem>
<listitem>
<simpara>De la même manière, éditer le fichier <literal>webmin.acl</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/webmin/webmin.acl</programlisting>
</listitem>
<listitem>
<simpara>Dans le fichier remplacer le texte <literal>root</literal> par le nom de votre &lt;sudo_username&gt;.</simpara>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">service webmin restart</programlisting>
</listitem>
<listitem>
<simpara>Connectez vous avec votre navigateur sur l&#8217;url <link xl:href="https://&lt;example.com&gt;:10000">https://&lt;example.com&gt;:10000</link>. Un message indique un problème de sécurité. Cela vient du certificat auto-signé. Cliquez sur 'Avancé' puis 'Accepter le risque et poursuivre'.</simpara>
</listitem>
<listitem>
<simpara>Loguez-vous &lt;sudo_username&gt;. Tapez le mot de passe de <literal>&lt;sudo_username&gt;</literal>. Le dashboard s&#8217;affiche.</simpara>
</listitem>
<listitem>
<simpara>Restreignez l&#8217;adressage IP</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Obtenez votre adresse IP en allant par exemples sur le site <link xl:href="https://www.showmyip.com/">https://www.showmyip.com/</link></simpara>
</listitem>
<listitem>
<simpara>Sur votre URL Webmin ou vous êtes logué, allez dans Webmin&#8594;Webmin Configuration</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;écran choisir l’icône <literal>Ip Access Control</literal>.</simpara>
</listitem>
<listitem>
<simpara>Choisissez <literal>Only allow from listed addresses</literal></simpara>
</listitem>
<listitem>
<simpara>Puis dans le champ <literal>Allowed IP addresses</literal> tapez votre adresse IP récupérée sur showmyip</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>Vous devriez avoir une brève déconnexion le temps que le serveur Webmin redémarre puis une reconnexion.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Si vous n&#8217;arrivez pas à vous reconnecter c&#8217;est que l&#8217;adresse IP n&#8217;est pas la bonne. Le seul moyen de se reconnecter est de:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Éditez le fichier /etc/webmin/miniserv.conf et supprimez la ligne <literal>allow= &#8230;&#8203;</literal></simpara>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">service webmin restart</programlisting>
</listitem>
<listitem>
<simpara>Connectez vous sur l&#8217;url de votre site Webmin. Tout doit fonctionner</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Compléments de configuration</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Pour augmenter la sécurité, vous pouvez désactiver le login <literal>sudo_username</literal> et créer un autre compte admin en allant dans: <literal>Webmin</literal> &#8594; <literal>Webmin Users</literal> &#8594; <literal>Create a new privileged user</literal>. Pour le user <literal>sudo_username</literal>, modifier le <literal>Password</literal> en mettant <literal>No password accepted</literal></simpara>
</listitem>
<listitem>
<simpara>Allez dans <literal>Webmin</literal> &#8594; <literal>Webmin Configuration</literal> &#8594; <literal>SSL Encryption</literal> &#8594; onglet <literal>Let&#8217;s Encrypt</literal> &#8594; <literal>Request Certificate</literal>. Attention cette opération ne fonctionne que si le serveur est disponible sur internet.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Passez en Français. Pour les personnes non anglophone. Les traductions française ont des problèmes d&#8217;encodage de caractère ce n&#8217;est donc pas recommandé. La suite de mon tutoriel suppose que vous êtes resté en anglais.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Sur votre url Webmin ou vous êtes logué, allez dans Webmin&#8594;Webmin Configuration</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;écran choisir l’icône <literal>Language and Locale</literal>.</simpara>
</listitem>
<listitem>
<simpara>Choisir <literal>Display Language</literal> à <literal>French (FR.UTF-8)</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="domain-config">
<title>Configuration d&#8217;un domaine</title>
<simpara>Cette configuration est réalisée avec le Panel ISPConfig installé dans le chapitre précédent.
L&#8217;étape "login initial" n&#8217;est à appliquer qu&#8217;une seule fois. Une fois votre premier domaine configuré, vous pourrez vous loguer à ISPconfig en utilisant ce domaine à l&#8217;adresse: <link xl:href="https://example.com:8080/">https://example.com:8080/</link> .</simpara>
<section xml:id="_login_initial">
<title>Login initial</title>
<note>
<simpara>Cette procédure n&#8217;est à appliquer que lorsqu&#8217;aucun domaine n&#8217;est encore créé.</simpara>
</note>
<simpara>Vous devrez tout d&#8217;abord vous loguer sur le serveur ISPConfig.
Comme vous n&#8217;avez pas encore configuré de nom de de domaine, vous devrez vous loguer de prime abord sur le site <link xl:href="http://vmixxxxx.contaboserver.net:8080/">http://vmixxxxx.contaboserver.net:8080/</link> pour un vps chez contabo par exemple ou sur <link xl:href="http://raspberrypi.local:8080/">http://raspberrypi.local:8080/</link> pour un Raspberry.</simpara>
<simpara>Utiliser le login: Admin et le mot de passe que vous avez configuré lors de l&#8217;installation d&#8217;ISPConfig</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Aller dans la rubrique <literal>System</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Dans le menu <literal>Main config</literal></simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Dans l’onglet <literal>Sites</literal>, configurer:</simpara>
<orderedlist numeration="upperalpha">
<listitem>
<simpara><literal>Create subdomains as web site:</literal> &#8592; Yes</simpara>
</listitem>
<listitem>
<simpara><literal>Create aliasdomains as web site:</literal> &#8592; Yes</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet <literal>Mail</literal> :</simpara>
<orderedlist numeration="upperalpha">
<listitem>
<simpara><literal>Administrator&#8217;s e-mail :</literal> &#8592; adresse mail de l’administrateur. par exemple <link xl:href="mailto:admin@example.com">admin@example.com</link></simpara>
</listitem>
<listitem>
<simpara><literal>Administrator&#8217;s name :</literal> &#8592; nom de l’administrateur</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Dans le menu <literal>Firewall</literal></simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add Firewall Record</literal></simpara>
</listitem>
<listitem>
<simpara>Acceptez les valeurs par défaut en cliquant sur <literal>Save</literal></simpara>
<note>
<simpara>Il est possible de basculer le site ISPConfig entièrement en Français. J&#8217;ai pour ma part gardé la version anglaise du site.
Vous trouverez donc tous les libellés dans la suite de la documentation en anglais.</simpara>
</note>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>DNS</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Dans le menu <literal>Templates</literal></simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new record</literal></simpara>
</listitem>
<listitem>
<simpara>Remplissez les champs comme ci-après:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Name</literal> &#8592; Tapez <literal>Template IPV4 autoNS</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Fields</literal> &#8592; Cochez <literal>Domain</literal>, <literal>IP Address</literal>, <literal>Email</literal>, <literal>DKIM</literal>, <literal>DNSSEC</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Template</literal> &#8592; remplissez comme ci dessous:</simpara>
<programlisting language="bash" linenumbering="unnumbered">[ZONE]
origin={DOMAIN}.
ns=ns1.{DOMAIN}.
mbox={EMAIL}.
refresh=7200
retry=540
expire=604800
minimum=3600
ttl=3600
xfer=
also_notify=
dnssec_wanted=N
dnssec_algo=ECDSAP256SHA256

[DNS_RECORDS]
A|{DOMAIN}.|{IP}|0|3600
A|www|{IP}|0|3600
A|mail|{IP}|0|3600
A|autoconfig|{IP}|0|3600
A|autodiscover|{IP}|0|3600
A|webmail|{IP}|0|3600
A|ns1|{IP}|0|3600
CNAME|ftp|{DOMAIN}|0|3600
CNAME|smtp|{DOMAIN}|0|3600
CNAME|pop3|{DOMAIN}|0|3600
CNAME|imap|{DOMAIN}|0|3600
SRV|_pop3._tcp|0 0 .|0|3600
SRV|_imap._tcp|0 0 .|0|3600
SRV|_pop3s._tcp|1 995 mail.{DOMAIN}|0|3600
SRV|_imaps._tcp|1 993 mail.{DOMAIN}|0|3600
SRV|_submission._tcp|1 465 mail.{DOMAIN}|0|3600
SRV|_autodiscover._tcp|1 443 autodiscover.{DOMAIN}|0|3600
NS|{DOMAIN}.|ns1.{DOMAIN}.|0|3600
MX|{DOMAIN}.|mail.{DOMAIN}.|10|3600
TXT|{DOMAIN}.|v=spf1 mx a ~all|0|3600</programlisting>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new record</literal></simpara>
</listitem>
<listitem>
<simpara>Remplissez les champs comme ci-après:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Name</literal> &#8592; Tapez <literal>Template IPV6 autoNS</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Fields</literal> &#8592; Cochez <literal>Domain</literal>, <literal>IP Address</literal>, <literal>IPV6 Address</literal>, <literal>Email</literal>, <literal>DKIM</literal>, <literal>DNSSEC</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Template</literal> &#8592; remplissez comme ci dessous:</simpara>
<programlisting language="bash" linenumbering="unnumbered">[ZONE]
origin={DOMAIN}.
ns=ns1.{DOMAIN}.
mbox={EMAIL}.
refresh=7200
retry=540
expire=604800
minimum=3600
ttl=3600
xfer=
also_notify=
dnssec_wanted=N
dnssec_algo=ECDSAP256SHA256

[DNS_RECORDS]
A|{DOMAIN}.|{IP}|0|3600
A|www|{IP}|0|3600
A|mail|{IP}|0|3600
A|autoconfig|{IP}|0|3600
A|autodiscover|{IP}|0|3600
A|webmail|{IP}|0|3600
A|ns1|{IP}|0|3600
AAAA|{DOMAIN}.|{IPV6}|0|3600
AAAA|www|{IPV6}|0|3600
AAAA|mail|{IPV6}|0|3600
AAAA|autoconfig|{IPV6}|0|3600
AAAA|autodiscover|{IPV6}|0|3600
AAAA|webmail|{IPV6}|0|3600
AAAA|ns1|{IPV6}|0|3600
CNAME|ftp|{DOMAIN}|0|3600
CNAME|smtp|{DOMAIN}|0|3600
CNAME|pop3|{DOMAIN}|0|3600
CNAME|imap|{DOMAIN}|0|3600
SRV|_pop3._tcp|0 0 .|0|3600
SRV|_imap._tcp|0 0 .|0|3600
SRV|_pop3s._tcp|1 995 mail.{DOMAIN}|0|3600
SRV|_imaps._tcp|1 993 mail.{DOMAIN}|0|3600
SRV|_submission._tcp|1 465 mail.{DOMAIN}|0|3600
SRV|_autodiscover._tcp|1 443 autodiscover.{DOMAIN}|0|3600
NS|{DOMAIN}.|ns1.{DOMAIN}.|0|3600
MX|{DOMAIN}.|mail.{DOMAIN}.|10|3600
TXT|{DOMAIN}.|v=spf1 mx a ~all|0|3600</programlisting>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_la_zone_dns_dun_domaine">
<title>Création de la zone DNS d&#8217;un domaine</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans <literal>DNS</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>Add dns-zone</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Dns zone wizard</literal></simpara>
</listitem>
<listitem>
<simpara>Choisir le template <literal>IPV4 autoNS</literal> ou`IPV6 autoNS` selon que vous soyez IPV4 ou IPV4+V6</simpara>
</listitem>
<listitem>
<simpara>Remplissez les champs:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Domain :</literal> &#8592; tapez le nom de votre domaine <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP Address:</literal> &#8592; prendre l’adresse IPV4 du serveur sélectionnée</simpara>
</listitem>
<listitem>
<simpara><literal>IPV6 Address:</literal> &#8592; prendre l’adresse IPV6 du serveur sélectionnée</simpara>
</listitem>
<listitem>
<simpara><literal>Email:</literal> &#8592; votre Email valide exemple <literal>admin@example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>DKIM:</literal> &#8592; Yes</simpara>
<note>
<simpara>Si votre serveur est chez vous, il est probablement installé derrière un routeur ADSL configuré au préalable avec une DMZ qui pointe sur ce serveur. Dans ce cas, vous ne devrez pas indiquer l&#8217;adresse IP locale de votre serveur mais l&#8217;adresse IP de votre routeur ADSL telle qu&#8217;elle est vue sur internet. On suppose aussi que cette adresse IP est statique et non pas allouée dynamiquement par l&#8217;opérateur.</simpara>
</note>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Create DNS-record</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<simpara>Attendez quelques minutes le temps que les enregistrements DNS se propagent et faites une essai de votre nom de domaine sur le site <link xl:href="https://zonemaster.fr/domain_check">ZoneMaster</link>.</simpara>
<simpara>Dans le champ Nom de domaine saisissez votre nom de domaine et tapez sur check. Tout doit est OK sauf pour les serveurs de noms ns1 et ns2. Si ce n&#8217;est pas le cas, votre nom de domaine doit être mal configuré chez votre registrar. Il vous faut vérifier la configuration initiale.</simpara>
<note>
<simpara>Zonemaster a bien repéré que l&#8217;on a essayé de mettre des noms de host différents pour les serveurs de DNS. Ils ont cependant tous la même adresse IP. Cela apparait comme une erreur suite au test.
De la même manière, il indique dans la rubrique connectivité qu&#8217;il n&#8217;y a pas de redondance de serveur DNS.
Une manière de corriger ce problème est de définir un DNS secondaire chez OVH en utilisant le service qu&#8217;ils mettent à disposition.</simpara>
</note>
<simpara>Vous pouvez maintenant essayer les différents Hostname munis de leur nom de domaine dans votre navigateur. Par exemple: <link xl:href="http://webmail.example.com">http://webmail.example.com</link></simpara>
<simpara>Ils doivent afficher une page web basique (Apache2, ou de parking).Si ce n&#8217;est pas le cas revérifier la configuration du DNS dans ISPConfig.</simpara>
</section>
<section xml:id="_activation_de_dnssec">
<title>Activation de DNSSEC</title>
<simpara>Vous pouvez maintenant activer DNSSEC afin d&#8217;augmenter la sécurité de résolution de nom de domaine:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>puis dans le menu <literal>Zones</literal></simpara>
</listitem>
<listitem>
<simpara>choisissez la zone correspondant à votre domaine</simpara>
</listitem>
<listitem>
<simpara>dans l&#8217;onglet <literal>Zones settings</literal> allez tout en bas et activer la coche <literal>Sign Zone (DNSSEC)</literal></simpara>
</listitem>
<listitem>
<simpara>cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>Une fois fait, retourner dans le même onglet. La boite `DNSSEC DS-Data for registry: `contient les informations que vous devez coller dans le site web de votre registrar pour sécuriser votre zone.</simpara>
</listitem>
<listitem>
<simpara>Gardez cette fenêtre ouverte dans votre navigateur et ouvrez un autre onglet sur le site de votre registrar.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<simpara>Si vous êtes chez <link xl:href="https://admin.gandi.net/">Gandi</link>, il vous faut:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Sélectionner le menu <literal>nom de domaine</literal></simpara>
</listitem>
<listitem>
<simpara>Choisir votre nom de domaine "example.com"</simpara>
</listitem>
<listitem>
<simpara>Allez dans l&#8217;onglet DNSSEC. Il doit permettre d&#8217;ajouter des clés puisque vous fonctionner avec des DNS externes.</simpara>
</listitem>
<listitem>
<simpara>Effacez éventuellement toutes les clés si vous n&#8217;êtes pas sur de celles-ci.</simpara>
</listitem>
<listitem>
<simpara>puis cliquez sur <literal>Ajouter une clé externe</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Sélectionnez d&#8217;abord le flag <literal>257 (KSK)</literal>. puis l&#8217;algorithme <literal>13 (ECDSAP256SHA256)</literal></simpara>
</listitem>
<listitem>
<simpara>Collez ensuite la clé de votre site ISPConfig. Elle doit ressembler à cela:</simpara>
<screen>example.com. IN DNSKEY 257 3 13 CGI4g4NzPkOXeuRzA1ZdBT7N5/WJ2su5Q6teGDjVeYq2kwnxbFsYJhjq QVcqDqm7gzFqPl6QC/zK1eC0zrPE9g==</screen>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Ajouter</literal></simpara>
</listitem>
<listitem>
<simpara>Entrez la deuxième clé. Cliquez sur <literal>Ajouter une clé externe</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez d&#8217;abord le flag <literal>256 (ZSK)</literal>. puis l&#8217;algorithme <literal>13 (ECDSAP256SHA256)</literal></simpara>
</listitem>
<listitem>
<simpara>Collez ensuite la clé de votre site ISPConfig. Elle doit ressembler à cela:</simpara>
<screen>example.com. IN DNSKEY 256 3 13 YFzB4DJmq0I7K6J17ynU4A+dracTW7qkrMnK5ZIbEO/DtjgJyDPaZn9f uvJ/KriFY/sdf89XHb4u8q+MQCm/cg==</screen>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Ajouter</literal></simpara>
</listitem>
<listitem>
<simpara>Les deux clés doivent maintenant apparaître dans l&#8217;onglet <literal>DNSSEC</literal></simpara>
</listitem>
<listitem>
<simpara>Vous devez attendre quelques minutes (une heure dans certains cas) pour que les clés se propagent. Pendant ce temps vous pouvez avoir quelques problèmes d&#8217;accès à vos sites webs</simpara>
</listitem>
<listitem>
<simpara>Allez sur le site <link xl:href="https://dnssec-debugger.verisignlabs.com/">DNSSEC Analyzer</link>.</simpara>
</listitem>
<listitem>
<simpara>Entrez votre nom de domaine "example.com" et tapez sur "entrée".</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
<simpara>Le site doit afficher pour les différentes zones le statut des certificats. Tout doit être au vert.
Si ce n&#8217;est pas le cas, réessayer dans une heure. S&#8217;il y a encore des problèmes vérifiez votre configuration dans ISPConfig, chez votre registrar (rubrique DNSSEC) ou regardez les logs d&#8217;ISPConfig sur votre serveur pour y débusquer une erreur.</simpara>
<tip>
<simpara>Une erreur classique est de croiser les certificats avec leurs types. Vérifiez bien que vous avez mis les bons certificats avec les bons types.</simpara>
</tip>
<warning>
<simpara>Une fois que vous activez DNSSEC, vous pourriez faire face au problème suivant: les nouveaux enregistrements que vous renseignez ne sont pas actifs.
Une analyse des logs montre que la commande <literal>dnssec-signzone</literal> retourne l&#8217;erreur <literal>fatal: 'example.com': found DS RRset without NS RRset</literal>.
Cela signifie que vous avez saisi une ou deux entrées DS dans vos enregistrements. Il faut les supprimer pour que tout redevienne fonctionnel.</simpara>
</warning>
</section>
<section xml:id="_exemple_de_configuration_de_domaine">
<title>Exemple de configuration de domaine</title>
<simpara>Une fois la configuration terminé, les différents enregistrements du domaines ressemblent à l&#8217;exemple ci-dessous.
Il peut y avoir des enregistrements supplémentaires pour les configurations SPF, DKIM et Let&#8217;s encrypt.</simpara>
<screen>example.com.         3600 A              1.2.3.4
www                  3600 A              1.2.3.4
mail                 3600 A              1.2.3.4
ns1                  3600 A              1.2.3.4
ns2                  3600 A              1.2.3.4
webmail              3600 A              1.2.3.4
autoconfig           3600 A              1.2.3.4
autodiscover         3600 A              1.2.3.4
ftp                  3600 CNAME          example.com.
smtp                 3600 CNAME          mail.example.com.
pop3                 3600 CNAME          mail.example.com.
imap                 3600 CNAME          mail.example.com.
example.com.         3600 NS             ns1.example.com.
example.com.         3600 NS             ns2.example.com.
example.com.         3600 MX    10       mail.example.com.
_pop3s._tcp          3600 SRV   10 1 995 mail.example.com.
_imaps._tcp          3600 SRV   0  1 993 mail.example.com.
_submission._tcp     3600 SRV   0  1 465 mail.example.com.
_imap._tcp           3600 SRV   0  0 0   .
_pop3._tcp           3600 SRV   0  0 0   .
_autodiscover._tcp   3600 SRV   0 0 443  autoconfig.example.com.
example.com.         3600 TXT            "v=spf1 mx a ~all"</screen>
</section>
<section xml:id="_création_dun_sous_domaine">
<title>Création d&#8217;un sous domaine</title>
<simpara>Supposons que vous êtes en train de créer un sous domain nommé <literal>sub.example.com</literal> .
Dans ce sous domaines vous allez créer un ensemble de site web par exemple <literal>mail.sub.example.com</literal> ou <literal>blog.sub.example.com</literal> .</simpara>
<simpara>Un cas assez classique est que ce sous domaine est délégué à une machine tierce.</simpara>
<simpara>Par exemple: <literal>example.com</literal> est installé sur un VPS quelque part sur internet et <literal>sub.example.com</literal> est hébergé chez vous sur votre Raspberry.</simpara>
<simpara>On suppose que votre domain a été configuré en suivant la procédure du chapitre précédent.</simpara>
<simpara>Rien de bien sorcier pour votre sous domaine: Vous devez le créer sur votre Raspberry selon la même procédure mais avec le nom du sous domaine ( <literal>sub.example.com</literal> donc).</simpara>
<simpara>Vous aurez des actions complémentaires à effectuer sur votre domaine:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans <literal>DNS</literal> de votre serveur de domaine principal</simpara>
</listitem>
<listitem>
<simpara>Sélectionner le menu <literal>Zones</literal> puis le domaine <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara>Choisissez l&#8217;onglet <literal>Records</literal> et créez:</simpara>
<itemizedlist>
<listitem>
<simpara>un enregistrement de type <literal>NS</literal> avec une <literal>Zone</literal> &#8592; <literal>sub.example.com.</literal> et un <literal>nameserver Hostname</literal> &#8592; <literal>ns1.sub.example.com.</literal></simpara>
</listitem>
<listitem>
<simpara>un enregistrement de type <literal>NS</literal> avec une <literal>Zone</literal> &#8592; <literal>sub.example.com.</literal> et un <literal>nameserver Hostname</literal> &#8592; <literal>ns2.sub.example.com.</literal></simpara>
</listitem>
<listitem>
<simpara>un enregistrement de type <literal>A</literal> avec une <literal>IP_Address</literal> &#8592; <literal>IPV4_NS1</literal> et un <literal>Hostname</literal> &#8592; <literal>ns1.sub.example.com.</literal></simpara>
</listitem>
<listitem>
<simpara>un enregistrement de type <literal>A</literal> avec une <literal>IP_Address</literal> &#8592; <literal>IPV4_NS2</literal> et un <literal>Hostname</literal> &#8592; <literal>ns2.sub.example.com.</literal></simpara>
<simpara>Ces deux derniers types d&#8217;enregistrement se nomment un Glue record pour faire le lien vers le serveur secondaire.</simpara>
</listitem>
<listitem>
<simpara>Si vous connaissez pas l&#8217;adresse IPV4, tapez dans un terminal texte de votre serveur 'sub.example.com`:</simpara>
<programlisting language="bash" linenumbering="unnumbered">wget -qO- http://ipecho.net/plain; echo</programlisting>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Si vous avez activé DNSSEC sur votre serveur DNS de <literal>sub.example.com</literal> vous devrez récupérer les entrées DS du champ <literal>DNSSEC DS-Data for registry</literal> de votre domaine <literal>sub.example.com</literal> et créer dans votre domaine <literal>example.com</literal> les deux entrées suivantes:</simpara>
<itemizedlist>
<listitem>
<simpara>un enregistrement de type <literal>DS</literal> avec une <literal>Zone</literal> &#8592; <literal>sub.example.com.</literal> et un champ <literal>data</literal> contenant <literal>xxxxx 7 1 &lt;votre_digest_recupérée&gt;</literal></simpara>
</listitem>
<listitem>
<simpara>un enregistrement de type <literal>DS</literal> avec une <literal>Zone</literal> &#8592; <literal>sub.example.com.</literal> et un champ <literal>data</literal> contenant <literal>xxxxx 7 2 &lt;votre_digest_recupérée&gt;</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Allez sur le site <link xl:href="https://dnssec-debugger.verisignlabs.com/">DNSSEC Analyzer</link>.</simpara>
</listitem>
<listitem>
<simpara>Entrez votre nom de domaine <literal>sub.example.com</literal> et tapez sur "entrée".</simpara>
</listitem>
</orderedlist>
<simpara>Le site doit afficher pour les différentes zones le statut des certificats. Tout doit être au vert.
Si ce n&#8217;est pas le cas, réessayer dans une heure. S&#8217;il y a encore des problèmes vérifiez votre configuration dans ISPConfig de votre domaine et de votre sous-domaine, chez votre registrar (rubrique DNSSEC) ou regardez les logs d&#8217;ISPConfig sur votre serveur pour y débusquer une erreur.</simpara>
</section>
<section xml:id="domain-site">
<title>Création d’un site web</title>
<simpara>Dans la suite le site web sera nommé <literal>example.com</literal>.</simpara>
<simpara>Vous devez avoir avant tout défini le "record" DNS associé au site.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Aller dans "Sites"</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu "Website" pour définir un site web</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur "Add new website"</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Client:</literal> &#8592; laisser vide ou mettre le client que vous avez créé.</simpara>
</listitem>
<listitem>
<simpara><literal>IPv4-Address:</literal> &#8592; mettre <literal>*</literal>. Si vous mettez votre adresse IPV4 vous allez rencontrer quelques disfonctionnements.</simpara>
</listitem>
<listitem>
<simpara><literal>Domain:</literal> &#8592; mettre <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Auto-subdomain:</literal> &#8592; sélectionner <literal>wwww</literal> ou <literal>*</literal> si l’on veut un certificat let’s encrypt wildcard</simpara>
</listitem>
<listitem>
<simpara><literal>SSL:</literal> &#8592; yes</simpara>
</listitem>
<listitem>
<simpara><literal>Let’s Encrypt:</literal> &#8592; yes</simpara>
</listitem>
<listitem>
<simpara><literal>Php:</literal> &#8592; Sélectionez <literal>php-fpm</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez éventuellement aussi les coches <literal>Perl</literal>, <literal>Python</literal>, <literal>Ruby</literal> en fonction des technologies déployées sur votre site. Cela est indiqué dans la procédure d&#8217;installation du site.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet <literal>redirect</literal> du même écran</simpara>
<itemizedlist>
<listitem>
<simpara><literal>SEO Redirect:</literal> &#8592; Sélectionner <literal>domain.tld &#8658;www.domain.tld</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Rewrite http to https:</literal> &#8592; yes</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet <literal>Statistics</literal> du même écran</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Set Webstatistics password:</literal> &#8592; saisissez un mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; ressaisissez le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet <literal>Backup</literal> du même écran</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Backup interval:</literal> &#8592; saisir <literal>weekly</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Number of backup copies:</literal> &#8592; saisir <literal>1</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet <literal>Options</literal>, il peut être utile pour certains types de site qui sont des redirections d&#8217;autres sites (locaux, d&#8217;autres machines ou de container docker) de saisir dans la zone <literal>Apache Directives:</literal></simpara>
<itemizedlist>
<listitem>
<simpara>Pour un site en HTTP (attention dans ce cas, ce site doit être local ou dans un container pour des raisons de sécurité) :</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# Original httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPassMatch ^/(.+)/websocket ws://localhost[:port_number_if_any]/$1/websocket keepalive=On # If websocket is in use

ProxyPass / http://localhost[:port_number_if_any]/[path_if_any]
ProxyPassReverse / http://localhost[:port_number_if_any]/[path_if_any]

RedirectMatch ^/$ https://www.example.com <co xml:id="CO26-1"/></programlisting>
<calloutlist>
<callout arearefs="CO26-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pour un site en HTTPS :</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# redirect from server
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
SSLProxyEngine On # Comment this out if no https required
ProxyPreserveHost    On
SSLProxyVerify none
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off

ProxyPass / https://localhost[:port_number_if_any]/[path_if_any]
ProxyPassReverse / https://localhost[:port_number_if_any]/[path_if_any]

RedirectMatch ^/$ https://www.example.com <co xml:id="CO27-1"/></programlisting>
<calloutlist>
<callout arearefs="CO27-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant tester la qualité de la  connexion de votre site en allant sur: <link xl:href="https://www.ssllabs.com/ssltest">SSL Server Test</link>. Saisissez votre nom de domaine et cliquez sur <literal>Submit</literal>. Votre site doit au moins être de <literal>Grade A</literal>.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="subdomain-site">
<title>Création d’un Site Vhost</title>
<simpara>Dans la suite le sous-domaine sera nommé "mail.example.com".</simpara>
<simpara>Vous devez avoir avant tout défini le "record" DNS associé au site.
Vous ne pouvez définir un sous-domaine que si vous avez défini le site web racine auparavant.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Aller dans "Sites"</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu "Subdomain(vhost)" pour définir un sous-domaine</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur "Add Subdomain" pour un nouveau sous domaine</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592;  saisir <literal>mail</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Domain:</literal> &#8592; mettre <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>web folder:</literal> &#8592; saisir <literal>mail</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Auto-subdomain:</literal> &#8592; sélectionner <literal>wwww</literal> ou <literal>*</literal> si l’on veut un certificat let’s encrypt wildcard</simpara>
</listitem>
<listitem>
<simpara><literal>SSL:</literal> &#8592; yes</simpara>
</listitem>
<listitem>
<simpara><literal>Let’s Encrypt:</literal> &#8592; yes</simpara>
</listitem>
<listitem>
<simpara><literal>Php:</literal> &#8592; Sélectionez <literal>php-fpm</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez éventuellement aussi les coches <literal>Perl</literal>, <literal>Python</literal>, <literal>Ruby</literal> en fonction des technologies déployées sur votre site. Cela est indiqué dans la procédure d&#8217;installation du site.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet <literal>redirect</literal> du même écran</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Rewrite http to https:</literal> &#8592; yes</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet <literal>Statistics</literal> du même écran</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Set Webstatistics password:</literal> &#8592; <link linkend="pass_gen">Saisissez un mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; Ressaisissez le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet <literal>Options</literal>, il peut être utile pour certains types de site qui sont des redirections d&#8217;autres sites (locaux, d&#8217;autres machines ou de container docker) de saisir dans la zone <literal>Apache Directives:</literal></simpara>
<itemizedlist>
<listitem>
<simpara>Pour un site en HTTP (attention dans ce cas, ce site doit être local ou dans un container pour des raisons de sécurité) :</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# yacht httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost[:port_number_if_any]/[path_if_any]
ProxyPassReverse / http://localhost[:port_number_if_any]/[path_if_any]

RedirectMatch ^/$ https://sub.example.com <co xml:id="CO28-1"/></programlisting>
<calloutlist>
<callout arearefs="CO28-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pour un site en HTTPS :</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# redirect from server
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
SSLProxyEngine On # Comment this out if no https required
ProxyPreserveHost    On

ProxyPass / https://localhost[:port_number_if_any]/[path_if_any]
ProxyPassReverse / https://localhost[:port_number_if_any]/[path_if_any]

RedirectMatch ^/$ https://sub.example.com <co xml:id="CO29-1"/></programlisting>
<calloutlist>
<callout arearefs="CO29-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant tester la qualité de la  connexion de votre site en allant sur: <link xl:href="https://www.ssllabs.com/ssltest">SSL Server Test</link>. Saisissez votre nom de domaine et cliquez sur <literal>Submit</literal>. Votre site doit au moins être de <literal>Grade A</literal>.</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_associer_des_certificats_reconnu_à_vos_outils">
<title>Associer des certificats reconnu à vos outils</title>
<simpara>Cette action est à effectuer une fois que vous avez créé votre domaine principal et que vous avez généré vos premiers certificats let&#8217;s encrypt dans ISPConfig, vous pouvez maintenant, affecter ce certificat aux services de base:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Vous devez avoir créé au préalable un site pour les domaines example.com et mail.example.com</simpara>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Liez le certificat d&#8217;ISPconfig avec celui du domaine crée.</simpara>
<itemizedlist>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /usr/local/ispconfig/interface/ssl/
mv ispserver.crt ispserver.crt-$(date +"%y%m%d%H%M%S").bak
mv ispserver.key ispserver.key-$(date +"%y%m%d%H%M%S").bak
ln -s /var/www/clients/&lt;clientx&gt;/&lt;webx&gt;/ssl/&lt;example.com&gt;-le.crt ispserver.crt <co xml:id="CO30-1"/>
ln -s /var/www/clients/&lt;clientx&gt;/&lt;webx&gt;/ssl/&lt;example.com&gt;-le.key ispserver.key <co xml:id="CO30-2"/>
cat ispserver.{key,crt} &gt; ispserver.pem
chmod 600 ispserver.pem
systemctl restart apache2</programlisting>
<calloutlist>
<callout arearefs="CO30-1 CO30-2">
<para>remplacer &lt;example.com&gt; par votre nom de domaine, &lt;clientx&gt; par votre numéro de client, &lt;webx&gt; par votre numéro de serveur web. L&#8217;information est facilement retrouvé en cliquant sur l&#8217;interface d&#8217;ISPconfig dans <literal>Sites</literal>&#8594;`Website`&#8594;`&lt;example.com&gt;`. Le champ <literal>Document Root</literal> donne le début du chemin <literal>/var/www/clients/&lt;clientx&gt;/&lt;webx&gt;/</literal></para>
</callout>
</calloutlist>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Liez le certificat Postfix et Dovecot avec celui de let&#8217;s encrypt</simpara>
<itemizedlist>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc/postfix/
mv smtpd.cert smtpd.cert-$(date +"%y%m%d%H%M%S").bak
mv smtpd.key smtpd.key-$(date +"%y%m%d%H%M%S").bak
ln -s /var/www/clients/client0/web1/ssl/mail.example.com-le.crt smtpd.cert <co xml:id="CO31-1"/>
ln -s /var/www/clients/client0/web1/ssl/mail.example.com-le.key smtpd.key <co xml:id="CO31-2"/>
service postfix restart
service dovecot restart</programlisting>
<calloutlist>
<callout arearefs="CO31-1 CO31-2">
<para>remplacer &lt;example.com&gt; par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Liez le certificat pour Pureftd</simpara>
<itemizedlist>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc/ssl/private/
mv pure-ftpd.pem pure-ftpd.pem-$(date +"%y%m%d%H%M%S").bak
ln -s /usr/local/ispconfig/interface/ssl/ispserver.pem pure-ftpd.pem
ln -s /usr/local/ispconfig/interface/ssl/dhparam4096.pem pure-ftpd-dhparams.pem
chmod 600 pure-ftpd.pem
service pure-ftpd-mysql restart</programlisting>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Création d&#8217;un script de renouvellement automatique du fichier pem</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Installez la cron. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">crontab -e</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez la ligne suivante:</simpara>
<programlisting language="bash" linenumbering="unnumbered">00 02 1 * * /usr/local/bin/certif_update.sh</programlisting>
</listitem>
<listitem>
<simpara>Créez le fichier d&#8217;exécution périodique. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/certif_update.sh</programlisting>
<simpara>et coller dans le fichier le code suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/bash

cd /usr/local/ispconfig/interface/ssl/
mv ispserver.pem ispserver.pem-$(date +"%y%m%d%H%M%S").bak
cat ispserver.{key,crt} &gt; ispserver.pem
chmod 600 ispserver.pem
chmod 600 /etc/ssl/private/pure-ftpd.pem
cd /etc/postfix
cat smtpd.{key,cert} &gt; smtpd.pem
chmod 600 smtpd.pem
service pure-ftpd-mysql restart
service monit restart
service postfix restart
service dovecot restart
service apache2 restart</programlisting>
</listitem>
<listitem>
<simpara>Sauvez et quittez. Tapez ensuite:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod +x /usr/local/bin/certif_update.sh</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_surveillance_du_serveur_avec_munin_et_monit">
<title>Surveillance du serveur avec Munin et Monit</title>
<section xml:id="_note_préliminaire">
<title>Note préliminaire</title>
<simpara>Installez tout d&#8217;abord les paquets indispensables pour faire fonctionner Munin avec Apache puis activez le module fcgid:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install apache2 libcgi-fast-perl libapache2-mod-fcgid
a2enmod fcgid</programlisting>
</section>
<section xml:id="_installation_et_configuration_de_munin">
<title>Installation et configuration de Munin</title>
<simpara>Suivez les étapes ci-après:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Installer le paquet Munin:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install munin munin-node munin-plugins-extra logtail libcache-cache-perl</programlisting>
</listitem>
<listitem>
<simpara>Votre configuration de Munin va utiliser une base de données MariaDB. Vous devez activer quelques plugins. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc/munin/plugins
ln -s /usr/share/munin/plugins/mysql_ mysql_
ln -s /usr/share/munin/plugins/mysql_bytes mysql_bytes
ln -s /usr/share/munin/plugins/mysql_innodb mysql_innodb
ln -s /usr/share/munin/plugins/mysql_isam_space_ mysql_isam_space_
ln -s /usr/share/munin/plugins/mysql_queries mysql_queries
ln -s /usr/share/munin/plugins/mysql_slowqueries mysql_slowqueries
ln -s /usr/share/munin/plugins/mysql_threads mysql_threads</programlisting>
</listitem>
<listitem>
<simpara>Créez la base de données MariaDB de Munin. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql -p</programlisting>
</listitem>
<listitem>
<simpara>Tapez le mot de passe mysql de root , puis dans mysql tapez:</simpara>
<programlisting language="mysql" linenumbering="unnumbered">CREATE SCHEMA munin_innodb;
USE munin_innodb
CREATE TABLE something (anything int) ENGINE=InnoDB;
GRANT SELECT ON munin_innodb.* TO 'munin'@'localhost' IDENTIFIED BY 'munin';
FLUSH PRIVILEGES;
EXIT;</programlisting>
</listitem>
<listitem>
<simpara>Editez ensuite le fichier de configuration de Munin. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/munin/munin.conf</programlisting>
</listitem>
<listitem>
<simpara>Décommentez les lignes débutant par: <literal>dbdir</literal>, <literal>htmldir</literal>, <literal>logdir</literal>, <literal>rundir</literal>, and <literal>tmpldir</literal>. Les valeurs par défaut sont correctes.</simpara>
</listitem>
<listitem>
<simpara>Munin utilisera l&#8217;adresse <literal>munin.example.com</literal>. Toujours dans le fichier de configuration de munin, remplacer la directive <literal>[localhost.localdomain]</literal> par <literal>[munin.example.com]</literal>.</simpara>
</listitem>
<listitem>
<simpara>Un fois les commentaires enlevés et la ligne modifiée, le fichier de configuration doit ressembler à celui-ci:</simpara>
<screen># Example configuration file for Munin, generated by 'make build'
# The next three variables specifies where the location of the RRD
# databases, the HTML output, logs and the lock/pid files. They all
# must be writable by the user running munin-cron. They are all
# defaulted to the values you see here.
#
dbdir /var/lib/munin
htmldir /var/cache/munin/www
logdir /var/log/munin
rundir /var/run/munin
# Where to look for the HTML templates
#
tmpldir /etc/munin/templates
# Where to look for the static www files
#
#staticdir /etc/munin/static
# temporary cgi files are here. note that it has to be writable by
# the cgi user (usually nobody or httpd).
#
# cgitmpdir /var/lib/munin/cgi-tmp

# (Exactly one) directory to include all files from.
includedir /etc/munin/munin-conf.d
[...]
# a simple host tree
[munin.example.com] <co xml:id="CO32-1"/>
 address 127.0.0.1
 use_node_name yes
[...]</screen>
<calloutlist>
<callout arearefs="CO32-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Activez Munin dans Apache. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2enconf munin</programlisting>
</listitem>
<listitem>
<simpara>Editez le fichier munin.conf d&#8217;Apache:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/apache2/conf-enabled/munin.conf</programlisting>
</listitem>
<listitem>
<simpara>Nous allons maintenant activer le module Munin dans Apache et définir une authentification basique.</simpara>
</listitem>
<listitem>
<simpara>Modifiez le fichier pour qu&#8217;il ressemble à celui ci-dessous:</simpara>
<programlisting language="apache" linenumbering="unnumbered">ScriptAlias /munin-cgi/munin-cgi-graph /usr/lib/munin/cgi/munin-cgi-graph
Alias /munin/static/ /var/cache/munin/www/static/

&lt;Directory /var/cache/munin/www&gt;
    Options FollowSymLinks SymLinksIfOwnerMatch
    AuthUserFile /etc/munin/munin-htpasswd
    AuthName "Munin"
    AuthType Basic
    Require valid-user

&lt;/Directory&gt;

&lt;Directory /usr/lib/munin/cgi&gt;
    AuthUserFile /etc/munin/munin-htpasswd
    AuthName "Munin"
    AuthType Basic
    Require valid-user
    Options FollowSymLinks SymLinksIfOwnerMatch
    &lt;IfModule mod_fcgid.c&gt;
        SetHandler fcgid-script
    &lt;/IfModule&gt;
    &lt;IfModule !mod_fcgid.c&gt;
        SetHandler cgi-script
    &lt;/IfModule&gt;
&lt;/Directory&gt;

# ***** SETTINGS FOR CGI/CRON STRATEGIES *****

# pick _one_ of the following lines depending on your "html_strategy"
# html_strategy: cron (default)
Alias /munin /var/cache/munin/www
# html_strategy: cgi (requires the apache module "cgid" or "fcgid")
#ScriptAlias /munin /usr/lib/munin/cgi/munin-cgi-html</programlisting>
</listitem>
<listitem>
<simpara>Créez ensuite le fichier de mot de passe de munin:</simpara>
<programlisting language="bash" linenumbering="unnumbered">htpasswd -c /etc/munin/munin-htpasswd admin</programlisting>
</listitem>
<listitem>
<simpara>Tapez <link linkend="pass_gen">votre mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara>Redémarrez apache. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service apache2 restart</programlisting>
</listitem>
<listitem>
<simpara>Vérifiez bien que IPV6 est activé. Si ce n&#8217;est pas le cas, le redémarrage de Munin peut survenir.</simpara>
</listitem>
<listitem>
<simpara>Redémarrez Munin. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service munin-node restart</programlisting>
</listitem>
<listitem>
<simpara>Attendez quelques minutes afin que Munin produise ses premiers fichiers de sortie. et allez ensuite sur l&#8217;URL: <link xl:href="http://example.com/munin/">http://example.com/munin/</link>.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_activez_les_plugins_de_munin">
<title>Activez les plugins de Munin</title>
<simpara>Dans Debian 10, tous les plugins complémentaires sont déjà activés.Vous pouvez être tenté de vérifier:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Pour vérifier que la configuration est correcte. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">munin-node-configure --suggest</programlisting>
</listitem>
<listitem>
<simpara>Une liste de plugins doit s&#8217;afficher à l&#8217;écran. La colonne <literal>used</literal> indique que le plugins est activé. La colonne <literal>Suggestions</literal> indique que le serveur fait fonctionner un service qui peut être monitoré par ce module. Il faut créer un lien symbolique du module de <literal>/usr/share/munin/plugins</literal> dans <literal>/etc/munin/plugins</literal> pour l&#8217;activer.</simpara>
</listitem>
<listitem>
<simpara>Par exemple pour activer les modules apache_*:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc/munin/plugins
ln -s /usr/share/munin/plugins/apache_accesses
ln -s /usr/share/munin/plugins/apache_processes
ln -s /usr/share/munin/plugins/apache_volume
rm /usr/share/munin/plugins/mysql_</programlisting>
</listitem>
<listitem>
<simpara>Une autre manière simple de configurer munin est de taper:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /etc/munin/plugins
munin-node-configure --shell --families=contrib,auto | sh -x</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez ensuite le service Munin. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service munin-node restart</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installer_et_configurer_monit">
<title>Installer et configurer Monit</title>
<simpara>Pour installer et configurer Monit, vous devez appliquer la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install monit</programlisting>
</listitem>
<listitem>
<simpara>Maintenant nous devons éditer le fichier <literal>monitrc</literal> qui définira les services que l&#8217;on souhaite monitorer. Il existe de nombreux exemples sur le web et vous pourrez trouver de nombreuses configuration sur <link xl:href="http://mmonit.com/monit/documentation/">http://mmonit.com/monit/documentation/</link>.</simpara>
</listitem>
<listitem>
<simpara>Changez la configuration de Monit. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf.d/monitrc.local</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>set daemon 60
set logfile syslog facility log_daemon
set mailserver localhost
set mail-format { from: monit@example.com } <co xml:id="CO33-1"/>
set alert nom@example.com <co xml:id="CO33-2"/>
set httpd port 2812 and
 SSL ENABLE
 PEMFILE /usr/local/ispconfig/interface/ssl/ispserver.pem
 allow admin:"my_password" <co xml:id="CO33-3"/></screen>
<calloutlist>
<callout arearefs="CO33-3">
<para>remplacez my_password par <link linkend="pass_gen">votre mot de passe généré</link></para>
</callout>
<callout arearefs="CO33-1 CO33-2">
<para>remplacer example.com par votre domaine et <link xl:href="mailto:nom@example.com">nom@example.com</link> par votre email</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Activez les modules standards :</simpara>
<screen>cd /etc/monit/conf-enabled</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour Mariadb. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/mariadb</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen> check process mysqld with pidfile /var/run/mysqld/mysqld.pid
   group database
   group mysql
   start program = "/etc/init.d/mariadb start"
   stop  program = "/etc/init.d/mariadb stop"
   if failed host localhost port 3306 protocol mysql with timeout 15 seconds for 3 times within 4 cycles then restart
   if failed unixsocket /var/run/mysqld/mysqld.sock protocol mysql for 3 times within 4 cycles then restart
   if 5 restarts with 5 cycles then timeout
   depend mysql_bin
   depend mysql_rc

 check file mysql_bin with path /usr/sbin/mysqld
   group mysql
   include /etc/monit/templates/rootbin

 check file mysql_rc with path /etc/init.d/mariadb
   group mysql
   include /etc/monit/templates/rootbin</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour Pureftpd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/pureftpd</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>check process pureftpd with pidfile /var/run/pure-ftpd/pure-ftpd.pid
 start program = "/usr/sbin/service pure-ftpd-mysql start"
 stop program = "/usr/sbin/service pure-ftpd-mysql stop"
 if failed port 21 protocol ftp then restart
 if 5 restarts within 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour named. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/named</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>check process named with pidfile /var/run/named/named.pid
 start program = "/usr/sbin/service bind9 start"
 stop program = "/usr/sbin/service bind9 stop"
 if failed host 127.0.0.1 port 53 type tcp protocol dns then restart
 if failed host 127.0.0.1 port 53 type udp protocol dns then restart
 if 5 restarts within 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour sshd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/sshd</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen> check process sshd with pidfile /var/run/sshd.pid
  start program = "/etc/init.d/ssh start"
  stop program = "/etc/init.d/ssh stop"
  if failed host localhost port 22 with proto ssh then restart
  if 5 restarts within 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour apache. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/apache2</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen> check process apache with pidfile /var/run/apache2/apache2.pid
   start program = "/etc/init.d/apache2 start"
   stop program  = "/etc/init.d/apache2 stop"
   if 4 restarts within 20 cycles then timeout
   if failed host localhost port 80 with protocol http and request "/server-status" with timeout 25 seconds for 4 times within 5 cycles then restart</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour memcached. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/memcached</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen> check process memcached with pidfile /var/run/memcached/memcached.pid
   start program = "/etc/init.d/memcached start"
   stop program  = "/etc/init.d/memcached stop"
   if failed host 127.0.0.1 port 11211 and protocol memcache then restart
   if cpu &gt; 60% for 2 cycles then alert
   if cpu &gt; 98% for 5 cycles then restart
   if 5 restarts within 20 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour ntpd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/ntpd</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>check process ntpd with pidfile /var/run/ntpd.pid
 start program = "/usr/sbin/service ntp start"
 stop program = "/usr/sbin/service ntp stop"
 if failed host 127.0.0.1 port 123 type udp then restart
 if 5 restarts within 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour dovecot. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/dovecot</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>check process dovecot with pidfile /var/run/dovecot/master.pid
 group mail
 start program = "/usr/sbin/service dovecot start"
 stop program = "/usr/sbin/service dovecot stop"
 if failed host localhost port 993 type tcpssl sslauto protocol imap then restart
 if 5 restarts within 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour postfix. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/postfix</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen> check process postfix with pidfile /var/spool/postfix/pid/master.pid
   start program = "/etc/init.d/postfix start"
   stop  program = "/etc/init.d/postfix stop"
   if failed host localhost port 25 with protocol smtp for 2 times within 3 cycles then restart
   if 5 restarts with 5 cycles then timeout</screen>
</listitem>
<listitem>
<simpara>Créez ensuite un fichier pour redis. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/monit/conf-enabled/redis</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier cette configuration :</simpara>
<screen>check process redis with pidfile /var/run/redis/redis-server.pid
  start program = "/usr/sbin/service redis-server start" with timeout 60 seconds
  stop program  = "/usr/sbin/service redis-server stop" with timeout 60 seconds
  if failed host 127.0.0.1 port 6379 then restart
  if totalmem &gt; 500 Mb then alert
  if cpu &gt; 60% for 2 cycles then alert
  if cpu &gt; 98% for 5 cycles then restart
  if 2 restarts within 2 cycles then alert</screen>
</listitem>
<listitem>
<simpara>La configuration est assez claire à lire. pour obtenir des précisions, référez vous à la documentation de monit <link xl:href="http://mmonit.com/monit/documentation/monit.html">http://mmonit.com/monit/documentation/monit.html</link>.</simpara>
</listitem>
<listitem>
<simpara>Redémarrez apache. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service apache2 restart</programlisting>
</listitem>
<listitem>
<simpara>Dans la configuration pour apache, la configuration indique que monit doit allez chercher sur le port 80 un fichier dans <literal>/monit/token</literal>. Nous devons donc créer ce fichier. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir /var/www/html/monit
echo "hello" &gt; /var/www/html/monit/token</programlisting>
</listitem>
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">service monit restart</programlisting>
</listitem>
<listitem>
<simpara>Pour monitorer le statut des process en ligne de commande, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">monit status</programlisting>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 2812 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Maintenant naviguez sur le site <link xl:href="https://example.com:2812/">https://example.com:2812/</link></simpara>
</listitem>
<listitem>
<simpara>Rentrez le login <literal>admin</literal> et votre mot de passe <literal>my_password</literal>. Monit affiche alors les informations de monitoring du serveur.</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_configuration_de_la_messagerie">
<title>Configuration de la messagerie</title>
<section xml:id="_configuration_de_lantispam_rspamd">
<title>Configuration de l&#8217;antispam rspamd</title>
<simpara><literal>rspamd</literal> est réputé de meilleure qualité que <literal>Amavis</literal> dans la chasse aux spams. Vous pouvez décider de l&#8217;installer à la place d&#8217;Amavis. Cette installation reste optionnelle.</simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez les paquets debian. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install rspamd redis-server</programlisting>
</listitem>
<listitem>
<simpara>Loguez vous dans ISPConfig</simpara>
</listitem>
<listitem>
<simpara>Activer Rspamd dans ISPConfig</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Allez dans la rubrique <literal>system</literal> &#8594; menu <literal>Server Config</literal> &#8594; Sélectionnez votre serveur &#8594; Onglet <literal>Mail</literal></simpara>
</listitem>
<listitem>
<simpara>Dans le champ <literal>Content Filter</literal>, sélectionnez <literal>Rspamd</literal></simpara>
</listitem>
<listitem>
<simpara>Dans le champ <literal>Rspamd Password</literal>, tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>Revenez dans la rubrique <literal>system</literal> &#8594; menu <literal>Server Config</literal> &#8594; Sélectionnez votre serveur &#8594; Onglet <literal>Mail</literal></simpara>
</listitem>
<listitem>
<simpara>Vous pouvez voir le mot de passe de connexion au serveur web Rspamd.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Activez l&#8217;apprentissage automatique. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/classifier-bayes.conf</programlisting>
</listitem>
<listitem>
<simpara>insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">backend = "redis";
servers = "127.0.0.1";
expire = 8640000;
autolearn {
  spam_threshold = 6.0; # When to learn spam (score &gt;= threshold and action is reject)
  junk_threshold = 4.0; # When to learn spam (score &gt;= threshold and action is rewrite subject or add header, and has two or more positive results)
  ham_threshold = -0.5; # When to learn ham (score &lt;= threshold and action is no action, and score is negative or has three or more negative results)
  check_balance = true; # Check spam and ham balance
  min_balance = 0.9; # Keep diff for spam/ham learns for at least this value
}

per_user = false;
per_language = true;</screen>
</listitem>
<listitem>
<simpara>Activez Redis dans la configuration de Rspamd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo 'write_servers = "127.0.0.1";' &gt; /etc/rspamd/local.d/redis.conf
echo 'read_servers = "127.0.0.1";' &gt;&gt; /etc/rspamd/local.d/redis.conf</programlisting>
</listitem>
<listitem>
<simpara>Fixer des métriques assez élevées pour analyser les spams</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "actions {" &gt; /etc/rspamd/local.d/metrics.conf
echo 'add_header = 5;' &gt;&gt; /etc/rspamd/local.d/metrics.conf
echo "greylist = 25;" &gt;&gt; /etc/rspamd/local.d/metrics.conf
echo "reject = 50;" &gt;&gt; /etc/rspamd/local.d/metrics.conf
echo "}" &gt;&gt; /etc/rspamd/local.d/metrics.conf</programlisting>
</listitem>
<listitem>
<simpara>Augmentez la taille de l&#8217;historique de Rspamd, activez la compression.</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "nrows = 2500;" &gt; /etc/rspamd/local.d/history_redis.conf
echo "compress = true;" &gt;&gt; /etc/rspamd/local.d/history_redis.conf
echo "subject_privacy = false;" &gt;&gt; /etc/rspamd/local.d/history_redis.conf <co xml:id="CO34-1"/></programlisting>
<calloutlist>
<callout arearefs="CO34-1">
<para>à basculer à <literal>true</literal> si vous avez des utilisateurs de votre serveur de mail souhaitant une compatibilité RGPD.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Assignez un calcul automatique de réputation aux URLs</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo 'enabled = true;' &gt; /etc/rspamd/local.d/url_reputation.conf</programlisting>
</listitem>
<listitem>
<simpara>Vérifiez si l&#8217;émetteur est bien un serveur de mail. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/mx_check.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">enabled = true;
key_prefix = "rmx";
symbol_bad_mx = "MX_INVALID";
symbol_no_mx = "MX_MISSING";
symbol_good_mx = "MX_GOOD";
expire = 86400;
expire_novalid = 7200;
greylist_invalid = false;</screen>
</listitem>
<listitem>
<simpara>Activez l&#8217;analyse par réseau de neurone. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/neural.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">enabled = true;

rules {
  "LONG" {
    train {
      max_trains = 5000;
      max_usages = 200;
      max_iterations = 25;
      learning_rate = 0.01,
      spam_score = 10;
      ham_score = -2;
    }
    symbol_spam = "NEURAL_SPAM_LONG";
    symbol_ham = "NEURAL_HAM_LONG";
    ann_expire = 100d;
  }
  "SHORT" {
    train {
      max_trains = 100;
      max_usages = 2;
      max_iterations = 25;
      learning_rate = 0.01,
      spam_score = 10;
      ham_score = -2;
    }
    symbol_spam = "NEURAL_SPAM_SHORT";
    symbol_ham = "NEURAL_HAM_SHORT";
    ann_expire = 1d;
  }
}</screen>
</listitem>
<listitem>
<simpara>Créez les groupes associés. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/neural_group.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">symbols = {
  "NEURAL_SPAM_LONG" {
    weight = 1.0; # sample weight
    description = "Neural network spam (long)";
  }
  "NEURAL_HAM_LONG" {
    weight = -2.0; # sample weight
    description = "Neural network ham (long)";
  }
  "NEURAL_SPAM_SHORT" {
    weight = 0.5; # sample weight
    description = "Neural network spam (short)";
  }
  "NEURAL_HAM_SHORT" {
    weight = -1.0; # sample weight
    description = "Neural network ham (short)";
  }
}</screen>
</listitem>
<listitem>
<simpara>Enrichissez les headers des mails spams. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/milter_headers.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered"># local.d/milter_headers.conf:

# Options

# Add "extended Rspamd headers" (default false) (enables x-spamd-result, x-rspamd-server &amp; x-rspamd-queue-id routines)
extended_spam_headers = true;

# List of headers to be enabled for authenticated users (default empty)
authenticated_headers = ["authentication-results"];

# List of headers to be enabled for local IPs (default empty)
local_headers = ["x-spamd-bar"];

# Set false to always add headers for local IPs (default true)
# skip_local = true;

# Set false to always add headers for authenticated users (default true)
# skip_authenticated = true;

# Routines to use- this is the only required setting (may be omitted if using extended_spam_headers)
use = ["x-spamd-bar", "x-spam-level", "x-spam-status", "authentication-results", "remove-headers"];

# this is where we may configure our selected routines
routines {
  remove-headers {
    headers {
      "X-Spam" = 0;
      "X-Spamd-Bar" = 0;
      "X-Spam-Level" = 0;
      "X-Spam-Status" = 0;
      "X-Spam-Flag" = 0;
    }
  }
  # other routines...
}
custom {
  # user-defined routines: more on these later
}</screen>
</listitem>
<listitem>
<simpara>Créez une configuration pour le protocole arc. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/arc.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">sign_authenticated = false;
sign_inbound = true;
sign_local = false;
use_domain = "header";
try_fallback = false;
use_esld = false;
path_map = "/etc/rspamd/local.d/dkim_domains.map";
selector_map = "/etc/rspamd/local.d/dkim_selectors.map";</screen>
</listitem>
<listitem>
<simpara>Créez un mot de passe. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">rspamadm pw</programlisting>
</listitem>
<listitem>
<simpara>Entrez <link linkend="pass_gen">votre mot de passe généré</link>. Une hash phrase est générée.</simpara>
</listitem>
<listitem>
<simpara>Copiez la.</simpara>
</listitem>
<listitem>
<simpara>Remplacez celle déjà présente dans <literal>/etc/rspamd/local.d/worker-controller.inc</literal></simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/worker-controller.inc</programlisting>
</listitem>
<listitem>
<simpara>Remplacez le texte entre guillemets sur la ligne <literal>password = "$2$g95yw&#8230;&#8203;&#8230;&#8203;dq3c5byy";</literal> par le texte copié.</simpara>
</listitem>
<listitem>
<simpara>Si vous avez installé l&#8217;antivirus Clamav, Créez un fichier pour la configuration:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/antivirus.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant :</simpara>
<screen linenumbering="unnumbered">clamav {
    # If set force this action if any virus is found (default unset: no action is forced)
    #action = "reject";
    # Scan mime_parts separately - otherwise the complete mail will be transferred to AV Scanner
    scan_mime_parts = true;
    # Scanning Text is suitable for some av scanner databases (e.g. Sanesecurity)
    scan_text_mime = true;
    scan_image_mime = true;
    # If `max_size` is set, messages &gt; n bytes in size are not scanned
    #max_size = 20000000;
    # symbol to add (add it to metric if you want non-zero weight)
    symbol = "CLAM_VIRUS";
    # type of scanner: "clamav", "fprot", "sophos" or "savapi"
    type = "clamav";
    # For "savapi" you must also specify the following variable
    #product_id = 12345;
    # You can enable logging for clean messages
    #log_clean = true;
    # servers to query (if port is unspecified, scanner-specific default is used)
    # can be specified multiple times to pool servers
    # can be set to a path to a unix socket
    # Enable this in local.d/antivirus.conf
    #servers = "127.0.0.1:3310";
    servers = "/var/run/clamav/clamd.ctl";
    # if `patterns` is specified virus name will be matched against provided regexes and the related
    # symbol will be yielded if a match is found. If no match is found, default symbol is yielded.
    patterns {
      # symbol_name = "pattern";
      JUST_EICAR = "^Eicar-Test-Signature$";
    }
    patterns_fail {
      # symbol_name = "pattern";
      CLAM_PROTOCOL_ERROR = '^unhandled response';
    }
    # `whitelist` points to a map of IP addresses. Mail from these addresses is not scanned.
    whitelist = "/etc/rspamd/antivirus.wl";
}</screen>
</listitem>
<listitem>
<simpara>Définissez des groupes:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/groups.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant :</simpara>
<screen linenumbering="unnumbered">group "antivirus" {
    .include(try=true; priority=1; duplicate=merge) "$LOCAL_CONFDIR/local.d/antivirus_group.conf"
    .include(try=true; priority=10) "$LOCAL_CONFDIR/override.d/antivirus_group.conf"
}</screen>
</listitem>
<listitem>
<simpara>Définissez les détections de virus :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/rspamd/local.d/antivirus_group.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant :</simpara>
<screen linenumbering="unnumbered">subject = "***SPAM*** %s";
symbols = {
        "CLAM_VIRUS" {
                weight = 50;
                description = "Clamav has found a virus.";
        }
        "JUST_EICAR" {
                weight = 50;
                description = "Clamav has found a virus.";
        }
        "R_DUMMY" {
                weight = 0.0;
                description = "Dummy symbol";
        }
}</screen>
</listitem>
<listitem>
<simpara>Ajuster les permissions. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 755 /etc/rspamd/local.d/maps.d</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez Rspamd</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart rspamd</programlisting>
</listitem>
<listitem>
<simpara>Rendre le site rspamd accessible dans un host</simpara>
</listitem>
<listitem>
<simpara>Activez le module proxy dans apache</simpara>
<programlisting language="bash" linenumbering="unnumbered">a2enmod proxy
systemctl restart apache2</programlisting>
</listitem>
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>rspamd</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de <literal>sites</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>rspamd</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>rspamd</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# redirect from server
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
SSLProxyEngine On # Comment this out if no https required
ProxyPreserveHost    On
SSLProxyVerify none
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off

ProxyPass /rspamd https://example.com:8081/rspamd/ <co xml:id="CO35-1"/>
ProxyPass / https://example.com:8081/rspamd/ <co xml:id="CO35-2"/>
ProxyPassReverse / https://example.com:8081/rspamd/ <co xml:id="CO35-3"/>

RedirectMatch ^/$ https://rspamd.example.com <co xml:id="CO35-4"/></programlisting>
<calloutlist>
<callout arearefs="CO35-1 CO35-2 CO35-3 CO35-4">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>en pointant sur le site <literal>rspampd.example.com</literal> , et en utilisant le mot de passe saisi plus haut vous pouvez accéder aux fonctions de l&#8217;outil.</simpara>
</listitem>
<listitem>
<simpara>Activer l&#8217;apprentissage par déplacement</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Couplé avec Dovecot, Rspamd nous propose de pouvoir apprendre également en fonction des actions des utilisateurs. Si un mail est déplacé vers le répertoire Junk, il sera appris comme tel et au contraire, s’il est sorti du répertoire Junk vers autre chose que la corbeille, il sera appris comme Ham.</simpara>
</listitem>
<listitem>
<simpara>Editez le fichier Dovecot.conf (remarques ISPConfig n&#8217;utilise pas aujourd&#8217;hui le contenu du répertoire conf.d). Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/dovecot/conf.d/99-ispconfig-custom-config.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez le texte suivant :</simpara>
<screen linenumbering="unnumbered">plugin {
  sieve_plugins = sieve_imapsieve sieve_extprograms

  imapsieve_mailbox1_name = Junk
  imapsieve_mailbox1_causes = COPY
  imapsieve_mailbox1_before = file:/etc/dovecot/sieve/report-spam.sieve

  imapsieve_mailbox2_name = *
  imapsieve_mailbox2_from = Junk
  imapsieve_mailbox2_causes = COPY
  imapsieve_mailbox2_before = file:/etc/dovecot/sieve/report-ham.sieve

  sieve_pipe_bin_dir = /etc/dovecot/sieve

  sieve_global_extensions = +vnd.dovecot.pipe
}

protocol imap {
  mail_plugins = quota imap_quota imap_sieve
}</screen>
</listitem>
<listitem>
<simpara>Redémarrez dovecot. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service dovecot restart</programlisting>
</listitem>
<listitem>
<simpara>Créez un répertoire sieve et éditez report-ham.sieve. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /etc/dovecot/sieve/
vi /etc/dovecot/sieve/report-ham.sieve</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">require ["vnd.dovecot.pipe", "copy", "imapsieve", "environment", "variables"];

if environment :matches "imap.mailbox" "*" {
set "mailbox" "${1}";
}

if string "${mailbox}" "Trash" {
stop;
}

if environment :matches "imap.email" "*" {
set "email" "${1}";
}

pipe :copy "train-ham.sh" [ "${email}" ];</screen>
</listitem>
<listitem>
<simpara>Editez report-spam.sieve. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/dovecot/sieve/report-spam.sieve</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">require ["vnd.dovecot.pipe", "copy", "imapsieve", "environment", "variables"];

if environment :matches "imap.email" "*" {
set "email" "${1}";
}

pipe :copy "train-spam.sh" [ "${email}" ];</screen>
</listitem>
<listitem>
<simpara>Créez les scripts et rétablissez les droits et permissions. Compilez les règles. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "exec /usr/bin/rspamc learn_ham" &gt; /etc/dovecot/sieve/train-ham.sh
echo "exec /usr/bin/rspamc learn_spam" &gt; /etc/dovecot/sieve/train-spam.sh
sievec /etc/dovecot/sieve/report-ham.sieve
sievec /etc/dovecot/sieve/report-spam.sieve
chmod +x /etc/dovecot/sieve/train-*
chown -R vmail:vmail /etc/dovecot/sieve</programlisting>
</listitem>
<listitem>
<simpara>On en profite pour ajouter un petit script qui informe l&#8217;utilisateur de l&#8217;atteinte de son quota. On édite le fichier <literal>90-quota.conf</literal> :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/dovecot/conf.d/90-quota.conf</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<screen linenumbering="unnumbered">plugin {
  quota = maildir:User quota
  quota_warning = storage=90%% quota-warning 90 %u
}

service quota-warning {
  executable = script /usr/local/bin/quota-warning.sh
  user = vmail
  unix_listener quota-warning {
    user = vmail
  }
}</screen>
</listitem>
<listitem>
<simpara>Créer le fichier de script :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/quota-warning.sh</programlisting>
</listitem>
<listitem>
<simpara>Insérez le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/usr/bin/env bash

PERCENT=${1}
USER=${2}

cat &lt;&lt; EOF | /usr/sbin/sendmail $USER -O "plugin/quota=maildir:User quota:noenforcing"
From: postmaster@example.com <co xml:id="CO36-1"/>

Votre Boite est plein à plus de ${PERCENT}. Faut faire du ménage mon ami !
EOF</programlisting>
<calloutlist>
<callout arearefs="CO36-1">
<para>remplacer example.com par votre nom de domaine.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Changez les permissions :</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod +x /usr/local/bin/quota-warning.sh
chown vmail /usr/local/bin/quota-warning.sh</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez dovecot. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service dovecot restart</programlisting>
</listitem>
<listitem>
<simpara>Lorsque vous déplacer un mail du répertoire Inbox vers le répertoire Junk ou vice-versa, les fichiers <literal>/var/log/mail.log</literal> et <literal>/var/log/rspamd/rspamd.log</literal> doivent montrer les actions de recalcul des spams.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Enfin, vous pouvez désactiver amavisd si vous le souhaitez et s&#8217;il est installé sur votre système. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl stop amavisd-new
systemctl disable amavisd-new</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_du_serveur_de_messagerie">
<title>Création du serveur de messagerie</title>
<simpara>Pour créer un serveur de messagerie:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Assurez vous d&#8217;avoir créé le domaine DNS. Si ce n&#8217;est pas le cas déroulez tout d&#8217;abord la procédure de <link linkend="domain-config">création de domaines</link></simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Email</literal>. Sélectionnez ensuite le menu <literal>Domain</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Domain</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez le nom de domaine.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>Attendez quelques secondes la fin de configuration puis rouvrez la configuration de votre serveur de mail et</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>DomainKeys Indentified Mail (DKIM)</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>enable DKIM</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Generate DKIM Private-key</literal></simpara>
</listitem>
<listitem>
<simpara>Une fois cela fait, retourner dans la gestion des <literal>Records</literal> de domaine et activer le type DMARC</simpara>
</listitem>
<listitem>
<simpara>Garder le paramétrage par défaut et sauvegardez.</simpara>
</listitem>
<listitem>
<simpara>Faites de même pour les enregistrements SPF mais sélectionnez le mécanisme softfail.</simpara>
</listitem>
<listitem>
<simpara>Votre serveur est créé et protégé Contre les spams (entrants et sortants).</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_mise_en_oeuvre_du_site_web_de_webmail">
<title>Mise en oeuvre du site web de webmail</title>
<simpara>On suppose que vous avez install roundcube lors de la procédure d&#8217;installation initiale et que vous avez déjà créé le host <literal>mail.example.com</literal> .</simpara>
<simpara>Il vous reste à appliquer la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>mail</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>mail</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# redirect from server
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
SSLProxyEngine On # Comment this out if no https required
ProxyPreserveHost    On
SSLProxyVerify none
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off

ProxyPass /webmail https://localhost:8080/webmail/
ProxyPass / https://localhost:8080/webmail/
ProxyPassReverse / https://localhost:8080/webmail/

RedirectMatch ^/$ https://mail.example.com <co xml:id="CO37-1"/></programlisting>
<calloutlist>
<callout arearefs="CO37-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>C&#8217;est fait, vous pouvez accéder à Roundcube directement sur <link xl:href="https://mail.example.com">https://mail.example.com</link></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_finaliser_la_sécurisation_de_votre_serveur_de_mail">
<title>Finaliser la sécurisation de votre serveur de mail</title>
<simpara>Afin de mieux sécuriser votre serveur de mail, appliquez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>editez le fichier main.cf</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/postfix/main.cf</programlisting>
</listitem>
<listitem>
<simpara>Rechercher <literal>myhostname</literal> et replacer le texte par:</simpara>
<programlisting language="ini" linenumbering="unnumbered">myhostname = mail.example.com <co xml:id="CO38-1"/></programlisting>
<calloutlist>
<callout arearefs="CO38-1">
<para>Remplacer <literal>example.com</literal> par votre nom de domaine.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Redémarrez Postfix. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service postfix restart</programlisting>
</listitem>
<listitem>
<simpara>Vous pouvez ajouter une signature DKIM. Si vous utilisez ISPConfig, cette opération est effectuée automatiquement et cette étape est à sauter :</simpara>
<itemizedlist>
<listitem>
<simpara>DKIM est une méthode d&#8217;authentification du courrier électronique conçue pour détecter l&#8217;usurpation d&#8217;adresse électronique. Elle permet au serveur de réception de vérifier l&#8217;origine d&#8217;un courrier électronique en y apposant une signature numérique. La vérification de la signature est effectuée à l&#8217;aide de la clé publique du signataire publiée dans le DNS. Elle peut être utilisée pour détecter les courriels frauduleux.</simpara>
</listitem>
<listitem>
<simpara>Créez un nouveau répertoire pour stocker la clé DKIM et générez une nouvelle paire de clés DKIM à l&#8217;aide de l&#8217;utilitaire <literal>rspamadm</literal>. Dans l&#8217;exemple suivant, nous utilisons mail comme sélecteur DKIM. Il générera une paire de clés qui pourra être utilisée pour tous les domaines gérés par le serveur de messagerie:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir /var/lib/rspamd/dkim/
rspamadm dkim_keygen -d example.com -s default -k toto -b 2048 /var/lib/rspamd/dkim/example.com.dkim.key &gt; /var/lib/rspamd/dkim/example.com.dkim.key.pub <co xml:id="CO39-1"/></programlisting>
<calloutlist>
<callout arearefs="CO39-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Vous trouverez deux fichiers dans le répertoire :</simpara>
<itemizedlist>
<listitem>
<simpara><literal>mail.key</literal> - Le fichier de clé privée</simpara>
</listitem>
<listitem>
<simpara><literal>mail.pub</literal> - Le fichier de clé publique</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Editez le fichier dkim_domains.map et ajoutez:</simpara>
<screen linenumbering="unnumbered">example.com /var/lib/rspamd/dkim/example.com.dkim.key <co xml:id="CO40-1"/></screen>
<calloutlist>
<callout arearefs="CO40-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Editez le fichier <literal>dkim_selectors.map</literal> et ajoutez:</simpara>
<screen linenumbering="unnumbered">example.com default <co xml:id="CO41-1"/></screen>
<calloutlist>
<callout arearefs="CO41-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Ajoutez une entrée DNS avec le texte suivant:</simpara>
<screen linenumbering="unnumbered">default._domainkey.example.com. 3600  IN  TXT   "v=DKIM1; t=s; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAtBdWvMUlDmlAzZWTMhyheOmcewA4DFx+nMHI+3baOuJWt3/v7CdrX+egisWD5jwRzi/wN18kWR4kG/5rQKpIQLjurQrzqPO9i1Bub9O+VZWw0ldCAVNjKtkoFfgEErePMnKX/9Qjje+rqrH9oHSC+RK0z2Dvj3+WQIDAQAB" <co xml:id="CO42-1"/></screen>
<calloutlist>
<callout arearefs="CO42-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine et remplacez le contenu derrière p= par le contenu derrière p= présent dans le fichier /var/lib/rspamd/dkim/exaple.com.dkim.key.pub</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Ajouter si ce n&#8217;est pas le cas une entrée DNS pour le SPF:</simpara>
<screen linenumbering="unnumbered">v=spf1 mx a a:mail.example.com a:mail.other.example.com  include:mail.toto.com -all <co xml:id="CO43-1"/></screen>
<calloutlist>
<callout arearefs="CO43-1">
<para>remplacez example.com par votre nom de domaine. Vous pouvez
rajouter autant d&#8217;entrée <literal>a:</literal> ou <literal>include:</literal> que nécessaires si
vous avez des serveur de mail secondaires qui peuvent relayer des
mails pour ce domaine. La valeur -all interdira tout autre domaine
ou addresse IP à envoyer des mails</para>
</callout>
</calloutlist>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Vous pouvez le tester en allant sur le site <link xl:href="https://mxtoolbox.com/diagnostic.aspx">MxToolbox</link>.</simpara>
<itemizedlist>
<listitem>
<simpara>Entrez le nom de host de votre serveur de mail: <literal>mail.example.com</literal> .</simpara>
</listitem>
<listitem>
<simpara>cliquez sur <literal>test Email Server</literal></simpara>
</listitem>
<listitem>
<simpara>Tout doit être correct sauf éventuellement le reverse DNS qui doit être configuré pour pointer vers <literal>mail.example.com</literal> .</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Testez votre email sur le site <link xl:href="https://www.phishingscorecard.com/">Phishing Scoreboard</link></simpara>
<itemizedlist>
<listitem>
<simpara>Entrez votre adresse mail: <literal>admin@example.com</literal></simpara>
</listitem>
<listitem>
<simpara>Entrez votre nom de domaine: <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara>Entrez votre clé dkim: <literal>default</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Enfin, vous pouvez tester votre statut de spammer potentiel en envoyant allant sur le site <link xl:href="https://www.mail-tester.com/">Newsletter Spam test</link></simpara>
<itemizedlist>
<listitem>
<simpara>suivez les instructions (envoi d&#8217;un email à l&#8217;adresse donnée)</simpara>
</listitem>
<listitem>
<simpara>le site vous donnera des informations intéressantes sur la configuration du serveur et des informations complémentaires liées au contenu du mail. Pour ces dernières ne pas en tenir compte.</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_surveillance_du_statut_de_spammer">
<title>Surveillance du statut de Spammer</title>
<simpara>Il est nécessaire aujourd&#8217;hui de surveiller le statut de votre serveur de mail et de vérifier notamment si votre configuration SPF, DKIM et DMARC est correctement comprise par les serveurs de mails les plus connus comme Gmail, Yahoo, Hotmail &#8230;&#8203;</simpara>
<simpara>Pour cela un peu de configuration est nécessaire.</simpara>
<simpara>En premier, il faut créer un compte:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez sur le site <link xl:href="https://dmarcian.com">Dmarcian</link></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Sign up Free</literal></simpara>
</listitem>
<listitem>
<simpara>Choisissez votre région, <literal>Europe</literal> par exemple.</simpara>
</listitem>
<listitem>
<simpara>Enregistrez votre compte (mail, mot de passe) et votre nom de domaine <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara>notez bien l&#8217;adresse email qui va vous être donnée par dmarcian de la forme <literal>xyzabcd@ag.dmarcian.eu</literal> pour la réception de messages de type abuse te de la forme <literal>xyzabcd@fr.dmarcian.eu</literal> pour des forensic. Notez bien ces deux adresses.</simpara>
</listitem>
</orderedlist>
<simpara>Ensuite, vous devez modifier votre configuration DMARC:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans <literal>DNS</literal> de votre serveur de domaine principal</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez le menu <literal>Zones</literal> puis le domaine <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara>Choisissez l&#8217;onglet <literal>Records</literal> et éditez l&#8217;entrée <literal>TXT</literal> nommée _dmarc</simpara>
</listitem>
<listitem>
<simpara>modifiez le champ <literal>Text</literal> avec : <literal>v=DMARC1;p=reject;sp=quarantine;pct=100;rua=mailto:abuse@example.com;ruf=mailto:forensic@example.com</literal>. On remplacera bien le domaine <literal>example.com</literal> par son propre domaine.</simpara>
</listitem>
<listitem>
<simpara>Allez ensuite dans <literal>Email</literal></simpara>
</listitem>
<listitem>
<simpara>Allez dans le menu <literal>Email Forward</literal></simpara>
</listitem>
<listitem>
<simpara>cliquez sur  <literal>Add new Email Forward</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez dans <literal>Email</literal> la valeur <literal>abuse</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez dans Destination Email sur 2 lignes l&#8217;adresse de votre mail de réception interne et l&#8217;adresse mail qui vous a été fournie par <literal>dmarcian.com</literal> pour l&#8217;adresse abuse ( de la forme <literal>xyzabcd@ag.dmarcian.eu</literal> )</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>cliquez sur  <literal>Add new Email Forward</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez dans <literal>Email</literal> la valeur <literal>forensic</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez dans Destination Email sur 2 lignes l&#8217;adresse de votre mail de réception interne et l&#8217;adresse mail qui vous a été fournie par <literal>dmarcian.com</literal> pour l&#8217;adresse forensic ( de la forme <literal>xyzabcd@fr.dmarcian.eu</literal> )</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
<listitem>
<simpara>le site <literal>dmarcian.com</literal> va commencer à recevoir tous les comptes rendus de mails refusés par les destinataires de messagerie et élaborer des statistiques ainsi que des comptes rendus que vous pourrez consulter sur votre compte.</simpara>
</listitem>
</orderedlist>
<simpara>Il est intéressant de vérifier votre statut de spammer en vérifiant les différentes blacklist qui existent.</simpara>
<simpara>Pour cela allez sur le site <link xl:href="https://mxtoolbox.com/blacklists.aspx">Email Blacklist Check</link> entrez votre nom de domaine <literal>example.com</literal> et cliquez sur le bouton <literal>Blacklist Check</literal>.</simpara>
<simpara>Tous les sites doivent indiquer que votre domaine n&#8217;est pas blacklisté.</simpara>
</section>
<section xml:id="_création_de_lautoconfig_pour_thunderbird_et_android">
<title>Création de l’autoconfig pour Thunderbird et Android</title>
<simpara>La procédure est utilisé par Thunderbird et Android pour configurer automatiquement les paramètres de la messagerie.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>autoconfig</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>autoconfig</literal>.</simpara>
</listitem>
<listitem>
<simpara>Mettre dans <literal>Auto-SubDomain</literal> la valeur <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;FilesMatch "^.+\.xml$"&gt;
        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost" <co xml:id="CO44-1"/>
&lt;/FilesMatch&gt;

&lt;FilesMatch "^.+\.json$"&gt;
        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost" <co xml:id="CO44-2"/>
&lt;/FilesMatch&gt;

AddHandler application/x-httpd-php .php .xml .json

&lt;IfModule mod_speling.c&gt;
    CheckCaseOnly on
    CheckSpelling on
&lt;/IfModule&gt;</programlisting>
<calloutlist>
<callout arearefs="CO44-1 CO44-2">
<para>Mettez bien ici la version de PHP que vous avez choisi. Dans l&#8217;exemple c&#8217;est la 8.2</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Sauver.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Editez le fichier le fichier <literal>/etc/php/8.2/fpm/pool.d/www.conf</literal> (mettez votre version choisie à la place de 8.2).</simpara>
</listitem>
<listitem>
<simpara>Dans le fichier, recherchez <literal>security.limit_extension</literal> et ajoutez:</simpara>
</listitem>
</orderedlist>
<screen>security.limit_extensions = .php .php3 .php4 .php5 .php7 .xml .json</screen>
<orderedlist numeration="arabic">
<listitem>
<simpara>Dans le répertoire <literal>/var/www/autoconfig.&lt;example.com&gt;/autoconfig/</literal> créer un répertoire mail. Lui donner les permissions 755 et affecter les mêmes possesseurs que pour autres fichiers du répertoire. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/www/autoconfig.example.com <co xml:id="CO45-1"/>
mkdir -p autoconfig/mail
chmod 755 autoconfig/mail
chown web1:client0 autoconfig/mail <co xml:id="CO45-2"/></programlisting>
<calloutlist>
<callout arearefs="CO45-2">
<para>remplacer web1:client0 par les permissions du répertoire <literal>/var/www/autoconfig.example.com</literal></para>
</callout>
<callout arearefs="CO45-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>A l’intérieur de ce répertoire, Editez un fichier <literal>config-v1.1.xml</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi autoconfig/mail/config-v1.1.xml</programlisting>
</listitem>
<listitem>
<simpara>Y coller:</simpara>
<programlisting language="xml" linenumbering="unnumbered">&lt;?php
header('Content-Type: application/xml');
?&gt;
&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;clientConfig version="1.1"&gt;
 &lt;emailProvider id="example.com"&gt; <co xml:id="CO46-1"/>
   &lt;domain&gt;example.com&lt;/domain&gt;  <co xml:id="CO46-2"/>
   &lt;displayName&gt;Example Mail&lt;/displayName&gt; <co xml:id="CO46-3"/>
   &lt;displayShortName&gt;Example&lt;/displayShortName&gt; <co xml:id="CO46-4"/>
   &lt;incomingServer type="imap"&gt;
     &lt;hostname&gt;mail.example.com&lt;/hostname&gt; <co xml:id="CO46-5"/>
     &lt;port&gt;993&lt;/port&gt;
     &lt;socketType&gt;SSL&lt;/socketType&gt;
     &lt;authentication&gt;password-cleartext&lt;/authentication&gt;
     &lt;username&gt;%EMAILADDRESS%&lt;/username&gt;
   &lt;/incomingServer&gt;
   &lt;incomingServer type="pop3"&gt;
     &lt;hostname&gt;mail.example.com&lt;/hostname&gt; <co xml:id="CO46-6"/>
     &lt;port&gt;995&lt;/port&gt;
     &lt;socketType&gt;SSL&lt;/socketType&gt;
     &lt;authentication&gt;password-cleartext&lt;/authentication&gt;
     &lt;username&gt;%EMAILADDRESS%&lt;/username&gt;
   &lt;/incomingServer&gt;
   &lt;outgoingServer type="smtp"&gt;
     &lt;hostname&gt;mail.example.com&lt;/hostname&gt; <co xml:id="CO46-7"/>
     &lt;port&gt;465&lt;/port&gt;
     &lt;socketType&gt;SSL&lt;/socketType&gt;
     &lt;authentication&gt;password-cleartext&lt;/authentication&gt;
     &lt;username&gt;%EMAILADDRESS%&lt;/username&gt;
   &lt;/outgoingServer&gt;
   &lt;outgoingServer type="smtp"&gt;
     &lt;hostname&gt;mail.example.com&lt;/hostname&gt; <co xml:id="CO46-8"/>
     &lt;port&gt;587&lt;/port&gt;
     &lt;socketType&gt;STARTTLS&lt;/socketType&gt;
     &lt;authentication&gt;password-cleartext&lt;/authentication&gt;
     &lt;username&gt;%EMAILADDRESS%&lt;/username&gt;
   &lt;/outgoingServer&gt;
 &lt;/emailProvider&gt;
&lt;/clientConfig&gt;</programlisting>
<calloutlist>
<callout arearefs="CO46-1 CO46-2 CO46-5 CO46-6 CO46-7 CO46-8">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
<callout arearefs="CO46-3">
<para>mettre ici votre libellé long pour votre nom de messagerie</para>
</callout>
<callout arearefs="CO46-4">
<para>mettre ici un libellé court pour votre nom de messagerie</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Donner la permission en lecture seule et affecter les groupes d&#8217;appartenance. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 644 autoconfig/mail/config-v1.1.xml
chown web1:client0 autoconfig/mail/config-v1.1.xml <co xml:id="CO47-1"/></programlisting>
<calloutlist>
<callout arearefs="CO47-1">
<para>remplacer web1:client0 par les permissions du répertoire <literal>/var/www/autoconfig.example.com</literal></para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_dautodiscover_pour_outlook">
<title>Création d’autodiscover pour Outlook</title>
<simpara>Outlook utilise un autre mécanisme pour se configurer automatiquement. Il est basé sur l&#8217;utilisation du nom de sous-domaine <literal>autodiscover</literal>. Cette methode ne fonctionne pas avec les versions récentes de Outlook.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>autodiscover</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>autoconfig</literal>.</simpara>
</listitem>
<listitem>
<simpara>Mettre dans <literal>Auto-SubDomain</literal> la valeur <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;FilesMatch "^.+\.xml$"&gt;
        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost" <co xml:id="CO48-1"/>
&lt;/FilesMatch&gt;

&lt;FilesMatch "^.+\.json$"&gt;
        SetHandler "proxy:unix:/run/php/php8.2-fpm.sock|fcgi://localhost" <co xml:id="CO48-2"/>
&lt;/FilesMatch&gt;

AddHandler application/x-httpd-php .php .xml .json

&lt;IfModule mod_speling.c&gt;
    CheckCaseOnly on
    CheckSpelling on
&lt;/IfModule&gt;</programlisting>
<calloutlist>
<callout arearefs="CO48-1 CO48-2">
<para>Mettez bien ici la version de PHP que vous avez choisi. Dans l&#8217;exemple c&#8217;est la 8.2</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Sauver.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Editez le fichier le fichier <literal>/etc/php/8.2/fpm/pool.d/www.conf</literal> (mettez votre version choisie à la place de 8.2).</simpara>
</listitem>
<listitem>
<simpara>Dans le fichier, recherchez <literal>security.limit_extension</literal> et ajoutez:</simpara>
</listitem>
</orderedlist>
<screen>security.limit_extensions = .php .php3 .php4 .php5 .php7 .xml .json</screen>
<orderedlist numeration="arabic">
<listitem>
<simpara>Dans le répertoire <literal>/var/www/autoconfig.&lt;example.com&gt;/autoconfig/</literal>, créer un répertoire <literal>Autodiscover</literal>. Lui donner les permissions 755 et affecter les mêmes possesseurs que pour autres fichiers du répertoire. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/www/autoconfig.example.com <co xml:id="CO49-1"/>
mkdir -p autoconfig/Autodiscover/
chmod 755 autoconfig/Autodiscover/
chown web1:client0 autoconfig/Autodiscover/ <co xml:id="CO49-2"/></programlisting>
<calloutlist>
<callout arearefs="CO49-2">
<para>remplacer web1:client0 par les permissions du répertoire <literal>/var/www/autoconfig.example.com</literal></para>
</callout>
<callout arearefs="CO49-1">
<para>remplacez <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>A l’intérieur de ce répertoire, Editez un fichier <literal>Autodiscover.xml</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi autoconfig/Autodiscover/Autodiscover.xml</programlisting>
</listitem>
<listitem>
<simpara>Y coller:</simpara>
<programlisting language="xml" linenumbering="unnumbered">&lt;?php
$postData = file_get_contents('php://input'); //Autodiscover requests are HTTP posts with XML content
$xml = simplexml_load_string($postData);
$user = $xml-&gt;Request-&gt;EMailAddress; //copy the email address from the request into a variable

//set Content-Type
header("Content-Type: application/xml");
?&gt;
&lt;?php echo '&lt;?xml version="1.0" encoding="utf-8" ?&gt;'; ?&gt;
&lt;Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/responseschema/2006"&gt;
    &lt;Response xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a"&gt;
        &lt;Account&gt;
            &lt;AccountType&gt;email&lt;/AccountType&gt;
            &lt;Action&gt;settings&lt;/Action&gt;
            &lt;Protocol&gt;
                &lt;Type&gt;POP3&lt;/Type&gt;
                &lt;Server&gt;mail.example.com&lt;/Server&gt; <co xml:id="CO50-1"/>
                &lt;Port&gt;995&lt;/Port&gt;
                &lt;LoginName&gt;&lt;?php echo $user; ?&gt;&lt;/LoginName&gt;
                &lt;DomainRequired&gt;off&lt;/DomainRequired&gt;
                &lt;SPA&gt;off&lt;/SPA&gt;
                &lt;SSL&gt;on&lt;/SSL&gt;
                &lt;AuthRequired&gt;on&lt;/AuthRequired&gt;
                &lt;DomainRequired&gt;on&lt;/DomainRequired&gt;
            &lt;/Protocol&gt;
            &lt;Protocol&gt;
                &lt;Type&gt;IMAP&lt;/Type&gt;
                &lt;Server&gt;mail.example.com&lt;/Server&gt; <co xml:id="CO50-2"/>
                &lt;Port&gt;993&lt;/Port&gt;
                &lt;DomainRequired&gt;on&lt;/DomainRequired&gt;
                &lt;LoginName&gt;&lt;?php echo $user; ?&gt;&lt;/LoginName&gt;
                &lt;SPA&gt;off&lt;/SPA&gt;
                &lt;SSL&gt;on&lt;/SSL&gt;
                &lt;Encryption&gt;Auto&lt;/Encryption&gt;
                &lt;AuthRequired&gt;on&lt;/AuthRequired&gt;
            &lt;/Protocol&gt;
            &lt;Protocol&gt;
                &lt;Type&gt;SMTP&lt;/Type&gt;
                &lt;Server&gt;mail.example.com&lt;/Server&gt; <co xml:id="CO50-3"/>
                &lt;Port&gt;465&lt;/Port&gt;
                &lt;DomainRequired&gt;on&lt;/DomainRequired&gt;
                &lt;LoginName&gt;&lt;?php echo $user; ?&gt;&lt;/LoginName&gt;
                &lt;SPA&gt;off&lt;/SPA&gt;
                &lt;Encryption&gt;Auto&lt;/Encryption&gt;
                &lt;!-- if your server requires encryption other than SSL --&gt;
                &lt;AuthRequired&gt;on&lt;/AuthRequired&gt;
                &lt;UsePOPAuth&gt;on&lt;/UsePOPAuth&gt;
                &lt;SMTPLast&gt;off&lt;/SMTPLast&gt;
            &lt;/Protocol&gt;
        &lt;/Account&gt;
    &lt;/Response&gt;
&lt;/Autodiscover&gt;</programlisting>
<calloutlist>
<callout arearefs="CO50-1 CO50-2 CO50-3">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Changez les permissions comme pour le répertoire</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 644 autoconfig/Autodiscover/Autodiscover.xml
chown web1:client0 autoconfig/Autodiscover/Autodiscover.xml <co xml:id="CO51-1"/></programlisting>
<calloutlist>
<callout arearefs="CO51-1">
<para>remplacer web1:client0 par les permissions du répertoire <literal>/var/www/autoconfig.example.com</literal></para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointer votre navigateur sur le site <link xl:href="https://autodiscover.example.com/Autodiscover/Autodiscover.xml">https://autodiscover.example.com/Autodiscover/Autodiscover.xml</link>.</simpara>
</listitem>
<listitem>
<simpara>Le contenu du fichier xml doit s&#8217;afficher</simpara>
</listitem>
<listitem>
<simpara>Dans le répertoire <literal>/var/www/autoconfig.&lt;example.com&gt;/autoconfig/</literal>, Editez un fichier <literal>autodiscover.json</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi autoconfig/Autodiscover/autodiscover.json</programlisting>
</listitem>
<listitem>
<simpara>Y coller:</simpara>
<programlisting language="php" linenumbering="unnumbered">&lt;?php
header('Content-type: application/json');
echo '{"Protocol":"AutodiscoverV1","Url":"https://autodiscover.example.com/Autodiscover/Autodiscover.xml"}'; <co xml:id="CO52-1"/>
?&gt;</programlisting>
<calloutlist>
<callout arearefs="CO52-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Changez les permissions comme pour le répertoire</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 644 autoconfig/Autodiscover/autodiscover.json
chown web1:client0 autoconfig/Autodiscover/autodiscover.json <co xml:id="CO53-1"/>
cp -pr autoconfig/Autodiscover autoconfig/autodiscover</programlisting>
<calloutlist>
<callout arearefs="CO53-1">
<para>remplacer web1:client0 par les permissions du répertoire <literal>/var/www/autoconfig.example.com</literal></para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointer votre navigateur sur le site <link xl:href="https://autodiscover.example.com/autodiscover/autodiscover.json">https://autodiscover.example.com/autodiscover/autodiscover.json</link></simpara>
</listitem>
<listitem>
<simpara>Le contenu du fichier json doit s&#8217;afficher</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez faire aussi un test sur le <link xl:href="https://testconnectivity.microsoft.com">Testeur de connectivité Microsoft</link>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>choisissez: <literal>Découverte automatique Outlook</literal></simpara>
</listitem>
<listitem>
<simpara>cliquez sur <literal>suivant</literal></simpara>
</listitem>
<listitem>
<simpara>Entrez votre adresse de courrier: <literal>user@example.com</literal>, un domain: <literal>example\user</literal>, un mot de passe tiré au hazard, Cochez les deux cases en dessous.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>effectuer un test</literal></simpara>
</listitem>
<listitem>
<simpara>Le résultat doit être: <literal>Test de connectivité réussi</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_dune_boite_mail">
<title>Création d’une boite mail</title>
<simpara>Pour créer une boite de messagerie:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Aller dans la rubrique <literal>Email</literal>. Sélectionnez ensuite le menu <literal>Email Mailbox</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Mailbox</literal></simpara>
</listitem>
<listitem>
<simpara>Remplissez les champs suivants:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara><literal>Name:</literal> &#8592; mettez votre prénom et votre nom</simpara>
</listitem>
<listitem>
<simpara><literal>`Email:</literal> &#8592; saisir le &lt;mail_name&gt; <literal>mail_name@example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Password:</literal> &#8592; <link linkend="pass_gen">Saisissez un mot de passe généré</link> ou générez en un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password</literal> &#8592; saisissez une deuxième fois votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Quota (0 for unlimited):</literal> &#8592; mettez éventuellement un quota ou laissez 0 pour illimité.</simpara>
</listitem>
<listitem>
<simpara><literal>Spamfilter:</literal> &#8592; Sélectionnez <literal>Normal</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Dans l’onglet Backup:</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara><literal>Backup interval:</literal> Sélectionnez <literal>Daily</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Number of backup copies:</literal> Sélectionnez 1</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
<note>
<simpara>Notez que si vous créez une adresse mail nommée <literal>mail_name@example.com</literal>, vous pouvez utilisez toutes les variantes (nommées tag) derrière le caractère "+". Ainsi <literal>mail_name+nospam@example.com</literal> sera bien redirigé vers votre boite et l&#8217;extension <literal>+nospam</literal> vous permettre de trier automatiquement les mails que vous ne voulez pas recevoir.</simpara>
</note>
<note>
<simpara>Il est possible de changer ce caractère spécial en le modifiant dans le fichier <literal>/etc/postfix/main.cf</literal> sur la ligne commençant par <literal>recipient_delimiter</literal>.</simpara>
</note>
</section>
<section xml:id="_configuration_de_votre_client_de_messagerie">
<title>Configuration de votre client de messagerie.</title>
<simpara>Saisir l&#8217;adresse mail et votre mot de passe doit suffire pour configurer automatiquement votre client de messagerie.</simpara>
<simpara>Si vous avez besoin de configurer votre client manuellement, voici les informations à saisir:</simpara>
<informaltable frame="all" rowsep="1" colsep="1">
<tgroup cols="2">
<colspec colname="col_1" colwidth="50*"/>
<colspec colname="col_2" colwidth="50*"/>
<thead>
<row>
<entry align="left" valign="top">Paramètre</entry>
<entry align="left" valign="top">Valeur</entry>
</row>
</thead>
<tbody>
<row>
<entry align="left" valign="top"><simpara>Type de serveur</simpara></entry>
<entry align="left" valign="top"><simpara>IMAP</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Nom de serveur IMAP</simpara></entry>
<entry align="left" valign="top"><simpara>mail.example.com</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Nom d&#8217;utilisateur IMAP</simpara></entry>
<entry align="left" valign="top"><simpara><link xl:href="mailto:user@example.com">user@example.com</link></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Port IMAP</simpara></entry>
<entry align="left" valign="top"><simpara>993</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Sécurité IMAP</simpara></entry>
<entry align="left" valign="top"><simpara>SSL/TLS</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Authentification IMAP</simpara></entry>
<entry align="left" valign="top"><simpara>Normal Password</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Nom de serveur SMTP</simpara></entry>
<entry align="left" valign="top"><simpara>mail.example.com</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Nom d&#8217;utilisateur SMTP</simpara></entry>
<entry align="left" valign="top"><simpara><link xl:href="mailto:user@example.com">user@example.com</link></simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Port SMTP</simpara></entry>
<entry align="left" valign="top"><simpara>465</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Sécurité SMTP</simpara></entry>
<entry align="left" valign="top"><simpara>SSL/TLS</simpara></entry>
</row>
<row>
<entry align="left" valign="top"><simpara>Authentification SMTP</simpara></entry>
<entry align="left" valign="top"><simpara>Normal Password</simpara></entry>
</row>
</tbody>
</tgroup>
</informaltable>
</section>
<section xml:id="_transfert_de_vos_boites_mails_imap">
<title>Transfert de vos boites mails IMAP</title>
<simpara>Si vous faites une migration d&#8217;un ancien serveur vers un nouveau serveur vous souhaiterez probablement migrer aussi vos boites mail.</simpara>
<simpara>La procédure ci dessous est à appliquer pour chaque compte mail IMAP. Elle peut facilement être scriptée.</simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Téléchargez imapsync du repository. Tapez:</simpara>
<screen>wget https://raw.githubusercontent.com/imapsync/imapsync/master/imapsync
chmod 755 imapsync</screen>
</listitem>
<listitem>
<simpara>Installez les packages perls éventuellement manquants:</simpara>
<screen>apt install libregexp-common-perl libfile-tail-perl libsys-meminfo-perl libunicode-string-perl libmail-imapclient-perl libio-tee-perl libio-socket-inet6-perl libfile-copy-recursive-perl libencode-imaputf7-perl</screen>
</listitem>
<listitem>
<simpara>Créez deux fichiers temporaires qui contiennent les mots de passe du 1er et  2eme serveur. Tapez:</simpara>
<screen>echo "passwdsrc" &gt; secretsrc <co xml:id="CO54-1"/>
echo "passwddst" &gt; secretdst <co xml:id="CO54-2"/>
chmod 600 secretsrc
chmod 600 secretdst</screen>
<calloutlist>
<callout arearefs="CO54-1">
<para>passwdsrc est à remplacer par le mot de passe du compte sur le serveur source</para>
</callout>
<callout arearefs="CO54-2">
<para>passwddst est à remplacer par le mot de passe du compte sur le serveur destination</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Nous pouvons maintenant lancer la commande. Tapez:</simpara>
<screen>./imapsync --host1 imap.examplesrc.com --user1 usersrc@examplesrc.com --passfile1 secretsrc --host2 imap.exampledst.com --user2 userdst@exampledst.com --passfile2 secretdst --addheader</screen>
</listitem>
<listitem>
<simpara>Un fois la synchronisation effectuée, vous pouvez supprimer le fichier des mots de passe. tapez:</simpara>
<screen>rm secretsrc
rm secretdst</screen>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_de_docker_et_des_outils_associés">
<title>Installation de Docker et des outils associés</title>
<simpara>Le logiciel <literal>Docker</literal> est une technologie de conteneurisation qui permet la création et l&#8217;utilisation de conteneurs Linux.
En clair, <literal>Docker</literal> permet d&#8217;installer et de configurer rapidement toute une appli web complexe dans un environnement isolé et avec tout son échosystème de bibliothèques logicielles spécifiques.</simpara>
<simpara>Il est ainsi possible d&#8217;effectuer rapidement des installations, de suivre des mises à jours et d&#8217;isoler ces environnements du système principal.</simpara>
<section xml:id="_a_propos_des_raspberry_pi">
<title>A propos des Raspberry Pi</title>
<warning>
<simpara>Les raspberry utilisent une architecture ARM, tous les containeurs ne seront pas forcément compatibles "out of the box" ( Exemple pour MySQL). Sur le <link xl:href="https://hub.docker.com/">Docker Hub</link>, il faut choisir par un Raspberry Pi 4 ou 5 en Ubuntu une architecture de type ARM64 et pour un Raspberry Pi 3 en Raspbian une architecture de type ARM.</simpara>
</warning>
</section>
<section xml:id="_installation_de_docker">
<title>Installation de Docker</title>
<simpara>L&#8217;installation de Docker est relativement simple.</simpara>
<simpara>Il faut suivre les étapes suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Désinstallez les éventuelles anciennes versions de docker. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt remove --purge docker docker.io containerd runc docker-doc docker-compose podman-docker <co xml:id="CO55-1"/></programlisting>
<calloutlist>
<callout arearefs="CO55-1">
<para>docker-engine n&#8217;existe pas dans une distribution ubuntu. C&#8217;est à enlever.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered"># Add Docker's official GPG key:
apt-get update
apt-get install ca-certificates curl
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc
chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian \
  $(. /etc/os-release &amp;&amp; echo "$VERSION_CODENAME") stable" | \
  tee /etc/apt/sources.list.d/docker.list &gt; /dev/null</programlisting>
</listitem>
<listitem>
<simpara>Une fois installé avec succès, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update</programlisting>
</listitem>
<listitem>
<simpara>Si vous obtenez une erreur c&#8217;est que vous avez ajouté un repository qui n&#8217;est pas suppporté par Docker. Vérifiez les fichier <literal>/etc/apt/sources.list</literal>.</simpara>
</listitem>
<listitem>
<simpara>Une fois mis à jour avec succès, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</programlisting>
</listitem>
<listitem>
<simpara>vérifiez que votre installation de <literal>Docker</literal> est fonctionnelle. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run hello-world</programlisting>
</listitem>
<listitem>
<simpara>Cette commande exécute un conteneur simple. Si aucune erreur n’apparaît c&#8217;est que l&#8217;installation est réussie.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_docker_swarm">
<title>Installation de docker swarm</title>
<simpara>Docker contient nativement le mode Swarm afin de gérer un ensemble de Docker Engines.
Cette installation est optionnelle puisque l&#8217;on peut faire fonctionner Docker sans cette Option.</simpara>
<simpara>Il y a deux types de machines: les <emphasis role="strong">Managers</emphasis> et les <emphasis role="strong">Workers</emphasis>.</simpara>
<simpara>Les managers : Ce sont les nodes gestionnaires de votre cluster. Ils distribuent les tâches aux nodes workers et ils effectuent également les fonctions d&#8217;orchestration et de gestion.</simpara>
<simpara>Les workers : Ils vont exécuter les tâches confiées par les managers. Un agent s&#8217;exécute sur chaque nœud et rend compte des tâches qui lui sont affectées. Il informe ainsi les nodes managers de l&#8217;état des tâches affectées.</simpara>
<simpara>Il faut suivre les étapes suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker swarm init</programlisting>
</listitem>
<listitem>
<simpara>Le résultat de la commande donne la commande <literal>docker swarm join</literal> a exécuter sur un "worker"  pour lui faire rejoindre le "swarm". A noter que le "manager" que nous venons de creer est aussi un worker. De ce fait, un swarm peut être installé de façon standalone sur un VPS.</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant vérifier l&#8217;état de votre cluster. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker node ls</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_choix_des_images_docker">
<title>Choix des images docker</title>
<simpara>Les images docker sont accessibles sur le <link xl:href="https://hub.docker.com/">Docker Hub</link>.</simpara>
<simpara>Mais voilà, c&#8217;est un peu la jungle. Un bon moyen de trouver des images à jour d&#8217;un point de vue sécurité et non compromises est de ne sélectionner que des images "Docker Certified" ou "Verified Publisher" ou "Official Images".</simpara>
<simpara>Du moins on est sûr que ces images ont été à minima vérifiées par les équipes Docker.</simpara>
<simpara>Pour mémoire: <emphasis role="strong">Le nombre de chargement d&#8217;une image n&#8217;est pas un gage de qualité !</emphasis></simpara>
<simpara>Si vous n&#8217;utilisez pas une image du type mentionné ci dessus, l&#8217;accès facile au fichier Dockerfile est un gage de qualité et de transparence. En tout cas, il vous sera facilement possible de regarder comment l&#8217;image est construite et quels sont les package dockers de base et si ces packages dockers de base sont récents et certifiés.</simpara>
<simpara>Pour les plateformes de type Raspberry, il faut bien vérifier que l&#8217;image docker que vous chargez est compatible de votre plateforme. Sur Docker Hub, vous devez allez sur l&#8217;onglet Tag de votre package et vérifier que le champ OS/ARCH contient bien votre plateforme.</simpara>
<simpara>Pour un Raspberry Pi 4 ou 5 ce doit être: <literal>Linux/arm64</literal></simpara>
<simpara>Pour un Raspberry Pi 3 ce doit être: <literal>Linux/arm</literal></simpara>
<simpara>Par exemple pour les docker de <literal>Yacht</literal> et de <literal>Portainer</literal> décrits ci après, on peut voir que les containers sont multiplateforme et conviennent très bien pour de l&#8217;Intel ou de l&#8217;ARM.</simpara>
</section>
<section xml:id="_considérations_de_sécurité">
<title>Considérations de sécurité</title>
<simpara>A propos de l&#8217;export des ports sous docker.</simpara>
<simpara>Par défaut lorsque vous lancez un container docker, l&#8217;option pour exporter un port de votre docker vers votre machine est <literal>-p dst_port:src_port</literal>.
Si vous indiquez uniquement le port de destination comme par exemple dans <literal>-p 80:8080</literal> qui exporte le port 8080 de votre docker vers le port 80 de votre machine réelle, vous exporter vers le port 80 de l&#8217;adresse IP 0.0.0.0 ce qui en pratique indique que vous n&#8217;utilisez pas les règles du firewall; le port est exporté automatiquement sur toutes les interfaces.</simpara>
<simpara>De ce fait, vous exposez tous les ports interne de votre système docker à tout internet et le firewall ne bloque rien pour ces ports.</simpara>
<simpara>Il est donc indispensable pour une machine directement exposée sur internet d&#8217;indiquer l&#8217;adresse du loopback en indiquant systématiquement l&#8217;adresse IP soit <literal>-p 127.0.0.1:80:8080</literal>. Ainsi les règles du firewall sont appliquées et vous pourrez par votre configuration d&#8217;ISPconfig n&#8217;exposer que les ports et noms de domaines nécessaires.</simpara>
<important>
<simpara>Dans tout ce qui suit nous omettrons d&#8217;utiliser cette adresse en 127.0.0.1 . Pensez bien donc à ajouter cette adresse systématiquement pour un serveur présent sur le web !</simpara>
</important>
</section>
<section xml:id="_mise_à_jour_automatique_des_images">
<title>Mise à jour automatique des images</title>
<simpara>Vos images docker peuvent être mise à jour automatiquement si vous les avez installés à partir du docker hub ou de n&#8217;importe quel autre repository compatible.</simpara>
<simpara>Un outil automatise cette mise à jour c&#8217;est <link xl:href="https://github.com/containrrr/watchtower">watchtower</link>.</simpara>
<simpara>Pour l&#8217;installer, rien de plus simple:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -d --name watchtower -v /var/run/docker.sock:/var/run/docker.sock containrrr/watchtower --cleanup --interval 86400</programlisting>
</listitem>
<listitem>
<simpara>l&#8217;option cleanup effectue le ménage des images inutiles et interval indique en secondes le temps à attendre entre deux vérifications (ici 24h)</simpara>
</listitem>
<listitem>
<simpara>si vous voulez vous connecter à un repository avec un login et un mot de passe, vous pouvez ajouter au lancement du docker les options suivantes:</simpara>
<programlisting language="bash" linenumbering="unnumbered">-e REPO_USER=username -e REPO_PASS=password</programlisting>
</listitem>
<listitem>
<simpara>Si vous désirez ne mettre à jour que certains containers, vous pouvez passer l&#8217;option <literal>--label-enable</literal> et ensuite désigner les container à mettre à jour en leur passant le label <literal>-l com.centurylinklabs.watchtower.enable=true</literal></simpara>
</listitem>
<listitem>
<simpara>Enfin dernière option très utile la possibilité de décider de la période de mise à jour à l&#8217;aide d&#8217;une expression de type cron. Comme exemple: <literal>--schedule "0 0 4 * * *"</literal> mettra à jour à 0h0 tous les 4 de chaque mois.</simpara>
</listitem>
<listitem>
<simpara>Enfin lorsqu&#8217;une mise à jour s&#8217;effectue vous pouvez être notifié par mail, slack ou d&#8217;autres outils tels que shoutrrr. Se référer à la <link xl:href="https://containrrr.dev/watchtower/notifications/">documentation</link></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_surveillance_et_redémarrage_de_container">
<title>Surveillance et redémarrage de container</title>
<simpara>Il peut arriver que certains container s&#8217;arrêtent brusquement suite à un bug.</simpara>
<simpara>Autoheal est unn outil qui redémarre ces container automatiquement en se basant sur l&#8217;attribut healthcheck des containers.</simpara>
<simpara>La documentation est <link xl:href="https://github.com/willfarrell/docker-autoheal">ici</link>.</simpara>
<simpara>Pour l&#8217;installer:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -d --name autoheal --restart=always -e AUTOHEAL_CONTAINER_LABEL=all -v /var/run/docker.sock:/var/run/docker.sock willfarrell/autoheal</programlisting>
</listitem>
<listitem>
<simpara>La variable d&#8217;environnement AUTOHEAL_CONTAINER_LABEL indique que tous les containers seront vérifiés. Si vous souhaitez uniquement indiquer les container à vérifier, il vous faut ajouter pour les container concernés l&#8217;otion <literal>-l autoheal=true</literal></simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_configuration_de_docker_mirror">
<title>Configuration de Docker-mirror</title>
<simpara>L&#8217;outil Docker-mirror est un système de cache de fichier Dockers.</simpara>
<simpara>Si vous avez plusieurs machines utilisant docker sur votre réseau, les déploiements et les mises à jour seront considérablement accélérées par l&#8217;utilisation de ce système de cache.</simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Obtenez une configuration initiale pour le fichier <literal>config.yml</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -it --rm --entrypoint cat registry:2 /etc/docker/registry/config.yml &gt; /etc/docker-mirror.yml</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez ceci dans le fichier <literal>config.yml</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/docker-mirror-1.yml</programlisting>
</listitem>
<listitem>
<simpara>Dans ce fichier, ajoutez les lignes suivantes :</simpara>
<screen linenumbering="unnumbered">proxy:
      remoteurl: https://registry-1.docker.io</screen>
</listitem>
<listitem>
<simpara>Démarrez ensuite le service docker. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -d --restart=always -p 5000:5000 --name docker-registry-proxy-1 -v /etc/docker-mirror-1.yml:/etc/docker/registry/config.yml registry:2</programlisting>
</listitem>
</orderedlist>
<simpara>Si vous avez plusieurs miroirs à configurer, il faut créer un proxy sur chaque. Ainsi si vous voulez créer un miroir pour ghcr.io il vous faudra créer une autre fichier docker-mirror-2.yml avec la deuxième adresse remote et lancer le tout par:</simpara>
<simpara>+</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -d --restart=always -p 5001:5000 --name docker-registry-proxy-2 -v /etc/docker-mirror-2.yml:/etc/docker/registry/config.yml registry:2</programlisting>
<simpara>Et ainsi de suite pour chaque proxy que vous voulez mettre en place.</simpara>
<simpara>Sur le poste client, soit passez l&#8217;option --registry-mirror lorsque vous lancez le démon <literal>dockerd</literal> ou sinon éditez le fichier <literal>/etc/docker/daemon.json</literal> et ajoutez la clé <literal>registry-mirrors</literal> pour rendre le changement persistant:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le poste client</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/docker/daemon.json</programlisting>
</listitem>
<listitem>
<simpara>Dans le fichier, ajoutez:</simpara>
<screen linenumbering="unnumbered">{
  "insecure-registries" : ["docker.example.com:5000" ], <co xml:id="CO56-1"/>
  "registry-mirrors": ["http://docker.example.com:5000"] <co xml:id="CO56-2"/>
}</screen>
<calloutlist>
<callout arearefs="CO56-1 CO56-2">
<para>remplacer <literal>docker.example.com</literal> par le nom ou l&#8217;adresse ip de votre cache docker. Si vous en avez plusieurs vous devez tous les lister en les séparant par des virgules.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Sauvegarder le fichier et redémarrez le démon docker. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart docker</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_outils_web_de_gestion_des_containers">
<title>Outils web de gestion des containers</title>
<section xml:id="_installation_de_yacht">
<title>Installation de Yacht</title>
<simpara>Yacht est un outil d&#8217;administration de vos instances docker sous forme de site web. Yacht est très facile d&#8217;utilisation mais manque de possibilités du moins dans la version actuelle. Si vous souhaitez administrer de façon plus avancée vos instances docker, il est conseillé d&#8217;utiliser Portainer.</simpara>
<simpara>Yacht s’installe comme un conteneur docker pour simplifier son déploiement.</simpara>
<simpara>Pour la création du site web, il faut suivre les étapes suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans ISPConfig dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>yacht</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>yacht</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>yacht</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# yacht httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:8061/
ProxyPassReverse / http://localhost:8061/

RedirectMatch ^/$ https://yacht.example.com <co xml:id="CO57-1"/></programlisting>
<calloutlist>
<callout arearefs="CO57-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Puis sur votre serveur, <link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker volume create yacht_data
docker run -d -p 8061:8000 --name=yacht -v /var/run/docker.sock:/var/run/docker.sock --restart=always -v yacht_data:/config selfhostedpro/yacht</programlisting>
</listitem>
<listitem>
<simpara>Ouvrez un navigateur et pointez sur <link xl:href="http://yacht.example.com">http://yacht.example.com</link></simpara>
</listitem>
<listitem>
<simpara>L&#8217;utilisateur par défaut est login: <literal>admin@yacht.local</literal> et mot de passe: <literal>pass</literal>.</simpara>
</listitem>
<listitem>
<simpara>Une fois loggué, Cliquez sur l&#8217;utilisateur en haut à droite et <literal>user</literal>.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>change password</literal></simpara>
</listitem>
<listitem>
<simpara>Modifier votre Email de login et saisissez un nouveau mot de passe.</simpara>
</listitem>
<listitem>
<simpara>Cliquez ensuite sur <literal>Templates</literal> dans la barre vertical de gauche puis sur <literal>New templates</literal></simpara>
</listitem>
<listitem>
<simpara>Copiez la suggestion de template proposée.</simpara>
</listitem>
<listitem>
<simpara>Saisissez un titre <literal>Yacht</literal> dans le champ <literal>Title</literal> puis collez l&#8217;URL du json dans le champ <literal>URL</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur Submit.</simpara>
</listitem>
<listitem>
<simpara>Allez dans <literal>Templates</literal> &#8594; <literal>View Templates</literal>.</simpara>
</listitem>
<listitem>
<simpara>cliquez sur <literal>Yacht</literal>; vous avez maintenant accès à une foule de templates.</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant administrer vos machines docker. Référez vous à la documentation de <link xl:href="https://yacht.sh/Pages/dashboard/">Yacht</link> pour installer de nouvelles machines docker</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="yacht_container_updt">
<title>Upgrade d&#8217;un container dans Yacht</title>
<simpara>Plutôt que d’effectuer des mises à jour automatiques avec Watchtower, vous préférerez mettre à jour manuellement avec Yacht.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Ouvrez un navigateur et pointez sur <link xl:href="http://yacht.example.com">http://yacht.example.com</link></simpara>
</listitem>
<listitem>
<simpara>Logguez vous en tant qu'`admin`</simpara>
</listitem>
<listitem>
<simpara>Allez  dans l&#8217;onglet <literal>Applications</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur le bouton <literal>Updates</literal></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_yacht">
<title>Upgrade de Yacht</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal>
Vous pouvez aussi appliquer la procédure de mise à jour des <link linkend="port_container_updt">containers à l&#8217;aide de <literal>Portainer</literal></link></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de Yacht. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull selfhostedpro/yacht
docker stop yacht
docker rm yacht
docker run -d -p 8061:8000 --name=yacht -v /var/run/docker.sock:/var/run/docker.sock --restart=always -v yacht_data:/config selfhostedpro/yacht</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_portainer">
<title>Installation de Portainer</title>
<simpara>Portainer est un outil d&#8217;administration de vos instances docker sous forme de site web. Portainer est plus complexe à utiliser que Yacht, mais offre cependant beaucoup plus de possibilités.</simpara>
<simpara>Portainer s’installe comme un conteneur docker pour simplifier son déploiement. Portainer gère une bonne partie des éléments de docker : conteneurs, images, volumes, réseaux, utilisateurs</simpara>
<simpara>Pour la création du site web, il faut suivre les étapes suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans ISPConfig dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>portainer</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>portainer</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>portainer</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# portainer httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:9050/
ProxyPassReverse / http://localhost:9050/

RedirectMatch ^/$ https://portainer.example.com <co xml:id="CO58-1"/></programlisting>
<calloutlist>
<callout arearefs="CO58-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Puis sur votre serveur, <link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker volume create portainer_data
docker run -d -p 9050:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</programlisting>
</listitem>
<listitem>
<simpara>Ouvrez un navigateur et pointez sur <link xl:href="http://portainer.example.com">http://portainer.example.com</link></simpara>
</listitem>
<listitem>
<simpara>Créez votre utilisateur de <literal>admin</literal> avec un mot de passe sécurisé.</simpara>
</listitem>
<listitem>
<simpara>Ajoutez un endpoint <literal>Local</literal></simpara>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant administrer vos machines docker. Référez vous à la documentation de <link xl:href="https://documentation.portainer.io/v2.0/stacks/create/">portainer</link> pour installer de nouvelles machines docker</simpara>
</listitem>
</orderedlist>
<simpara>Portainer offre la possibilité d&#8217;installer des templates par défaut. Vous pouvez soit garder le repository par défault : <literal><link xl:href="https://raw.githubusercontent.com/portainer/templates/master/templates-2.0.json">https://raw.githubusercontent.com/portainer/templates/master/templates-2.0.json</link></literal> ou utiliser un autre repository comme: <literal><link xl:href="https://raw.githubusercontent.com/Qballjos/portainer_templates/master/Template/template.json">https://raw.githubusercontent.com/Qballjos/portainer_templates/master/Template/template.json</link></literal>:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>allez sur votre site web portainer.</simpara>
</listitem>
<listitem>
<simpara>puis dans le menu Settings</simpara>
</listitem>
<listitem>
<simpara>Dans la zone <literal>App Templates</literal> saisissez le repository de votre choix dans le champ <literal>URL</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save Settings</literal></simpara>
</listitem>
<listitem>
<simpara>retournez dans le menu <literal>App Templates</literal>; vos nouveau templates sont maintenant affichés.</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="port_container_updt">
<title>Upgrade d&#8217;un container dans Portainer</title>
<simpara>Plutôt que d’effectuer des mises à jour automatiques avec Watchtower, vous préférerez mettre à jour manuellement avec Portainer.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Ouvrez un navigateur et pointez sur <link xl:href="http://portainer.example.com">http://portainer.example.com</link></simpara>
</listitem>
<listitem>
<simpara>Logguez vous en tant qu' <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara>Allez  dans l&#8217;onglet <literal>Containers</literal></simpara>
</listitem>
<listitem>
<simpara>Double-cliquez sur le container à mettre à jour</simpara>
</listitem>
<listitem>
<simpara>Dans le nouvel écran <literal>Container details</literal> cliquez sur l&#8217;icone <literal>recreate</literal></simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>Pull latest image</literal> et cliquez <literal>recreate</literal></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_portainer">
<title>Upgrade de Portainer</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal>
Vous pouvez aussi appliquer la procédure de mise à jour des containers à l&#8217;aide de <link linkend="yacht_container_updt"><literal>Yacht</literal></link></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de Yacht. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull portainer/portainer-ce
docker stop portainer
docker rm portainer
docker run -d -p 9050:9000 --name=portainer --restart=always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_des_cms_joomla">
<title>Installation des CMS Joomla</title>
<simpara>Joomla est un CMS très connu écrit en PHP. Il est fréquemment mis à jour et inclut une foule de plugins</simpara>
<section xml:id="_création_du_site_web_de_joomla">
<title>Création du site web de Joomla</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>joomla</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>joomla</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>joomla</literal>.</simpara>
</listitem>
<listitem>
<simpara>Pour <literal>Auto-Subdomain</literal> sélectionnez <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>joomla</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>joomla</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxjoomla</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_lapplication_joomla">
<title>Création de l&#8217;application Joomla</title>
<simpara>La procédure d&#8217;installation officielle de Joomla se trouve <link xl:href="https://docs.joomla.org/J3.x:Installing_Joomla">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://downloads.joomla.org/">Joomla</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil en format tarball.</simpara>
</listitem>
<listitem>
<simpara>Installez Joomla. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
wget -O joomla.tar.gz https://downloads.joomla.org/cms/joomla3/3-9-26/Joomla_3-9-26-Stable-Full_Package.tar.gz?format=gz <co xml:id="CO59-1"/>
cd /var/www/joomla.example.com/joomla/ <co xml:id="CO59-2"/>
tar -xvzf /tmp/joomla.tar.gz
rm /tmp/joomla.tar.gz
chown -R web[x]:client[y] /var/www/joomla.example.com/joomla <co xml:id="CO59-3"/> <co xml:id="CO59-4"/></programlisting>
<calloutlist>
<callout arearefs="CO59-3">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO59-2 CO59-4">
<para>mettre ici votre site web à la place de joomla.example.com et le répertoire d&#8217;installation à la place de joomla</para>
</callout>
<callout arearefs="CO59-1">
<para>coller ici l&#8217;adresse de téléchargement récupérée sur le site de Joomla.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointez votre navigateur sur <link xl:href="https://joomla.example.com">https://joomla.example.com</link>.</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet <literal>configuration</literal> :</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Choisissez votre langue <literal>fr</literal>.</simpara>
</listitem>
<listitem>
<simpara><literal>Nom du site</literal> &#8592; mettez le nom de votre site web</simpara>
</listitem>
<listitem>
<simpara><literal>Description</literal> &#8592; mettez une description courte de votre site</simpara>
</listitem>
<listitem>
<simpara><literal>Email</literal> &#8592; indiquez votre email d&#8217;admin</simpara>
</listitem>
<listitem>
<simpara>Saisissez le <literal>identifiant</literal> du compte administrateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez 2 fois <link linkend="pass_gen">un mot de passe généré</link> dans <literal>mot de passe</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez <literal>suivant</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Choisissez une base <literal>MySQLi</literal></simpara>
</listitem>
<listitem>
<simpara>mettez <literal>Localhost</literal> comme <literal>Nom du serveur</literal></simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom d&#8217;utilisateur</literal>  mettez <literal>cxjoomla</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>mot de passe</literal> saisissez le mot de passe de créé pour la base.</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom de la base de données</literal> mettez <literal>cxjoomla</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez laisser le prefixe des tables ou mettre à vide si votre base est dédiée.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez <literal>suivant</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Dans l&#8217;écran suivant, vous choisissez le <literal>type de site</literal></simpara>
</listitem>
<listitem>
<simpara>Vérifiez votre configuration</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez <literal>suivant</literal></simpara>
</listitem>
<listitem>
<simpara>L&#8217;installation s&#8217;effectue. Une fois terminée avec succès, vous pouvez décider d&#8217;installer des langues</simpara>
</listitem>
<listitem>
<simpara>N&#8217;oubliez pas ensuite de supprimer le répertoire <literal>installation</literal> en cliquant sur le bouton <literal>Supprimer le répertoire</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez ensuite sur le bouton <literal>Administration</literal> pour continuer à configurer votre site ou sur <literal>Site</literal> pour voir votre installation par défaut</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_joomla">
<title>Update de Joomla</title>
<simpara>La mise à jour de Joomla s&#8217;effectue au travers du portail d&#8217;administration
Joomla vous prévient d&#8217;un mise à jour du moteur et vous propose de le mettre à jour.
CLiquez sur le lien qui vous est présenté dans l&#8217;interface.</simpara>
</section>
</section>
<section xml:id="_installation_des_cms_concrete5">
<title>Installation des CMS Concrete5</title>
<simpara>Concrete5 est un CMS très connu écrit en PHP. Il est fréquemment mis à jour et permet une configuration wysiwyg</simpara>
<section xml:id="_création_du_site_web_de_concrete5">
<title>Création du site web de Concrete5</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>Concrete5</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>Concrete5</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>Concrete5</literal>.</simpara>
</listitem>
<listitem>
<simpara>Pour <literal>Auto-Subdomain</literal> sélectionnez <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_2">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>Concrete5</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>Concrete5</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxConcrete5</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_lapplication_concrete5">
<title>Création de l&#8217;application Concrete5</title>
<simpara>La procédure d&#8217;installation officielle de Concrete5 se trouve <link xl:href="https://documentation.concrete5.org/developers/introduction/installation">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://www.concrete5.org/download">Concrete5</link> et téléchargez la dernière version de l&#8217;outil en format zip.</simpara>
</listitem>
<listitem>
<simpara>Uploader ce fichier dans votre répertoire /tmp de votre serveur au moyen de filezilla</simpara>
</listitem>
<listitem>
<simpara>Installez Concrete5. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
unzip concrete5-8.5.5.zip <co xml:id="CO60-1"/>
mv concrete5-8.5.5/* /var/www/concrete5.example.com/concrete5/ <co xml:id="CO60-2"/> <co xml:id="CO60-3"/>
rm -rf concrete5-8.5.5 <co xml:id="CO60-4"/>
rm concrete5-8.5.5.zip <co xml:id="CO60-5"/>
chown -R web[x]:client[y] /var/www/concrete5.example.com/concrete5 <co xml:id="CO60-6"/> <co xml:id="CO60-7"/></programlisting>
<calloutlist>
<callout arearefs="CO60-6">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO60-3 CO60-7">
<para>mettre ici votre site web à la place de concrete5.example.com et le répertoire d&#8217;installation à la place de concrete5</para>
</callout>
<callout arearefs="CO60-1 CO60-2 CO60-4 CO60-5">
<para>le nom du fichier zip dépend de la version que vous avez téléchargé. De même le nom du répertoire est dépendant de la version.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointez votre navigateur sur <link xl:href="https://concrete5.example.com">https://concrete5.example.com</link>.</simpara>
</listitem>
<listitem>
<simpara>Choisissez votre langue <literal>français</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le système check que la configuration est correcte.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>continuer l&#8217;installation</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Nom</literal> &#8592; saisissez le nom de votre site</simpara>
</listitem>
<listitem>
<simpara><literal>Adresse de courriel administrateur</literal> &#8592; indiquez votre email d&#8217;admin</simpara>
</listitem>
<listitem>
<simpara>Saisissez 2 fois <link linkend="pass_gen">un mot de passe généré</link> dans <literal>Mot de passe administrateur</literal></simpara>
</listitem>
<listitem>
<simpara>Choisissez le <literal>point de départ</literal></simpara>
</listitem>
<listitem>
<simpara>mettez <literal>Localhost</literal> comme <literal>Serveur</literal></simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>Utilisateur MySQL</literal>  mettez <literal>cxconcrete5</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>Mot de passe MySQL</literal> saisissez le mot de passe de créé pour la base.</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom de la base de données</literal> mettez <literal>cxconcrete5</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur la case à cocher de la <literal>politique de confidentialité</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez <literal>Installer Concrete5</literal></simpara>
</listitem>
<listitem>
<simpara>L&#8217;installation s&#8217;effectue. Une fois terminée avec succès, Cliquez sur <literal>Modifier votre site</literal></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_concrete5">
<title>Update de concrete5</title>
<simpara>La mise à jour de concrete5 s&#8217;effectue au travers du portail d&#8217;administration
concrete5 vous prévient d&#8217;un mise à jour du moteur et vous propose de le mettre à jour.
Cliquez sur le lien qui vous est présenté dans l&#8217;interface.</simpara>
</section>
</section>
<section xml:id="_installation_du_portail_wiki_mediawiki">
<title>Installation du portail wiki Mediawiki</title>
<simpara>Mediawiki est le portail wiki mondialement connu et utilisé notamment pour le site wikipedia.</simpara>
<section xml:id="_création_du_site_web_de_mediawiki">
<title>Création du site web de Mediawiki</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>mediawiki</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>mediawiki</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>mediawiki</literal>.</simpara>
</listitem>
<listitem>
<simpara>Pour <literal>Auto-Subdomain</literal> sélectionnez <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_3">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>mediawiki</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>mediawiki</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxmediawiki</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_lapplication_mediawiki">
<title>Création de l&#8217;application Mediawiki</title>
<simpara>La procédure d&#8217;installation officielle de Mediawiki se trouve <link xl:href="https://www.mediawiki.org/wiki/Manual:Installation_guide">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://www.mediawiki.org/wiki/Download">Mediawiki</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil en format tarball.</simpara>
</listitem>
<listitem>
<simpara>Installez Mediawiki. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
wget -O mediawiki.tar.gz https://releases.wikimedia.org/mediawiki/1.35/mediawiki-1.35.2.tar.gz <co xml:id="CO61-1"/>
tar -xvzf mediawiki.tar.gz <co xml:id="CO61-2"/>
mv mediawiki-1.35.2/* /var/www/mediawiki.example.com/mediawiki/ <co xml:id="CO61-3"/> <co xml:id="CO61-4"/>
rm mediawiki.tar.gz
rm -rf mediawiki-1.35.2 <co xml:id="CO61-5"/>
chown -R web[x]:client[y] /var/www/mediawiki.example.com/mediawiki <co xml:id="CO61-6"/> <co xml:id="CO61-7"/></programlisting>
<calloutlist>
<callout arearefs="CO61-6">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO61-4 CO61-7">
<para>mettre ici votre site web à la place de mediawiki.example.com et le répertoire d&#8217;installation à la place de mediawiki</para>
</callout>
<callout arearefs="CO61-1">
<para>coller ici l&#8217;adresse de téléchargement récupérée sur le site de Mediawiki.</para>
</callout>
<callout arearefs="CO61-2 CO61-3 CO61-5">
<para>le nom du fichier tar.gz dépend de la version que vous avez téléchargé. De même le nom du répertoire est dépendant de la version.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointez votre navigateur sur <link xl:href="https://mediawiki.example.com">https://mediawiki.example.com</link>.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>set up the wiki</literal>.La procédure d&#8217;installation se déclenche :</simpara>
</listitem>
<listitem>
<simpara>Choisissez votre langue <literal>fr</literal>. Cliquez sur <literal>continuer</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>L&#8217;environnement est vérifié. Assurez vous que le texte <literal>L’environnement a été vérifié. Vous pouvez installer MediaWiki.</literal> s&#8217;affiche.</simpara>
</listitem>
<listitem>
<simpara>Choisissez une base <literal>MariaDB</literal></simpara>
</listitem>
<listitem>
<simpara>mettez <literal>Localhost</literal> comme nom d&#8217;hote de la Base</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom de la base de données</literal> mettez <literal>cxmediawiki</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom d&#8217;utilisateur de la base de données</literal> mettez <literal>cxmediawiki</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>mot de passe</literal> saisissez le mot de passe de créé pour la base.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>continuer</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Dans l&#8217;écran suivant, cliquez <literal>continuer</literal> sans rien changer</simpara>
</listitem>
<listitem>
<simpara>Saisissez le <literal>nom du wiki</literal></simpara>
</listitem>
<listitem>
<simpara>Saisissez le <literal>nom d&#8217;utilisateur</literal> du compte administrateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez 2 fois <link linkend="pass_gen">un mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara>Saisissez <literal>Adresse de courriel</literal> &#8592; votre Email.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>continuer</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Répondez en fonction de vos besoins aux questions suivantes.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>continuer</literal></simpara>
</listitem>
<listitem>
<simpara>Lisez le texte et cliquez sur <literal>continuer</literal></simpara>
</listitem>
<listitem>
<simpara>L&#8217;installation s&#8217;effectue et se termine avec succès. Cliquez sur <literal>continuer</literal></simpara>
</listitem>
<listitem>
<simpara>le fichier LocalSettings.php vous est proposé au téléchargement. Enregistrez le et ouvrez le dans un éditeur. Copier tout le contenu du fichier dans le presse papier</simpara>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Créez le fichier LocalSettings.php. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /var/www/mediawiki.example.com/mediawiki/LocalSettings.php <co xml:id="CO62-1"/></programlisting>
<calloutlist>
<callout arearefs="CO62-1">
<para>mettre ici votre site web à la place de mediawiki.example.com et le répertoire d&#8217;installation à la place de mediawiki</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Coller tout le texte dans le fichier édité. Sauvegardez et quittez.</simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chown -R web[x]:client[y] /var/www/mediawiki.example.com/mediawiki/LocalSettings.php <co xml:id="CO63-1"/> <co xml:id="CO63-2"/>
chmod 644 /var/www/mediawiki.example.com/mediawiki/LocalSettings.php <co xml:id="CO63-3"/></programlisting>
<calloutlist>
<callout arearefs="CO63-1">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO63-2 CO63-3">
<para>mettre ici votre site web à la place de mediawiki.example.com et le répertoire d&#8217;installation à la place de mediawiki</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Dans votre navigateur cliquez sur <literal>accéder à votre wiki</literal></simpara>
</listitem>
<listitem>
<simpara>C&#8217;est fait</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_du_serveur_mediawiki">
<title>Update du serveur Mediawiki</title>
<simpara>La procédure de mise à jour officielle de Mediawiki se trouve <link xl:href="https://www.mediawiki.org/wiki/Manual:Upgrading">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://www.mediawiki.org/wiki/Download">Mediawiki</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil en format tarball.</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour Mediawiki. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir /tmp/mediawiki.old
mv /var/www/mediawiki.example.com/mediawiki/* /tmp/mediawiki.old <co xml:id="CO64-1"/>
cd /tmp
wget -O mediawiki.tar.gz https://releases.wikimedia.org/mediawiki/1.35/mediawiki-1.35.2.tar.gz <co xml:id="CO64-2"/>
tar -xvzf mediawiki.tar.gz
mv mediawiki-1.35.2/* /var/www/mediawiki.example.com/mediawiki/ <co xml:id="CO64-3"/> <co xml:id="CO64-4"/>
rm mediawiki.tar.gz
rm -rf mediawiki-1.35.2 <co xml:id="CO64-5"/>
cp /tmp/mediawiki.old/LocalSettings.php  /var/www/mediawiki.example.com/mediawiki/LocalSettings.php <co xml:id="CO64-6"/>
cp -r /tmp/mediawiki.old/images/*  /var/www/mediawiki.example.com/mediawiki/images/ <co xml:id="CO64-7"/>
chown -R web[x]:client[y] /var/www/mediawiki.example.com/mediawiki <co xml:id="CO64-8"/> <co xml:id="CO64-9"/></programlisting>
<calloutlist>
<callout arearefs="CO64-8">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO64-1 CO64-4 CO64-6 CO64-7 CO64-9">
<para>mettre ici votre site web à la place de mediawiki.example.com et le répertoire d&#8217;installation à la place de mediawiki</para>
</callout>
<callout arearefs="CO64-2">
<para>coller ici l&#8217;adresse de téléchargement récupérée sur le site de Mediawiki.</para>
</callout>
<callout arearefs="CO64-3 CO64-5">
<para>le nom du fichier tar.gz dépend de la version que vous avez téléchargé. De même le nom du répertoire est dépendant de la version.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>vous pouvez aussi copier vos logos du répertoire resources/assets de l&#8217;ancien mediawiki.</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour vos extensions avec les dernières versions compatibles.</simpara>
</listitem>
<listitem>
<simpara>Suivez les recommandations de mise à jour de Mediawiki pour le fichier <literal>LocalSettings.php</literal></simpara>
</listitem>
<listitem>
<simpara>exécuter le script d&#8217;update. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/www/mediawiki.example.com/mediawiki/maintenance
php update.php</programlisting>
</listitem>
<listitem>
<simpara>Vérifiez que tout s&#8217;est bien passé. Se référer à la documentation de Mediawiki pour résoudre les problèmes.</simpara>
</listitem>
<listitem>
<simpara>Redémarrez apache. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart apache2</programlisting>
</listitem>
<listitem>
<simpara>Vérifiez que tout fonctionne correctement sur le site phpmyadmin</simpara>
</listitem>
<listitem>
<simpara>Supprimez l&#8217;ancien répertoire</simpara>
<programlisting language="bash" linenumbering="unnumbered">rm -rf /tmp/mediawiki.old</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_dun_gestionnaire_de_blog_wordpress">
<title>Installation d&#8217;un gestionnaire de Blog Wordpress</title>
<simpara>Wordpress est un CMS très connu écrit en PHP. Il est fréquemment mis à jour.</simpara>
<section xml:id="_création_du_site_web_de_wordpress">
<title>Création du site web de Wordpress</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>wordpress</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>wordpress</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>wordpress</literal>.</simpara>
</listitem>
<listitem>
<simpara>Pour <literal>Auto-Subdomain</literal> sélectionnez <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_4">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>wordpress</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>wordpress</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxwordpress</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_lapplication_wordpress">
<title>Création de l&#8217;application Wordpress</title>
<simpara>La procédure d&#8217;installation officielle de Wordpress se trouve <link xl:href="https://fr.wordpress.org/support/article/how-to-install-wordpress/">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://fr.wordpress.org/download/">Wordpress</link> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil en format tarball.</simpara>
</listitem>
<listitem>
<simpara>Installez Wordpress. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
wget -O wordpress.tar.gz https://wordpress.org/latest.tar.gz
tar -xvzf wordpress.tar.gz
mv wordpress/* /var/www/wordpress.example.com/wordpress/ <co xml:id="CO65-1"/>
rm wordpress.tar.gz
rm -rf wordpress
chown -R web[x]:client[y] /var/www/wordpress.example.com/wordpress <co xml:id="CO65-2"/> <co xml:id="CO65-3"/></programlisting>
<calloutlist>
<callout arearefs="CO65-2">
<para>Remplacez [x] et [y] par les numéros de site web et de client. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO65-1 CO65-3">
<para>mettre ici votre site web à la place de wordpress.example.com et le répertoire d&#8217;installation à la place de wordpress</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Pointez votre navigateur sur <link xl:href="https://wordpress.example.com">https://wordpress.example.com</link>.</simpara>
</listitem>
<listitem>
<simpara>Choisissez votre langue <literal>français</literal>. Cliquez sur <literal>continuer</literal>.</simpara>
</listitem>
<listitem>
<simpara>Lisez le texte et cliquez sur <literal>C&#8217;est parti !</literal></simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>nom de la base de données</literal> mettez <literal>cxwordpress</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>Identifiant</literal>  mettez <literal>cxwordpress</literal> comme créé plus haut</simpara>
</listitem>
<listitem>
<simpara>Dans le <literal>Mot de passe</literal> saisissez le mot de passe de créé pour la base.</simpara>
</listitem>
<listitem>
<simpara>mettez <literal>Localhost</literal> comme <literal>Adresse de la base de données</literal></simpara>
</listitem>
<listitem>
<simpara>Vous pouvez laisser le <literal>préfixe des tables</literal> ou mettre à vide si votre base est dédiée.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Envoyer</literal>.</simpara>
</listitem>
<listitem>
<simpara>Cliquez ensuite sur <literal>Lancer l&#8217;installation</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Titre du site</literal> &#8592; mettez le nom de votre site web</simpara>
</listitem>
<listitem>
<simpara>Saisissez le <literal>identifiant</literal> du compte administrateur</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Saisissez <link linkend="pass_gen">un mot de passe généré</link> dans <literal>mot de passe</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Votre e-mail</literal> &#8592; indiquez votre email d&#8217;admin</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez <literal>Installer Wordpress</literal></simpara>
</listitem>
<listitem>
<simpara>C&#8217;est fini.</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez ensuite cliquer sur <literal>Se connecter</literal> pour administrer votre site</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_wordpress">
<title>Update de wordpress</title>
<simpara>La mise à jour de wordpress s&#8217;effectue directement dans le site web en allant sur <literal>Dashboard</literal> et l&#8217;item <literal>updates</literal>. Il n&#8217;y a rien d&#8217;autre à faire.</simpara>
</section>
</section>
<section xml:id="_installation_du_cms_micro_weber">
<title>Installation du CMS Micro Weber</title>
<simpara>Microweber est un système de gestion de contenu et un constructeur de sites web Open Source. Il est basé sur le langage de programmation PHP et le framework web Laravel 5, utilisant le glisser-déposer et permettant aux utilisateurs de créer rapidement du contenu, tout en programmant et en gérant plusieurs affichages. Il dispose d&#8217;une fonction d&#8217;édition en direct qui permet aux utilisateurs de visualiser leurs modifications telles qu&#8217;elles apparaîtraient.</simpara>
<section xml:id="_création_du_site_web_de_microweber">
<title>Création du site web de Microweber</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>microweber</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>microweber</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>microweber</literal>.</simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_5">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>microweber</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; <link linkend="pass_gen">Saisissez un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>microweber</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxmicroweber</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_microweber">
<title>Installation de Microweber</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="command" linenumbering="unnumbered">cd /var/www/microweber.example.com/microweber <co xml:id="CO66-1"/>
wget https://raw.githubusercontent.com/microweber-dev/webinstall/master/webinstall.php</programlisting>
<calloutlist>
<callout arearefs="CO66-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Un fois téléchargé, faites pointer votre navigateur vers <link xl:href="http://microweber.example.com/netinstall.php">http://microweber.example.com/netinstall.php</link></simpara>
</listitem>
<listitem>
<simpara>Indique <literal>.</literal> comme répertoire d&#8217;installation et cliquez sur <literal>Télécharger et décompresser microweber</literal></simpara>
</listitem>
<listitem>
<simpara>Une fois le téléchargement terminé cliquez sur <literal>Installer Microweber</literal>. Rechargez la page si besoin.</simpara>
</listitem>
<listitem>
<simpara>Répondez aux questions suivantes:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database Engine</literal> &#8592; <literal>MySQL</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Hostname</literal> &#8592; Laissez <literal>localhost</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Username</literal> &#8592; entrez <literal>cxmicroweber</literal>. x est le numéro de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>Password</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Database</literal> &#8592; entrez <literal>cxmicroweber</literal>. x est le numéro de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>Préfix des noms de tables</literal> &#8592; Laissez le champ vide</simpara>
</listitem>
<listitem>
<simpara><literal>Website Default Language</literal> &#8592; <literal>French</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Admin username</literal> &#8592; tapez <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Admin password</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat password</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Admin email</literal> &#8592; Tapez votre adresse mail d&#8217;administrateur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Tapez <literal>Install</literal></simpara>
</listitem>
<listitem>
<simpara>Vous êtes redirigé sur le site Microweber ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_microweber">
<title>Update de Microweber</title>
<simpara>La mise à jour de Microweber s&#8217;effectue directement dans le site web en allant sur <literal>Dashboard</literal> et l&#8217;item <literal>updates</literal>. Il n&#8217;y a rien d&#8217;autre à faire.</simpara>
</section>
</section>
<section xml:id="_installation_de_mealie">
<title>Installation de Mealie</title>
<simpara>le logiciel <literal>Mealie</literal> est un gestionnaire de recettes et un planificateur de repas auto-hébergés avec un backend RestAPI et une application frontale responsive construite en Vue pour une expérience utilisateur agréable pour toute la famille.</simpara>
<section xml:id="_prérequis">
<title>Prérequis</title>
<simpara>Il vous faudra tout d&#8217;abord installer <literal>docker</literal> en vous référant au chapitre qui y est consacré.</simpara>
</section>
<section xml:id="_installation_du_serveur_mealie">
<title>Installation du serveur Mealie</title>
<simpara>Nous allons installer Mealie à partir de son container Docker.</simpara>
<simpara>Ouvrez un terminal et suivez la procédure:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Créez le docker de Mealie. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker volume create mealie_data
docker run -d -p 1282:9000 --name=mealie --restart=always -v mealie_data:'/app/data/' -e PGID=1000 -e PUID=1000  ghcr.io/mealie-recipes/mealie:latest</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_du_site_web_de_mealie">
<title>Création du site web de mealie</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>mealie</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>mealie</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>mealie</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# mealie httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:1282/
ProxyPassReverse / http://localhost:1282/

RedirectMatch ^/$ https://mealie.example.com <co xml:id="CO67-1"/></programlisting>
<calloutlist>
<callout arearefs="CO67-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_du_site_mealie">
<title>Configuration du site mealie</title>
<simpara>Votre site web <literal>mealie</literal> est installé et opérationnel.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Pointez votre navigateur sur votre site web <literal>mealie</literal></simpara>
</listitem>
<listitem>
<simpara>Loggez vous avec le mail <literal>changeme@email.com</literal> et le mot de passe <literal>MyPassword</literal></simpara>
</listitem>
<listitem>
<simpara>Vous devez ensuite aller dans le menu de configuration de l&#8217;utilisateur pour changer ce mail et ce mot de passe par défaut</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant ajouter des utilisateurs et des recettes de cuisine.</simpara>
</listitem>
<listitem>
<simpara>C&#8217;est prêt !</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_mealie">
<title>Upgrade de Mealie</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal>
Vous pouvez aussi appliquer la procédure de mise à jour des containers à l&#8217;aide de <link linkend="port_container_updt"><literal>Portainer</literal></link> ou à l&#8217;aide <link linkend="yacht_container_updt"><literal>Yacht</literal></link></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de Mealie. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull hkotel/mealie:latest
docker stop mealie
docker rm mealie
docker run -d -p 1282:9000 --name=mealie --restart=always -v mealie_data:'/app/data/' -e PGID=1000 -e PUID=1000  ghcr.io/mealie-recipes/mealie:latest</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_du_gestionnaire_de_photos_piwigo">
<title>Installation du gestionnaire de photos Piwigo</title>
<simpara>Piwigo est une application web pour gérer votre collection de photos, et autres médias. Doté de puissantes fonctionnalités, il gère des galeries partout dans le monde. Elle est écrite en PHP et nécessite une base de données MySQL.</simpara>
<simpara>Piwigo était auparavant connu sous le nom PhpWebGallery.</simpara>
<section xml:id="_création_du_site_web_de_piwigo">
<title>Création du site web de Piwigo</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>piwigo</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>piwigo</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>piwigo</literal>.</simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_6">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>piwigo</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir  <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>piwigo</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxpiwigo</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_piwigo">
<title>Installation de Piwigo</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez la commande suivante:</simpara>
<programlisting language="command" linenumbering="unnumbered">cd /var/www/piwigo.example.com/piwigo <co xml:id="CO68-1"/>
wget http://piwigo.org/download/dlcounter.php?code=netinstall -O piwigo-netinstall.php</programlisting>
<calloutlist>
<callout arearefs="CO68-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Un fois téléchargé, faites pointer votre navigateur vers <link xl:href="http://piwigo.example.com/piwigo-netinstall.php">http://piwigo.example.com/piwigo-netinstall.php</link></simpara>
</listitem>
<listitem>
<simpara>Choisissez votre <literal>Langue</literal> à <literal>Français</literal></simpara>
</listitem>
<listitem>
<simpara>Indique <literal>.</literal> comme répertoire d&#8217;installation et cliquez sur <literal>Télécharger et décompresser Piwigo</literal></simpara>
</listitem>
<listitem>
<simpara>Une fois le téléchargement terminé cliquez sur <literal>Installer Piwigo</literal>. Rechargez la page si besoin.</simpara>
</listitem>
<listitem>
<simpara>Répondez aux questions suivantes:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Langue par défaut de la galerie</literal> &#8592; <literal>Français</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Hote</literal> &#8592; Laissez <literal>localhost</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Utilisateur</literal> &#8592; entrez <literal>cxpiwigo</literal>. x est le numero de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Nom de la Base de données</literal> &#8592; entrez <literal>cxpiwigo</literal>. x est le numero de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>Préfix des noms de tables</literal> &#8592; Laissez le champ vide</simpara>
</listitem>
<listitem>
<simpara><literal>Nom d&#8217;Utilisateur</literal> &#8592; tapez <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe</literal> &#8592; Tapez <link linkend="pass_gen">votre mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe [confirmer]</literal> &#8592; Retapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Adresse e-mail</literal> &#8592; Tapez votre adresse mail d&#8217;administrateur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Tapez <literal>Démarrer l&#8217;installation</literal></simpara>
</listitem>
<listitem>
<simpara>Vous êtes redirigé sur le site piwigo ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_piwigo">
<title>Update de Piwigo</title>
<simpara>La mise à jour de Piwigo s&#8217;effectue directement dans le site web en allant sur <literal>Dashboard Admin</literal> et l&#8217;item <literal>Mises à jour</literal>. Il n&#8217;y a rien d&#8217;autre à faire.</simpara>
</section>
</section>
<section xml:id="_installation_du_système_collaboratif_nextcloud">
<title>Installation du système collaboratif Nextcloud</title>
<simpara>NextCloud est un serveur d&#8217;hébergement et de partage de fichiers gratuit et open source, fork du projet ownCloud.
Il est très similaire aux autres systèmes de partage de fichiers des services comme Google Drive, Dropbox et iCloud ou Seafile.
NextCloud vous permet de stocker des fichiers, des documents, des photos, des films et des vidéos à partir de la centrale l&#8217;emplacement.
Avec NextCloud, vous pouvez partager des fichiers, des contacts et tout autre les médias avec vos amis et vos clients.
NextCloud s&#8217;intègre avec le courrier, calendrier, contacts et autres fonctionnalités qui aideront vos équipes à obtenir leur travail est plus rapide et plus facile.
Vous pouvez installer le client NextCloud sur un  ou plusieurs PC pour synchroniser les fichiers avec votre serveur Nextcloud.
Des clients sont disponibles pour la plupart des systèmes d&#8217;exploitation, y compris Windows, macOS, FreeBSD, et Linux.</simpara>
<section xml:id="_installation_initiale">
<title>Installation initiale</title>
<simpara>NextCloud est écrit en PHP et utilise une base de données MariaDB pour stocker ses données.</simpara>
<simpara>Pour installer, Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez quelques paquets de base. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt-get install  php-cgi php-curl</programlisting>
</listitem>
<listitem>
<simpara>Une fois installé, éditez le fichier php.ini pour changer quelques limitations. Tapez:</simpara>
</listitem>
</orderedlist>
<screen>vi /etc/php/8.2/fpm/php.ini <co xml:id="CO69-1"/></screen>
<calloutlist>
<callout arearefs="CO69-1">
<para>remplacer 8.2 par votre version de php</para>
<orderedlist numeration="arabic">
<listitem>
<simpara>Cherchez les champs ci dessous et changez les valeurs comme suit:</simpara>
<programlisting language="ini" linenumbering="unnumbered">memory_limit = 512M
upload_max_filesize = 500M
post_max_size = 500M
max_execution_time = 300</programlisting>
</listitem>
<listitem>
<simpara>Sauvez et redémarrez apache. Tapez:</simpara>
<programlisting language="command" linenumbering="unnumbered">systemctl restart apache2</programlisting>
</listitem>
</orderedlist>
</callout>
</calloutlist>
</section>
<section xml:id="_création_du_site_web_de_nextcloud">
<title>Création du site web de Nextcloud</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>nextcloud</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>nextcloud</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>nextcloud</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Aller dans l&#8217;onglet <literal>Statistics</literal> pour <literal>Webstatistics program</literal> sélectionnez <literal>None</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_7">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>nextcloud</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; saisir <link linkend="pass_gen">un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>nextcloud</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxnextcloud</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_nextcloud">
<title>Installation de Nextcloud</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez la commande suivante:</simpara>
</listitem>
</orderedlist>
<screen>cd /var/www/nextcloud.example.com/nextcloud <co xml:id="CO70-1"/>
wget https://download.nextcloud.com/server/installer/setup-nextcloud.php</screen>
<calloutlist>
<callout arearefs="CO70-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
<orderedlist numeration="arabic">
<listitem>
<simpara>Un fois téléchargé, faites pointer votre navigateur vers <link xl:href="http://nextcloud.example.com/setup-nextcloud.php">http://nextcloud.example.com/setup-nextcloud.php</link></simpara>
</listitem>
<listitem>
<simpara>Indique <literal>.</literal> comme répertoire d&#8217;installation et cliquez sur <literal>Next</literal></simpara>
</listitem>
<listitem>
<simpara>Une fois le téléchargement terminé cliquez sur <literal>Next</literal>. Rechargez la page si besoin.</simpara>
</listitem>
<listitem>
<simpara>Répondez aux questions suivantes:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Login Admin</literal> &#8592; tapez <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Password Admin</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara>ouvrez <literal>Stockage et base de données</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Configurer la base de données</literal> &#8592; cliquez sur <literal>MariaDB</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Utilisateur de la Base de données</literal> &#8592; entrez <literal>cxnextcloud</literal>. x est le numero de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>Password de la Base de données</literal> &#8592; Tapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Nom de la Base de données</literal> &#8592; entrez <literal>cxnextcloud</literal>. x est le numéro de client; habituellement c&#8217;est 0</simpara>
</listitem>
<listitem>
<simpara><literal>nom du serveur</literal> &#8592; Laissez <literal>Localhost</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Tapez <literal>Next</literal></simpara>
</listitem>
<listitem>
<simpara>Vous êtes redirigé sur le site nextcloud ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</simpara>
</listitem>
</orderedlist>
</callout>
</calloutlist>
</section>
<section xml:id="_upgrade_de_nextcloud">
<title>Upgrade de Nextcloud</title>
<simpara>La mise à jour de nextcloud se fait directement dans nextcloud avec l&#8217;outil de mise à jour intégré à l&#8217;interface.
Il faut se connecter en mode Admin</simpara>
</section>
</section>
<section xml:id="_installation_du_gestionnaire_de_projet_gitea">
<title>Installation du gestionnaire de projet Gitea</title>
<simpara>Gitea est un système simple d&#8217;hébergement de code basé sur Git. C&#8217;est un fork de Gogs.
Il montre des fonctionnalités similaires à gitlab ou github tout en gardant un code plus simple.</simpara>
<section xml:id="_création_du_site_web_de_gitea">
<title>Création du site web de Gitea</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>gitea</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>gitea</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>gitea</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# gitea httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:3000/
ProxyPassReverse / http://localhost:3000/

RedirectMatch ^/$ https://gitea.example.com <co xml:id="CO71-1"/></programlisting>
<calloutlist>
<callout arearefs="CO71-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Créez un utilisateur <literal>Gitea</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">adduser --system --disabled-password --group --shell /bin/bash --home /home/gitea gitea</programlisting>
</listitem>
<listitem>
<simpara>Créez la structure de répertoire de <literal>Gitea</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /var/lib/gitea/{data,log} /etc/gitea /run/gitea</programlisting>
</listitem>
<listitem>
<simpara>Donnez les bonnes permissions aux répertoires. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chown -R gitea:gitea /var/lib/gitea
chown -R gitea:gitea /run/gitea
chown -R root:gitea /etc/gitea
chmod -R 750 /var/lib/gitea
chmod 770 /etc/gitea</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_8">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>gitea</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; <link linkend="pass_gen">Saisissez un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>gitea</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxgitea</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_téléchargez_et_installez_gitea">
<title>Téléchargez et installez Gitea</title>
<simpara>Appliquez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Téléchargez gitea du <link xl:href="https://dl.gitea.io/gitea/">site de chargement</link>. Tapez pour un système 64 bits:</simpara>
<programlisting language="bash" linenumbering="unnumbered">wget https://dl.gitea.io/gitea/main/gitea-main-linux-amd64 -O /usr/local/bin/gitea
chmod 755 /usr/local/bin/gitea</programlisting>
</listitem>
<listitem>
<simpara>Créez maintenant une entrée pour le launcher systemd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/systemd/system/gitea.service</programlisting>
</listitem>
<listitem>
<simpara>y Coller le texte suivant:</simpara>
<programlisting language="ini" linenumbering="unnumbered">[Unit]
Description=Gitea (Git with a cup of tea)
After=syslog.target
After=network.target
Requires=mysqld.service
[Service]
Type=simple
User=gitea
Group=gitea
WorkingDirectory=/var/lib/gitea/
RuntimeDirectory=gitea
ExecStart=/usr/local/bin/gitea web -c /etc/gitea/app.ini
Restart=always
Environment=USER=gitea HOME=/home/gitea GITEA_WORK_DIR=/var/lib/gitea
[Install]
WantedBy=multi-user.target</programlisting>
</listitem>
<listitem>
<simpara>Recharge la base de systemd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl daemon-reload</programlisting>
</listitem>
<listitem>
<simpara>Activez et démarrez <literal>Gitea</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl enable gitea.service
systemctl start gitea.service</programlisting>
</listitem>
<listitem>
<simpara>Ouvrez votre navigateur sur l&#8217;url: <link xl:href="https://gitea.example.com/install">https://gitea.example.com/install</link> et remplissez les paramètres comme ci-après :</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Type de base de données:</literal> &#8592; Sélectionnez <literal>MySQL</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Nom d&#8217;utilisateur:</literal> &#8592; Tapez <literal>c0gitea</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe:</literal> &#8592;  Tapez le mot de passe saisi lors de la création de la base</simpara>
</listitem>
<listitem>
<simpara><literal>Nom de base de données:</literal> &#8592; Tapez <literal>c0gitea</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Titre du site:</literal> &#8592; mettez une titre de votre choix</simpara>
</listitem>
<listitem>
<simpara><literal>Emplacement racine des dépôts:</literal> &#8592; saisissez <literal>/home/gitea/gitea-repositories</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Répertoire racine Git LFS:</literal> &#8592; Tapez <literal>/var/lib/gitea/data/lfs</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Exécuter avec le compte d&#8217;un autre utilisateur :</literal> &#8592; Tapez <literal>gitea</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Domaine du serveur SSH:</literal> &#8592; Tapez votre domaine. exemple : <literal>gitea.example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Port du serveur SSH:</literal> &#8592; Tapez 22</simpara>
</listitem>
<listitem>
<simpara><literal>Port d&#8217;écoute HTTP de Gitea:</literal> &#8592; Tapez 3000</simpara>
</listitem>
<listitem>
<simpara><literal>URL de base de Gitea:</literal> &#8592; Tapez l&#8217;URL de votre domaine. Exemple: <literal><link xl:href="https://gitea.example.com">https://gitea.example.com</link></literal></simpara>
</listitem>
<listitem>
<simpara><literal>Chemin des fichiers log:</literal> &#8592; Tapez  <literal>/var/lib/gitea/log</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Hôte SMTP:</literal> &#8592; Tapez <literal>localhost</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Envoyer les e-mails en tant que:</literal> &#8592; Tapez <literal>gitea@gitea.example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Exiger la confirmation de l&#8217;e-mail lors de l&#8217;inscription:</literal> &#8592; cochez la case</simpara>
</listitem>
<listitem>
<simpara><literal>Activez les notifications par e-mail:</literal> &#8592; cochez la case</simpara>
</listitem>
<listitem>
<simpara><literal>Désactiver le formulaire d&#8217;inscription:</literal> &#8592; cochez la case</simpara>
</listitem>
<listitem>
<simpara><literal>Masquer les adresses e-mail par défaut:</literal> &#8592; cochez la case</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Laissez le reste et cliquez sur <literal>Install Gitea</literal>.</simpara>
</listitem>
<listitem>
<simpara>Restreignez les permissions sur le fichier de configuration de gitea. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 750 /etc/gitea
chown root:gitea /etc/gitea/app.ini
chmod 640 /etc/gitea/app.ini</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez <literal>gitea</literal>.</simpara>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart gitea.service</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_activer_une_connexion_ssh_dédiée">
<title>Activer une connexion SSH dédiée</title>
<simpara>En option, vous pouvez avoir envie de dédier une connexion SSH pour Gitea:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Éditez le fichier de configuration. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/gitea/app.ini</programlisting>
</listitem>
<listitem>
<simpara>Trouvez les lignes suivantes et les remplacer dans le fichier. Chercher et remplacez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">START_SSH_SERVER = true
SSH_PORT = 2222 <co xml:id="CO72-1"/></programlisting>
<calloutlist>
<callout arearefs="CO72-1">
<para>mettez ici le numéro de port que vous souhaitez</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 2222 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Redémarrez <literal>gitea</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart gitea.service</programlisting>
</listitem>
<listitem>
<simpara>Enjoy !</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_gitea">
<title>Update de Gitea</title>
<simpara>Appliquez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Téléchargez gitea du <link xl:href="https://dl.gitea.io/gitea/">site de chargement</link>. Tapez pour un système 64 bits:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service gitea stop
wget https://dl.gitea.io/gitea/main/gitea-main-linux-amd64 -O /usr/local/bin/gitea
chmod 755 /usr/local/bin/gitea
service gitea start</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_de_vaultwarden">
<title>Installation de vaultwarden</title>
<simpara>le logiciel <literal>vaultwarden</literal> est un gestionnaire de mots de passe relativement complet et gratuit. Il peut être installé sur votre serveur VPS de manière indépendante de l&#8217;éditeur vaultwarden.</simpara>
<simpara>Il reste cependant un bémol puisque l&#8217;installation s&#8217;effectue à l&#8217;aide de containers dockers qui sont eux générés par l&#8217;éditeur de <literal>vaultwarden</literal>.</simpara>
<section xml:id="_prérequis_2">
<title>Prérequis</title>
<simpara>Il vous faudra tout d&#8217;abord installer <literal>docker</literal> en vous référant au chapitre qui y est consacré.</simpara>
</section>
<section xml:id="_installation_du_serveur_vaultwarden">
<title>Installation du serveur vaultwarden</title>
<simpara>Nous allons installer Vaultwarden qui est la version libre de vaultwarden et compatible avec les APIs.
Cette version est plus complète que la version officielle, consomme moins de ressources et est plus rapide.</simpara>
<simpara>Ouvrez un terminal et suivez la procédure:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Installez <literal>argon2</literal></simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install argon2</programlisting>
</listitem>
<listitem>
<simpara>Créez un <link linkend="pass_gen">mot de passe</link></simpara>
</listitem>
<listitem>
<simpara>Créez un code de hashage valide à partir de celui ci et notez le. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo -n "MySecretPassword" | argon2 "$(openssl rand -base64 32)" -e -id -k 19456 -t 2 -p 1</programlisting>
</listitem>
<listitem>
<simpara>Créez le docker de Vaultwarden. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker volume create vaultwarden_data
docker run -d -p 1280:80 --name=vaultwarden --restart=always -v vaultwarden_data:/data:rw -e ROCKET_ENV=staging -e ROCKET_PORT=80 -e ROCKET_WORKERS=10 -e SMTP_HOST=mail.example.com -e SMTP_FROM=mailname@example.com -e SMTP_PORT=587 -e SMTP_SSL=true -e SMTP_USERNAME=mailname@example.com -e SMTP_PASSWORD=mailpassword -e WEBSOCKET_ENABLED=true -e ADMIN_TOKEN=Hashcode -e SIGNUPS_ALLOWED=false -e DOMAIN=https://vaultwarden.example.com vaultwarden/server:latest <co xml:id="CO73-1"/></programlisting>
<calloutlist>
<callout arearefs="CO73-1">
<para>ici il faut remplacer <literal>example.com</literal> par votre nom de domaine. Il faut aussi remplacer <literal>mailname@example.com</literal> par une boite mail valide sur le serveur et <literal>mailpassword</literal> par le mot de passe de cette boite mail valide. <literal>Hashcode</literal> doit être remplacé par le code de hashage généré. Ce code protège l&#8217;accès <literal>admin</literal> de vaultwarden.</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_du_site_web_de_vaultwarden">
<title>Création du site web de vaultwarden</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>vaultwarden</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>vaultwarden</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>vaultwarden</literal>.</simpara>
</listitem>
<listitem>
<simpara>Mettre <literal>None</literal> dans <literal>Auto-Subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer let’s encrypt ssl</simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-PFM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# vaultwarden httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:1280/
ProxyPassReverse / http://localhost:1280/

RedirectMatch ^/$ https://vaultwarden.example.com</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_du_site_vaultwarden">
<title>Configuration du site vaultwarden</title>
<simpara>Votre site web <literal>vaultwarden</literal> est installé et opérationnel.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Pointez votre navigateur sur votre site web <literal>vaultwarden</literal></simpara>
</listitem>
<listitem>
<simpara>Créez un compte avec votre login et choisissez un mot de passe.</simpara>
</listitem>
<listitem>
<simpara>Loggez vous sur le site vous pouvez maintenant créer des droits d&#8217;accès ou importer ceux d&#8217;un autre outil tel que <literal>lastpass</literal> ou <literal>1password</literal>.</simpara>
</listitem>
<listitem>
<simpara>Vous pouvez aussi vous connecter en tant qu&#8217;admin en allant sur l&#8217;url <link xl:href="https://vaultwarden.example.com/admin">https://vaultwarden.example.com/admin</link></simpara>
</listitem>
<listitem>
<simpara>Une fenetre apparait vous demandant le code de hachage que vous avez configuré à l&#8217;installation. Saisissez le.</simpara>
</listitem>
<listitem>
<simpara>vous pouvez maintenant configurer des options dans vaultwarden.</simpara>
</listitem>
<listitem>
<simpara>une option qu&#8217;il est important de configurer est la désactivation de la création de compte. Pour cela:</simpara>
<itemizedlist>
<listitem>
<simpara>allez dans <literal>General Settings</literal></simpara>
</listitem>
<listitem>
<simpara>désactivez <literal>Allow new signups</literal>. Cliquez sur <literal>Save</literal> (en bas à gauche).</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Les utilisateurs non invités ne pourront plus créer de compte sur votre serveur.</simpara>
</listitem>
<listitem>
<simpara>Une autre façon de faire est de démarrer le container docker avec l&#8217;option <literal>-e SIGNUPS_ALLOWED=false</literal></simpara>
</listitem>
</orderedlist>
<simpara>Sur votre smartphone on dans votre navigateur, configurez vaultwarden pour pointer vers votre serveur en y configurant l&#8217;URL: <literal><link xl:href="https://vaultwarden.example.com">https://vaultwarden.example.com</link></literal>
Logguez vous.</simpara>
<simpara>Tout est prêt!</simpara>
</section>
<section xml:id="_upgrade_de_vaultwarden">
<title>Upgrade de vaultwarden</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal>
Vous pouvez aussi appliquer la procédure de mise à jour des containers à l&#8217;aide de <link linkend="port_container_updt"><literal>Portainer</literal></link> ou à l&#8217;aide <link linkend="yacht_container_updt"><literal>Yacht</literal></link></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de Bitwarden_rs. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull vaultwarden/server:latest
docker stop vaultwarden
docker rm vaultwarden
docker run -d -p 1280:80 --name=vaultwarden --restart=always -v vaultwarden_data:/data:rw -e ROCKET_ENV=staging -e ROCKET_PORT=80 -e ROCKET_WORKERS=10 -e SMTP_HOST=mail.example.com -e SMTP_FROM=mailname@example.com -e SMTP_PORT=587 -e SMTP_SSL=true -e SMTP_USERNAME=mailname@example.com -e SMTP_PASSWORD=mailpassword -e WEBSOCKET_ENABLED=true -e ADMIN_TOKEN=Hashcode -e SIGNUPS_ALLOWED=false -e DOMAIN=https://vaultwarden.example.com vaultwarden/server:latest <co xml:id="CO74-1"/></programlisting>
<calloutlist>
<callout arearefs="CO74-1">
<para>ici il faut remplacer <literal>example.com</literal> par votre nom de domaine. Il faut aussi remplacer <literal>mailname@example.com</literal> par une boite mail valide sur le serveur et <literal>mailpassword</literal> par le mot de passe de cette boite mail valide. <literal>Hashcode</literal> doit être remplacé par le code de hashage généré. Ce code protège l&#8217;accès <literal>admin</literal> de vaultwarden.</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_de_heimdall">
<title>Installation de Heimdall</title>
<simpara>le logiciel <literal>Heimdall</literal> est un logiciel de portail offrant de nombreuses possibilités de configuration.</simpara>
<section xml:id="_prérequis_3">
<title>Prérequis</title>
<simpara>Il vous faudra tout d&#8217;abord installer <literal>docker</literal> en vous référant au chapitre qui y est consacré.</simpara>
</section>
<section xml:id="_installation_du_serveur_heimdall">
<title>Installation du serveur Heimdall</title>
<simpara>Nous allons installer Heimdall à partir de son container Docker.</simpara>
<simpara>Ouvrez un terminal et suivez la procédure:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Créez le docker de heimdall. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker volume create heimdall_data
docker run -d -p 1281:443 --name=heimdall --restart=always -v heimdall_data:/config:rw -e PGID=1000 -e PUID=1000  linuxserver/heimdall</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_du_site_web_de_heimdall">
<title>Création du site web de heimdall</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>heimdall</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>heimdall</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>heimdall</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# redirect from server
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
SSLProxyEngine On # Comment this out if no https required
ProxyPreserveHost    On
SSLProxyVerify none
SSLProxyCheckPeerCN off
SSLProxyCheckPeerName off
SSLProxyCheckPeerExpire off

ProxyPass / https://localhost:1281/
ProxyPassReverse / https://localhost:1281/

RedirectMatch ^/$ https://heimdall.example.com <co xml:id="CO75-1"/></programlisting>
<calloutlist>
<callout arearefs="CO75-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_configuration_du_site_heimdall">
<title>Configuration du site heimdall</title>
<simpara>Votre site web <literal>heimdall</literal> est installé et opérationnel.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Pointez votre navigateur sur votre site web <literal>heimdall</literal></simpara>
</listitem>
<listitem>
<simpara>Créez un compte avec votre login et choisissez un mot de passe.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez l&#8217;icone User (3 éme icone en forme de portrait à droite).</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez Admin et cliquez sur l&#8217;icone modifier</simpara>
</listitem>
<listitem>
<simpara>Tapez un mot de passe, le confirmer. Sélectionnez "Allow logging in from a specific URL". Cliquez sur "Enregistrez"</simpara>
</listitem>
<listitem>
<simpara>Une URL est maintenant disponible vous pouvez la mettre comme page d&#8217;accueil de votre navigateur</simpara>
</listitem>
</orderedlist>
<simpara>Tout est prêt!</simpara>
</section>
<section xml:id="_upgrade_de_heimdall">
<title>Upgrade de Heimdall</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal>
Vous pouvez aussi appliquer la procédure de mise à jour des containers à l&#8217;aide de <link linkend="port_container_updt"><literal>Portainer</literal></link> ou à l&#8217;aide <link linkend="yacht_container_updt"><literal>Yacht</literal></link></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de heimdall. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull linuxserver/heimdall
docker stop heimdall
docker rm heimdall
docker run -d -p 1281:443 --name=heimdall --restart=always -v heimdall_data:/config:rw -e PGID=1000 -e PUID=1000  linuxserver/heimdall</programlisting>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_du_système_de_partage_de_fichiers_seafile">
<title>Installation du système de partage de fichiers Seafile</title>
<simpara>Seafile est un système de partage de fichier simple et efficace écrit en Python. Il existe des clients de connexion pour Windows, Linux, Android, IOS.</simpara>
<simpara>Cette installation est optionnelle.</simpara>
<section xml:id="_création_du_site_web_de_seafile">
<title>Création du site web de Seafile</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>seafile</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>seafile</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>seafile</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# Seafile configuration

Alias /media {DOCROOT}/private/seafile/seafile-server-latest/seahub/media
RewriteEngine On

&lt;Location /media&gt;
Require all granted
&lt;/Location&gt;

# seafile httpserver
#
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On
ProxyPass /seafhttp http://localhost:8092
ProxyPassReverse /seafhttp http://localhost:8092
RewriteRule ^/seafhttp - [QSA,L]

# seahub
#
SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On
ProxyPass / http://localhost:8090/
ProxyPassReverse / http://localhost:8090/</programlisting>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_de_bases_de_données">
<title>Création de bases de données</title>
<orderedlist numeration="arabic">
<listitem>
<simpara>Loguez vous sur ISPConfig</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>seafile</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; Saisir <link linkend="pass_gen">votre mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; Resaisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Aller dans le menu <literal>Database</literal> pour définir les bases de données</simpara>
</listitem>
<listitem>
<simpara>Appliquer l&#8217;opération ci après 3 fois d&#8217;affilée pour créer les trois bases suivantes: <literal>ccnetdb</literal>, <literal>seafiledb</literal>, <literal>seahubdb</literal></simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données</simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxseafile</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Les trois bases de données doivent apparaître dans la liste des bases</simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_téléchargez_et_installez_seafile">
<title>Téléchargez et installez Seafile</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez quelques paquets Debian complémentaires. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install python3 python3-setuptools python3-pip default-libmysqlclient-dev
pip3 install --timeout=3600 Pillow pylibmc captcha jinja2 future mysqlclient sqlalchemy==1.4.3 psd-tools django-pylibmc django-simple-captcha python3-ldap</programlisting>
</listitem>
<listitem>
<simpara>Allez sur le site de téléchargement de <link xl:href="https://www.seafile.com/en/download/">Seafile</link> et copier le lien de téléchargement pour <literal>Server for generic Linux</literal></simpara>
</listitem>
<listitem>
<simpara>Il est préférable d&#8217;exécuter les serveurs dans un répertoire privé plutôt que dans le répertoire web pour des questions de sécurité. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib
mkdir seafile
cd seafile
wget https://s3.eu-central-1.amazonaws.com/download.seadrive.org/seafile-server_7.1.3_x86-64.tar.gz <co xml:id="CO76-1"/>
tar zxvf seafile-server_7.1.3_x86-64.tar.gz <co xml:id="CO76-2"/>
mkdir installed
mv seafile-server_* installed
cd seafile-server-*
./setup-seafile-mysql.sh
cd ../..
chown -R web1:client0 seafile <co xml:id="CO76-3"/></programlisting>
<calloutlist>
<callout arearefs="CO76-3">
<para>choisissez le user et le groupe de votre site web. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO76-1">
<para>coller ici l&#8217;adresse de téléchargement récupérée sur le site de Seafile.</para>
</callout>
<callout arearefs="CO76-2">
<para>le nom du fichier tar.gz dépend de la version que vous avez téléchargé. De même le nom du répertoire est dépendant de la version.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>A ce moment, vous devez répondre à un certain nombre de questions.</simpara>
</listitem>
<listitem>
<simpara>Choisissez le mode de configuration 2) pour indiquer vous même les informations sur les bases de données créées.</simpara>
</listitem>
<listitem>
<simpara>Vous devrez ensuite donner le nom d&#8217;utilisateur pour la base de données, le mot de passe ainsi que le nom des 3 bases de données.</simpara>
</listitem>
<listitem>
<simpara>Si tout est saisi correctement le programme doit donner une synthèse de ce qui a été configuré</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_lancement_initial">
<title>Lancement initial</title>
<simpara>Nous allons effectuer un premier lancement du serveur Seafile:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>allez dans le répertoire contenant les configurations et éditez <literal>gunicorn.conf</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib/seafile/conf
vi gunicorn.conf</programlisting>
</listitem>
<listitem>
<simpara>Repèrez le texte <literal>bind=</literal> et mettez un numéro de port 8090 à la place de 8000. Comme ceci:</simpara>
<programlisting language="bash" linenumbering="unnumbered">bind = "127.0.0.1:8090"</programlisting>
</listitem>
<listitem>
<simpara>Editez le fichier <literal>seafile.conf</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi seafile.conf</programlisting>
</listitem>
<listitem>
<simpara>mettez un port 8092 au lieu du port 8082 saisi pour l&#8217;entrée <literal>fileserver</literal>. Le fichier doit contenir ceci:</simpara>
<programlisting language="ini" linenumbering="unnumbered">[fileserver]
port = 8092</programlisting>
</listitem>
<listitem>
<simpara>Editez le fichier <literal>ccnet.conf</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi ccnet.conf</programlisting>
</listitem>
<listitem>
<simpara>modifier l&#8217;entrée SERVICE_URL. Le fichier doit contenir ceci:</simpara>
<programlisting language="bash" linenumbering="unnumbered">SERVICE_URL = https://seafile.example.com <co xml:id="CO77-1"/></programlisting>
<calloutlist>
<callout arearefs="CO77-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Editez le fichier <literal>seahub_settings.py</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi seahub_settings.py</programlisting>
</listitem>
<listitem>
<simpara>modifier l&#8217;entrée FILE_SERVER_ROOT. Le fichier doit contenir ceci:</simpara>
<programlisting language="python" linenumbering="unnumbered">FILE_SERVER_ROOT = 'https://seafile.example.com/seafhttp' <co xml:id="CO78-1"/></programlisting>
<calloutlist>
<callout arearefs="CO78-1">
<para>mettre à la place de <literal>example.com</literal> votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Démarrez Seafile. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib/seafile/seafile-server-latest
sudo -u web1 ./seafile.sh start <co xml:id="CO79-1"/>
sudo -u web1 ./seahub.sh start 8090 <co xml:id="CO79-2"/></programlisting>
<calloutlist>
<callout arearefs="CO79-1 CO79-2">
<para>remplacer le nom de user web1 par celui correspondant à celui du site web installé (indiqué dans le champ <literal>Options</literal>&#8594;`linux user` du web domain). (Si vous n&#8217;avez qu&#8217;un site, web1 est le bon).</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 8090 et 8092 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Faites pointer votre navigateur sur <link xl:href="https://seafile.example.com">https://seafile.example.com</link></simpara>
</listitem>
<listitem>
<simpara>La page de login de Seafile doit s&#8217;afficher</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_lancement_automatique_de_seafile">
<title>Lancement automatique de Seafile</title>
<simpara>Afin de s&#8217;assurer que Seafile tourne en permanence, on doit créer un script de lancement automatique de Seafile:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créer un script de lancement automatique. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib/seafile
touch startseafile.sh
chmod +x startseafile.sh
vi startseafile.sh</programlisting>
</listitem>
<listitem>
<simpara>Coller le texte suivant de le fichier ouvert:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/bash

# Change the value of "seafile_dir" to your path of seafile installation
seafile_dir=/var/lib/seafile
script_path=${seafile_dir}/seafile-server-latest
seafile_init_log=${seafile_dir}/logs/seafile.init.log
seahub_init_log=${seafile_dir}/logs/seahub.init.log
seafgc_init_log=${seafile_dir}/logs/seafgc.init.log

case "$1" in
start)
${script_path}/seafile.sh start &gt;&gt; ${seafile_init_log}
${script_path}/seahub.sh start 8090 &gt;&gt; ${seahub_init_log}
;;
restart)
${script_path}/seafile.sh restart &gt;&gt; ${seafile_init_log}
${script_path}/seahub.sh restart 8090 &gt;&gt; ${seahub_init_log}
;;
reload)
${script_path}/seahub.sh stop &gt;&gt; ${seahub_init_log}
${script_path}/seafile.sh stop &gt;&gt; ${seafile_init_log}
${script_path}/seaf-gc.sh &gt;&gt; ${seafgc_init_log}
${script_path}/seafile.sh start &gt;&gt; ${seafile_init_log}
${script_path}/seahub.sh start 8090 &gt;&gt; ${seahub_init_log}
;;
stop)
${script_path}/seahub.sh stop &gt;&gt; ${seahub_init_log}
${script_path}/seafile.sh stop &gt;&gt; ${seafile_init_log}
;;
*)
echo "Usage: /etc/init.d/seafile {start|stop|restart|reload}"
exit 1
;;
esac</programlisting>
</listitem>
<listitem>
<simpara>Créer un job cron dans ISPConfig pour démarrer Seafile au démarrage</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Allez dans la rubrique <literal>Sites</literal> puis dans le menu <literal>Cron Jobs</literal>. Cliquez sur <literal>Add cron Job</literal>. Saisisssez les champs:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Parent Website:</literal> &#8592; mettre <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Minutes:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Hours:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Days of month:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Months:</literal> &#8592; mettre <literal>@reboot</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Days of week:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Command to run:</literal> &#8592; mettre <literal>/var/lib/seafile/startseafile.sh start</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un second job cron dans ISPConfig pour redémarrer Seafile tous les jours</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Allez dans la rubrique <literal>Sites</literal> puis dans le menu <literal>Cron Jobs</literal>. Cliquez sur <literal>Add cron Job</literal>. Saisissez les champs:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Parent Website:</literal> &#8592; mettre <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Minutes:</literal> &#8592; mettre 45</simpara>
</listitem>
<listitem>
<simpara><literal>Hours:</literal> &#8592; mettre 20</simpara>
</listitem>
<listitem>
<simpara><literal>Days of month:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Months:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Days of week:</literal> &#8592; mettre *</simpara>
</listitem>
<listitem>
<simpara><literal>Command to run:</literal> &#8592; mettre <literal>/var/lib/seafile/startseafile.sh reload</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Arretez le serveur précédemment lancé en tant que root. Tapez:</simpara>
</listitem>
<listitem>
<simpara>Enjoy !</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_upgrade_de_seafile">
<title>Upgrade de Seafile</title>
<simpara>La procédure de mise à jour officielle de Seafile se trouve <link xl:href="https://manual.seafile.com/upgrade/upgrade/">ici</link></simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez sur le site de téléchargement de <link xl:href="https://www.seafile.com/en/download/">Seafile</link> et copier le lien de téléchargement pour <literal>Server for generic Linux</literal></simpara>
</listitem>
<listitem>
<simpara>Il est préférable d&#8217;exécuter les serveurs dans un répertoire privé plutôt que dans le répertoire web pour des questions de sécurité. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib/seafile
wget https://s3.eu-central-1.amazonaws.com/download.seadrive.org/seafile-server_7.1.3_x86-64.tar.gz <co xml:id="CO80-1"/>
tar zxvf seafile-server_7.1.3_x86-64.tar.gz <co xml:id="CO80-2"/>
./startseafile.sh stop
mv seafile-server_* installed
cd seafile-server-7.1.3 <co xml:id="CO80-3"/>
cd upgrade
./upgrade_7.1.2.sh <co xml:id="CO80-4"/>
./setup-seafile-mysql.sh
cd ../../..
chown -R web1:client0 seafile <co xml:id="CO80-5"/>
cd seafile/seafile-server-latest
sudo -u web1 ./seafile.sh start <co xml:id="CO80-6"/>
sudo -u web1 ./seahub.sh start 8090 <co xml:id="CO80-7"/></programlisting>
<calloutlist>
<callout arearefs="CO80-1">
<para>coller ici l&#8217;adresse de téléchargement récupérée sur le site de Seafile.</para>
</callout>
<callout arearefs="CO80-5 CO80-6 CO80-7">
<para>choisissez le user et le groupe de votre site web. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <literal>Options</literal>&#8594;champs Linux User et Linux Group.</para>
</callout>
<callout arearefs="CO80-2 CO80-3">
<para>le nom du fichier tar.gz dépend de la version que vous avez téléchargé. De même le nom du répertoire est dépendant de la version.</para>
</callout>
<callout arearefs="CO80-4">
<para>exécutez tous les scripts d&#8217;upgrade dont le numéro de version est supérieur ou égal au numéro de version du seafile installé préalablement.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Vérifiez que vous savez accéder à Seafile tant sur le site web qu&#8217;avec vos applis PC et smartphone</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_du_système_de_monitoring_grafana">
<title>Installation du système de monitoring Grafana</title>
<simpara>Grafana est un logiciel de visualisation et d&#8217;analyse à code source ouvert. Il vous permet d&#8217;interroger, de visualiser, d&#8217;alerter et d&#8217;explorer vos mesures, quel que soit l&#8217;endroit où elles sont stockées. En clair, il vous fournit des outils pour transformer vos données de base de données de séries chronologiques (TSDB) en de magnifiques graphiques et visualisations.
Grafana s&#8217;appuie sur Prometheus afin d&#8217;obtenir des métriques.
Loki est aussi installé pour réaliser une analyse précise des fichiers de logs.</simpara>
<simpara>Cette installation est optionnelle puisque Munin est déjà installé sur votre système.</simpara>
<section xml:id="_création_du_site_web_de_grafana">
<title>Création du site web de Grafana</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>grafana</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>grafana</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>grafana</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# grafana httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:3100/
ProxyPassReverse / http://localhost:3100/

RedirectMatch ^/$ https://grafana.example.com <co xml:id="CO81-1"/></programlisting>
<calloutlist>
<callout arearefs="CO81-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_grafana">
<title>Installation de Grafana</title>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "deb https://packages.grafana.com/oss/deb stable main" &gt;&gt;/etc/apt/sources.list.d/grafana.list
cd /etc/apt/trusted.gpg.d
wget https://packages.grafana.com/gpg.key grafana.asc</programlisting>
</listitem>
<listitem>
<simpara>Installez les paquets. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt update
apt install grafana prometheus prometheus-mysqld-exporter prometheus-apache-exporter prometheus-bind-exporter prometheus-process-exporter</programlisting>
</listitem>
<listitem>
<simpara>Editez la configuration de Prometheus. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/prometheus/prometheus.yml</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez les lignes suivantes:</simpara>
<programlisting language="yaml" linenumbering="unnumbered">  - job_name: 'prometheus'

    # Override the global default and scrape targets from this job every 5 seconds.
    scrape_interval: 5s
    scrape_timeout: 5s

    # metrics_path defaults to '/metrics'
    # scheme defaults to 'http'.

    static_configs:
      - targets: ['localhost:9090']

  - job_name: node
    # If prometheus-node-exporter is installed, grab stats about the local
    # machine by default.
    static_configs:
      - targets: ['localhost:9100']

  - job_name: dns-master
    static_configs:
      - targets: ['localhost:9119']
        labels:
          alias: dns-master

  - job_name: apache
    static_configs:
      - targets: ['localhost:9117']

  - job_name: process
    static_configs:
      - targets: ['localhost:9256']

  - job_name: mysql
    static_configs:
      - targets: ['localhost:9104']</programlisting>
</listitem>
<listitem>
<simpara>Editez la configuration de <literal>prometheus-process-exporter</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi etc/default/prometheus-process-exporter</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez les lignes suivantes:</simpara>
<screen linenumbering="unnumbered">ARGS="-procnames postgres,dovecot,apache2,sshd,php-fpm7.3,rspamd,named,mysqld"</screen>
</listitem>
<listitem>
<simpara>Editez la configuration de <literal>prometheus-mysqld-exporter</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi etc/default/prometheus-mysqld-exporter</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez les lignes suivantes:</simpara>
<screen linenumbering="unnumbered">ARGS='--config.my-cnf /etc/mysql/debian.cnf --collect.info_schema.tables.databases="*" --collect.auto_increment.columns --collect.perf_schema.file_instances.filter=".*" --collect.info_schema.tablestats'</screen>
</listitem>
<listitem>
<simpara>Ajuster les permissions du fichier de conf de mysql pour donner l&#8217;accès à prometheus. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 644 /etc/mysql/debian.cnf</programlisting>
</listitem>
<listitem>
<simpara>Ajustez la configuration de bind pour servir des statistiques. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/bind/named.conf</programlisting>
</listitem>
<listitem>
<simpara>Ajouter dans le fichier:</simpara>
<screen linenumbering="unnumbered">statistics-channels {
  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
};</screen>
</listitem>
<listitem>
<simpara>Activez dans mysql quelques statistiques. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mysql -p</programlisting>
</listitem>
<listitem>
<simpara>tapez votre mot de passe root pour mysql. puis taper:</simpara>
<programlisting language="mysql" linenumbering="unnumbered">INSTALL PLUGIN QUERY_RESPONSE_TIME_AUDIT SONAME 'query_response_time.so';
INSTALL PLUGIN QUERY_RESPONSE_TIME SONAME 'query_response_time.so';
INSTALL PLUGIN QUERY_RESPONSE_TIME_READ SONAME 'query_response_time.so';
INSTALL PLUGIN QUERY_RESPONSE_TIME_WRITE SONAME 'query_response_time.so';
SET GLOBAL query_response_time_stats=ON;
SET GLOBAL userstat=ON;</programlisting>
</listitem>
<listitem>
<simpara>Redémarrez les services. Taper:</simpara>
<programlisting language="mysql" linenumbering="unnumbered">service prometheus restart
service prometheus-mysqld-exporter restart
service prometheus-process-exporter restart</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_et_configuration_de_loki">
<title>Installation et configuration de Loki</title>
<simpara>Pour installer Loki, appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://github.com/grafana/loki/releases/">Loki</link> et copier l&#8217;adresse du lien vers la dernière version de loki-linux-amd64.zip (ou loki-linux-arm.zip pour raspberry pi 3 ou loki-linux-arm64.zip pour raspberry pi 4 ou 5)</simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /usr/local/bin
curl -fSL -o loki.gz https://github.com/grafana/loki/releases/download/v1.4.1/loki-linux-amd64.zip
gunzip loki.gz
chmod a+x loki</programlisting>
</listitem>
<listitem>
<simpara>Créez le fichier de configuration de loki</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/config-loki.yml</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez le texte ci dessous dans le fichier</simpara>
<screen>auth_enabled: false

server:
  http_listen_port: 3100
  log_level: "warn"

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 5m
  chunk_retain_period: 30s

schema_config:
  configs:
  - from: 2010-01-01
    store: boltdb
    object_store: filesystem
    schema: v9
    index:
      prefix: index_
      period: 168h

storage_config:
  boltdb:
    directory: /tmp/loki/index

  filesystem:
    directory: /tmp/loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0

table_manager:
  chunk_tables_provisioning:
    inactive_read_throughput: 0
    inactive_write_throughput: 0
    provisioned_read_throughput: 0
    provisioned_write_throughput: 0
  index_tables_provisioning:
    inactive_read_throughput: 0
    inactive_write_throughput: 0
    provisioned_read_throughput: 0
    provisioned_write_throughput: 0
  retention_deletes_enabled: false
  retention_period: 0</screen>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 3100 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Testez maintenant la configuration de Loki. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">loki -config.file /etc/config-loki.yml</programlisting>
</listitem>
<listitem>
<simpara>Ouvrez un navigateur et visitez: <link xl:href="http://example.com:3100/metrics">http://example.com:3100/metrics</link></simpara>
</listitem>
<listitem>
<simpara>Maintenant arrêtez Loki en tapant <emphasis role="strong">CTRL-C</emphasis>.</simpara>
</listitem>
<listitem>
<simpara><link linkend="firewall">Bloquez le port 3100 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Configurez un service Loki afin de le faire tourner en arrière plan. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/systemd/system/loki.service</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez le texte ci dessous et sauvez:</simpara>
<screen linenumbering="unnumbered">[Unit]
Description=Loki service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/loki -config.file /etc/config-loki.yml

[Install]
WantedBy=multi-user.target</screen>
</listitem>
<listitem>
<simpara>Maintenant lancez le service et vérifiez que tout est fonctionnel. Tapez:
Now start and check the service is running.</simpara>
<programlisting language="bash" linenumbering="unnumbered">sudo service loki start
sudo service loki status</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_et_configuration_de_promtail">
<title>Installation et configuration de Promtail</title>
<simpara>Installez maintenant Promtail:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>allez sur le site de <link xl:href="https://github.com/grafana/loki/releases/">Loki</link> et copier l&#8217;adresse du lien vers la dernière version de promtail-linux-amd64.zip (ou promtail-linux-arm.zip pour raspberry pi 3 ou promtail-linux-arm64.zip pour raspberry pi 4 ou 5)</simpara>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /usr/local/bin
curl -fSL -o promtail.zip https://github.com/grafana/loki/releases/download/v1.4.1/promtail-linux-amd64.zip
gunzip promtail.zip
chmod a+x promtail</programlisting>
</listitem>
<listitem>
<simpara>Créez la configuration de Promtail. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /var/log/journal
vi /etc/config-promtail.yml</programlisting>
</listitem>
<listitem>
<simpara>Et ajoutez le texte suivant puis sauvez:</simpara>
<screen linenumbering="unnumbered">server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://127.0.0.1:3100/api/prom/push

scrape_configs:
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/{*.log,*/*.log}</screen>
</listitem>
<listitem>
<simpara><link linkend="firewall">Debloquez le port 9800 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>testez que Promtail fonctionne. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">promtail -config.file /etc/config-promtail.yml</programlisting>
</listitem>
<listitem>
<simpara>Ouvrez un navigateur et visitez: <link xl:href="http://example.com:9080">http://example.com:9080</link></simpara>
</listitem>
<listitem>
<simpara>Maintenant arrêtez Promtail en tapant <emphasis role="strong">CTRL-C</emphasis>.</simpara>
</listitem>
<listitem>
<simpara><link linkend="firewall">Bloquez le port 9800 sur votre firewall</link></simpara>
</listitem>
<listitem>
<simpara>Configurez un service Promtail afin de le faire tourner en arrière plan. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/systemd/system/promtail.service</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez le texte ci dessous et sauvez:</simpara>
<screen linenumbering="unnumbered">[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/promtail -config.file /etc/config-promtail.yml

[Install]
WantedBy=multi-user.target</screen>
</listitem>
<listitem>
<simpara>Maintenant lancez le service et vérifiez que tout est fonctionnel. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">sudo service promtail start
sudo service promtail status</programlisting>
</listitem>
<listitem>
<simpara>Allez sur votre site grafana <link xl:href="http://grafana.example.com">http://grafana.example.com</link> et ajoutez une source de données de type loki</simpara>
</listitem>
<listitem>
<simpara>Mettez l&#8217;URL suivante: <link xl:href="http://127.0.0.1:3100">http://127.0.0.1:3100</link> . Laissez tout le reste tel quel.</simpara>
</listitem>
<listitem>
<simpara>vous pouvez maintenant explorer vos logs en utilisant le menu explore sur la gauche. Dans la zone texte "Log Labels" essayez ces examples un à un:</simpara>
<screen linenumbering="unnumbered">{job="varlogs"}</screen>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_grafana">
<title>Upgrade de Grafana</title>
<simpara>Comme grafana est installé à partir de paquets Debian, la mise à jour s&#8217;effectue automatiquement avec le système.</simpara>
<simpara>Il reste cependant Loki et Promtail à mettre à jour.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://github.com/grafana/loki/releases/">Loki</link> et copier l&#8217;adresse du lien vers la dernière version de loki-linux-amd64.zip (ou loki-linux-arm.zip pour raspberry pi 3 ou loki-linux-arm64.zip pour raspberry pi 4 ou 5)</simpara>
</listitem>
<listitem>
<simpara>allez sur le site de <link xl:href="https://github.com/grafana/loki/releases/">Loki</link> et copier l&#8217;adresse du lien vers la dernière version de promtail-linux-amd64.zip (ou promtail-linux-arm.zip pour raspberry pi 3 ou promtail-linux-arm64.zip pour raspberry pi 4)</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour Loki et Promtail à jour. Exécutez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /usr/local/bin
curl -fSL -o loki.gz https://github.com/grafana/loki/releases/download/v2.2.1/loki-linux-amd64.zip
gunzip loki.gz
chmod a+x loki
curl -fSL -o promtail.zip https://github.com/grafana/loki/releases/download/v2.2.1/promtail-linux-amd64.zip
gunzip promtail.zip
chmod a+x promtail</programlisting>
</listitem>
<listitem>
<simpara>redémarrez les service. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">sudo service loki restart
sudo service loki status
sudo service promtail restart
sudo service promtail status</programlisting>
</listitem>
<listitem>
<simpara>Allez sur votre site Grafana <link xl:href="http://grafana.example.com">http://grafana.example.com</link></simpara>
</listitem>
<listitem>
<simpara>Vérifiez que tout fonctionne</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_du_système_de_backup_borgbackup">
<title>Installation du système de backup BorgBackup</title>
<simpara>BorgBackup est un système de backup simple mais offrant des fonctionnalités avancées telles que le backup incrémental, la déduplication de données, la compression, l&#8217;authentification, l&#8217;encryption.</simpara>
<simpara>Borg backup est un système de backup offsite. Cela signifie que vous devez avoir accès à un espace de stockage sur un autre site pour effectuer cette sauvegarde.</simpara>
<simpara>Pour le moment, BorgBackup n&#8217;utilise pas de mécanisme de type RClone et il n&#8217;est donc pas encore possible de sauvegarder sur google drive ou autres espaces partagés.</simpara>
<section xml:id="_introduction">
<title>Introduction</title>
<simpara>BorgBackup permet de stocker des backups sur un serveur distant.
Nous nommerons le serveur sur lequel les sauvegardes seront stockées : serveur de stockage et identifié par &lt;storing_srv&gt;.
Nous nommerons le serveur qu&#8217;il faut sauvegarder: serveur sauvegardé et identifié par &lt;example.com&gt;</simpara>
</section>
<section xml:id="_installation_du_serveur_de_stockage">
<title>Installation du serveur de stockage</title>
<simpara>Il est préférable pour des questions de sécurité de créer un compte utilisateur spécifique.</simpara>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install borgbackup</programlisting>
</listitem>
<listitem>
<simpara><link linkend="pass_gen">Générez un mot de passe long</link></simpara>
<important>
<simpara>Sauvegardez précieusement ce mot de passe. Il vous sera indispensable pour récupérer vos backup après un crash du serveur. Sans celui-ci, impossible de récupérer votre installation !</simpara>
</important>
</listitem>
<listitem>
<simpara>Créez un compte utilisateur. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">adduser borgbackup</programlisting>
</listitem>
<listitem>
<simpara>Copiez-collez le mot de passe généré lorsqu&#8217;il est demandé</simpara>
</listitem>
<listitem>
<simpara>se loguer comme <literal>borgbackup</literal></simpara>
</listitem>
<listitem>
<simpara>Créer un répertoire <literal>~/.ssh</literal> s&#8217;il n&#8217;existe pas. tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p $HOME/.ssh
chmod 700 ~/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Allez dans le répertoire. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd ~/.ssh</programlisting>
</listitem>
<listitem>
<simpara>Générez vous clés. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh-keygen -t rsa</programlisting>
</listitem>
<listitem>
<simpara>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</simpara>
</listitem>
<listitem>
<simpara>Créez maintenant le répertoire pour recevoir les sauvegardes</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd
mkdir borgbackup
chmod 700 borgbackup</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_sur_le_serveur_sauvegardé">
<title>Installation sur le serveur sauvegardé</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install borgbackup</programlisting>
</listitem>
<listitem>
<simpara>Copiez la clé publique de root sur le &lt;storing_srv&gt;. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh-copy-id -i ~/.ssh/id_*.pub borgbackup@&lt;storing_srv&gt;</programlisting>
</listitem>
<listitem>
<simpara>Coller le mot de passe généré plus haut lorsqu&#8217;il est demandé</simpara>
</listitem>
<listitem>
<simpara>Affichez votre adresse IP. tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">wget -qO- http://ipecho.net/plain; echo</programlisting>
</listitem>
<listitem>
<simpara>Faites un essai de connexion en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ssh borgbackup@&lt;storing_srv&gt;</programlisting>
</listitem>
<listitem>
<simpara>Aucun mot de passe ne doit être demandée et vous devez être connecté en tant que borgbackup sur le &lt;storing_srv&gt;</simpara>
</listitem>
<listitem>
<simpara>Si vous êtes très attaché à la sécurité, vous pouvez restreindre l&#8217;accès au seul serveur &lt;example.com&gt;. Tapez sur la ligne de commande du &lt;storing_srv&gt; :</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi ~/.ssh/authorized_keys</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez en première ligne du fichier :</simpara>
<screen>from="SERVERIPADDRESS",command="borg serve --restrict-to-path /home/borgbackup/borgbackup/",no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc <co xml:id="CO82-1"/></screen>
<calloutlist>
<callout arearefs="CO82-1">
<para>remplacez SERVERIPADDRESS par l&#8217;adresse IP affichée plus tôt.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Fusionnez cette ligne avec la suivante qui démarre par ssh en prenant bien garde de laissez un espace entre no-user-rc et ssh-rsa</simpara>
</listitem>
<listitem>
<simpara>Déconnectez vous en tapant :</simpara>
<programlisting language="bash" linenumbering="unnumbered">exit</programlisting>
</listitem>
<listitem>
<simpara>De retour sur le serveur &lt;example.com&gt;</simpara>
</listitem>
<listitem>
<simpara><link linkend="pass_gen">Créez un mot de passe pour le dépot borg backup</link>.</simpara>
<important>
<simpara>Sauvegardez précieusement ce mot de passe. Il vous sera indispensable pour récupérer vos backup après un crash du serveur. Sans celui-ci, impossible de récupérer votre installation !</simpara>
</important>
</listitem>
<listitem>
<simpara>Puis tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">export BORG_PASSPHRASE='mot_passe' <co xml:id="CO83-1"/></programlisting>
<calloutlist>
<callout arearefs="CO83-1">
<para>mot_passe doit être remplacé par celui généré plus haut</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Initialisez le dépot borg. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">borg init -e repokey-blake2 borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</programlisting>
</listitem>
<listitem>
<simpara>Tout est maintenant prêt pour faire un backup</simpara>
</listitem>
<listitem>
<simpara>avec le mode <literal>repokey</literal>, une clé de cryptage est stockée dans le repository de backup. Il est conseillé de la sauvegarder. Pour cela, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">borg key export borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</programlisting>
</listitem>
<listitem>
<simpara>Notez bien la clé qui sert à décrypter le repository dans un endroit sécurisé
=== Effectuer un backup</simpara>
</listitem>
</orderedlist>
<simpara>Nous allons créer tout d&#8217;abord un script de backup pour sauvegarder tout le serveur sauf les répertoires système:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgbackup.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO84-1"/>
cd / &amp;&amp; /usr/bin/borg create --stats --progress --compress zstd borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::`hostname`-`date +%Y-%m-%d-%H-%M-%S` ./ --exclude=dev --exclude=proc --exclude=run --exclude=root/.cache/ --exclude=mnt/borgmount --exclude=sys --exclude=swapfile --exclude=tmp &amp;&amp; cd <co xml:id="CO84-2"/></programlisting>
<calloutlist>
<callout arearefs="CO84-1">
<para>mot_passe doit être remplacé par celui généré plus haut</para>
</callout>
<callout arearefs="CO84-2">
<para>en fonction de la puissance de votre machine, vous pouvez remplacer l&#8217;algorithme de compression zstd par un algorithme lz4 (rapide) ou  lzma (très lent mais performant en taille).</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgbackup.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant effectuer une première sauvegarde en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgbackup.sh</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_lister_les_backups">
<title>Lister les backups</title>
<simpara>Nous allons créer un script de listage :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borglist.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO85-1"/>
/usr/bin/borg list -v borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</programlisting>
<calloutlist>
<callout arearefs="CO85-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borglist.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant lister vos backup en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borglist.sh</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_obtenir_les_infos_sur_un_backup">
<title>Obtenir les infos sur un backup</title>
<simpara>Nous allons créer un script de listage :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borginfo.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO86-1"/>
/usr/bin/borg info --progress borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::$1</programlisting>
<calloutlist>
<callout arearefs="CO86-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borginfo.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant lister vos backup en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borginfo.sh</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_vérifier_un_backup">
<title>Vérifier un backup</title>
<simpara>Nous allons créer un script de vérification :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgcheck.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO87-1"/>
/usr/bin/borg check --progress borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::$1</programlisting>
<calloutlist>
<callout arearefs="CO87-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgcheck.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant vérifier un de vos backup en tapant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgcheck.sh &lt;nom_de_sauvegarde&gt; <co xml:id="CO88-1"/></programlisting>
<calloutlist>
<callout arearefs="CO88-1">
<para>le nom de sauvegarde est récupéré en utilisant la commande borglist.sh</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_restaurer_un_backup">
<title>Restaurer un backup</title>
<simpara>Nous allons créer un script de montage sous forme de système de fichier :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgmount.sh</programlisting>
</listitem>
<listitem>
<simpara>Insérez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
mkdir -p /mnt/borgbackup
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO89-1"/>
/usr/bin/borg mount borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/ /mnt/borgbackup</programlisting>
<calloutlist>
<callout arearefs="CO89-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgmount.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant monter vos backups et effectuer des opérations de fichiers. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgmount.sh</programlisting>
</listitem>
<listitem>
<simpara>Pour créer un script pour démonter les backups. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgumount.sh</programlisting>
</listitem>
<listitem>
<simpara>Insérez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
umount /mnt/borgbackup
rmdir /mnt/borgbackup</programlisting>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgumount.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant demonter vos backups. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgumount.sh</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_supprimer_vos_vieux_backups">
<title>Supprimer vos vieux backups</title>
<simpara>Nous allons créer un script de ménage des backups :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;example.com&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgprune.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh

# Nettoyage des anciens backups
# On conserve
# - une archive par jour les 7 derniers jours,
# - une archive par semaine pour les 4 dernières semaines,
# - une archive par mois pour les 6 derniers mois.


export BORG_PASSPHRASE='mot_passe' <co xml:id="CO90-1"/>
/usr/bin/borg prune --stats --progress borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/ --prefix `hostname`- --keep-daily=7 --keep-weekly=4 --keep-monthly=12 <co xml:id="CO90-2"/></programlisting>
<calloutlist>
<callout arearefs="CO90-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
<callout arearefs="CO90-2">
<para>Le nettoyage des sauvegardes va conserver 7 sauvegardes journalières, 4 à la semaine et 12 au mois</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgprune.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant effectuer du ménage:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgprune.sh</programlisting>
</listitem>
<listitem>
<simpara>Pour récupèrer l&#8217;espace libéré par la suppression des sauvegardes inutiles, créez le script suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /usr/local/bin/borgcompact.sh</programlisting>
</listitem>
<listitem>
<simpara>Insèrez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh

export BORG_PASSPHRASE='mot_passe' <co xml:id="CO91-1"/>
/usr/bin/borg compact --progress  borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</programlisting>
<calloutlist>
<callout arearefs="CO91-1">
<para>mot_passe doit être remplacé par celui généré plus haut.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgcompact.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez maintenant effectuer du ménage:</simpara>
<programlisting language="bash" linenumbering="unnumbered">/usr/local/bin/borgcompact.sh</programlisting>
<simpara>=== Automatisez votre sauvegarde</simpara>
</listitem>
<listitem>
<simpara>Pour créer un script automatisé de backup. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /var/log/borg
vi /usr/local/bin/borgcron.sh</programlisting>
</listitem>
<listitem>
<simpara>Insérez dans le fichier le texte suivant:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#!/bin/sh
#
# Script de sauvegarde.
#

set -e

LOG_PATH=/var/log/borg/cron.log

/usr/local/bin/borgbackup.sh &gt;&gt; ${LOG_PATH} 2&gt;&amp;1
/usr/local/bin/borgprune.sh &gt;&gt; ${LOG_PATH} 2&gt;&amp;1
/usr/local/bin/borgcompact.sh &gt;&gt; ${LOG_PATH} 2&gt;&amp;1</programlisting>
</listitem>
<listitem>
<simpara>changez les permissions du script. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">chmod 700 /usr/local/bin/borgcron.sh</programlisting>
</listitem>
<listitem>
<simpara>vous pouvez ensuite planifier votre backup à 1h du matin. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">crontab -e</programlisting>
</listitem>
<listitem>
<simpara>Inserez ensuite le texte suivant:</simpara>
</listitem>
</orderedlist>
<screen># Backup via Borg to backup server
00 01 * * * /usr/local/bin/borgcron.sh</screen>
</section>
<section xml:id="_restauration_durgence">
<title>Restauration d&#8217;urgence.</title>
<simpara>En cas de crash du serveur, l’intérêt du backup offsite est de pouvoir remonter la dernière sauvegarde sans souci.
Pour cela il faut avoir un moyen de booter le serveur dans un mode rescue (boot du VPS en mode rescue, utilisation d&#8217;un clé USB bootable, boot réseau ou autre moyen).</simpara>
<simpara>On suppose dans ce qu&#8217;il suit que vous avez booté sur un linux de type debian ou ubuntu dont la version n&#8217;est pas la toute dernière et dans laquelle borg-backup n&#8217;est pas obligatoirement présent du moins dans un version suffisamment récente.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>loguez vous root sur votre serveur. A noter que, comme vous êtes en mode rescue, l&#8217;accès au mode est indiqué par votre hébergeur ou, si vous avez booté sur une clé USB en local, l&#8217;accès root s&#8217;effectue souvent avec une commande <literal>sudo bash</literal></simpara>
</listitem>
<listitem>
<simpara>Montez votre partition racine. Sur un VPS, la partition est souvent déjà montée dans le répertoire /mnt. Sur un PC c&#8217;est souvent /dev/sda1. Sur un Raspberry Pi cette partition est /dev/mmcblk0p7. Tapez la commande:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /mnt/root
mount /dev/mmcblk0p7 /mnt/root</programlisting>
</listitem>
<listitem>
<simpara>Installez borgbackup. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install python3-pip libssl-dev cython3 gcc g++ libpython3-dev libacl1-dev python3-llfuse libfuse-dev
pip3 install -U pip setuptools wheel
pip3 install pkgconfig
pip3 install borgbackup[llfuse]</programlisting>
</listitem>
<listitem>
<simpara>Si la compilation échoue, c&#8217;est qu&#8217;il manque des packages. lisez attentivement les logs et installez les packages manquant.</simpara>
</listitem>
<listitem>
<simpara>Munissez vous du mot de passe &lt;mot_passe&gt; des archives borg et tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /mnt/borgbackup
export BORG_PASSPHRASE='mot_passe' <co xml:id="CO92-1"/>
borg list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</programlisting>
<calloutlist>
<callout arearefs="CO92-1">
<para>remplacez mot_passe par votre mot de passe de borg</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>tapez le mot de passe du compte borgbackup.</simpara>
</listitem>
<listitem>
<simpara>la liste des sauvegardes est affichées à l&#8217;écran.</simpara>
</listitem>
<listitem>
<simpara>Choisissez l&#8217;archive qui vous convient et tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /mnt/root
borg extract --list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::&lt;votre_archive&gt;</programlisting>
</listitem>
<listitem>
<simpara>tapez le mot de passe du compte borgbackup.</simpara>
</listitem>
<listitem>
<simpara>la restauration s&#8217;effectue et peut prendre des heures ! soyez patient.</simpara>
</listitem>
<listitem>
<simpara>il peut être nécessaire de réinstaller le bootloader (non utile sur VPS ou raspberry). Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /mnt/root
chroot . bash
mkdir -p dev proc run sys tmp
mount -t devtmpfs dev /dev
mount -t proc proc /proc
grub_install /dev/sda <co xml:id="CO93-1"/>
umount /proc
umount /dev
sync
exit</programlisting>
<calloutlist>
<callout arearefs="CO93-1">
<para>tapez ici le nom de device de votre disque de boot</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Créez votre fichier de swap en suivant <link linkend="swap_create">la
procédure</link>. Attention le fichier de swap doit être installé dans
<literal>/mnt/root/swapfile</literal></simpara>
</listitem>
<listitem>
<simpara>vous pouvez maintenant rebooter votre machine en mode normal.</simpara>
</listitem>
<listitem>
<simpara>une autre façon de remonter la sauvegarde est d&#8217;extraire un fichier tar.xz directement du serveur de stockage et de transférer cette archive sur la machine en mode rescue puis de décompresser. La commande de génération d&#8217;archive est:</simpara>
<programlisting language="bash" linenumbering="unnumbered">borg export-tar --list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::&lt;votre_archive&gt; restore.tar.xz</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_borgweb">
<title>Installation de Borgweb</title>
<simpara>Borgweb existe en version officielle. Cette version n&#8217;a pas trop d&#8217;intéret pour nous étant donnée qu&#8217;elle n&#8217;interroge pas le serveur de stockage pour obtenir les informations des backups réalisés. Il existe un clone de repository qui implémente une fonctionnalité qui liste tous les backups effectués sur le serveur de stockage</simpara>
<simpara>Suivez la procédure suivante sur le serveur de stockage:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Installez pip  pour python3 et NPM. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">apt install python3-pip npm</programlisting>
</listitem>
<listitem>
<simpara>Installer le logiciel dans le répertoire <literal>/var/lib/borgweb</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /var/lib/borgweb
cd /var/lib/borgweb
git clone https://github.com/vche/borgweb.git</programlisting>
</listitem>
<listitem>
<simpara>Dans la version testée, le fichier <literal>README.rst</literal> est utilisé par l&#8217;installeur mais plus présent dans le repo. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd borgweb
touch README.rst</programlisting>
</listitem>
<listitem>
<simpara>Lancez l&#8217;installation. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">pip3 install -e .
cd js
npm install</programlisting>
</listitem>
<listitem>
<simpara>Editez la configuration. Comme la variable d&#8217;environnement <literal>BORG_CONFIG</literal> semble n&#8217;avoir aucun effet, éditez directement le fichier de configuration du repository. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /var/lib/borgweb/borgweb/borgweb
vi config.py</programlisting>
</listitem>
<listitem>
<simpara>Mettez ce texte dans le fichier édité:</simpara>
<programlisting language="python" linenumbering="unnumbered">class Config(object):
    """This is the basic configuration class for BorgWeb."""

    #: builtin web server configuration
    HOST = '127.0.0.1'  # use 0.0.0.0 to bind to all interfaces
    PORT = 5000  # ports &lt; 1024 need root
    DEBUG=False

    #: borg / borgweb configuration
    LOG_DIR = '/var/log/borg'
    BORG_PATH="/usr/bin/borg"

    # Repo status cache configuration. TTL in secs
    STATUS_CACHE_TTL=43200
    STATUS_CACHE_PATH="/tmp/borgweb.cache"

    BACKUP_REPOS = {
        # Repo  name
        "example.com": { <co xml:id="CO94-1"/>
            # Repo absolute path
            "repo_path": "/home/borgbackup/borgbackup",

            # Repo logs absolute path, or relative to the main LOG_DIR
            "log_path": "/var/log/borg/",

            # Repo password
            "repo_pwd": "your_password", <co xml:id="CO94-2"/>

            # Command/script to run to manually start a backup.
            # If left empty or not specified, the backup won't be
            # manually runnable
            "script": "script",

            # Filled with discovered backups in the repo
            "backups": []
        }
    }</programlisting>
<calloutlist>
<callout arearefs="CO94-2">
<para>Insérez ici le mot de passe du dépot Borg Backup</para>
</callout>
<callout arearefs="CO94-1">
<para>Mettez ici le nom de votre domaine sauvegardé</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Créez un service <literal>systemd</literal>. Editez le fichier de service. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/systemd/system/borgweb.service</programlisting>
</listitem>
<listitem>
<simpara>Insérez dans le fichier le texte suivant:</simpara>
<screen linenumbering="unnumbered">[Unit]
Description=Borgweb Daemon
After=syslog.target network.target

[Service]
WorkingDirectory=/var/lib/borgweb
User=root
Group=root
UMask=0002
Restart=on-failure
RestartSec=5
Type=simple
ExecStart=/usr/local/bin/borgweb
KillSignal=SIGINT
TimeoutStopSec=20
SyslogIdentifier=borgweb

[Install]
WantedBy=multi-user.target</screen>
</listitem>
<listitem>
<simpara>Recharge la base de systemd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl daemon-reload</programlisting>
</listitem>
<listitem>
<simpara>Activez et démarrez <literal>borgweb</literal>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl enable borgweb.service
systemctl start borgweb.service</programlisting>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_du_site_web_de_borgweb">
<title>Création du site web de Borgweb</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig de votre serveur de stockage &lt;storing_srv&gt;:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>borgweb</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>borgweb</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>borgweb</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

# borgweb httpserver
#

&lt;Location /&gt;
    AllowOverride AuthConfig
    AuthUserFile /var/lib/borgweb/borgweb-htpasswd
    AuthName "Borgweb"
    AuthType Basic
    Require valid-user

&lt;/Location&gt;


ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# borgweb httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On
ProxyPass / http://localhost:5000/
ProxyPassReverse / http://localhost:5000/

RedirectMatch ^/$ https://borgweb.example.com <co xml:id="CO95-1"/></programlisting>
<calloutlist>
<callout arearefs="CO95-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </link></simpara>
</listitem>
<listitem>
<simpara>Créez ensuite le fichier de mot de passe de borgweb dans votre &lt;storing_srv&gt;:</simpara>
<programlisting language="bash" linenumbering="unnumbered">htpasswd -c /var/lib/borgweb/borgweb-htpasswd admin</programlisting>
</listitem>
<listitem>
<simpara>Tapez <link linkend="pass_gen">votre mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara>Redémarrez apache. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">service apache2 restart</programlisting>
</listitem>
<listitem>
<simpara>Pointez votre navigateur sur <link xl:href="https://borgweb.storing_srv">https://borgweb.storing_srv</link> , un mot de passe vous est demandé. Tapez <literal>admin</literal> pour le user et le password saisi. Vous accédez aux informations de sauvegarde de votre site.</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_dun_serveur_de_vpn_wireguard">
<title>Installation d&#8217;un serveur de VPN Wireguard</title>
<section xml:id="_création_du_site_web_de_wireguard">
<title>Création du site web de Wireguard</title>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>wireguard</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>wireguard</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>wireguard</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# wireguard httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass / http://localhost:51821/
ProxyPassReverse / http://localhost:51821/

RedirectMatch ^/$ https://wireguard.example.com <co xml:id="CO96-1"/></programlisting>
<calloutlist>
<callout arearefs="CO96-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_de_wireguard">
<title>Installation de Wireguard</title>
<simpara>Nous allons installer wg-easy qui est un container qui implémente wireguard dans un docker.</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Installez Wireguard. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker run -d \
  --name=wg-easy \
  -e LANG=fr \
  -e WG_HOST=Public_IP \ <co xml:id="CO97-1"/>
  -e PASSWORD=mot_de_passe \ <co xml:id="CO97-2"/>
  -e PORT=51821 \
  -e WG_PORT=51820 \
  -v /etc/wg-easy:/etc/wireguard \
  -p 51820:51820/udp \
  -p 51821:51821/tcp \
  --cap-add=NET_ADMIN \
  --cap-add=SYS_MODULE \
  --sysctl="net.ipv4.conf.all.src_valid_mark=1" \
  --sysctl="net.ipv4.ip_forward=1" \
  --restart unless-stopped \
  ghcr.io/wg-easy/wg-easy</programlisting>
<calloutlist>
<callout arearefs="CO97-1">
<para>saisir votre adresse IP publique donnée par exemple sur le site <link xl:href="https://www.showmyip.com/">https://www.showmyip.com/</link>. Attention ce doit être une IP V4</para>
</callout>
<callout arearefs="CO97-2">
<para>saisir <link linkend="pass_gen">un mot de passe généré</link></para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Configurez votre firewall pour ouvrir le port 51820 en mode UDP</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_update_de_wireguard">
<title>Update de Wireguard</title>
<simpara>Rien a faire pour la mise à jour si vous utilisez <literal>Watchtower</literal></simpara>
<simpara>Sinon, effectuez les opérations suivantes:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Allez dans le répertoire de root</simpara>
</listitem>
<listitem>
<simpara>Mettez à jour le docker de wg-easy. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">docker pull ghcr.io/wg-easy/wg-easy
docker stop wg-easy
docker rm wg-easy
docker run -d \
  --name=wg-easy \
  -e LANG=fr \
  -e WG_HOST=Public_IP \ <co xml:id="CO98-1"/>
  -e PASSWORD=mot_de_passe \ <co xml:id="CO98-2"/>
  -e PORT=51821 \
  -e WG_PORT=51820 \
  -v /etc/wg-easy:/etc/wireguard \
  -p 51820:51820/udp \
  -p 51821:51821/tcp \
  --cap-add=NET_ADMIN \
  --cap-add=SYS_MODULE \
  --sysctl="net.ipv4.conf.all.src_valid_mark=1" \
  --sysctl="net.ipv4.ip_forward=1" \
  --restart unless-stopped \
  ghcr.io/wg-easy/wg-easy</programlisting>
<calloutlist>
<callout arearefs="CO98-1">
<para>saisir votre adresse IP publique donnée par exemple sur le site <link xl:href="https://www.showmyip.com/">https://www.showmyip.com/</link>. Attention ce doit être une IP V4</para>
</callout>
<callout arearefs="CO98-2">
<para>saisir <link linkend="pass_gen">un mot de passe généré</link></para>
</callout>
</calloutlist>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_installation_dun_serveur_de_bureau_à_distance_guacamole">
<title>Installation d&#8217;un serveur de bureau à distance Guacamole</title>
<simpara>Apache Guacamole est un logiciel opensource et une application web de bureau à distance qui vous permet d&#8217;accéder à vos machines de bureau par le biais d&#8217;un navigateur web. Il s&#8217;agit d&#8217;une appli web html5 qui prend en charge des protocoles standard comme VNC, RDP et SSH. Vous n&#8217;avez pas besoin d&#8217;installer et d&#8217;utiliser des logiciels ou des plugins sur le serveur. Avec Guacamole, vous pouvez facilement passer d&#8217;un bureau d&#8217;une machine à l&#8217;autre avec le même navigateur.</simpara>
<simpara>Guacamole est assez ancien et d&#8217;un point de vue protocole, il ne saura pas se connecter avec des serveurs VNC utilisants les stack cryptos récentes. Il faut se mettre en version compatible 3.8 de serveur VNC.</simpara>
<section xml:id="_création_du_site_web_de_guacamole">
<title>Création du site web de Guacamole</title>
<simpara>Appliquez les opérations suivantes Dans ISPConfig:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Allez dans la rubrique <literal>DNS</literal>, sélectionnez le menu <literal>Zones</literal>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <literal>Records</literal>.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Cliquez sur <literal>A</literal> et saisissez:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Hostname:</literal> &#8592; Tapez <literal>guacamole</literal></simpara>
</listitem>
<listitem>
<simpara><literal>IP-Address:</literal> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Créer un <link linkend="subdomain-site">sub-domain (vhost)</link> dans le configurateur de sites.</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Lui donner le nom <literal>guacamole</literal>.</simpara>
</listitem>
<listitem>
<simpara>Le faire pointer vers le web folder <literal>guacamole</literal>.</simpara>
</listitem>
<listitem>
<simpara>Sélectionnez <literal>None</literal> dans <literal>Auto-subdomain</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>let’s encrypt SSL</literal></simpara>
</listitem>
<listitem>
<simpara>Activer <literal>PHP-FPM</literal> pour PHP</simpara>
</listitem>
<listitem>
<simpara>Dans l&#8217;onglet Redirect Cochez la case <literal>Rewrite HTTP to HTTPS</literal></simpara>
</listitem>
<listitem>
<simpara>Laisser le reste par défaut.</simpara>
</listitem>
<listitem>
<simpara>Dans l’onglet Options:</simpara>
</listitem>
<listitem>
<simpara>Dans la boite <literal>Apache Directives:</literal> saisir le texte suivant:</simpara>
<programlisting language="apache" linenumbering="unnumbered">&lt;Proxy *&gt;
Order deny,allow
Allow from all
&lt;/Proxy&gt;

ProxyRequests Off
ProxyPass /stats !
ProxyPass /.well-known/acme-challenge !

# guacamole httpserver
#

SetEnvIf Authorization "(.*)" HTTP_AUTHORIZATION=$1
ProxyPreserveHost    On

ProxyPass /guacamole http://localhost:8085/guacamole
ProxyPassReverse /guacamole http://localhost:8085/guacamole

RedirectMatch ^/$ https://guacamole.example.com <co xml:id="CO99-1"/></programlisting>
<calloutlist>
<callout arearefs="CO99-1">
<para>remplacer <literal>example.com</literal> par votre nom de domaine</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_création_des_bases_de_données_9">
<title>Création des bases de données</title>
<simpara>Appliquez les opérations suivantes dans ISPConfig :</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara>Créez une base de données mysql. Aller dans le menu <literal>Database</literal> pour définir un utilisateur MariaDB</simpara>
</listitem>
<listitem>
<simpara>Aller dans la rubrique <literal>Sites</literal></simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Aller dans le menu <literal>Database users</literal> pour définir un utilisateur MariaDB</simpara>
<orderedlist numeration="lowerroman">
<listitem>
<simpara>Cliquez sur <literal>Add new User</literal> pour créer un nouvel utilisateur</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Database user:</literal> &#8592;  saisir votre nom d&#8217;utilisateur <literal>guacamole</literal> par exemple</simpara>
</listitem>
<listitem>
<simpara><literal>Database password:</literal> &#8592; <link linkend="pass_gen">Saisissez un mot de passe généré</link> ou en générer un en cliquant sur le bouton</simpara>
</listitem>
<listitem>
<simpara><literal>Repeat Password:</literal> &#8592; saisir de nouveau le mot de passe</simpara>
</listitem>
</itemizedlist>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Add new Database</literal> pour créer une nouvelle base de données</simpara>
</listitem>
<listitem>
<simpara>Saisissez les informations:</simpara>
<itemizedlist>
<listitem>
<simpara><literal>Site:</literal> &#8592; sélectionner le site <literal>example.com</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database name:</literal> &#8592; Saisissez le nom de la base de données <literal>guacamole</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Database user:</literal> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <literal>cxguacamole</literal>. x: est le numéro de client.</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>save</literal></simpara>
</listitem>
</orderedlist>
</listitem>
</orderedlist>
</section>
<section xml:id="_installation_du_guacamole">
<title>Installation du Guacamole</title>
<simpara>Suivez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Guacamole n&#8217;est pas compatible aujourd&#8217;hui (version 1.5.5) de Tomcat10. Or c&#8217;est la version présente dans la dernière version de Debian. Je vous conseille donc d&#8217;installer tomcat9 de la version de debian précédente.</simpara>
</listitem>
<listitem>
<simpara>Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">echo "deb http://deb.debian.org/debian/ bullseye main" &gt; /etc/apt/sources.list.d/bullseye.list
apt update
apt install tomcat9 tomcat9-admin tomcat9-common tomcat9-user
sed -i 's/^/#/' /etc/apt/sources.list.d/bullseye.list
apt install gcc g++ libossp-uuid-dev libavcodec-dev libpango1.0-dev libssh2-1-dev libcairo2-dev libjpeg-dev libpng-dev libavutil-dev libavformat-dev libswscale-dev libvncserver-dev libssl-dev libvorbis-dev libwebp-dev freerdp2-dev libtelnet-dev libswscale-dev libossp-uuid-dev libwebsockets-dev libpulse-dev  libmariadb-java</programlisting>
</listitem>
<listitem>
<simpara>Par ailleurs, Guacamole pose des problèmes de compatibilités avec IP V6.</simpara>
</listitem>
<listitem>
<simpara>Editez votre fichier <literal>/etc/hosts</literal> et commentez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">#::1            localhost ip6-localhost ip6-loopback</programlisting>
</listitem>
<listitem>
<simpara>Téléchargez la dernière version de Guacamole en allant sur le site web et en récupérant le <link xl:href="https://guacamole.apache.org/releases/">lien de téléchargement</link>.</simpara>
</listitem>
<listitem>
<simpara>tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
curl -fSL -o guacamole-server.tar.gz 'https://apache.org/dyn/closer.lua/guacamole/1.5.5/source/guacamole-server-1.5.5.tar.gz?action=download' <co xml:id="CO100-1"/>
tar xfz guacamole-server.tar.gz
cd guacamole-server-*</programlisting>
<calloutlist>
<callout arearefs="CO100-1">
<para>insérez ici l&#8217;adresse du package serveur à charger</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Lancez la configuration. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">./configure --with-init-dir=/etc/init.d</programlisting>
</listitem>
<listitem>
<simpara>Vous devez obtenir, à la fin de la configuration, une table de ce type:</simpara>
<screen linenumbering="unnumbered">------------------------------------------------
guacamole-server version 1.5.5
------------------------------------------------

   Library status:

     freerdp2 ............ yes
     pango ............... yes
     libavcodec .......... yes
     libavformat.......... yes
     libavutil ........... yes
     libssh2 ............. yes
     libssl .............. yes
     libswscale .......... yes
     libtelnet ........... yes
     libVNCServer ........ yes
     libvorbis ........... yes
     libpulse ............ yes
     libwebsockets ....... yes
     libwebp ............. yes
     wsock32 ............. no

   Protocol support:

      Kubernetes .... yes
      RDP ........... yes
      SSH ........... yes
      Telnet ........ yes
      VNC ........... yes

   Services / tools:

      guacd ...... yes
      guacenc .... yes
      guaclog .... yes</screen>
</listitem>
<listitem>
<simpara>Si ce n&#8217;est pas le cas, c&#8217;est qu&#8217;une bibliothèque n&#8217;est pas installée correctement.</simpara>
</listitem>
<listitem>
<simpara>Lancez la compilation et l&#8217;installation. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">make
make install
ldconfig</programlisting>
</listitem>
<listitem>
<simpara>Activez le démon de gestion guacd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl daemon-reload
systemctl enable guacd
systemctl start guacd</programlisting>
</listitem>
<listitem>
<simpara>Téléchargez le dernier client <literal>war</literal> de Guacamole en allant sur le site web et en récupérant le <link xl:href="https://guacamole.apache.org/releases/">lien de téléchargement</link>. Récupérez le lien puis tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /usr/local/share/guacamole
cd /usr/local/share/guacamole
curl -fSL -o guacamole.war 'https://apache.org/dyn/closer.lua/guacamole/1.5.5/binary/guacamole-1.5.5.war?action=download' <co xml:id="CO101-1"/>
ln -s /usr/local/share/guacamole/guacamole.war /var/lib/tomcat9/webapps/
systemctl restart tomcat9
systemctl restart guacd</programlisting>
<calloutlist>
<callout arearefs="CO101-1">
<para>insérez ici l&#8217;adresse du war à charger</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Editez le fichier server.xml. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/tomcat9/server.xml</programlisting>
</listitem>
<listitem>
<simpara>Chercher <literal>Connector port="8080" protocol="HTTP/1.1</literal> et remplacer partout le port <literal>8080</literal> par <literal>8085</literal></simpara>
</listitem>
<listitem>
<simpara>Créez les répertoires de configuration de guacamole. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">mkdir -p /etc/guacamole
mkdir -p /etc/guacamole/{extensions,lib}</programlisting>
</listitem>
<listitem>
<simpara>Récupérez le driver mysql/mariadb pour java. Sur la plupart des Linux, il est présent dans <literal>/usr/share/java</literal>. Pour le copier, tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">ln -s /usr/share/java/mariadb-java-client.jar /etc/guacamole/lib/</programlisting>
</listitem>
<listitem>
<simpara>Il se peut que ce driver ne soit pas présent: allez sur le site <link xl:href="https://dev.mysql.com/downloads/connector/j/">Mysql</link> et téléchargez la version Platform independant. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">curl -fSL -o mysql-java.tar.gz 'https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-j-8.3.0.tar.gz' <co xml:id="CO102-1"/>
tar xfz mysql-java.tar.gz
cd mysql-connector-java-*
cp mysql-connector-java-*.jar /etc/guacamole/lib/mysql-connector-java.jar</programlisting>
<calloutlist>
<callout arearefs="CO102-1">
<para>Collez ici le lien récupéré sur le site de Mysql.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Editez le fichier guacamole.properties. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">vi /etc/guacamole/guacamole.properties</programlisting>
</listitem>
<listitem>
<simpara>Ajoutez dans le fichier:</simpara>
<screen linenumbering="unnumbered">mysql-hostname: localhost
mysql-port: 3306
mysql-database: cxguacamole <co xml:id="CO103-1"/>
mysql-username: cxguacamole <co xml:id="CO103-2"/>
mysql-password: &lt;mot_de_passe&gt; <co xml:id="CO103-3"/></screen>
<calloutlist>
<callout arearefs="CO103-1 CO103-2 CO103-3">
<para>mettez ici le nom de la base de données, le nom de l&#8217;utilisateur de la base et son mot_de_passe tels qu&#8217;ils ont été saisis dans le chapitre de création de la base de données.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Vous devez maintenant télécharger les plugins mysql pour Guacamole. Allez sur le site web de guacamole et récupérez le <link xl:href="https://guacamole.apache.org/releases/">lien de téléchargement de guacamole-auth-jdbc</link>. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
curl -fSL -o guacamole-auth-jdbc.tar.gz 'https://apache.org/dyn/closer.lua/guacamole/1.5.5/binary/guacamole-auth-jdbc-1.5.5.tar.gz?action=download' <co xml:id="CO104-1"/>
tar xfz guacamole-auth-jdbc.tar.gz
cd guacamole-auth-jdbc-*/mysql
cp guacamole-auth-jdbc-mysql-*.jar /usr/local/share/guacamole/
ln -s /usr/local/share/guacamole/guacamole-auth-jdbc-mysql-*.jar /etc/guacamole/extensions</programlisting>
<calloutlist>
<callout arearefs="CO104-1">
<para>insérez ici l&#8217;adresse du fichier guacamole-auth-jdbc à charger</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Créez les tables de la base:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd schema
cat *.sql | mysql -u cxguacamole -p cxguacamole <co xml:id="CO105-1"/></programlisting>
<calloutlist>
<callout arearefs="CO105-1">
<para>mettez derrière le <literal>-u</literal> le nom d&#8217;utilisateur de la base de données et derrière le <literal>-p</literal> le nom de la base de données. Un mot de passe vous sera demandé.</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Redémarrez tomcat et guacd. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl restart tomcat9
systemctl restart guacd</programlisting>
</listitem>
<listitem>
<simpara>Allez sur le site de <literal>guacamole.example.com/guacamole</literal></simpara>
</listitem>
<listitem>
<simpara>Loguez vous avec le compte: <literal>guacadmin</literal> et password: <literal>guacadmin</literal></simpara>
</listitem>
<listitem>
<simpara>Commencez par cliquez sur <literal>guacadmin</literal> &#8594; <literal>paramètres</literal> &#8594; <literal>utilisateurs</literal>&#8594; <literal>Nouvel Utilisateur</literal></simpara>
<itemizedlist>
<listitem>
<simpara><literal>Identifiant</literal> &#8592; Tapez <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Mot de passe</literal> &#8592; Tapez votre <link linkend="pass_gen">mot de passe généré</link></simpara>
</listitem>
<listitem>
<simpara><literal>Répétez mot de passe</literal> &#8592; Retapez votre mot de passe</simpara>
</listitem>
<listitem>
<simpara><literal>Permissions</literal> &#8592; activer toutes les options</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Deconnectez vous et reconnectez vous avec le login <literal>admin</literal></simpara>
</listitem>
<listitem>
<simpara>cliquez sur <literal>admin</literal> &#8594; <literal>paramètres</literal> &#8594; <literal>utilisateurs</literal> &#8594; <literal>guacadmin</literal></simpara>
</listitem>
<listitem>
<simpara>Supprimez ce compte utilisateur</simpara>
</listitem>
<listitem>
<simpara>Si vous avez activé VNC. Cliquez sur <literal>Admin</literal> &#8594; <literal>Paramètres</literal> &#8594; <literal>Utilisateurs</literal> &#8594; <literal>Connexions</literal> &#8594; <literal>Nouvelle Connexion</literal></simpara>
<itemizedlist>
<listitem>
<simpara><literal>Nom</literal> &#8592; Tapez <literal>Local server VNC</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Protocole</literal> &#8592; Sélectionnez <literal>VNC</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>Nom d’hôte</literal> &#8592; Tapez <literal>Localhost</literal></simpara>
</listitem>
<listitem>
<simpara>Cochez <literal>SFTP</literal> &#8594; <literal>Activer SFTP</literal></simpara>
</listitem>
<listitem>
<simpara><literal>SFTP</literal> &#8594; <literal>Nom d&#8217;hôte</literal> &#8592; Tapez <literal>Localhost</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>port</literal> &#8592; Tapez <literal>5900</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>Mot de passe</literal> &#8592; Tapez votre mot de passe VNC de votre machine locale.</simpara>
</listitem>
<listitem>
<simpara><literal>SFTP</literal> &#8594; <literal>Mot de passe</literal> &#8592; Tapez un mot de passe sur votre Hôte</simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Cliquez sur <literal>Admin</literal> &#8594; <literal>Paramètres</literal> &#8594; <literal>Utilisateurs</literal> &#8594; <literal>Connexions</literal> &#8594; <literal>Nouvelle Connexion</literal></simpara>
<itemizedlist>
<listitem>
<simpara><literal>Nom</literal> &#8592; Tapez <literal>Local server SSH</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Protocole</literal> &#8592; Sélectionnez <literal>SSH</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>Nom d’hôte</literal> &#8592; Tapez <literal>Localhost</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>port</literal> &#8592; Tapez <literal>22</literal></simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>Identifiant</literal> &#8592; Tapez un login sur votre Hôte</simpara>
</listitem>
<listitem>
<simpara><literal>Paramètres</literal> &#8594; <literal>Mot de passe</literal> &#8592; Tapez votre mot de passe de compte</simpara>
</listitem>
<listitem>
<simpara>Cochez <literal>SFTP</literal> &#8594; <literal>Activer SFTP</literal></simpara>
</listitem>
<listitem>
<simpara><literal>SFTP</literal> &#8594; <literal>File browser root directory</literal> &#8592; Tapez <literal>/</literal></simpara>
</listitem>
</itemizedlist>
</listitem>
<listitem>
<simpara>Vous pouvez maintenant vérifier vos connexions en vous loguant avec l&#8217;un des deux profils.</simpara>
</listitem>
<listitem>
<simpara>l&#8217;appui simultané sur <literal>SHIFT</literal> <literal>CTRL</literal> <literal>ALT</literal> fait apparaître un menu pour effectuer des chargements de fichiers ou contrôler votre connexion</simpara>
</listitem>
</orderedlist>
</section>
<section xml:id="_upgrade_de_guacamole">
<title>Upgrade de Guacamole</title>
<simpara>Il est nécessaire de regénérer les logiciels avec les dernières versions.</simpara>
<simpara>Appliquez la procédure suivante:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Arrêtez le serveur guacamole</simpara>
<programlisting language="bash" linenumbering="unnumbered">systemctl stop guacd</programlisting>
</listitem>
<listitem>
<simpara>Téléchargez la dernière version de Guacamole en allant sur le site web et en récupérant le <link xl:href="https://guacamole.apache.org/releases/">lien de téléchargement</link>.</simpara>
</listitem>
<listitem>
<simpara>tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /tmp
curl -fSL -o guacamole-server.tar.gz 'http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/1.2.0/source/guacamole-server-1.2.0.tar.gz' <co xml:id="CO106-1"/>
tar xfz guacamole-server.tar.gz
cd guacamole-server-*</programlisting>
<calloutlist>
<callout arearefs="CO106-1">
<para>insérez ici l&#8217;adresse du package serveur à charger</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Lancez la configuration. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">./configure --with-init-dir=/etc/init.d</programlisting>
</listitem>
<listitem>
<simpara>Lancez la compilation et l&#8217;installation. Tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">make
make install
ldconfig</programlisting>
</listitem>
<listitem>
<simpara>Téléchargez le dernier client <literal>war</literal> de Guacamole en allant sur le site web et en récupérant le <link xl:href="https://guacamole.apache.org/releases/">lien de téléchargement</link>. Récupérez le lien puis tapez:</simpara>
<programlisting language="bash" linenumbering="unnumbered">cd /usr/local/share/guacamole
curl -fSL -o guacamole.war 'http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/1.2.0/binary/guacamole-1.2.0.war' <co xml:id="CO107-1"/>
systemctl daemon-reload
systemctl restart tomcat9 <co xml:id="CO107-2"/>
systemctl start guacd</programlisting>
<calloutlist>
<callout arearefs="CO107-1">
<para>insérez ici l&#8217;adresse du war à charger</para>
</callout>
</calloutlist>
</listitem>
<listitem>
<simpara>Allez sur le site de <literal>guacamole.example.com/guacamole</literal></simpara>
</listitem>
<listitem>
<simpara>Vérifiez que tout fonctionne</simpara>
</listitem>
</orderedlist>
</section>
</section>
<section xml:id="_annexe">
<title>Annexe</title>
<section xml:id="_installation_de_hestia">
<title>Installation de Hestia</title>
<simpara><literal>Hestia</literal> est basé sur VestaCP. C&#8217;est une alternative opensource et plus moderne de cet outil.
La documentation est proposée ici: <link xl:href="https://docs.hestiacp.com/">https://docs.hestiacp.com/</link></simpara>
<simpara>Attention <literal>Hestia</literal> n&#8217;est pas compatible de <literal>Webmin</literal> dans le sens que <literal>Webmin</literal> est incapable de lire et d&#8217;interpréter les fichiers créés par <literal>Hestia</literal>.</simpara>
<simpara>De même, <literal>Hestia</literal> est principalement compatible de PHP. Si vous utilisez des système web basés sur des applicatifs écrits en Python ou en Ruby, la configuration sera à faire à la main avec tous les problèmes de compatibilité que cela impose.</simpara>
<simpara>Pour installer:</simpara>
<orderedlist numeration="arabic">
<listitem>
<simpara><link linkend="root_login">Loguez vous comme root sur le serveur</link></simpara>
</listitem>
<listitem>
<simpara>Télécharger le package et lancez l’installeur</simpara>
<orderedlist numeration="loweralpha">
<listitem>
<simpara>Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">wget https://raw.githubusercontent.com/hestiacp/hestiacp/release/install/hst-install.sh</programlisting>
</listitem>
<listitem>
<simpara>Lancez l&#8217;installeur. Tapez :</simpara>
<programlisting language="bash" linenumbering="unnumbered">bash hst-install.sh -g yes -o yes</programlisting>
</listitem>
<listitem>
<simpara>Si le système n&#8217;est pas compatible, HestiaCP vous le dira. Sinon,  il vous informe de la configuration qui sera installée. Tapez <literal>Y</literal> pour continuer.</simpara>
</listitem>
<listitem>
<simpara>Entrez votre adresse mail standard et indépendante du futur serveur qui sera installé. ce peut être une adresse gmail.com par exemple.</simpara>
</listitem>
</orderedlist>
</listitem>
<listitem>
<simpara><literal>Hestia</literal> est installé. Il est important de bien noter le mot de passe du compte admin de <literal>Hestia</literal> ainsi que le numéro de port du site web</simpara>
</listitem>
</orderedlist>
</section>
</section>
</article>