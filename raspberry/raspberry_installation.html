<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="author" content="Stéphane Apiou">
<title>Installation d&#8217;un serveur Linux sur un Raspberry</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre { line-height: 125%; margin: 0; }
td.linenos pre { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
span.linenos { color: #000000; background-color: #f0f0f0; padding: 0 5px 0 5px; }
td.linenos pre.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding: 0 5px 0 5px; }
pre.pygments .hll { background-color: #ffffcc }
pre.pygments { background: #ffffff; }
pre.pygments .tok-c { color: #888888 } /* Comment */
pre.pygments .tok-err { color: #FF0000; background-color: #FFAAAA } /* Error */
pre.pygments .tok-k { color: #008800; font-weight: bold } /* Keyword */
pre.pygments .tok-o { color: #333333 } /* Operator */
pre.pygments .tok-ch { color: #888888 } /* Comment.Hashbang */
pre.pygments .tok-cm { color: #888888 } /* Comment.Multiline */
pre.pygments .tok-cp { color: #557799 } /* Comment.Preproc */
pre.pygments .tok-cpf { color: #888888 } /* Comment.PreprocFile */
pre.pygments .tok-c1 { color: #888888 } /* Comment.Single */
pre.pygments .tok-cs { color: #cc0000; font-weight: bold } /* Comment.Special */
pre.pygments .tok-gd { color: #A00000 } /* Generic.Deleted */
pre.pygments .tok-ge { font-style: italic } /* Generic.Emph */
pre.pygments .tok-gr { color: #FF0000 } /* Generic.Error */
pre.pygments .tok-gh { color: #000080; font-weight: bold } /* Generic.Heading */
pre.pygments .tok-gi { color: #00A000 } /* Generic.Inserted */
pre.pygments .tok-go { color: #888888 } /* Generic.Output */
pre.pygments .tok-gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
pre.pygments .tok-gs { font-weight: bold } /* Generic.Strong */
pre.pygments .tok-gu { color: #800080; font-weight: bold } /* Generic.Subheading */
pre.pygments .tok-gt { color: #0044DD } /* Generic.Traceback */
pre.pygments .tok-kc { color: #008800; font-weight: bold } /* Keyword.Constant */
pre.pygments .tok-kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
pre.pygments .tok-kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
pre.pygments .tok-kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
pre.pygments .tok-kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
pre.pygments .tok-kt { color: #333399; font-weight: bold } /* Keyword.Type */
pre.pygments .tok-m { color: #6600EE; font-weight: bold } /* Literal.Number */
pre.pygments .tok-s { background-color: #fff0f0 } /* Literal.String */
pre.pygments .tok-na { color: #0000CC } /* Name.Attribute */
pre.pygments .tok-nb { color: #007020 } /* Name.Builtin */
pre.pygments .tok-nc { color: #BB0066; font-weight: bold } /* Name.Class */
pre.pygments .tok-no { color: #003366; font-weight: bold } /* Name.Constant */
pre.pygments .tok-nd { color: #555555; font-weight: bold } /* Name.Decorator */
pre.pygments .tok-ni { color: #880000; font-weight: bold } /* Name.Entity */
pre.pygments .tok-ne { color: #FF0000; font-weight: bold } /* Name.Exception */
pre.pygments .tok-nf { color: #0066BB; font-weight: bold } /* Name.Function */
pre.pygments .tok-nl { color: #997700; font-weight: bold } /* Name.Label */
pre.pygments .tok-nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
pre.pygments .tok-nt { color: #007700 } /* Name.Tag */
pre.pygments .tok-nv { color: #996633 } /* Name.Variable */
pre.pygments .tok-ow { color: #000000; font-weight: bold } /* Operator.Word */
pre.pygments .tok-w { color: #bbbbbb } /* Text.Whitespace */
pre.pygments .tok-mb { color: #6600EE; font-weight: bold } /* Literal.Number.Bin */
pre.pygments .tok-mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
pre.pygments .tok-mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
pre.pygments .tok-mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
pre.pygments .tok-mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
pre.pygments .tok-sa { background-color: #fff0f0 } /* Literal.String.Affix */
pre.pygments .tok-sb { background-color: #fff0f0 } /* Literal.String.Backtick */
pre.pygments .tok-sc { color: #0044DD } /* Literal.String.Char */
pre.pygments .tok-dl { background-color: #fff0f0 } /* Literal.String.Delimiter */
pre.pygments .tok-sd { color: #DD4422 } /* Literal.String.Doc */
pre.pygments .tok-s2 { background-color: #fff0f0 } /* Literal.String.Double */
pre.pygments .tok-se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
pre.pygments .tok-sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
pre.pygments .tok-si { background-color: #eeeeee } /* Literal.String.Interpol */
pre.pygments .tok-sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
pre.pygments .tok-sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
pre.pygments .tok-s1 { background-color: #fff0f0 } /* Literal.String.Single */
pre.pygments .tok-ss { color: #AA6600 } /* Literal.String.Symbol */
pre.pygments .tok-bp { color: #007020 } /* Name.Builtin.Pseudo */
pre.pygments .tok-fm { color: #0066BB; font-weight: bold } /* Name.Function.Magic */
pre.pygments .tok-vc { color: #336699 } /* Name.Variable.Class */
pre.pygments .tok-vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
pre.pygments .tok-vi { color: #3333BB } /* Name.Variable.Instance */
pre.pygments .tok-vm { color: #996633 } /* Name.Variable.Magic */
pre.pygments .tok-il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body class="article">
<div id="header">
<h1>Installation d&#8217;un serveur Linux sur un Raspberry</h1>
<div class="details">
<span id="author" class="author">Stéphane Apiou</span><br>
<span id="email" class="email"><a href="mailto:stephane@apiou.org">stephane@apiou.org</a></span><br>
<span id="revnumber">version 1.2,</span>
<span id="revdate">2021-01-24</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_avant_propos">1. Avant propos</a></li>
<li><a href="#root_login">2. Se loguer root sur le serveur</a></li>
<li><a href="#pass_gen">3. Gestion des mots de passe</a></li>
<li><a href="#_choix_du_registrar">4. Choix du registrar</a></li>
<li><a href="#_installation_du_linux_sur_votre_raspberry_pi">5. Installation du linux sur votre Raspberry Pi</a>
<ul class="sectlevel2">
<li><a href="#_installation_avec_écran_et_clavier">5.1. Installation avec écran et clavier</a></li>
<li><a href="#_installation_headless_de_raspbian">5.2. Installation Headless de Raspbian</a></li>
<li><a href="#_installation_headless_de_ubuntu_64">5.3. Installation Headless de Ubuntu 64</a></li>
<li><a href="#_reconnecter_automatiquement_votre_raspberry_pi_au_wifi">5.4. Reconnecter automatiquement votre Raspberry Pi au wifi</a></li>
</ul>
</li>
<li><a href="#_configuration_basique">6. Configuration basique</a>
<ul class="sectlevel2">
<li><a href="#_mettre_léditeur_de_votre_choix">6.1. Mettre l&#8217;éditeur de votre choix</a></li>
<li><a href="#_installation_dun_repository_pour_etc">6.2. Installation d&#8217;un repository pour <code>/etc</code></a></li>
<li><a href="#_mise_à_jour_des_sources_de_paquets_debian_ou_ubuntu">6.3. Mise à jour des sources de paquets Debian ou Ubuntu</a></li>
<li><a href="#_installation_des_paquets_de_base">6.4. Installation des paquets de base</a></li>
<li><a href="#_installer_loutil_debfoster">6.5. Installer l&#8217;outil Debfoster</a></li>
<li><a href="#_création_dun_fichier_keeper_dans_etc">6.6. Création d&#8217;un fichier keeper dans /etc</a></li>
<li><a href="#_installation_des_mises_à_jours_automatiques">6.7. Installation des mises à jours automatiques</a></li>
<li><a href="#_vérification_du_nom_de_serveur">6.8. Vérification du nom de serveur</a></li>
<li><a href="#_interdire_le_login_direct_en_root">6.9. Interdire le login direct en root</a></li>
<li><a href="#_création_dune_clé_de_connexion_ssh_locale">6.10. Création d&#8217;une clé de connexion ssh locale</a></li>
<li><a href="#_sudo_sans_mot_de_passe">6.11. Sudo sans mot de passe</a></li>
<li><a href="#_installer_loutil_dselect">6.12. Installer l&#8217;outil dselect</a></li>
<li><a href="#swap_create">6.13. Ajouter un fichier de swap</a></li>
</ul>
</li>
<li><a href="#_installation_initiale_des_outils">7. Installation initiale des outils</a>
<ul class="sectlevel2">
<li><a href="#_configuration_de_postfix">7.1. Configuration de Postfix</a></li>
<li><a href="#_configuration_de_mariadb">7.2. Configuration de MariaDB</a></li>
<li><a href="#_configuration_dapache">7.3. Configuration d&#8217;Apache</a></li>
<li><a href="#_installation_du_gestionnaire_de_mailing_list_mailman">7.4. Installation du gestionnaire de mailing list Mailman</a></li>
<li><a href="#_configuration_d_awstats">7.5. Configuration d' Awstats</a></li>
<li><a href="#_configuration_de_fail2ban">7.6. Configuration de Fail2ban</a></li>
<li><a href="#_installation_et_configuration_de_pureftpd">7.7. Installation et configuration de PureFTPd</a></li>
<li><a href="#_installation_et_configuration_de_phpmyadmin">7.8. Installation et configuration de phpmyadmin</a></li>
<li><a href="#_installation_du_webmail_roundcube">7.9. Installation du webmail Roundcube</a></li>
<li><a href="#_installation_de_lets_encrypt">7.10. Installation de Let&#8217;s Encrypt</a></li>
<li><a href="#_installation_dun_scanner_de_vulnérabilités_lynis">7.11. Installation d&#8217;un scanner de vulnérabilités Lynis</a></li>
</ul>
</li>
<li><a href="#_installation_dun_panel">8. Installation d&#8217;un Panel</a>
<ul class="sectlevel2">
<li><a href="#_installation_et_configuration_de_ispconfig">8.1. Installation et configuration de ISPConfig</a></li>
<li><a href="#_installation_du_système_dadministration_webmin">8.2. Installation du système d&#8217;administration Webmin</a></li>
</ul>
</li>
<li><a href="#domain-config">9. Configuration d&#8217;un domaine</a>
<ul class="sectlevel2">
<li><a href="#_login_initial">9.1. Login initial</a></li>
<li><a href="#_création_de_la_zone_dns_dun_domaine">9.2. Création de la zone DNS d&#8217;un domaine</a></li>
<li><a href="#_activation_de_dnssec">9.3. Activation de DNSSEC</a></li>
<li><a href="#_exemple_de_configuration_de_domaine">9.4. Exemple de configuration de domaine</a></li>
<li><a href="#_création_dun_sous_domaine">9.5. Création d&#8217;un sous domaine</a></li>
<li><a href="#domain-site">9.6. Création d’un site web</a></li>
<li><a href="#subdomain-site">9.7. Création d’un Site Vhost</a></li>
</ul>
</li>
<li><a href="#_associer_des_certificats_reconnu_à_vos_outils">10. Associer des certificats reconnu à vos outils</a></li>
<li><a href="#_surveillance_du_serveur_avec_munin_et_monit">11. Surveillance du serveur avec Munin et Monit</a>
<ul class="sectlevel2">
<li><a href="#_note_préliminaire">11.1. Note préliminaire</a></li>
<li><a href="#_installation_et_configuration_de_munin">11.2. Installation et configuration de Munin</a></li>
<li><a href="#_activez_les_plugins_de_munin">11.3. Activez les plugins de Munin</a></li>
<li><a href="#_installer_et_configurer_monit">11.4. Installer et configurer Monit</a></li>
</ul>
</li>
<li><a href="#_configuration_de_la_messagerie">12. Configuration de la messagerie</a>
<ul class="sectlevel2">
<li><a href="#_installation_de_lantispam_rspamd_à_la_place_d_amavis_new">12.1. Installation de l&#8217;antispam rspamd à la place d' Amavis-new</a></li>
<li><a href="#_création_du_serveur_de_messagerie">12.2. Création du serveur de messagerie</a></li>
<li><a href="#_finaliser_la_sécurisation_de_votre_serveur_de_mail">12.3. Finaliser la sécurisation de votre serveur de mail</a></li>
<li><a href="#_surveillance_du_statut_de_spammer">12.4. Surveillance du statut de Spammer</a></li>
<li><a href="#_création_de_lautoconfig_pour_thunderbird_et_android">12.5. Création de l’autoconfig pour Thunderbird et Android</a></li>
<li><a href="#_création_dautodiscover_pour_outlook">12.6. Création d’autodiscover pour Outlook</a></li>
<li><a href="#_création_dune_boite_mail">12.7. Création d’une boite mail</a></li>
<li><a href="#_configuration_de_votre_client_de_messagerie">12.8. Configuration de votre client de messagerie.</a></li>
<li><a href="#_mise_en_oeuvre_du_site_web_de_webmail">12.9. Mise en oeuvre du site web de webmail</a></li>
<li><a href="#_transfert_de_vos_boites_mails_imap">12.10. Transfert de vos boites mails IMAP</a></li>
</ul>
</li>
<li><a href="#_installation_de_docker_et_des_outils_associés">13. Installation de Docker et des outils associés</a>
<ul class="sectlevel2">
<li><a href="#_a_propos_des_raspberry_pi">13.1. A propos des Raspberry Pi</a></li>
<li><a href="#_installation_de_docker">13.2. Installation de Docker</a></li>
<li><a href="#_installation_de_docker_compose">13.3. Installation de docker-compose</a></li>
<li><a href="#_installation_de_docker_swarm">13.4. Installation de docker swarm</a></li>
<li><a href="#_choix_des_images_docker">13.5. Choix des images docker</a></li>
<li><a href="#_mise_à_jour_automatique_des_images">13.6. Mise à jour automatique des images</a></li>
<li><a href="#_installation_de_yacht">13.7. Installation de Yacht</a></li>
<li><a href="#_installation_de_portainer">13.8. Installation de Portainer</a></li>
</ul>
</li>
<li><a href="#_installation_des_cms_joomla_et_concrete5">14. Installation des CMS Joomla et Concrete5</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_joomla">14.1. Création du site web de Joomla</a></li>
<li><a href="#_création_de_lapplication_joomla">14.2. Création de l&#8217;application Joomla</a></li>
</ul>
</li>
<li><a href="#_installation_du_portail_wiki_mediawiki">15. Installation du portail wiki Mediawiki</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_mediawiki">15.1. Création du site web de Mediawiki</a></li>
<li><a href="#_création_de_lapplication_mediawiki">15.2. Création de l&#8217;application Mediawiki</a></li>
</ul>
</li>
<li><a href="#_installation_dun_gestionnaire_de_blog_wordpress">16. Installation d&#8217;un gestionnaire de Blog Wordpress</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_wordpress">16.1. Création du site web de Wordpress</a></li>
<li><a href="#_création_de_lapplication_wordpress">16.2. Création de l&#8217;application Wordpress</a></li>
</ul>
</li>
<li><a href="#_installation_du_cms_micro_weber">17. Installation du CMS Micro Weber</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_microweber">17.1. Création du site web de Microweber</a></li>
<li><a href="#_création_des_bases_de_données">17.2. Création des bases de données</a></li>
<li><a href="#_installation_de_microweber">17.3. Installation de Microweber</a></li>
</ul>
</li>
<li><a href="#_installation_du_gestionnaire_de_photos_piwigo">18. Installation du gestionnaire de photos Piwigo</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_piwigo">18.1. Création du site web de Piwigo</a></li>
<li><a href="#_création_des_bases_de_données_2">18.2. Création des bases de données</a></li>
<li><a href="#_installation_de_piwigo">18.3. Installation de Piwigo</a></li>
</ul>
</li>
<li><a href="#_installation_du_système_collaboratif_nextcloud">19. Installation du système collaboratif Nextcloud</a>
<ul class="sectlevel2">
<li><a href="#_installation_initiale">19.1. Installation initiale</a></li>
<li><a href="#_création_du_site_web_de_nextcloud">19.2. Création du site web de Nextcloud</a></li>
<li><a href="#_création_des_bases_de_données_3">19.3. Création des bases de données</a></li>
<li><a href="#_installation_de_nextcloud">19.4. Installation de Nextcloud</a></li>
</ul>
</li>
<li><a href="#_installation_du_gestionnaire_de_projet_gitea">20. Installation du gestionnaire de projet Gitea</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_gitea">20.1. Création du site web de Gitea</a></li>
<li><a href="#_création_des_bases_de_données_4">20.2. Création des bases de données</a></li>
<li><a href="#_téléchargez_et_installez_gitea">20.3. Téléchargez et installez Gitea</a></li>
<li><a href="#_activer_une_connexion_ssh_dédiée">20.4. Activer une connexion SSH dédiée</a></li>
</ul>
</li>
<li><a href="#_installation_du_système_de_partage_de_fichiers_seafile">21. Installation du système de partage de fichiers Seafile</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_seafile">21.1. Création du site web de Seafile</a></li>
<li><a href="#_création_de_bases_de_données">21.2. Création de bases de données</a></li>
<li><a href="#_téléchargez_et_installez_seafile">21.3. Téléchargez et installez Seafile</a></li>
<li><a href="#_lancement_initial">21.4. Lancement initial</a></li>
<li><a href="#_lancement_automatique_de_seafile">21.5. Lancement automatique de Seafile</a></li>
</ul>
</li>
<li><a href="#_installation_du_système_de_monitoring_grafana">22. Installation du système de monitoring Grafana</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_grafana">22.1. Création du site web de Grafana</a></li>
<li><a href="#_installation_de_grafana">22.2. Installation de Grafana</a></li>
<li><a href="#_installation_et_configuration_de_loki">22.3. Installation et configuration de Loki</a></li>
<li><a href="#_installation_et_configuration_de_promtail">22.4. Installation et configuration de Promtail</a></li>
</ul>
</li>
<li><a href="#_installation_du_système_de_backup_borgbackup">23. Installation du système de backup BorgBackup</a>
<ul class="sectlevel2">
<li><a href="#_introduction">23.1. Introduction</a></li>
<li><a href="#_installation_du_serveur_de_stockage">23.2. Installation du serveur de stockage</a></li>
<li><a href="#_installation_sur_le_serveur_sauvegardé">23.3. Installation sur le serveur sauvegardé</a></li>
<li><a href="#_effectuer_un_backup">23.4. Effectuer un backup</a></li>
<li><a href="#_lister_les_backups">23.5. Lister les backups</a></li>
<li><a href="#_vérifier_un_backup">23.6. Vérifier un backup</a></li>
<li><a href="#_restaurer_un_backup">23.7. Restaurer un backup</a></li>
<li><a href="#_supprimer_vos_vieux_backups">23.8. Supprimer vos vieux backups</a></li>
<li><a href="#_automatisez_votre_sauvegarde">23.9. Automatisez votre sauvegarde</a></li>
<li><a href="#_restauration_durgence">23.10. Restauration d&#8217;urgence.</a></li>
<li><a href="#_installation_de_borgweb">23.11. Installation de Borgweb</a></li>
<li><a href="#_création_du_site_web_de_borgweb">23.12. Création du site web de Borgweb</a></li>
</ul>
</li>
<li><a href="#_installation_dun_serveur_de_vpn_pritunl">24. Installation d&#8217;un serveur de VPN Pritunl</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_pritunl">24.1. Création du site web de Pritunl</a></li>
<li><a href="#_installation_de_pritunl_sur_un_vps">24.2. Installation de Pritunl sur un VPS</a></li>
<li><a href="#_installation_de_pritunl_sur_un_raspberrypi">24.3. Installation de Pritunl sur un Raspberrypi</a></li>
<li><a href="#_se_connecter_au_serveur_de_vpn">24.4. Se connecter au serveur de VPN</a></li>
<li><a href="#_réparer_une_base_pritunl">24.5. Réparer une base Pritunl</a></li>
<li><a href="#_mot_de_passe_perdu">24.6. Mot de passe perdu</a></li>
</ul>
</li>
<li><a href="#_installation_dun_serveur_de_bureau_à_distance_guacamole">25. Installation d&#8217;un serveur de bureau à distance Guacamole</a>
<ul class="sectlevel2">
<li><a href="#_création_du_site_web_de_guacamole">25.1. Création du site web de Guacamole</a></li>
<li><a href="#_création_des_bases_de_données_5">25.2. Création des bases de données</a></li>
<li><a href="#_installation_du_guacamole">25.3. Installation du Guacamole</a></li>
</ul>
</li>
<li><a href="#_annexe">26. Annexe</a>
<ul class="sectlevel2">
<li><a href="#_installation_de_hestia">26.1. Installation de Hestia</a></li>
<li><a href="#_configuration_dun_écran_3_5inch_rpi_lcd_a">26.2. Configuration d&#8217;un écran 3.5inch RPi LCD (A)</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_avant_propos">1. Avant propos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ce document est disponible sur le site <a href="https://raspberry-installation.readthedocs.io">ReadTheDocs</a>
et sur <a href="https://github.com/stefapi/vps_installation">Github</a>. Sur Github vous trouverez aussi les versions PDF, EPUB, HTML, Docbook et Asciidoc de ce document</p>
</div>
<div class="paragraph">
<p>Cette documentation décrit la méthode que j&#8217;ai utilisé pour installer une homebox (site auto hébergé) avec un raspberry PI.</p>
</div>
<div class="paragraph">
<p>Elle est le résultat de très nombreuses heures de travail pour collecter la documentation nécessaire.
Sur mon serveur, j&#8217;ai installé un Ubuntu pour Raspberry. Cette documentation décrit aussi l&#8217;installation pour une Raspbian.</p>
</div>
<div class="paragraph">
<p>Dans ce document, je montre la configuration de nombreux types de sites web et services dans un domaine en utilisant ISPConfig.</p>
</div>
<div class="paragraph">
<p>Sont installés:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un panel <a href="https://www.ispconfig.org/">ISPConfig</a>,</p>
</li>
<li>
<p>un configurateur <a href="http://www.webmin.com/">Webmin</a>,</p>
</li>
<li>
<p>un serveur apache avec sa configuration let&#8217;s encrypt et les plugins PHP, Python et Ruby,</p>
</li>
<li>
<p>un serveur de mail avec antispam, sécurisation d&#8217;envoi des mails et autoconfiguration pour Outlook, Thunderbird, Android,</p>
</li>
<li>
<p>un webmail <a href="https://roundcube.net">roundcube</a>,</p>
</li>
<li>
<p>un serveur de mailing list <a href="https://www.list.org">mailman</a>,</p>
</li>
<li>
<p>un serveur ftp et sftp sécurisé,</p>
</li>
<li>
<p>un serveur de base de données MariaDB et son interface web d&#8217;administration <a href="https://www.phpmyadmin.net/">phpmyadmin</a>,</p>
</li>
<li>
<p>des outils de sécurisation, de mise à jour automatique et d&#8217;audit du serveur,</p>
</li>
<li>
<p>un outil de Monitoring <a href="http://munin-monitoring.org/">Munin</a>,</p>
</li>
<li>
<p>un outil de Monitoring <a href="http://mmonit.com/monit/">Monit</a>,</p>
</li>
<li>
<p>un sous domaine pointant sur un site auto-hébergé (l’installation du site n&#8217;est pas décrite ici; Se référer à <a href="https://yunohost.org">Yunohost</a>),</p>
</li>
<li>
<p>un site CMS sous <a href="https://www.joomla.fr/">Joomla</a>,</p>
</li>
<li>
<p>un site CMS sous <a href="https://www.concrete5.org/">Concrete5</a>,</p>
</li>
<li>
<p>un site WIKI sous <a href="https://www.mediawiki.org">Mediawiki</a>,</p>
</li>
<li>
<p>un site <a href="https://wordpress.com">Wordpress</a>,</p>
</li>
<li>
<p>un site <a href="https://microweber.org/">Microweber</a>,</p>
</li>
<li>
<p>un site Photo sous <a href="https://piwigo.org/">Piwigo</a>,</p>
</li>
<li>
<p>un site Collaboratif sous <a href="https://nextcloud.com">Nextcloud</a>,</p>
</li>
<li>
<p>un site <a href="https://gitea.io">Gitea</a> et son repository GIT,</p>
</li>
<li>
<p>un serveur et un site  de partage de fichiers <a href="https://www.seafile.com">Seafile</a>,</p>
</li>
<li>
<p>un serveur <a href="https://grafana.com/">Grafana</a>, <a href="https://prometheus.io/">Prometheus</a>, <a href="https://github.com/grafana/loki">Loki</a>, Promtail pour gérer les statistiques et les logs du serveur,</p>
</li>
<li>
<p>un serveur de sauvegardes <a href="https://borgbackup.readthedocs.io/">BorgBackup</a>,</p>
</li>
<li>
<p>un serveur de VPN <a href="https://pritunl.com/">Pritunl</a>,</p>
</li>
<li>
<p>un serveur de bureau à distance <a href="https://guacamole.apache.org">Guacamole</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Dans ce document nous configurons un nom de domaine principal. Pour la clarté du texte, il sera nommé "example.com". Il est à remplacer évidemment par votre nom de domaine principal.</p>
</div>
<div class="paragraph">
<p>Je suppose dans ce document que vous savez vous connecter à distance sur un serveur en mode terminal, que vous savez vous servir de <code>ssh</code> pour Linux ou de <code>putty</code> pour Windows, que vous avez des notions élémentaires de Shell Unix et que vous savez vous servir de l&#8217;éditeur <code>vi</code>. Si <code>vi</code> est trop compliqué pour vous, je vous suggère d&#8217;utiliser l&#8217;éditeur de texte <code>nano</code> à la place et de remplacer <code>vi</code> par <code>nano</code> dans toutes les lignes de commande.</p>
</div>
<div class="paragraph">
<p>Dans le document, on peut trouver des textes entourés de &lt;texte&gt;. Cela signifie que vous devez mettre ici votre propre texte selon vos préférences.</p>
</div>
<div class="paragraph">
<p>Le coût pour mettre en oeuvre ce type de serveur est relativement faible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compter 15-18€TTC/an pour un nom de domaine classique (mais il peut y avoir des promos)</p>
</li>
<li>
<p>Comptez 26€ pour acheter une carte Raspberry PI 3 A+ (1Go de Ram) et 61€ pour un PI 4 avec 4Go de Ram. A cela il faut ajouter un boitier, une alim et une flash de 64 ou 128 Go (prenez les cartes SD les plus rapide possible en écriture). Vous en aurez donc pour 110€ si vous achetez tout le kit.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Par rapport à une solution VPS directement dans le cloud, ce budget correspond à 7-10 mois d&#8217;abonnement.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="root_login">2. Se loguer root sur le serveur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A de nombreux endroit dans la documentation, il est demandé de se loguer root sur le serveur.
Pour se loguer root, et dans l’hypothèse que vous avez mis en place un compte sudo:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>De votre machine locale, loguez vous avec votre compte <code>&lt;sudo_username&gt;</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh &lt;sudo_username&gt;@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Mettez ici &lt;sudo_username&gt; par votre nom de login et &lt;example.com&gt; par votre nom de domaine ou son adresse IP. Au début votre nom de domaine acheté n&#8217;est pas encore configuré. Il faut donc utiliser le nom de machine ( par exemple pour un VPS OVH: VPSxxxxxx.ovh.net ou pour un raspberry: raspberrypi.local ) ou votre adresse IP.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>ou utilisez putty si vous êtes sous Windows.</p>
</div>
</li>
<li>
<p>Tapez votre mot de passe s&#8217;il est demandé. Si vous avez installé une clé de connexion ce ne devrait pas être le cas.</p>
</li>
<li>
<p>Loguez-vous <code>root</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Un mot de passe vous est demandé. Tapez le mot de passe demandé.</p>
</div>
</li>
<li>
<p>Dans le cas contraire (pas de sudo créé et connexion en root directe sur le serveur):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Se loguer root sur le serveur distant. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh root@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;example.com&gt; par votre nom de domaine.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Tapez ensuite votre mot de passe root</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="pass_gen">3. Gestion des mots de passe</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A propos des mots de passe: il est conseillé de saisir des mots de passe de 10 caractères contenant des majuscules/minuscules/nombres/caractères spéciaux. Une autre façon de faire est de saisir de longues phrases. Par exemple: 'J&#8217;aime manger de la mousse au chocolat parfumée à la menthe'. Ce dernier exemple a un taux de complexité bien meilleur qu&#8217;un mot de passe classique. Il est aussi plus facile à retenir que 'Az3~1ym_a&amp;'.</p>
</div>
<div class="paragraph">
<p>Cependant, si vous êtes en manque d&#8217;inspiration et que vous souhaitez générer des mots de passe, voici quelques méthodes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>En se basant sur la date. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>date +%s <span class="tok-p">|</span> sha256sum <span class="tok-p">|</span> base64 <span class="tok-p">|</span> head -c <span class="tok-m">32</span> <span class="tok-p">;</span> <span class="tok-nb">echo</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</td>
</tr>
</table>
</div>
</li>
<li>
<p>En se basant sur les nombres aléatoires système. Tapez l&#8217;une des deux lignes ci dessous :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tr -cd <span class="tok-s1">&#39;[:graph:]&#39;</span> &lt; /dev/urandom <span class="tok-p">|</span> head -c <span class="tok-m">32</span><span class="tok-p">;</span> <span class="tok-nb">echo</span> <i class="conum" data-value="1"></i><b>(1)</b>
tr -cd A-Za-z0-9 &lt; /dev/urandom <span class="tok-p">|</span> head -c <span class="tok-m">32</span><span class="tok-p">;</span><span class="tok-nb">echo</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</td>
</tr>
</table>
</div>
</li>
<li>
<p>En utilisant Openssl. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>openssl rand -base64 <span class="tok-m">32</span> <span class="tok-p">|</span> cut -c-32 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</td>
</tr>
</table>
</div>
</li>
<li>
<p>En utilisant gpg. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>gpg --gen-random --armor <span class="tok-m">1</span> <span class="tok-m">32</span> <span class="tok-p">|</span> cut -c-32 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères</td>
</tr>
</table>
</div>
</li>
<li>
<p>En utilisant pwgen pour générer des mots de passe qui suivent des règles de longueur et types de caractères.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pour installer l&#8217;outil, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install pwgen</code></pre>
</div>
</div>
</li>
<li>
<p>Ensuite tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pwgen -Bcny <span class="tok-m">32</span> -1 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez 32 par la valeur qui vous convient pour générer un mot de passe d&#8217;une taille différente de 32 caractères. La commande crée un mot de passe non ambigue avec au moins une majuscule , une valeur numérique, un symbole.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>En utilisant apg pour générer des mots de passe prononcables tel que: <code>7quiGrikCod+ (SEVEN-qui-Grik-Cod-PLUS_SIGN)</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pour installer l&#8217;outil, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install apg</code></pre>
</div>
</div>
</li>
<li>
<p>Ensuite tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apg</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>En utilisant xkcdpass pour générer des passphrases comme: <code>context smashup spiffy cuddly throttle landfall</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pour installer l&#8217;outil, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install xkcdpass</code></pre>
</div>
</div>
</li>
<li>
<p>Ensuite tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>xkcdpass</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_choix_du_registrar">4. Choix du registrar</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pour rappel, un registrar est une société auprès de laquelle vous pourrez acheter un nom de domaine sur une durée déterminée. Vous devrez fournir pour votre enregistrement un ensemble de données personnelles qui permettront de vous identifier en tant que propriétaire de ce nom de domaine.</p>
</div>
<div class="paragraph">
<p>Pour ma part j&#8217;ai choisi Gandi car il ne sont pas très cher et leur interface d&#8217;administration est simple d&#8217;usage. Vous pouvez très bien prendre aussi vos DNS chez OVH.</p>
</div>
<div class="paragraph">
<p>Une fois votre domaine enregistré et votre compte créé vous pouvez vous loguer sur la <a href="https://admin.gandi.net/dashboard">plateforme de gestion de Gandi</a>.</p>
</div>
<div class="paragraph">
<p>Allez dans Nom de domaine et sélectionnez le nom de domaine que vous voulez administrer.
La vue générale vous montre les services actifs. Il faut une fois la configuration des DNS effectuée être dans le mode suivant:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Serveurs de noms: Externes</p>
</li>
<li>
<p>Emails: Inactif</p>
</li>
<li>
<p>DNSSEC: Actif (cela sera activé dans une seconde étape de ce guide)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vous ne devez avoir aucune boite mail active sur ce domaine. A regardez dans le menu "Boites &amp; redirections Mails".
Vous devez reconfigurer les 'Enregistrements DNS' en mode externes.
Dans le menu "serveurs de noms", vous devez configurer les serveurs de noms externe. Mettre 3 DNS:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les deux DNS de votre domaine: ns1.&lt;example.com&gt; et ns2.&lt;example.com&gt;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour que tout cela fonctionne bien, ajoutez des Glue records:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un pour ns1.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</p>
</li>
<li>
<p>un pour ns2.&lt;example.com&gt; lié à l&#8217;adresse &lt;IP&gt; du serveur</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cette configuration du lien chez votre registrar des deux DNS de votre serveur n&#8217;est à faire qu&#8217;après avoir défini le premier domaine de votre serveur
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Il y a la possibilité chez OVH d&#8217;utiliser un DNS secondaire. Dans ce cas, enregistrez votre nom de domaine sur le serveur de dns secondaire de votre hébergeur. Notez ensuite le nom de domaine de ce DNS secondaire et ajoutez une entrée supplémentaire sur le serveur de votre registrar avec l&#8217;adresse DNS secondaire.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Avoir un DNS sur au moins deux machines distinctes est la configuration recommandée.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Le menu restant est associé à DNSSEC; nous y reviendrons plus tard.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_linux_sur_votre_raspberry_pi">5. Installation du linux sur votre Raspberry Pi</h2>
<div class="sectionbody">
<div class="paragraph">
<p>C&#8217;est la première étape.</p>
</div>
<div class="paragraph">
<p>Il vous faut bien choisir le type de linux que vous souhaitez installer:
* Raspbian: C&#8217;est la distribution la plus connue et celle qui offre le plus de possibilités juste après l&#8217;installation (notamment pour faire de la domotique, utiliser le GPIO &#8230;&#8203;) . Elle présente l&#8217;inconvénient de ne pas être 64 bits et de ne pas permettre l&#8217;installation d&#8217;un certain nombre de programmes qui ne sont aujourd&#8217;hui disponibles que pour ces plateformes. Certains paquets sont aussi ancien (tels que Mongodb) ce qui pose quelques problèmes d&#8217;installation.
* Ubuntu 64: Elle est plus proche d&#8217;une ubuntu standard et propose beaucoup de paquets pour faire fonctionner votre raspberry en serveur web.</p>
</div>
<div class="paragraph">
<p>Il vous faudra un lecteur de flash microSD - USB que vous brancherez sur votre PC.</p>
</div>
<div class="paragraph">
<p>Il existe maintenant un outil nommé <a href="https://www.raspberrypi.org/downloads/">Rasberry PI Imager</a> pour la plateforme qui vous convient. C&#8217;est le moyen de plus simple de flasher votre raspberry pi.</p>
</div>
<div class="paragraph">
<p>Pour Windows, très simple, il suffit de lancer le programme téléchargé.
Pour Linux, appliquer la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /tmp
wget https://downloads.raspberrypi.org/imager/imager_amd64.deb
dpkg -i imager_amd64.deb</code></pre>
</div>
</div>
</li>
<li>
<p>Lancez le programme.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Suivez la procédure ci dessous commune à toutes les plateformes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sélectionnez <code>Choose OS</code> et dans la liste choisissez <code>Raspbian</code> ou <code>Ubuntu 64</code></p>
</li>
<li>
<p>Sélectionnez <code>CHoose SD CARD</code> et sélectionnez votre lecteur de carte SD</p>
</li>
<li>
<p>Cliquez sur <code>Write</code></p>
</li>
<li>
<p>Attendez la fin du chargement et de l&#8217;écriture sur la flash.</p>
</li>
<li>
<p>Vous avez deux façons d&#8217;installer:</p>
<div class="ulist">
<ul>
<li>
<p>avec un écran et un clavier qui est la méthode la plus facile</p>
</li>
<li>
<p>en mode Headless qui est plus complexe mais ne nécessite pas d&#8217;écran ni de clavier</p>
</li>
</ul>
</div>
</li>
<li>
<p>Vous devez choisir l&#8217;une des méthodes décrites dans les deux chapitres suivants.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_installation_avec_écran_et_clavier">5.1. Installation avec écran et clavier</h3>
<div class="paragraph">
<p>Pour ce type d&#8217;installation, il vous faut un clavier+souris et un écran.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enlevez la carte SD de votre lecteur et insérez la dans votre raspberry PI.</p>
</li>
<li>
<p>Brancher un clavier, une souris et un écran (ou utilisez un écran 3,5" configuré selon la procédure en annexe).</p>
</li>
<li>
<p>Branchez votre Raspberry sur votre réseau Ethernet filaire (vous pouvez aussi utiliser le wifi)</p>
</li>
<li>
<p>Démarrez votre Raspberry.</p>
</li>
<li>
<p>Après l&#8217;écran de démarrage arc en ciel, vous devez assez rapidement arriver sur le bureau</p>
</li>
<li>
<p>Un programme doit se lancer automatiquement.</p>
</li>
<li>
<p>Sélectionnez le clavier et la langue en français</p>
</li>
<li>
<p>Tapez votre nouveau mot de passe pour le login <code>pi</code></p>
</li>
<li>
<p>Choisissez un full screen sans bords</p>
</li>
<li>
<p>Choisissez votre connexion wifi et entrez le mot de passe</p>
</li>
<li>
<p>Bien noter votre adresse IP elle vous sera utile ensuite</p>
</li>
<li>
<p>Les mises à jours de paquets Debian ainsi que l&#8217;installation des traductions en français vont s&#8217;installer.</p>
</li>
<li>
<p>Une fois les installations terminées, le Raspberry va rebooter.</p>
</li>
<li>
<p>Une fois rebooté, sélectionnez dans le menu <code>Préférences</code>&#8594;`Configuration du Raspberry PI`</p>
<div class="ulist">
<ul>
<li>
<p>Dans l&#8217;onglet <code>Display</code> Cliquez sur <code>Set Resolution</code> et choisissez <code>31: 1920x1080</code></p>
</li>
<li>
<p>Dans l&#8217;onglet <code>Interfaces</code> activez <code>SSH</code> et <code>VNC</code></p>
</li>
<li>
<p>Cliquez sur <code>Valider</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur l’icône <code>VNC</code> dans la barre en haut à Droite</p>
<div class="ulist">
<ul>
<li>
<p>Dans la fenêtre cliquez sur le menu burger en haut à Droite.</p>
</li>
<li>
<p>Choisissez <code>Options</code> puis l&#8217;onglet <code>Sécurité</code></p>
</li>
<li>
<p>Dans le champ Authentification choisissez l&#8217;option <code>mot de passe VNC</code></p>
</li>
<li>
<p>Tapez votre mot de passe dans les deux champs et cliquez <code>Valider</code> puis <code>OK</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Vous pouvez maintenant rebooter votre Raspberry sans écran et sans clavier pour continuer la configuration.</p>
</li>
<li>
<p>Vous avez deux options: connexion en mode SSH ou au travers d&#8217;une connexion VNC</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_headless_de_raspbian">5.2. Installation Headless de Raspbian</h3>
<div class="paragraph">
<p>Pour ce type d&#8217;installation, pas besoin d&#8217;écran, de clavier et de souris. Tout s&#8217;effectue à distance.</p>
</div>
<div class="paragraph">
<p>Dans la suite, je suppose que vous possèdez un PC fonctionnant avec un Linux (la procédure peut être adaptée pour une machine windows en utilisant la ligne de commande et putty)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Avant d&#8217;enlever votre flash SD du lecteur, appliquez la procédure ci après:</p>
<div class="ulist">
<ul>
<li>
<p>Sur la flash, 2 partitions ont été crées. Montez la partition boot</p>
</li>
<li>
<p>sur cette partition, créez un fichier <code>wpa_supplicant.conf</code> et éditez le avec un éditeur de text (Nano ou vi sous linux ou Notepad sous windows).</p>
</li>
<li>
<p>Mettez y le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>ctrl_interface=DIR=/var/run/wpa_supplicant GROUP=netdev
update_config=1
country=US
network={
    ssid=&quot;YOURSSID&quot; <i class="conum" data-value="1"></i><b>(1)</b>
    psk=&quot;YOURPASSWORD&quot; <i class="conum" data-value="2"></i><b>(2)</b>
    key_mgmt=WPA-PSK
    scan_ssid=1
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez <code>YOURSSID</code> par le nom SSID de votre wifi local</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacez <code>YOURPASSWORD</code> par le mot de passe de votre wifi local</td>
</tr>
</table>
</div>
</li>
<li>
<p>sauvez le fichier</p>
</li>
<li>
<p>Sur la même partition créez un fichier <code>ssh</code> (vide et sans extension). Il servira à indiquer au raspberry d&#8217;activer ssh au prochain boot</p>
</li>
<li>
<p>démontez la partition</p>
</li>
<li>
<p>au boot sur la carte SD, le fichier sera recopié dans votre configuration et le réseau wifi sera ainsi accessible</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enlevez la carte SD de votre lecteur et insérez la dans votre Raspberry PI.</p>
</li>
<li>
<p>Démarrez votre raspberry.</p>
</li>
<li>
<p>Attendez environ 2 minutes le temps que le premier boot se termine. Tout pendant la procédure de boot, la petite led d&#8217;accès disque doit clignoter.</p>
</li>
<li>
<p>Vous devez maintenant découvrir l&#8217;adresse IP de votre Raspberry, pour cela tapez la commande suivante:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ping raspberrypi.local</code></pre>
</div>
</div>
</li>
<li>
<p>Si le Raspberry a démarré correctement, cette commande doit montrer l&#8217;adresse IP du raspberry et une réponse correcte au ping</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>PING raspberrypi.local (192.168.3.212) 56(84) bytes of data.
64 bytes from raspberrypi.local (192.168.3.212): icmp_seq=1 ttl=64 time=1.32 ms</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vous pouvez aussi utiliser la commande suivante:
+</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre> arp -na | grep -Pi "(b8:27:eb)|(dc:a6:32)"</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Si vous n&#8217;obtenez aucun résultat essayer la commande <code>nmap</code> sur le subnet de votre réseau local</p>
<div class="ulist">
<ul>
<li>
<p>On obtient l&#8217;adresse local du subnet en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hostname -I</code></pre>
</div>
</div>
</li>
<li>
<p>l&#8217;adresse IP de votre PC est affichée comme premier mot. Par exemple :`192.168.3.10`</p>
</li>
<li>
<p>le subnet se déduit de cette adresse en gardant les 3 premiers nombres (cas général de la plupart des utilisateurs).</p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>nmap -sn <span class="tok-m">192</span>.168.3.0/24</code></pre>
</div>
</div>
</li>
<li>
<p>la commande affiche alors les adresses IP et mac de toutes les machines présentes sur le réseau.</p>
</li>
<li>
<p>le Raspberry se reconnait par son nom de machine qui contient le terme <code>raspberry</code> ou par son adresse mac qui est reconnue du type <code>Raspberry Pi Foundation</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>vous pouvez alors directement vous connecter. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh pi@adresse_ip <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adresse_ip est l&#8217;adresse IP du Raspberry pi découverte précédemment ou raspberrypi.local</td>
</tr>
</table>
</div>
</li>
<li>
<p>Se loguer avec le mot de passe <code>raspberry</code></p>
</li>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo raspi-config</code></pre>
</div>
</div>
</li>
<li>
<p>Choisissez <code>1 Change User Password</code> &#8594; tapez votre nouveau mot de passe 2 fois</p>
</li>
<li>
<p>Sur l&#8217;étape suivante, il ne faut pas se louper ou vous serez obligé d&#8217;éteindre votre raspberry, retirer la flash et la reprogrammer avec le fichier <code>wpa_supplicant.conf</code> dans la partition <code>boot</code></p>
</li>
<li>
<p>Choisissez <code>2 Network Options</code> &#8594; <code>N2 Wi-fi</code> &#8594; Tapez votre nom de SSID (attention aux majuscules) &#8594; Tapez votre mot de passe</p>
</li>
<li>
<p>Choisissez <code>4 Localisation Options</code> &#8594; <code>I1 Change Locale</code> &#8594; Sélectionnez votre langue: <code>fr_FR.UTF-8 UTF-8</code> &#8594; puis la locale par défaut <code>fr_FR.UTF-8 UTF-8</code></p>
</li>
<li>
<p>Choisissez <code>4 Localisation Options</code> &#8594; <code>I2 Change Timezone</code> &#8594; Choisissez votre timezone (par exemple: <code>Europe</code> &#8594; <code>Paris</code>)</p>
</li>
<li>
<p>Choisissez <code>4 Localisation Options</code> &#8594; <code>I3 Change Keyboard Layout</code> &#8594; Choisissez votre mapping clavier</p>
</li>
<li>
<p>Choisissez <code>4 Localisation Options</code> &#8594; <code>I4 Change Wi-fi Country</code> &#8594; choisissez votre pays de norme wifi</p>
</li>
<li>
<p>choisissez <code>5 Interfacing Options</code> &#8594; <code>P2 SSH</code> &#8594; choisissez <code>yes</code></p>
</li>
<li>
<p>choisissez <code>5 Interfacing Options</code> &#8594; <code>P3 VNC</code> &#8594; choisissez <code>yes</code></p>
</li>
<li>
<p>choisissez <code>7 Advanced Options</code> &#8594; <code>A5 Resolution</code> &#8594; choisissez <code>DMT Mode 82 1920x1080 60Hz 16:9</code></p>
</li>
<li>
<p>choisissez <code>8 Update</code> ; Une mise a jour du système va s&#8217;effectuer</p>
</li>
<li>
<p>Tapez ensuite 2 fois sur la touche <code>TAB</code> pour sélectionner <code>Finish</code>. Tapez <code>entrée</code>.</p>
</li>
<li>
<p>Rebootez le système en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo reboot</code></pre>
</div>
</div>
</li>
<li>
<p>Vous allez perdre votre connexion avec le raspberry</p>
</li>
<li>
<p>si vous arrivez à vous reloguer en tapant (attendre 30 secondes après le reboot avant d&#8217;essayer):</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh pi@adresse_ip <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adresse_ip est l&#8217;adresse IP du Raspberry pi découverte précédemment ou raspberrypi.local</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>C&#8217;est que vous avez terminé avec succès la configuration initiale.</p>
</div>
</li>
<li>
<p>RealVNC dans sa configuration par défaut ne permet pas à un utilisateur de se connecter simplement. Il faut donc ruser la première fois.</p>
</li>
<li>
<p>Dans un autre terminal sur votre poste local, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install realvnc-vnc-viewer
vncviewer adresse_ip:5900 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adresse_ip est l&#8217;adresse IP du Raspberry pi découverte précédemment ou raspberrypi.local</td>
</tr>
</table>
</div>
</li>
<li>
<p>Une demande de login et de mot de passe est affiché tapez <code>pi</code> dans le login et le mot de passe que vous avez choisi dans le champ mot de passe. Cliquez sur <code>OK</code></p>
</li>
<li>
<p>le bureau va s&#8217;afficher et un programme se lance automatiquement. Arrêter ce programme puisque vous avez déjà fait la configuration initiale.</p>
</li>
<li>
<p>Cliquez sur l&#8217;icone <code>VNC</code> dans la barre en haut à Droite</p>
<div class="ulist">
<ul>
<li>
<p>Dans la fenêtre cliquez sur le menu burger en haut à Droite.</p>
</li>
<li>
<p>Choisissez <code>Options</code> puis l&#8217;onglet <code>Sécurité</code></p>
</li>
<li>
<p>Dans le champ Authentification choisissez l&#8217;option <code>mot de passe VNC</code></p>
</li>
<li>
<p>Tapez votre mot de passe dans les deux champs et cliquez <code>Valider</code> puis <code>OK</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Vous avez terminé l&#8217;installation initiale de Raspbian. Vous pouvez maintenant rebooter votre raspberry pour continuer la configuration.</p>
</li>
<li>
<p>Vous avez deux options: connexion en mode SSH ou au travers d&#8217;une connection VNC</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_headless_de_ubuntu_64">5.3. Installation Headless de Ubuntu 64</h3>
<div class="paragraph">
<p>Pour ce type d&#8217;installation, pas besoin d&#8217;écran, de clavier et de souris. Tout s&#8217;effectue à distance.</p>
</div>
<div class="paragraph">
<p>Dans la suite, je suppose que vous possédez un PC fonctionnant avec un Linux (la procédure peut être adaptée pour une machine Windows en utilisant la ligne de commande et putty)</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Avant d&#8217;enlever votre flash SD du lecteur, appliquez la procédure ci après:</p>
<div class="ulist">
<ul>
<li>
<p>Sur la flash, 2 partitions ont été crées. Montez la partition <code>system-boot</code></p>
</li>
<li>
<p>sur cette partition, editez le fichier <code>network-config</code> et éditez le avec un éditeur de text (Nano ou vi sous linux ou Notepad sous windows).</p>
</li>
<li>
<p>Mettez y le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>version: 2
ethernets:
  eth0:
    dhcp4: true
    optional: true
wifis:
  wlan0:
    dhcp4: true
    optional: true
    access-points:
      YOURSSID: <i class="conum" data-value="1"></i><b>(1)</b>
        password: &quot;YOURPASSWORD&quot; <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez <code>YOURSSID</code> par le nom SSID de votre wifi local</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacez <code>YOURPASSWORD</code> par le mot de passe de votre wifi local</td>
</tr>
</table>
</div>
</li>
<li>
<p>sauvez le fichier</p>
</li>
<li>
<p>démontez la partition</p>
</li>
<li>
<p>au boot sur la carte SD, le fichier sera recopié dans votre configuration et le réseau wifi sera ainsi accessible</p>
</li>
</ul>
</div>
</li>
<li>
<p>Enlevez la carte SD de votre lecteur et insérez la dans votre Raspberry PI.</p>
</li>
<li>
<p>Démarrez votre raspberry.</p>
</li>
<li>
<p>Attendez environ 2 minutes le temps que le premier boot se termine. Tout pendant la procédure de boot, la petite led d&#8217;accès disque doit clignoter.</p>
</li>
<li>
<p>Vous devez maintenant découvrir l&#8217;adresse IP de votre Raspberry, pour cela tapez la commande suivante:
+</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre> arp -na | grep -Pi "(b8:27:eb)|(dc:a6:32)"</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Ensuite testez l&#8217;adresse ip trouvée</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ping <span class="tok-m">192</span>.168.0.100 <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettez ici l&#8217;adresse IP qui a été découverte.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Si le Raspberry a démarré correctement, cette commande doit montrer l&#8217;adresse IP du raspberry et une réponse correcte au ping</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>PING 192.168.0.100 (192.168.0.100) 56(84) bytes of data.
64 bytes from 192.168.0.100: icmp_seq=1 ttl=64 time=1.49 ms</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Si vous n&#8217;obtenez aucun résultat essayer la commande <code>nmap</code> sur le subnet de votre réseau local</p>
<div class="ulist">
<ul>
<li>
<p>On obtient l&#8217;adresse local du subnet en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hostname -I</code></pre>
</div>
</div>
</li>
<li>
<p>l&#8217;adresse IP de votre PC est affichée comme premier mot. Par exemple :`192.168.3.10`</p>
</li>
<li>
<p>le subnet se déduit de cette adresse en gardant les 3 premiers nombres (cas général de la plupart des utilisateurs).</p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>nmap -sn <span class="tok-m">192</span>.168.3.0/24</code></pre>
</div>
</div>
</li>
<li>
<p>la commande affiche alors les adresses IP et mac de toutes les machines présentes sur le réseau.</p>
</li>
<li>
<p>le Raspberry se reconnait par son nom de machine qui contient le terme <code>ubuntu</code> ou par son adresse mac qui est reconnue du type <code>Raspberry Pi Foundation</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>vous pouvez alors directement vous connecter. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh ubuntu@adresse_ip <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>adresse_ip est l&#8217;adresse IP du Raspberry pi découverte précédemment</td>
</tr>
</table>
</div>
</li>
<li>
<p>Se loguer avec le mot de passe <code>ubuntu</code></p>
</li>
<li>
<p>Un nouveau mot de passe vous sera demandé puis vous serez déconnecté.</p>
</li>
<li>
<p>Reconnectez vous.</p>
</li>
<li>
<p>Installez la langue française. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install language-pack-fr manpages-fr</code></pre>
</div>
</div>
</li>
<li>
<p>Installer la locale qui vous plait. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>dpkg-reconfigure locales</code></pre>
</div>
</div>
</li>
<li>
<p>Choisissez votre langue locale. Par exemple: <code>fr_FR.UTF-8</code></p>
</li>
<li>
<p>Installer la la timezone qui vous plait. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>dpkg-reconfigure tzdata</code></pre>
</div>
</div>
</li>
<li>
<p>Choisissez votre Timezone. Par exemple: <code>Europe/Paris</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_reconnecter_automatiquement_votre_raspberry_pi_au_wifi">5.4. Reconnecter automatiquement votre Raspberry Pi au wifi</h3>
<div class="paragraph">
<p>Si vous connectez votre raspberry pi au réseau au travers du wifi, il arrive que le raspberry perde la connexion au réseau de façon définitive.</p>
</div>
<div class="paragraph">
<p>Pour corriger ce problème, il faut reconnecter Raspberry Pi au réseau wifi de manière forcée.</p>
</div>
<div class="paragraph">
<p>Suivez la procédure ci-après:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Éditez le fichier <code>wifi_rebooter.sh</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install iw
vi /usr/local/bin/wifi_rebooter.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Collez-y le contenu suivant :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash</span>

<span class="tok-nv">SERVER</span><span class="tok-o">=</span><span class="tok-m">8</span>.8.8.8

<span class="tok-c1"># Envoyer seulement 2 pings, et envoyer la sortie vers /dev/null</span>
ping -c2 <span class="tok-si">${</span><span class="tok-nv">SERVER</span><span class="tok-si">}</span> &gt; /dev/null

<span class="tok-c1"># Si le code retour du ping ($?) est différent de 0 (qui correspond à une erreur)</span>
<span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-nv">$?</span> !<span class="tok-o">=</span> <span class="tok-m">0</span> <span class="tok-o">]</span>
<span class="tok-k">then</span>
    <span class="tok-c1"># Power save off</span>

    <span class="tok-c1"># Relancer l&#39;interface wifi</span>
    ip link <span class="tok-nb">set</span> dev wlan0 down
    sleep <span class="tok-m">2</span>
    ip link <span class="tok-nb">set</span> dev wlan0 up
    sleep <span class="tok-m">2</span>
    iw dev wlan0 <span class="tok-nb">set</span> power_save off
<span class="tok-k">fi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Rendre le script exécutable:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod +x /usr/local/bin/wifi_rebooter.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Mettre en place la crontab:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>crontab -e</code></pre>
</div>
</div>
</li>
<li>
<p>Ajouter à la fin du fichier les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>*/5 * * * *   /usr/local/bin/wifi_rebooter.sh</code></pre>
</div>
</div>
</li>
<li>
<p>C&#8217;est fait !</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_basique">6. Configuration basique</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_mettre_léditeur_de_votre_choix">6.1. Mettre l&#8217;éditeur de votre choix</h3>
<div class="paragraph">
<p>En fonction de vos préférences en terme d&#8217;éditeur, choisissez celui qui vous convient pour les outils utilisant un éditeur de façon automatique tels que <code>crontab</code>.</p>
</div>
<div class="paragraph">
<p>Pour les débutants, il est conseillé d&#8217;utiliser nano.</p>
</div>
<div class="paragraph">
<p><a href="#root_login">Loguez vous comme root </a> et tapez:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>update-alternatives  --config editor</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_dun_repository_pour_etc">6.2. Installation d&#8217;un repository pour <code>/etc</code></h3>
<div class="paragraph">
<p>Si vous souhaitez gérer en gestion de configuration le contenu de votre répertoire <code>/etc</code>, installez <code>etckeeper</code>.</p>
</div>
<div class="paragraph">
<p>Cette installation est optionnelle.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update
apt install etckeeper</code></pre>
</div>
</div>
</li>
<li>
<p>Vous pouvez créer un repository privé dans le cloud pour stocker votre configuration de serveur (autre serveur privé de confiance ou repository privé  <code>Gitlab</code> ou <code>Github</code>).</p>
</li>
<li>
<p>Ajoutez ce repository distant. Pour <code>Gitlab</code> et <code>Github</code>, une fois le repository créé, demandez l&#8217;affichage de la commande git pour une communication en ssh. Tapez ensuite sur votre serveur :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc
git remote add origin git@github.com:username/etc_keeper.git <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer l&#8217;url par celle qui correspond au chemin de votre repository</td>
</tr>
</table>
</div>
</li>
<li>
<p>modifier le fichier de configuration de <code>etckeeper</code>. tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/etckeeper/etckeeper.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Recherchez la ligne contenant <code>PUSH_REMOTE</code> et ajoutez y tous les repositories distant sur lesquels vous souhaitez pousser les modifications. Pour notre configuration, mettez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">PUSH_REMOTE</span><span class="tok-o">=</span><span class="tok-s2">&quot;origin&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Pour éviter des demandes de mot de passe de la part de <code>github</code> ou <code>gitlab</code>, il est nécessaire de déclarer une clé publique sur leur site. Créez une clé sur votre serveur pour l&#8217;utilisateur root:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Créer un répertoire <code>/root/.ssh</code> s&#8217;il n&#8217;existe pas. tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /root
mkdir -p .ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Allez dans le répertoire. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /root/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Générez vous clés. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh-keygen -t rsa</code></pre>
</div>
</div>
</li>
<li>
<p>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</p>
</li>
<li>
<p>Allez sur <code>gitlab</code> ou <code>github</code> dans la rubriques "settings" et le menu "SSH keys". Ajoutez la clé que vous aurez affiché avec la commande suivante:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat /root/.ssh/id_rsa.pub</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Effectuez un premier push. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc
git push -u origin master</code></pre>
</div>
</div>
</li>
<li>
<p>aucun mot de passe ne doit vous être demandé. Si ce n&#8217;est pas le cas, re-vérifier les étapes précédentes.</p>
</li>
<li>
<p>Lancer <code>etckeeper</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>etckeeper commit</code></pre>
</div>
</div>
</li>
<li>
<p>Tout le contenu de <code>/etc</code> est poussé sur le repository. Saisissez un commentaire.</p>
</li>
<li>
<p>C&#8217;est fait !</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_mise_à_jour_des_sources_de_paquets_debian_ou_ubuntu">6.3. Mise à jour des sources de paquets Debian ou Ubuntu</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Selon la distribution installée suivez la procédure ci-après ou celle suivante.</p>
</li>
<li>
<p>Modifier la liste standard de paquets Debian</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Éditer le fichier <code>/etc/apt/sources.list</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apt/sources.list</code></pre>
</div>
</div>
</li>
<li>
<p>Dé-commenter les lignes débutant par <code>deb</code> et contenant le terme <code>backports</code>. Par exemple pour <code>#deb <a href="http://deb.debian.org/debian" class="bare">http://deb.debian.org/debian</a> buster-backports main contrib non-free</code> enlever le # en début de ligne</p>
</li>
<li>
<p>Ajouter sur toutes les lignes les paquets <code>contrib</code> et <code>non-free</code> . en ajoutant ces textes après chaque mot <code>main</code> du fichier <code>source.list</code></p>
</li>
<li>
<p>Le fichier doit ressembler à ceci:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">deb http://raspbian.raspberrypi.org/raspbian/ buster main contrib non-free rpi</span>
<span class="tok-c1"># Uncomment line below then &#39;apt-get update&#39; to enable &#39;apt-get source&#39;</span>
<span class="tok-c1">#deb-src http://raspbian.raspberrypi.org/raspbian/ buster main contrib non-free rpi</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Modifier la liste standard de paquets Ubuntu</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Éditer le fichier <code>/etc/apt/sources.list</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apt/sources.list</code></pre>
</div>
</div>
</li>
<li>
<p>Dé-commenter les lignes débutant par <code>deb</code> enlever le # en début de ligne</p>
</li>
</ol>
</div>
</li>
<li>
<p>Effectuer une mise à niveau du système</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Mettez à jour la liste des paquets. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update</code></pre>
</div>
</div>
</li>
<li>
<p>Installez les nouveautés. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt dist-upgrade</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Effectuez du ménage. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt autoremove</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_des_paquets_de_base">6.4. Installation des paquets de base</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install curl wget ntpdate apt-transport-https apt-listchanges apt-file apt-rdepends man</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installer_loutil_debfoster">6.5. Installer l&#8217;outil Debfoster</h3>
<div class="paragraph">
<p>L&#8217;outil <code>debfoster</code> permet de ne conserver que les paquets essentiels.</p>
</div>
<div class="paragraph">
<p>Cette installation est optionnelle.</p>
</div>
<div class="paragraph">
<p>Il maintient un fichier <code>keepers</code> présent dans <code>/var/lib/debfoster</code></p>
</div>
<div class="paragraph">
<p>En répondant aux questions de conservations de paquets, <code>debfoster</code> maintient la liste des paquets uniques nécessaires au système.
Tous les autres paquets seront supprimés.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajouter le paquet <code>debfoster</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install debfoster</code></pre>
</div>
</div>
</li>
<li>
<p>Lancez <code>debfoster</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>debfoster</code></pre>
</div>
</div>
</li>
<li>
<p>Répondez au questions pour chaque paquet</p>
</li>
<li>
<p>Acceptez la liste des modifications proposées à la fin. Les paquets superflus seront supprimés</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ci dessous une petite liste de paquets à conserver sur une installation basique Raspian:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">alacarte</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apparmor</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apt-listchanges</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">arandr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">avahi-daemon</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">binutils-arm-linux-gnueabihf</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">blueman</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bluetooth</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cifs-utils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">console-setup</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">debconf-utils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">debfoster</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">debian-reference-en</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">dphys-swapfile</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ed</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">etckeeper</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ethtool</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fake-hwclock</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">fbset</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ffmpeg</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">firmware-atheros</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">firmware-brcm80211</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">firmware-libertas</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">firmware-misc-nonfree</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">firmware-realtek</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">gldriver-test</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hardlink</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">htop</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">hunspell-en-gb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hunspell-fr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hyphen-en-gb</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">hyphen-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">keyutils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">locales</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">lxde</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mythes-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">ncdu</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">omxplayer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pi-package</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">piclone</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">piwiz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">pkg-config</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">python-pip</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">qpdfview</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">raspberrypi-net-mods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">raspberrypi-ui-mods</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">raspi-copies-and-fills</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">read-edid</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">realvnc-vnc-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">realvnc-vnc-viewer</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rng-tools</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rp-prefapps</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">rpi-update</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">rsync</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssh</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ssh-import-id</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">strace</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">sudo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">tree</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ttf-bitstream-vera</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">usb-modeswitch</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">usbutils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">v4l-utils</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">vl805fw</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wamerican</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wfrench</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wireless-tools</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">wpasupplicant</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xcompmgr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xfonts-100dpi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xinit</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xml-core</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">xsel</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">xserver-xorg-video-fbdev</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">zip</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>La même liste pour un Ubuntu pour Raspberry Pi</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">apt-file</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apt-listchanges</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apt-rdepends</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">apt-transport-https</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">cloud-init</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">debfoster</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">etckeeper</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">language-pack-fr</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">linux-firmware-raspi2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">linux-raspi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">manpages-fr</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ntpdate</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">openssh-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">u-boot-rpi</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ubuntu-server</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ubuntu-standard</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">wpasupplicant</p></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_création_dun_fichier_keeper_dans_etc">6.6. Création d&#8217;un fichier keeper dans /etc</h3>
<div class="paragraph">
<p>Vous pourriez être intéressé après l&#8217;installation de <code>debfoster</code> et de <code>etckeeper</code> de construire automatiquement un fichier qui contient la liste des paquets qui permettent de réinstaller le système:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/etckeeper/pre-commit.d/35debfoster</code></pre>
</div>
</div>
</li>
<li>
<p>Saisissez dans le fichier:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-nb">set</span> -e

<span class="tok-c1"># Make sure sort always sorts in same order.</span>
<span class="tok-nv">LANG</span><span class="tok-o">=</span>C
<span class="tok-nb">export</span> LANG

shellquote<span class="tok-o">()</span> <span class="tok-o">{</span>
        <span class="tok-c1"># Single quotes text, escaping existing single quotes.</span>
        sed -e <span class="tok-s2">&quot;s/&#39;/&#39;\&quot;&#39;\&quot;&#39;/g&quot;</span> -e <span class="tok-s2">&quot;s/^/&#39;/&quot;</span> -e <span class="tok-s2">&quot;s/</span>$<span class="tok-s2">/&#39;/&quot;</span>
<span class="tok-o">}</span>


<span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$VCS</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> git <span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$VCS</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> hg <span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$VCS</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> bzr <span class="tok-o">]</span> <span class="tok-o">||</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$VCS</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> darcs <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
        <span class="tok-c1"># Make sure the file is not readable by others, since it can leak</span>
        <span class="tok-c1"># information about contents of non-readable directories in /etc.</span>
        debfoster -q -k /etc/keepers
        chmod <span class="tok-m">600</span> /etc/keepers
        sed -i <span class="tok-s2">&quot;1i\\# debfoster file&quot;</span> /etc/keepers
        sed -i <span class="tok-s2">&quot;1i\\# Generated by etckeeper.  Do not edit.&quot;</span>  /etc/keepers

        <span class="tok-c1"># stage the file as part of the current commit</span>
        <span class="tok-k">if</span> <span class="tok-o">[</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$VCS</span><span class="tok-s2">&quot;</span> <span class="tok-o">=</span> git <span class="tok-o">]</span><span class="tok-p">;</span> <span class="tok-k">then</span>
                <span class="tok-c1"># this will do nothing if the keepers file is unchanged.</span>
                git add keepers
        <span class="tok-k">fi</span>
        <span class="tok-c1"># hg, bzr and darcs add not done, they will automatically</span>
        <span class="tok-c1"># include the file in the current commit</span>
<span class="tok-k">fi</span></code></pre>
</div>
</div>
</li>
<li>
<p>Sauvez et tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">755</span> /etc/etckeeper/pre-commit.d/35debfoster</code></pre>
</div>
</div>
</li>
<li>
<p>Exécutez maintenant <code>etckeeper</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>etckeeper commit</code></pre>
</div>
</div>
</li>
<li>
<p>Le fichier keepers est créé et sauvegardé automatiquement.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_des_mises_à_jours_automatiques">6.7. Installation des mises à jours automatiques</h3>
<div class="paragraph">
<p>Si vous souhaitez installer automatiquement les paquets Debian de correction de bugs de sécurité, cette installation est pour vous.</p>
</div>
<div class="paragraph">
<p>Cette installation est optionnelle.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
L&#8217;installation automatique de paquets peut conduire dans certains cas
très rare à des dysfonctionnements du serveur. Il est important de
regarder périodiquement les logs d&#8217;installation.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install unattended-upgrades</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_vérification_du_nom_de_serveur">6.8. Vérification du nom de serveur</h3>
<div class="paragraph">
<p>Cette partie consiste à vérifier que le serveur a un hostname correctement configuré.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>vérifier que le hostname est bien celui attendu (c&#8217;est à dire configuré par votre hébergeur). Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat /etc/hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le nom du hostname (sans le domaine) doit s&#8217;afficher.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Si ce n&#8217;est pas le cas, changer ce nom en éditant le fichier. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="shell"><span></span>vi /etc/hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changez la valeur, sauvegardez et rebootez. Tapez :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>reboot</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Vérifier le fichier <code>hosts</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat /etc/hosts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Si le fichier contient plusieurs lignes avec la même adresse de loopback en <code>127.x.y.z</code>, en gardez une seule et celle avec le hostname et le nom de domaine complet.</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>si ce n&#8217;est pas le cas, changer les lignes en éditant le fichier. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/hosts</code></pre>
</div>
</div>
</li>
<li>
<p>Changez la ou les lignes, sauvegardez.</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Le FQDN (nom de machine avant le nom de domaine) doit être déclaré avant le hostname simple dans le fichier <code>hosts</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Rebootez. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>reboot</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
</ol>
</div>
</li>
<li>
<p>Vérifiez que tout est correctement configuré.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hostname</code></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie doit afficher le nom de host.</p>
</div>
</li>
<li>
<p>Tapez ensuite :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>hostname -f</code></pre>
</div>
</div>
<div class="paragraph">
<p>La sortie doit afficher le nom de host avec le nom de domaine.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_interdire_le_login_direct_en_root">6.9. Interdire le login direct en root</h3>
<div class="paragraph">
<p>Il est toujours vivement déconseillé d&#8217;autoriser la possibilité de se connecter directement en SSH en tant que root.
De ce fait, notre première action sera de désactiver le login direct en root  et d&#8217;autoriser le sudo.
Respectez bien les étapes de cette procédure:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajoutez un utilisateur standard qui sera nommé par la suite en tant que &lt;sudo_username&gt;</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>adduser &lt;sudo_username&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;sudo_username&gt; par votre login</td>
</tr>
</table>
</div>
</li>
<li>
<p>Répondez aux questions qui vont sont posées: habituellement le nom complet d&#8217;utilisateur et le mot de passe.</p>
</li>
<li>
<p>Donner les attributs sudo à l&#8217;utilisateur <code>&lt;sudo_username&gt;</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>usermod -a -G sudo &lt;sudo_username&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;sudo_username&gt; par votre login</td>
</tr>
</table>
</div>
</li>
<li>
<p>Dans une autre fenêtre, se connecter sur le serveur avec votre nouveau compte <code>&lt;sudo_username&gt;</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh &lt;sudo_username&gt;@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>une fois logué, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo bash</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tapez le mot de passe de votre utilisateur. Vous devez avoir accès au compte root. Si ce n&#8217;est pas le cas, revérifiez la procédure et repassez toutes les étapes.</p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Tout pendant que ces premières étapes ne donnent pas satisfaction ne passez pas à la suite sous peine de perdre la possibilité d’accéder à votre serveur.
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Il faut maintenant modifier la configuration de sshd.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Editez le fichier <code>/etc/ssh/sshd_config</code>, Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/ssh/sshd_config</code></pre>
</div>
</div>
<div class="paragraph">
<p>il faut rechercher la ligne: <code>PermitRootLogin yes</code> et la remplacer par:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">PermitRootLogin no</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez le serveur ssh. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service sshd restart</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Faites maintenant l&#8217;essai de vous re-loguer avec le compte root.Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh root@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remplacer ici &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Ce ne devrait plus être possible: le serveur vous l&#8217;indique par un message <code>Permission denied, please try again.</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_dune_clé_de_connexion_ssh_locale">6.10. Création d&#8217;une clé de connexion ssh locale</h3>
<div class="paragraph">
<p>Pour créer une clé et la déployer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une clé sur votre machine locale (et pas sur le serveur distant!):</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Ouvrir un terminal</p>
</li>
<li>
<p>Créer un répertoire <code>~/.ssh</code> s&#8217;il n&#8217;existe pas. tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p <span class="tok-nv">$HOME</span>/.ssh
chmod <span class="tok-m">700</span> ~/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Allez dans le répertoire. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> ~/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Générez vous clés. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh-keygen -t rsa</code></pre>
</div>
</div>
</li>
<li>
<p>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Sur votre PC local afficher la clé à l&#8217;écran. Elle sera copiée-collée par la suite:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cat ~/.ssh/id_rsa.pub</code></pre>
</div>
</div>
</li>
<li>
<p>Déployez votre clé:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Loguez vous sur votre serveur distant. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh &lt;sudo_username&gt;@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Entrez votre mot de passe</p>
</div>
</li>
<li>
<p>Créer un répertoire <code>~/.ssh</code> s&#8217;il n&#8217;existe pas. tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p <span class="tok-nv">$HOME</span>/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Éditez le fichier <code>~/.ssh/authorized_keys</code> tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi ~/.ssh/authorized_keys</code></pre>
</div>
</div>
<div class="paragraph">
<p>et coller dans ce fichier le texte contenu dans le votre fichier local <code>~/.ssh/id_rsa.pub</code>. Remarque: il peut y avoir déjà des clés dans le fichier <code>authorized_keys</code>.</p>
</div>
</li>
<li>
<p>Sécurisez votre fichier de clés. Tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">600</span> ~/.ssh/authorized_keys</code></pre>
</div>
</div>
</li>
<li>
<p>Sécurisez le répertoire SSH; Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> ~/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Déconnectez vous de votre session</p>
</li>
</ol>
</div>
</li>
<li>
<p>Vérifiez que tout fonctionne en vous connectant. Tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh &lt;sudo_username&gt;@&lt;example.com&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer ici &lt;sudo_username&gt; par votre login et &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>La session doit s&#8217;ouvrir sans demander de mot de passe.</p>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_sudo_sans_mot_de_passe">6.11. Sudo sans mot de passe</h3>
<div class="paragraph">
<p>Avant tout, il faut bien se rendre compte que cela constitue potentiellement une faille de sécurité et qu&#8217;en conséquence, le compte possédant cette propriété devra être autant sécurisé qu&#8217;un compte root.
L’intérêt étant d&#8217;interdire le compte root en connexion ssh tout en gardant la facilité de se loguer root sur le système au travers d&#8217;un super-compte.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajoutez un groupe sudonp et y affecter un utilisateur. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>addgroup --system sudonp</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Ajouter l&#8217;utilisateur: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>usermod -a -G sudonp &lt;sudo_username&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Éventuellement retirez l&#8217;utilisateur du groupe sudo s&#8217;il a été ajouté auparavant :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>gpasswd -d &lt;sudo_username&gt; sudo</code></pre>
</div>
</div>
</li>
<li>
<p>Éditez le fichier sudoers. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/sudoers</code></pre>
</div>
</div>
</li>
<li>
<p>Ajouter dans le fichier la ligne suivante:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">%sudonp ALL</span><span class="tok-o">=</span><span class="tok-s">(ALL:ALL) NOPASSWD: ALL</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>L&#8217;utilisateur nom_d_utilisateur pourra se logger root sans mot de passe au travers de la commande <code>sudo bash</code></p>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installer_loutil_dselect">6.12. Installer l&#8217;outil dselect</h3>
<div class="paragraph">
<p>L&#8217;outil <code>dselect</code> permet de choisir de façon interactive les paquets que l&#8217;on souhaite installer.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajouter le paquet <code>dselect</code>. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install dselect</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="swap_create">6.13. Ajouter un fichier de swap</h3>
<div class="paragraph">
<p>Pour un serveur VPS ou Raspberry Pi de 2 Go de RAM, la taille du fichier de swap sera de 2 Go.
Si vous avez beaucoup d&#8217;outils et de serveurs à installer il peut être nécessaire d&#8217;avoir 4 Go de RAM au total + 2 Go de swap.</p>
</div>
<div class="paragraph">
<p>Enfin pour un Raspberry PI 3 avec 1 Go de Ram, il faut ajouter 1 Go de swap.</p>
</div>
<div class="paragraph">
<p>Tapez :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tout d&#8217;abord, si l&#8217;outil <code>dphys-swapfile</code> est installé et configuré sur la machine, commencez par désactiver le swap. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>dphys-swapfile uninstall</code></pre>
</div>
</div>
</li>
<li>
<p>Pour installer un swap de 2Go, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /
fallocate -l 2G /swapfile
chmod <span class="tok-m">600</span> /swapfile
mkswap /swapfile
swapon /swapfile</code></pre>
</div>
</div>
</li>
<li>
<p>Enfin ajoutez une entrée dans le fichier fstab. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/fstab</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez la ligne:</p>
<div class="listingblock">
<div class="content">
<pre>/swapfile swap swap defaults 0 0</pre>
</div>
</div>
</li>
<li>
<p>Enfin vous pouvez être tenté de limiter le swap (surtout utile sur les systèmes avec peu de RAM et du SSD. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systctl.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez ou modifiez la ligne:</p>
<div class="listingblock">
<div class="content">
<pre>vm.swappiness = 5</pre>
</div>
</div>
</li>
<li>
<p>Le paramètre sera actif au prochain reboot</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_initiale_des_outils">7. Installation initiale des outils</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La procédure d&#8217;installation ci-dessous configure ISPconfig avec les fonctionnalités suivantes: Postfix, Dovecot, MariaDB, rkHunter, Apache, PHP, Let&#8217;s Encrypt, PureFTPd, Bind, Webalizer, AWStats, fail2Ban, UFW Firewall, PHPMyadmin, RoundCube.</p>
</div>
<div class="paragraph">
<p>Pour les systèmes ayant 2 Go de RAM ou plus, il est fortement conseillé d&#8217;installer les outils ci après :  Amavisd, SpamAssassin, ClamAV, Mailman.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Changez le Shell par défaut. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>dpkg-reconfigure dash</code></pre>
</div>
</div>
<div class="paragraph">
<p>A la question <code>utilisez dash comme shell par défaut</code> répondez <code>non</code>. C&#8217;est bash qui doit être utilisé.</p>
</div>
</li>
<li>
<p>Installation de quelques paquets debian. ;-)</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install patch ntp postfix postfix-mysql postfix-doc mariadb-client mariadb-server openssl getmail4 rkhunter binutils dovecot-imapd dovecot-pop3d dovecot-mysql dovecot-sieve dovecot-lmtpd unzip bzip2 arj nomarch lzop cabextract p7zip p7zip-full lrzip libnet-ldap-perl libauthen-sasl-perl clamav-docs daemon libio-string-perl libio-socket-ssl-perl libnet-ident-perl zip libnet-dns-perl libdbd-mysql-perl postgrey apache2 apache2-doc apache2-utils libapache2-mod-php php php-common php-gd php-mysql php-imap php-cli php-cgi libapache2-mod-fcgid apache2-suexec-pristine php-pear mcrypt  imagemagick libruby libapache2-mod-python php-curl php-intl php-pspell  php-sqlite3 php-tidy php-xmlrpc memcached php-memcache php-imagick php-zip php-mbstring libapache2-mod-passenger php-soap php-fpm php-apcu bind9 dnsutils haveged webalizer awstats geoip-database libclass-dbi-mysql-perl libtimedate-perl fail2ban ufw anacron goaccess php-gettext php-recode php-opcache php-xsl xz-utils lzip unrar jailkit</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>jailkit</code> et <code>unrar</code> ne sont pas disponible sur Raspbian. Il faut donc les supprimer de cette liste. Les paquets <code>php-ocache</code> et <code>php-xsl</code> doivent être remplacés par la version la plus récente sur Raspbian.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
pour Ubuntu 20, php-gettext et php-recode n&#8217;existent pas. Il faut donc les supprimer de la liste.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pour les systèmes avec plus de mémoire tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install amavisd-new spamassassin clamav clamav-daemon</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Aux questions posées répondez:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Type principal de configuration de mail</code>: &#8592; Sélectionnez <code>Site Internet</code></p>
</li>
<li>
<p><code>Nom de courrier</code>: &#8592; Entrez votre nom de host. Par exemple: <code>mail.example.com</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_configuration_de_postfix">7.1. Configuration de Postfix</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Editez le master.cf file de postfix. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/postfix/master.cf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez dans le fichier:</p>
<div class="listingblock">
<div class="content">
<pre>submission inet n - - - - smtpd
 -o syslog_name=postfix/submission
 -o smtpd_tls_security_level=encrypt
 -o smtpd_sasl_auth_enable=yes
 -o smtpd_client_restrictions=permit_sasl_authenticated,reject

smtps inet n - - - - smtpd
 -o syslog_name=postfix/smtps
 -o smtpd_tls_wrappermode=yes
 -o smtpd_sasl_auth_enable=yes
 -o smtpd_client_restrictions=permit_sasl_authenticated,reject</pre>
</div>
</div>
</li>
<li>
<p>Sauvegardez et relancez Postfix:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart postfix</code></pre>
</div>
</div>
</li>
<li>
<p>Si vous avez installé <code>SpamAssassin</code>, désactiver <code>SpamAssassin</code> puisque <code>amavisd</code> utilise celui ci en sous jacent. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl stop spamassassin
systemctl disable spamassassin</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_de_mariadb">7.2. Configuration de MariaDB</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Sécurisez votre installation MariaDB. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql_secure_installation</code></pre>
</div>
</div>
<div class="paragraph">
<p>Répondez au questions ainsi:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Enter current password for root</code>: &#8592; Tapez Entrée</p>
</li>
<li>
<p><code>Set root password? [Y/n]</code>: &#8592; Tapez <code>Y</code></p>
</li>
<li>
<p><code>New password:</code>: &#8592; Tapez votre mot de passe root MariaDB</p>
</li>
<li>
<p><code>Re-enter New password:</code>: &#8592; Tapez votre mot de passe root MariaDB</p>
</li>
<li>
<p><code>Remove anonymous users? [Y/n]</code>: &#8592; Tapez <code>Y</code></p>
</li>
<li>
<p><code>Disallow root login remotely? [Y/n]</code>: &#8592; Tapez <code>Y</code></p>
</li>
<li>
<p><code>Remove test database and access to it? [Y/n]</code>: &#8592; Tapez <code>Y</code></p>
</li>
<li>
<p><code>Reload privilege tables now? [Y/n]</code>: &#8592; Tapez <code>Y</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>MariaDB doit pouvoir être atteint par toutes les interfaces et pas seulement localhost.</p>
</li>
<li>
<p>Éditez le fichier de configuration. :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/mysql/mariadb.conf.d/50-server.cnf</code></pre>
</div>
</div>
</li>
<li>
<p>Commentez la ligne <code>bind-address</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-c1">#bind-address           = 127.0.0.1</span></code></pre>
</div>
</div>
</li>
<li>
<p>Modifiez la méthode d&#8217;accès à la base MariaDB pour utiliser la méthode de login native.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;update mysql.user set plugin = &#39;mysql_native_password&#39; where user=&#39;root&#39;;&quot;</span> <span class="tok-p">|</span> mysql -u root</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Editez le fichier debian.cnf. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/mysql/debian.cnf</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aux deux endroits du fichier ou le mot clé <code>password</code> est présent, mettez le mot de passe root de votre base de données.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">password</span> <span class="tok-o">=</span> <span class="tok-s">votre_mot_de_passe</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Pour éviter l&#8217;erreur <code>Error in accept: Too many open files</code>, augmenter la limite du nombre de fichiers ouverts.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Editer le fichier: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/security/limits.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez à la fin du fichier les deux lignes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql soft nofile <span class="tok-m">65535</span>
mysql hard nofile <span class="tok-m">65535</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Créez ensuite un nouveau répertoire. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /etc/systemd/system/mysql.service.d/</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Editer le fichier limits.conf. :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/mysql.service.d/limits.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez dans le fichier les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre>[Service]
LimitNOFILE=infinity</pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Redémarrez votre serveur MariaDB. Tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl daemon-reload
systemctl restart mariadb</code></pre>
</div>
</div>
</li>
<li>
<p>vérifiez maintenant que MariaDB est accessible sur toutes les interfaces réseau. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>netstat -tap <span class="tok-p">|</span> grep mysql</code></pre>
</div>
</div>
</li>
<li>
<p>La sortie doit être du type: <code>tcp6 0 0 [::]:mysql [::]:* LISTEN 13708/mysqld</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_dapache">7.3. Configuration d&#8217;Apache</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez les modules Apache nécessaires. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2enmod suexec rewrite ssl proxy_http actions include dav_fs dav auth_digest cgi headers actions proxy_fcgi <span class="tok-nb">alias</span> speling</code></pre>
</div>
</div>
</li>
<li>
<p>Pour ne pas être confronté aux problèmes de sécurité  de type <a href="https://www.howtoforge.com/tutorial/httpoxy-protect-your-server/">HTTPOXY</a>, il est nécessaire de créer un petit module dans apache.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Éditez le fichier <code>httpoxy.conf</code> :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apache2/conf-available/httpoxy.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Collez les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;IfModule</span> <span class="tok-s">mod_headers.c</span><span class="tok-nt">&gt;</span>
    <span class="tok-nb">RequestHeader</span> unset Proxy early
<span class="tok-nt">&lt;/IfModule&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Activez le module en tapant :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2enconf httpoxy
systemctl restart apache2</code></pre>
</div>
</div>
</li>
<li>
<p>Désactiver la documentation apache en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2disconf apache2-doc
systemctl restart apache2</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_du_gestionnaire_de_mailing_list_mailman">7.4. Installation du gestionnaire de mailing list Mailman</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install mailman</code></pre>
</div>
</div>
</li>
<li>
<p>Sélectionnez un langage:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Languages to support:</code> &#8592; Tapez <code>en (English)</code></p>
</li>
<li>
<p><code>Missing site list :</code> &#8592; Tapez <code>Ok</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créez une mailing list. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>newlist mailman</code></pre>
</div>
</div>
</li>
<li>
<p>ensuite éditez le fichier aliases: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/aliases</code></pre>
</div>
</div>
<div class="paragraph">
<p>et ajoutez les lignes affichées à l&#8217;écran:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>## mailman mailing list
mailman:              "|/var/lib/mailman/mail/mailman post mailman"
mailman-admin:        "|/var/lib/mailman/mail/mailman admin mailman"
mailman-bounces:      "|/var/lib/mailman/mail/mailman bounces mailman"
mailman-confirm:      "|/var/lib/mailman/mail/mailman confirm mailman"
mailman-join:         "|/var/lib/mailman/mail/mailman join mailman"
mailman-leave:        "|/var/lib/mailman/mail/mailman leave mailman"
mailman-owner:        "|/var/lib/mailman/mail/mailman owner mailman"
mailman-request:      "|/var/lib/mailman/mail/mailman request mailman"
mailman-subscribe:    "|/var/lib/mailman/mail/mailman subscribe mailman"
mailman-unsubscribe:  "|/var/lib/mailman/mail/mailman unsubscribe mailman"</pre>
</div>
</div>
</li>
<li>
<p>Exécutez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>newaliases</code></pre>
</div>
</div>
<div class="paragraph">
<p>et redémarrez postfix: :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart postfix</code></pre>
</div>
</div>
</li>
<li>
<p>Activez la page web de mailman dans apache: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ln -s /etc/mailman/apache.conf /etc/apache2/conf-enabled/mailman.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez apache :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart apache2</code></pre>
</div>
</div>
<div class="paragraph">
<p>puis redémarrez le demon mailman :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart mailman</code></pre>
</div>
</div>
</li>
<li>
<p>Le site web de mailman est accessible</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Vous pouvez accéder à la page admin Mailman à <a href="http://&lt;server1.example.com&gt;/cgi-bin/mailman/admin/" class="bare">http://&lt;server1.example.com&gt;/cgi-bin/mailman/admin/</a></p>
</li>
<li>
<p>La page web utilisateur de la mailing list est accessible  ici <a href="http://&lt;server1.example.com/cgi-bin&gt;/mailman/listinfo/" class="bare">http://&lt;server1.example.com/cgi-bin&gt;/mailman/listinfo/</a></p>
</li>
<li>
<p>Sous <a href="http://&lt;server1.example.com&gt;/pipermail/mailman" class="bare">http://&lt;server1.example.com&gt;/pipermail/mailman</a> vous avez accès aux archives.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_d_awstats">7.5. Configuration d' Awstats</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Configurer la tache cron d&#8217;awstats: Éditez le fichier :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/cron.d/awstats</code></pre>
</div>
</div>
</li>
<li>
<p>Et commentez toutes les lignes:</p>
<div class="listingblock">
<div class="content">
<pre>#MAILTO=root
#*/10 * * * * www-data [ -x /usr/share/awstats/tools/update.sh ] &amp;&amp; /usr/share/awstats/tools/update.sh
# Generate static reports:
#10 03 * * * www-data [ -x /usr/share/awstats/tools/buildstatic.sh ] &amp;&amp; /usr/share/awstats/tools/buildstatic.sh</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_de_fail2ban">7.6. Configuration de Fail2ban</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Editez le fichier jail.local :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/fail2ban/jail.local</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ajoutez les lignes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[dovecot]</span>
<span class="tok-na">enabled</span> <span class="tok-o">=</span> <span class="tok-s">true</span>
<span class="tok-na">filter</span> <span class="tok-o">=</span> <span class="tok-s">dovecot</span>
<span class="tok-na">logpath</span> <span class="tok-o">=</span> <span class="tok-s">/var/log/mail.log</span>
<span class="tok-na">maxretry</span> <span class="tok-o">=</span> <span class="tok-s">5</span>

<span class="tok-k">[postfix-sasl]</span>
<span class="tok-na">enabled</span> <span class="tok-o">=</span> <span class="tok-s">true</span>
<span class="tok-na">port</span> <span class="tok-o">=</span> <span class="tok-s">smtp</span>
<span class="tok-na">filter</span> <span class="tok-o">=</span> <span class="tok-s">postfix[mode=auth]</span>
<span class="tok-na">logpath</span> <span class="tok-o">=</span> <span class="tok-s">/var/log/mail.log</span>
<span class="tok-na">maxretry</span> <span class="tok-o">=</span> <span class="tok-s">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez Fail2ban: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart fail2ban</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_pureftpd">7.7. Installation et configuration de PureFTPd</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install pure-ftpd-common pure-ftpd-mysql</code></pre>
</div>
</div>
</li>
<li>
<p>Éditez le fichier de conf: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/default/pure-ftpd-common</code></pre>
</div>
</div>
</li>
<li>
<p>Changez les lignes ainsi:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">STANDALONE_OR_INETD</span><span class="tok-o">=</span><span class="tok-s">standalone</span>
<span class="tok-na">VIRTUALCHROOT</span><span class="tok-o">=</span><span class="tok-s">true</span></code></pre>
</div>
</div>
</li>
<li>
<p>Autorisez les connexions TLS. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-m">1</span> &gt; /etc/pure-ftpd/conf/TLS</code></pre>
</div>
</div>
</li>
<li>
<p>Créez un certificat SSL.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /etc/ssl/private/</code></pre>
</div>
</div>
</li>
<li>
<p>Puis créez le certificat auto signé. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>openssl req -x509 -nodes -days <span class="tok-m">7300</span> -newkey rsa:2048 -keyout /etc/ssl/private/pure-ftpd.pem -out /etc/ssl/private/pure-ftpd.pem</code></pre>
</div>
</div>
<div class="paragraph">
<p>et répondez aux questions de la manière suivante:</p>
</div>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p><code>Country Name (2 letter code) [AU]:</code> &#8592; Entrez le code pays à 2 lettres</p>
</li>
<li>
<p><code>State or Province Name (full name) [Some-State]:</code> &#8592; Entrer le nom d&#8217;état</p>
</li>
<li>
<p><code>Locality Name (eg, city) []:</code> &#8592; Entrer votre ville</p>
</li>
<li>
<p><code>Organization Name (eg, company) [Internet Widgits Pty Ltd]:</code> &#8592; Entrez votre entreprise ou tapez entrée</p>
</li>
<li>
<p><code>Organizational Unit Name (eg, section) []:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Common Name (e.g. server FQDN or YOUR name) []:</code> &#8592; Enter le nom d&#8217;hôte de votre serveur. Dans notre cas: <code>server1.example.com</code></p>
</li>
<li>
<p><code>Email Address []:</code> &#8592; Tapez entrée</p>
</li>
</ol>
</div>
</li>
<li>
<p>Puis tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">600</span> /etc/ssl/private/pure-ftpd.pem</code></pre>
</div>
</div>
</li>
<li>
<p>et redémarrez pure-ftpd en tapant: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart pure-ftpd-mysql</code></pre>
</div>
</div>
</li>
<li>
<p>En Option: Activer les quotas si votre kernel le permet.</p>
<div class="ulist">
<ul>
<li>
<p>Installez les paquets de gestion des quotas. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install quota quotatool</code></pre>
</div>
</div>
</li>
<li>
<p>Editez <code>fstab</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/fstab</code></pre>
</div>
</div>
</li>
<li>
<p>Inserez le texte ci dessous pour chaque directive de montage</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>UUID=45576b38-39e8-4994-b8c1-ea4870e2e614 / ext4 errors=remount-ro,usrjquota=quota.user,grpjquota=quota.group,jqfmt=vfsv0 0 1</code></pre>
</div>
</div>
</li>
<li>
<p>Pour une Raspbian:</p>
<div class="ulist">
<ul>
<li>
<p>Editez le fichier rc.local pour créer /dev/root à chaque reboot:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ln -s /dev/mmblk0p7 /dev/root
vi /etc/rc.local</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez avant <code>exit 0</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>ln -s /dev/mmcblk0p7 /dev/root</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Pour activer les quotas, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mount -o remount /
quotacheck -avugm
quotaon -avug</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_phpmyadmin">7.8. Installation et configuration de phpmyadmin</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>allez sur le site de <a href="https://www.phpmyadmin.net/downloads/">phpMyAdmin</a> et copier l&#8217;adresse du lien vers la dernière version de l&#8217;outil.</p>
</li>
<li>
<p>Installez phpmyadmin. Exécutez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir /usr/share/phpmyadmin
mkdir /etc/phpmyadmin
mkdir -p /var/lib/phpmyadmin/tmp
chown -R www-data:www-data /var/lib/phpmyadmin
touch /etc/phpmyadmin/htpasswd.setup
<span class="tok-nb">cd</span> /tmp
wget https://files.phpmyadmin.net/phpMyAdmin/5.0.2/phpMyAdmin-5.0.2-all-languages.tar.gz
tar xfz phpMyAdmin-5.0.2-all-languages.tar.gz
mv phpMyAdmin-5.0.2-all-languages/* /usr/share/phpmyadmin/
rm phpMyAdmin-5.0.2-all-languages.tar.gz
rm -rf phpMyAdmin-5.0.2-all-languages
cp /usr/share/phpmyadmin/config.sample.inc.php  /usr/share/phpmyadmin/config.inc.php</code></pre>
</div>
</div>
</li>
<li>
<p>Créez votre chaîne aléatoire en base64. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tr -dc A-Za-z0-9 &lt; /dev/urandom <span class="tok-p">|</span> head -c<span class="tok-si">${</span><span class="tok-nv">1</span><span class="tok-k">:-</span><span class="tok-nv">32</span><span class="tok-si">}</span><span class="tok-p">;</span>echo<span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Copiez le texte généré</p>
</li>
<li>
<p>Éditez le fichier :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/share/phpmyadmin/config.inc.php</code></pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Modifier l’entrée <code>blowfish_secret</code> en ajoutant votre propre chaîne de 32 caractères générée juste avant.</p>
</li>
<li>
<p>Éditez le fichier: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apache2/conf-available/phpmyadmin.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-c"># phpMyAdmin default Apache configuration</span>

<span class="tok-nb">Alias</span> <span class="tok-sx">/phpmyadmin</span> <span class="tok-sx">/usr/share/phpmyadmin</span>

<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/usr/share/phpmyadmin</span><span class="tok-nt">&gt;</span>
 <span class="tok-nb">Options</span> FollowSymLinks
 <span class="tok-nb">DirectoryIndex</span> index.php

 <span class="tok-nt">&lt;IfModule</span> <span class="tok-s">mod_php7.c</span><span class="tok-nt">&gt;</span>
 <span class="tok-nb">AddType</span> application/x-httpd-php .php

 <span class="tok-nb">php_flag</span> magic_quotes_gpc <span class="tok-k">Off</span>
 <span class="tok-nb">php_flag</span> track_vars <span class="tok-k">On</span>
 <span class="tok-nb">php_flag</span> register_globals <span class="tok-k">Off</span>
 <span class="tok-nb">php_value</span> include_path .
 <span class="tok-nt">&lt;/IfModule&gt;</span>

<span class="tok-nt">&lt;/Directory&gt;</span>

<span class="tok-c"># Authorize for setup</span>
<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/usr/share/phpmyadmin/setup</span><span class="tok-nt">&gt;</span>
 <span class="tok-nt">&lt;IfModule</span> <span class="tok-s">mod_authn_file.c</span><span class="tok-nt">&gt;</span>
 <span class="tok-nb">AuthType</span> Basic
 <span class="tok-nb">AuthName</span> <span class="tok-s2">&quot;phpMyAdmin Setup&quot;</span>
 <span class="tok-nb">AuthUserFile</span> <span class="tok-sx">/etc/phpmyadmin/htpasswd.setup</span>
 <span class="tok-nt">&lt;/IfModule&gt;</span>
 <span class="tok-nb">Require</span> valid-user
<span class="tok-nt">&lt;/Directory&gt;</span>

<span class="tok-c"># Disallow web access to directories that don&#39;t need it</span>
<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/usr/share/phpmyadmin/libraries</span><span class="tok-nt">&gt;</span>
 <span class="tok-nb">Order</span> Deny,Allow
 <span class="tok-nb">Deny</span> from <span class="tok-k">All</span>
<span class="tok-nt">&lt;/Directory&gt;</span>
<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/usr/share/phpmyadmin/setup/lib</span><span class="tok-nt">&gt;</span>
 <span class="tok-nb">Order</span> Deny,Allow
 <span class="tok-nb">Deny</span> from <span class="tok-k">All</span>
<span class="tok-nt">&lt;/Directory&gt;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Activez le module et redémarrez apache. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2enconf phpmyadmin
systemctl restart apache2</code></pre>
</div>
</div>
</li>
<li>
<p>Créer la base de donnée phpmyadmin.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql -u root -p</code></pre>
</div>
</div>
<div class="paragraph">
<p>puis entrer le mot de passe root</p>
</div>
</li>
<li>
<p>Créez une base phpmyadmin. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">CREATE</span> <span class="tok-k">DATABASE</span> <span class="tok-n">phpmyadmin</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Créez un utilisateur phpmyadmin. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">CREATE</span> <span class="tok-k">USER</span> <span class="tok-s1">&#39;pma&#39;</span><span class="tok-o">@</span><span class="tok-s1">&#39;localhost&#39;</span> <span class="tok-n">IDENTIFIED</span> <span class="tok-k">BY</span> <span class="tok-s1">&#39;mypassword&#39;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mypassword</code> doit être remplacé par <a href="#pass_gen">un mot de passe choisi.</a></td>
</tr>
</table>
</div>
</li>
<li>
<p>Accordez des privilèges et sauvez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-k">GRANT</span> <span class="tok-k">ALL</span> <span class="tok-k">PRIVILEGES</span> <span class="tok-k">ON</span> <span class="tok-n">phpmyadmin</span><span class="tok-p">.</span><span class="tok-o">*</span> <span class="tok-k">TO</span> <span class="tok-s1">&#39;pma&#39;</span><span class="tok-o">@</span><span class="tok-s1">&#39;localhost&#39;</span> <span class="tok-n">IDENTIFIED</span> <span class="tok-k">BY</span> <span class="tok-s1">&#39;mypassword&#39;</span> <span class="tok-k">WITH</span> <span class="tok-k">GRANT</span> <span class="tok-k">OPTION</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>mypassword</code> doit être remplacé par le mot de passe choisi plus haut.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Flusher les privilèges:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-n">FLUSH</span> <span class="tok-k">PRIVILEGES</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>et enfin</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="sql"><span></span><span class="tok-n">EXIT</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Chargez les tables sql dans la base phpmyadmin:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql -u root -p phpmyadmin &lt; /usr/share/phpmyadmin/sql/create_tables.sql</code></pre>
</div>
</div>
</li>
<li>
<p>Enfin ajoutez les mots de passe nécessaires dans le fichier de config.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/share/phpmyadmin/config.inc.php</code></pre>
</div>
</div>
</li>
<li>
<p>Rechercher le texte contenant <code>controlhost</code> .  Ci-dessous, un exemple:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-cm">/* User used to manipulate with storage */</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;controlhost&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;localhost&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;controlport&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;controluser&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;controlpass&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;mypassword&#39;</span><span class="tok-p">;</span> <i class="conum" data-value="1"></i><b>(1)</b>


<span class="tok-cm">/* Storage database and tables */</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;pmadb&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;phpmyadmin&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;bookmarktable&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__bookmark&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;relation&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__relation&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;table_info&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__table_info&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;table_coords&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__table_coords&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;pdf_pages&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__pdf_pages&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;column_info&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__column_info&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;history&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__history&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;table_uiprefs&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__table_uiprefs&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;tracking&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__tracking&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;userconfig&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__userconfig&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;recent&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__recent&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;favorite&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__favorite&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;users&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__users&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;usergroups&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__usergroups&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;navigationhiding&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__navigationhiding&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;savedsearches&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__savedsearches&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;central_columns&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__central_columns&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;designer_settings&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__designer_settings&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$cfg</span><span class="tok-p">[</span><span class="tok-s1">&#39;Servers&#39;</span><span class="tok-p">][</span><span class="tok-nv">$i</span><span class="tok-p">][</span><span class="tok-s1">&#39;export_templates&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;pma__export_templates&#39;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>A tous les endroit ou vous voyez dans le texte ci dessus le mot <code>mypassword</code> mettez celui choisi. N&#8217;oubliez pas de dé-commenter les lignes.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_du_webmail_roundcube">7.9. Installation du webmail Roundcube</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install roundcube roundcube-core roundcube-mysql roundcube-plugins</code></pre>
</div>
</div>
</li>
<li>
<p>Répondez aux question</p>
<div class="ulist">
<ul>
<li>
<p><code>Utiliser dbconfig_common</code> &#8592; Répondre <code>Oui</code></p>
</li>
<li>
<p><code>Mot de passe Mysql pour db Roundcube</code> &#8592; Tapez un mot de passe</p>
</li>
</ul>
</div>
</li>
<li>
<p>Éditez le fichier php de roundcube: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/roundcube/config.inc.php</code></pre>
</div>
</div>
<div class="paragraph">
<p>et définissez les hosts par défaut comme localhost</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="php"><span></span><span class="tok-nv">$config</span><span class="tok-p">[</span><span class="tok-s1">&#39;default_host&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;localhost&#39;</span><span class="tok-p">;</span>
<span class="tok-nv">$config</span><span class="tok-p">[</span><span class="tok-s1">&#39;smtp_server&#39;</span><span class="tok-p">]</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;localhost&#39;</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Éditez la configuration apache pour roundcube: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apache2/conf-enabled/roundcube.conf</code></pre>
</div>
</div>
<div class="paragraph">
<p>et ajouter au début les lignes suivantes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nb">Alias</span> <span class="tok-sx">/roundcube</span> <span class="tok-sx">/var/lib/roundcube</span>
<span class="tok-nb">Alias</span> <span class="tok-sx">/webmail</span> <span class="tok-sx">/var/lib/roundcube</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez Apache:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl reload apache2</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_lets_encrypt">7.10. Installation de Let&#8217;s Encrypt</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez Let&#8217;s Encrypt. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /usr/local/bin
wget https://dl.eff.org/certbot-auto
chmod a+x certbot-auto
./certbot-auto --install-only</code></pre>
</div>
</div>
</li>
<li>
<p>Une façon alternative de l&#8217;installer est:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install python3-certbot-apache</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_dun_scanner_de_vulnérabilités_lynis">7.11. Installation d&#8217;un scanner de vulnérabilités Lynis</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>installer Git. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install git</code></pre>
</div>
</div>
</li>
<li>
<p>installer Lynis</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span>
git clone https://github.com/CISOfy/lynis</code></pre>
</div>
</div>
</li>
<li>
<p>Executez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> lynis<span class="tok-p">;</span>./lynis audit system</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>L&#8217;outil vous listera dans une forme très synthétique la liste des vulnérabilités et des améliorations de sécurité à appliquer.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_dun_panel">8. Installation d&#8217;un Panel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Il existe plusieurs type de panel de contrôle pour les VPS. La plupart sont payant.</p>
</div>
<div class="paragraph">
<p>Pour citer les plus connus:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>payant: cPanel (leader du type), Plesk</p>
</li>
<li>
<p>gratuit: Yunohost ( un excellent système d&#8217;autohébergement packagé) , Ajenti, Froxlor, Centos web panel, Webmin et Usermin, ISPConfig, HestiaCP, VestaCP ,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ci après nous allons en présenter 3 différents (ISPConfig, Webmin et HestiaCP). Ils sont incompatibles entre eux.</p>
</div>
<div class="paragraph">
<p>On peut faire cohabiter ISPConfig et Webmin en prenant les précautions suivantes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ISPConfig est le maitre de la configuration: toute modification sur les sites webs, mailboxes et DNS doit impérativement être effectuées du coté d&#8217;ISPConfig</p>
</li>
<li>
<p>Les modifications réalisées au niveau de webmin pour ces sites webs, mailboxes et DNS seront au mieux écrasées par ISPConfig au pire elles risquent de conduire à des incompatibilités qui engendreront des dysfonctionnement d&#8217;ISPConfig (impossibilité de mettre à jour les configurations)</p>
</li>
<li>
<p>Le reste des modifications peuvent être configurées au niveau de webmin sans trop de contraintes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour rappel, HestiaCP (tout comme VestaCP) sont incompatibles d&#8217;ISPConfig et de Webmin. Ils doivent être utilisés seuls</p>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_ispconfig">8.1. Installation et configuration de ISPConfig</h3>
<div class="paragraph">
<p>ISPConfig est un système de configuration de sites web totalement compatible avec Webmin.</p>
</div>
<div class="paragraph">
<p>Pour installer ISPConfig, vous devez suivre la procédure ci-dessous. ISPConfig 3.2 a été utilisé dans ce tutoriel.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /tmp</code></pre>
</div>
</div>
</li>
<li>
<p>Cherchez la dernière version d&#8217;ISPConfig sur le site <a href="https://www.ispconfig.org/ispconfig/download/">ISPConfig</a></p>
</li>
<li>
<p>Installez cette version en tapant: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>wget &lt;la_version_a_telecharger&gt;.tar.gz</code></pre>
</div>
</div>
</li>
<li>
<p>Décompressez la version en tapant: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tar xfz &lt;la_version&gt;.tar.gz</code></pre>
</div>
</div>
</li>
<li>
<p>Enfin allez dans le répertoire d&#8217;installation: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> ispconfig3_install/install/</code></pre>
</div>
</div>
</li>
<li>
<p>Lancez l&#8217;installation: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>php -q install.php</code></pre>
</div>
</div>
<div class="paragraph">
<p>et répondez aux questions:</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Select language (en,de) [en]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Installation mode (standard,expert) [standard]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Full qualified hostname (FQDN) of the server, eg server1.domain.tld [server1.example.com]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>MySQL server hostname [localhost]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>MySQL server port [3306]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>MySQL root username [root]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>MySQL root password []:</code> &#8592; Enter your MySQL root password</p>
</li>
<li>
<p><code>MySQL database to create [dbispconfig]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>MySQL charset [utf8]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Country Name (2 letter code) [AU]:</code> &#8592; Entrez le code pays à 2 lettres</p>
</li>
<li>
<p><code>State or Province Name (full name) [Some-State]:</code> &#8592; Entrer le nom d&#8217;état</p>
</li>
<li>
<p><code>Locality Name (eg, city) []:</code> &#8592; Entrer votre ville</p>
</li>
<li>
<p><code>Organization Name (eg, company) [Internet Widgits Pty Ltd]:</code> &#8592; Entrez votre entreprise ou tapez entrée</p>
</li>
<li>
<p><code>Organizational Unit Name (eg, section) []:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Common Name (e.g. server FQDN or YOUR name) []:</code> &#8592; Enter le nom d&#8217;hôte de votre serveur. Dans notre cas: <code>server1.example.com</code></p>
</li>
<li>
<p><code>Email Address []:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>ISPConfig Port [8080]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Admin password [admin]:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Do you want a secure (SSL) connection to the ISPConfig web interface (y,n) [y]:</code> &#8592;- Tapez entrée</p>
</li>
<li>
<p><code>Country Name (2 letter code) [AU]:</code> &#8592; Entrez le code pays à 2 lettres</p>
</li>
<li>
<p><code>State or Province Name (full name) [Some-State]:</code> &#8592; Entrer le nom d&#8217;état</p>
</li>
<li>
<p><code>Locality Name (eg, city) []:</code> &#8592; Entrer votre ville</p>
</li>
<li>
<p><code>Organization Name (eg, company) [Internet Widgits Pty Ltd]:</code> &#8592; Entrez votre entreprise ou tapez entrée</p>
</li>
<li>
<p><code>Organizational Unit Name (eg, section) []:</code> &#8592; Tapez entrée</p>
</li>
<li>
<p><code>Common Name (e.g. server FQDN or YOUR name) []:</code> &#8592; Enter le nom d&#8217;hôte de votre serveur. Dans notre cas: <code>server1.example.com</code></p>
</li>
<li>
<p><code>Email Address []:</code> &#8592; Tapez entrée</p>
</li>
</ol>
</div>
</li>
<li>
<p>L&#8217;installation est terminée. Vous accédez au serveur à l&#8217;adresse: <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a> .</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Lors de votre première connexion, votre domaine n&#8217;est pas encore configuré. Il faudra alors utiliser le nom DNS donné par votre hébergeur. Pour OVH, elle s&#8217;écrit <code>VPSxxxxxx.ovh.net</code>.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Loguez vous comme admin et avec le mot de passe que vous avez choisi. Vous pouvez décider de le changer au premier login</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si le message "Possible attack detected. This action has been logged.". Cela signifie que vous avez des cookies d&#8217;une précédente installation qui sont configurés. Effacer les cookies de ce site de votre navigateur.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_du_système_dadministration_webmin">8.2. Installation du système d&#8217;administration Webmin</h3>
<div class="paragraph">
<p>Webmin est un outil généraliste de configuration de votre serveur. Son usage peut être assez complexe mais il permet une configuration plus précise des fonctionnalités.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajoutez le repository Webmin</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>allez dans le répertoire des repositories. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc/apt/sources.list.d</code></pre>
</div>
</div>
</li>
<li>
<p>Tapez: :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;deb http://download.webmin.com/download/repository sarge contrib&quot;</span> &gt;&gt; webmin.list</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez la clé. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl -fsSL http://www.webmin.com/jcameron-key.asc <span class="tok-p">|</span> sudo apt-key add -</code></pre>
</div>
</div>
<div class="paragraph">
<p>Le message <code>OK</code> s&#8217;affiche</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Mise à jour. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update</code></pre>
</div>
</div>
</li>
<li>
<p>Installation de Webmin. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install webmin</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Débloquez le port 10000 dans votre firewall</pre>
</div>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://&lt;example.com&gt;:8080/" class="bare">https://&lt;example.com&gt;:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 10000</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Connectez vous avec votre navigateur sur l&#8217;url <a href="https://&lt;example.com&gt;:10000" class="bare">https://&lt;example.com&gt;:10000</a>. Un message indique un problème de sécurité. Cela vient du certificat auto-signé. Cliquez sur 'Avancé' puis 'Accepter le risque et poursuivre'.</p>
</li>
<li>
<p>Loguez-vous <code>root</code>. Tapez le mot de passe de <code>root</code>. Le dashboard s&#8217;affiche.</p>
</li>
<li>
<p>Restreignez l&#8217;adressage IP</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Obtenez votre adresse IP en allant par exemples sur le site <a href="https://www.showmyip.com/" class="bare">https://www.showmyip.com/</a></p>
</li>
<li>
<p>Sur votre URL Webmin ou vous êtes logué, allez dans Webmin&#8594;Webmin Configuration</p>
</li>
<li>
<p>Dans l&#8217;écran choisir l’icône <code>Ip Access Control</code>.</p>
</li>
<li>
<p>Choisissez <code>Only allow from listed addresses</code></p>
</li>
<li>
<p>Puis dans le champ <code>Allowed IP addresses</code> tapez votre adresse IP récupérée sur showmyip</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
<li>
<p>Vous devriez avoir une brève déconnexion le temps que le serveur Webmin redémarre puis une reconnexion.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Si vous n&#8217;arrivez pas à vous reconnecter c&#8217;est que l&#8217;adresse IP n&#8217;est pas la bonne. Le seul moyen de se reconnecter est de:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Éditez le fichier /etc/webmin/miniserv.conf et supprimez la ligne <code>allow= &#8230;&#8203;</code></p>
</li>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service webmin restart</code></pre>
</div>
</div>
</li>
<li>
<p>Connectez vous sur l&#8217;url de votre site Webmin. Tout doit fonctionner</p>
</li>
</ol>
</div>
</li>
<li>
<p>Compléments de configuration</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Pour augmenter la sécurité, vous pouvez désactiver le login <code>root</code> et creer un autre compte admin en allant dans: <code>Webmin</code> &#8594; <code>Webmin Users</code> &#8594; <code>Create a new privileged user</code>. Pour le user <code>root</code>, modifier le <code>Password</code> en mettant <code>No password accepted</code></p>
</li>
<li>
<p>Allez dans <code>Webmin</code> &#8594; <code>Webmin Configuration</code> &#8594; <code>SSL Encryption</code> &#8594; onglet <code>Let&#8217;s Encrypt</code> &#8594; <code>Request Certificate</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Passez en Français. Pour les personnes non anglophone. Les traductions française ont des problèmes d&#8217;encodage de caractère ce n&#8217;est donc pas recommandé. La suite de mon tutoriel suppose que vous êtes resté en anglais.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Sur votre url Webmin ou vous êtes logué, allez dans Webmin&#8594;Webmin Configuration</p>
</li>
<li>
<p>Dans l&#8217;écran choisir l’icône <code>Language and Locale</code>.</p>
</li>
<li>
<p>Choisir <code>Display Language</code> à <code>French (FR.UTF-8)</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="domain-config">9. Configuration d&#8217;un domaine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cette configuration est réalisée avec le Panel ISPConfig installé dans le chapitre précédent.
L&#8217;étape "login initial" n&#8217;est à appliquer qu&#8217;une seule fois. Une fois votre premier domaine configuré, vous pourrez vous loguer à ISPconfig en utilisant ce domaine à l&#8217;adresse: <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a> .</p>
</div>
<div class="sect2">
<h3 id="_login_initial">9.1. Login initial</h3>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Cette procédure n&#8217;est à appliquer que lorsqu&#8217;aucun domaine n&#8217;est encore créé.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vous devrez tout d&#8217;abord vous loguer sur le serveur ISPConfig.
Comme vous n&#8217;avez pas encore configuré de nom de de domaine, vous devrez vous loguer de prime abord sur le site <a href="http://vpsxxxxxx.ovh.net:8080/" class="bare">http://vpsxxxxxx.ovh.net:8080/</a> pour un vps chez ovh par exemple ou sur <a href="http://raspberrypi.local:8080/" class="bare">http://raspberrypi.local:8080/</a> pour un Raspberry.</p>
</div>
<div class="paragraph">
<p>Utiliser le login: Admin et le mot de passe que vous avez configuré lors de l&#8217;installation d&#8217;ISPConfig</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Aller dans la rubrique <code>System</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Dans le menu <code>Main config</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Dans l’onglet <code>Sites</code>, configurer:</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p><code>Create subdomains as web site:</code> &#8592; Yes</p>
</li>
<li>
<p><code>Create aliasdomains as web site:</code> &#8592; Yes</p>
</li>
</ol>
</div>
</li>
<li>
<p>Dans l&#8217;onglet <code>Mail</code> :</p>
<div class="olist upperalpha">
<ol class="upperalpha" type="A">
<li>
<p><code>Administrator&#8217;s e-mail :</code> &#8592; adresse mail de l’administrateur. par exemple <a href="mailto:admin@example.com">admin@example.com</a></p>
</li>
<li>
<p><code>Administrator&#8217;s name :</code> &#8592; nom de l’administrateur</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Dans le menu <code>Firewall</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add Firewall Record</code></p>
</li>
<li>
<p>Acceptez les valeurs par défaut en cliquant sur <code>Save</code></p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Il est possible de basculer le site ISPConfig entièrement en Français. J&#8217;ai pour ma part gardé la version anglaise du site.
Vous trouverez donc tous les libellés dans la suite de la documentation en anglais.
</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Aller dans la rubrique <code>DNS</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Dans le menu <code>Template</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new record</code></p>
</li>
<li>
<p>Remplissez les champs comme ci-après:</p>
<div class="ulist">
<ul>
<li>
<p><code>Name</code> &#8592; Tapez <code>Template IPV4 autoNS</code></p>
</li>
<li>
<p><code>Fields</code> &#8592; Cochez <code>Domain</code>, <code>IP Address</code>, <code>Email</code>, <code>DKIM</code>, <code>DNSSEC</code></p>
</li>
<li>
<p><code>Template</code> &#8592; remplissez comme ci dessous:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">[</span>ZONE<span class="tok-o">]</span>
<span class="tok-nv">origin</span><span class="tok-o">={</span>DOMAIN<span class="tok-o">}</span>.
<span class="tok-nv">ns</span><span class="tok-o">=</span>ns1.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.
<span class="tok-nv">mbox</span><span class="tok-o">={</span>EMAIL<span class="tok-o">}</span>.
<span class="tok-nv">refresh</span><span class="tok-o">=</span><span class="tok-m">7200</span>
<span class="tok-nv">retry</span><span class="tok-o">=</span><span class="tok-m">540</span>
<span class="tok-nv">expire</span><span class="tok-o">=</span><span class="tok-m">604800</span>
<span class="tok-nv">minimum</span><span class="tok-o">=</span><span class="tok-m">3600</span>
<span class="tok-nv">ttl</span><span class="tok-o">=</span><span class="tok-m">3600</span>

<span class="tok-o">[</span>DNS_RECORDS<span class="tok-o">]</span>
A<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>www<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>mail<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>autoconfig<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>autodiscover<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>webmail<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>ns1<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>ftp<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>smtp<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>pop3<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>imap<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_pop3._tcp<span class="tok-p">|</span><span class="tok-m">0</span> <span class="tok-m">0</span> .<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_imap._tcp<span class="tok-p">|</span><span class="tok-m">0</span> <span class="tok-m">0</span> .<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_pop3s._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">995</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_imaps._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">993</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_submission._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">465</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_autodiscover._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">443</span> autodiscover.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
NS<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span>ns1.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
MX<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span>mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-m">10</span><span class="tok-p">|</span><span class="tok-m">3600</span>
TXT<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-nv">v</span><span class="tok-o">=</span>spf1 mx a ~all<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new record</code></p>
</li>
<li>
<p>Remplissez les champs comme ci-après:</p>
<div class="ulist">
<ul>
<li>
<p><code>Name</code> &#8592; Tapez <code>Template IPV6 autoNS</code></p>
</li>
<li>
<p><code>Fields</code> &#8592; Cochez <code>Domain</code>, <code>IP Address</code>, <code>IPV6 Address</code>, <code>Email</code>, <code>DKIM</code>, <code>DNSSEC</code></p>
</li>
<li>
<p><code>Template</code> &#8592; remplissez comme ci dessous:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-o">[</span>ZONE<span class="tok-o">]</span>
<span class="tok-nv">origin</span><span class="tok-o">={</span>DOMAIN<span class="tok-o">}</span>.
<span class="tok-nv">ns</span><span class="tok-o">=</span>ns1.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.
<span class="tok-nv">mbox</span><span class="tok-o">={</span>EMAIL<span class="tok-o">}</span>.
<span class="tok-nv">refresh</span><span class="tok-o">=</span><span class="tok-m">7200</span>
<span class="tok-nv">retry</span><span class="tok-o">=</span><span class="tok-m">540</span>
<span class="tok-nv">expire</span><span class="tok-o">=</span><span class="tok-m">604800</span>
<span class="tok-nv">minimum</span><span class="tok-o">=</span><span class="tok-m">3600</span>
<span class="tok-nv">ttl</span><span class="tok-o">=</span><span class="tok-m">3600</span>

<span class="tok-o">[</span>DNS_RECORDS<span class="tok-o">]</span>
A<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>www<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>mail<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>autoconfig<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>autodiscover<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>webmail<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
A<span class="tok-p">|</span>ns1<span class="tok-p">|</span><span class="tok-o">{</span>IP<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>www<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>mail<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>autoconfig<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>autodiscover<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>webmail<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
AAAA<span class="tok-p">|</span>ns1<span class="tok-p">|</span><span class="tok-o">{</span>IPV6<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>ftp<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>smtp<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>pop3<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
CNAME<span class="tok-p">|</span>imap<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_pop3._tcp<span class="tok-p">|</span><span class="tok-m">0</span> <span class="tok-m">0</span> .<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_imap._tcp<span class="tok-p">|</span><span class="tok-m">0</span> <span class="tok-m">0</span> .<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_pop3s._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">995</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_imaps._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">993</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_submission._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">465</span> mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
SRV<span class="tok-p">|</span>_autodiscover._tcp<span class="tok-p">|</span><span class="tok-m">1</span> <span class="tok-m">443</span> autodiscover.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span><span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
NS<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span>ns1.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span>
MX<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span>mail.<span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-m">10</span><span class="tok-p">|</span><span class="tok-m">3600</span>
TXT<span class="tok-p">|</span><span class="tok-o">{</span>DOMAIN<span class="tok-o">}</span>.<span class="tok-p">|</span><span class="tok-nv">v</span><span class="tok-o">=</span>spf1 mx a ~all<span class="tok-p">|</span><span class="tok-m">0</span><span class="tok-p">|</span><span class="tok-m">3600</span></code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_la_zone_dns_dun_domaine">9.2. Création de la zone DNS d&#8217;un domaine</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans <code>DNS</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>Add dns-zone</code></p>
</li>
<li>
<p>Cliquez sur <code>Dns zone wizard</code></p>
</li>
<li>
<p>Choisir le template <code>IPV4 autoNS</code> ou`IPV6 autoNS` selon que vous soyez IPV4 ou IPV4+V6</p>
</li>
<li>
<p>Remplissez les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Domain :</code> &#8592; tapez le nom de votre domaine <code>example.com</code></p>
</li>
<li>
<p><code>IP Address:</code> &#8592; prendre l’adresse IPV4 du serveur sélectionnée</p>
</li>
<li>
<p><code>IPV6 Address:</code> &#8592; prendre l’adresse IPV6 du serveur sélectionnée</p>
</li>
<li>
<p><code>Email:</code> &#8592; votre Email valide exemple <code>admin@example.com</code></p>
</li>
<li>
<p><code>DKIM:</code> &#8592; Yes</p>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Si votre serveur est chez vous, il est probablement installé derrière un routeur ADSL configuré au préalable avec une DMZ qui pointe sur ce serveur. Dans ce cas, vous ne devrez pas indiquer l&#8217;adresse IP locale de votre serveur mais l&#8217;adresse IP de votre routeur ADSL telle qu&#8217;elle est vue sur internet. On suppose aussi que cette adresse IP est statique et non pas allouée dynamiquement par l&#8217;opérateur.
</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Create DNS-record</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Attendez quelques minutes le temps que les enregistrements DNS se propagent et faites une essai de votre nom de domaine sur le site <a href="https://zonemaster.fr/domain_check">ZoneMaster</a>.</p>
</div>
<div class="paragraph">
<p>Dans le champ Nom de domaine saisissez votre nom de domaine et tapez sur check. Tout doit est OK sauf pour les serveurs de noms ns1 et ns2. Si ce n&#8217;est pas le cas, votre nom de domaine doit être mal configuré chez votre registrar. Il vous faut vérifier la configuration initiale.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Zonemaster a bien repéré que l&#8217;on a essayé de mettre des noms de host différents pour les serveurs de DNS. Ils ont cependant tous la même adresse IP. Cela apparait comme une erreur suite au test.
De la même manière, il indique dans la rubrique connectivité qu&#8217;il n&#8217;y a pas de redondance de serveur DNS.
Une manière de corriger ce problème est de définir un DNS secondaire chez OVH en utilisant le service qu&#8217;ils mettent à disposition.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Vous pouvez maintenant essayer les différents Hostname munis de leur nom de domaine dans votre navigateur. Par exemple: <a href="http://webmail.example.com" class="bare">http://webmail.example.com</a></p>
</div>
<div class="paragraph">
<p>Ils doivent afficher une page web basique (Apache2, ou de parking).Si ce n&#8217;est pas le cas revérifier la configuration du DNS dans ISPConfig.</p>
</div>
</div>
<div class="sect2">
<h3 id="_activation_de_dnssec">9.3. Activation de DNSSEC</h3>
<div class="paragraph">
<p>Vous pouvez maintenant activer DNSSEC afin d&#8217;augmenter la sécurité de résolution de nom de domaine:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>puis dans le menu <code>Zones</code></p>
</li>
<li>
<p>choisissez la zone correspondant à votre domaine</p>
</li>
<li>
<p>dans l&#8217;onglet <code>DNS Zone</code> allez tout en bas et activer la coche <code>Sign Zone (DNSSEC)</code></p>
</li>
<li>
<p>cliquez sur <code>Save</code></p>
</li>
<li>
<p>Une fois fait, retourner dans le même onglet. La boite `DNSSEC DS-Data for registry: `contient les informations que vous devez coller dans le site web de votre registrar pour sécuriser votre zone.</p>
</li>
<li>
<p>Gardez cette fenêtre ouverte dans votre navigateur et ouvrez un autre onglet sur le site de votre registrar.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Si vous êtes chez <a href="https://admin.gandi.net/">Gandi</a>, il vous faut:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Sélectionner le menu <code>nom de domaine</code></p>
</li>
<li>
<p>Choisir votre nom de domaine "example.com"</p>
</li>
<li>
<p>Allez dans l&#8217;onglet DNSSEC. Il doit permettre d&#8217;ajouter des clés puisque vous fonctionner avec des DNS externes.</p>
</li>
<li>
<p>Effacez éventuellement toutes les clés si vous n&#8217;êtes pas sur de celles-ci.</p>
</li>
<li>
<p>puis cliquez sur <code>Ajouter une clé externe</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Sélectionnez d&#8217;abord le flag <code>257 (KSK)</code>. puis l&#8217;algorithme <code>7 (RSASHA1-NSEC3-SHA1)</code></p>
</li>
<li>
<p>Collez ensuite la clé de votre site ISPConfig. Elle doit ressembler à cela:</p>
<div class="listingblock">
<div class="content">
<pre>example.com. IN DNSKEY 257 3 7 AwEAAcs+xTC5GlyC8CSufM9U7z5uazLNmNP3vG2txzNIGM1VJHWCpRYQVZjsBZqx5vZuOFBwp0F6cpF8YdW9QibZc82UAeIYAstgRSwnCLYsIV+3Zq0NpCcnGTkPLknxxZuN3MD5tARkxBM5c5fME0NgMU+kcx4xaTVm2Go6bEeFuhgNfRogzXKqLV6h2bMCajudfJbbTbJlehym2YegLI+yYCpYr6b+jWHorRoUVDJ41OPXLtz2s8wtycyINpZsdmLNJhNNaeGqOok3+c5uazLNmNP3vG2txzNIGLM1VJHWCpRYQVZjsBZkqx5vZuOFBgwp0F6cpF8YdW9QbZc82UAeIYAstKgRSwnCLYsIV+3Zq0NpCcnGTkPLkn</pre>
</div>
</div>
</li>
<li>
<p>Cliquez sur <code>Ajouter</code></p>
</li>
<li>
<p>Entrez la deuxième clé. Cliquez sur <code>Ajouter une clé externe</code></p>
</li>
<li>
<p>Sélectionnez d&#8217;abord le flag <code>256 (ZSK)</code>. puis l&#8217;algorithme <code>7 (RSASHA1-NSEC3-SHA1)</code></p>
</li>
<li>
<p>Collez ensuite la clé de votre site ISPConfig. Elle doit ressembler à cela:</p>
<div class="listingblock">
<div class="content">
<pre>example.com. IN DNSKEY 256 3 7 AwEAAcs+xTC5GlyC8CSufM9U7z5uazLNmNP3vG2txzNIGM1VJHWCpRYQVZjsBZqx5vZuOFBwp0F6cpF8YdW9QibZc82UAeIYAstgRSwnCLYsIV+3Zq0NpCcnGTkPLknxxZuN3MD5tARkxBM5c5fME0NgMU+kcx4xaTVm2Go6bEeFuhgNfRogzXKqLV6h2bMCajudfJbbTbJlehym2YegLI+yYCpYr6b+jWHorRoUVDJ41OPXLtz2s8wtycyINpZsdmLNJhNNaeGqOok3+c5uazLNmNP3vG2txzNIGLM1VJHWCpRYQVZjsBZkqx5vZuOFBgwp0F6cpF8YdW9QbZc82UAeIYAstKgRSwnCLYsIV+3Zq0NpCcnGTkPLkn</pre>
</div>
</div>
</li>
<li>
<p>Cliquez sur <code>Ajouter</code></p>
</li>
<li>
<p>Les deux clés doivent maintenant apparaître dans l&#8217;onglet <code>DNSSEC</code></p>
</li>
<li>
<p>Vous devez attendre quelques minutes (une heure dans certains cas) pour que les clés se propagent. Pendant ce temps vous pouvez avoir quelques problèmes d&#8217;accès à vos sites webs</p>
</li>
<li>
<p>Allez sur le site <a href="https://dnssec-debugger.verisignlabs.com/">DNSSEC Analyzer</a>.</p>
</li>
<li>
<p>Entrez votre nom de domaine "example.com" et tapez sur "entrée".</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le site doit afficher pour les différentes zones le statut des certificats. Tout doit être au vert.
Si ce n&#8217;est pas le cas, réessayer dans une heure. S&#8217;il y a encore des problèmes vérifiez votre configuration dans ISPConfig, chez votre registrar (rubrique DNSSEC) ou regardez les logs d&#8217;ISPConfig sur votre serveur pour y débusquer une erreur.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Une erreur classique est de croiser les certificats avec leurs types. Vérifiez bien que vous avez mis les bons certificats avec les bons types.
</td>
</tr>
</table>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Une fois que vous activez DNSSEC, vous pourriez faire face au problème suivant: les nouveaux enregistrements que vous renseignez ne sont pas actifs.
Une analyse des logs montre que la commande <code>dnssec-signzone</code> retourne l&#8217;erreur <code>fatal: 'example.com': found DS RRset without NS RRset</code>.
Cela signifie que vous avez saisi une ou deux entrées DS dans vos enregistrements. Il faut les supprimer pour que tout redevienne fonctionnel.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_exemple_de_configuration_de_domaine">9.4. Exemple de configuration de domaine</h3>
<div class="paragraph">
<p>Une fois la configuration terminé, les différents enregistrements du domaines ressemblent à l&#8217;exemple ci-dessous.
Il peut y avoir des enregistrements supplémentaires pour les configurations SPF, DKIM et Let&#8217;s encrypt.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>example.com.         3600 A              1.2.3.4
www                  3600 A              1.2.3.4
mail                 3600 A              1.2.3.4
ns1                  3600 A              1.2.3.4
ns2                  3600 A              1.2.3.4
webmail              3600 A              1.2.3.4
autoconfig           3600 A              1.2.3.4
autodiscover         3600 A              1.2.3.4
ftp                  3600 CNAME          example.com.
smtp                 3600 CNAME          mail.example.com.
pop3                 3600 CNAME          mail.example.com.
imap                 3600 CNAME          mail.example.com.
example.com.         3600 NS             ns1.example.com.
example.com.         3600 NS             ns2.example.com.
example.com.         3600 MX    10       mail.example.com.
_pop3s._tcp          3600 SRV   10 1 995 mail.example.com.
_imaps._tcp          3600 SRV   0  1 993 mail.example.com.
_submission._tcp     3600 SRV   0  1 465 mail.example.com.
_imap._tcp           3600 SRV   0  0 0   .
_pop3._tcp           3600 SRV   0  0 0   .
_autodiscover._tcp   3600 SRV   0 0 443  autoconfig.example.com.
example.com.         3600 TXT            "v=spf1 mx a ~all"</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_création_dun_sous_domaine">9.5. Création d&#8217;un sous domaine</h3>
<div class="paragraph">
<p>Supposons que vous êtes en train de créer un sous domain nommé <code>sub.example.com</code> .
Dans ce sous domaines vous allez créer un ensemble de site web par exemple <code>mail.sub.example.com</code> ou <code>blog.sub.example.com</code> .</p>
</div>
<div class="paragraph">
<p>Un cas assez classique est que ce sous domaine est délégué à une machine tierce.</p>
</div>
<div class="paragraph">
<p>Par exemple: <code>example.com</code> est installé sur un VPS quelque part sur internet et <code>sub.example.com</code> est hébergé chez vous sur votre Raspberry.</p>
</div>
<div class="paragraph">
<p>On suppose que votre domain a été configuré en suivant la procédure du chapitre précédent.</p>
</div>
<div class="paragraph">
<p>Rien de bien sorcier pour votre sous domaine: Vous devez le créer sur votre Raspberry selon la même procédure mais avec le nom du sous domaine ( <code>sub.example.com</code> donc).</p>
</div>
<div class="paragraph">
<p>Vous aurez des actions complémentaires à effectuer sur votre domaine:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans <code>DNS</code> de votre serveur de domaine principal</p>
</li>
<li>
<p>Sélectionner le menu <code>Zones</code> puis le domaine <code>example.com</code></p>
</li>
<li>
<p>Choisissez l&#8217;onglet <code>Records</code> et créez:</p>
<div class="ulist">
<ul>
<li>
<p>un enregistrement de type <code>NS</code> avec une <code>Zone</code> &#8592; <code>sub.example.com.</code> et un <code>nameserver Hostname</code> &#8592; <code>ns1.sub.example.com.</code></p>
</li>
<li>
<p>un enregistrement de type <code>NS</code> avec une <code>Zone</code> &#8592; <code>sub.example.com.</code> et un <code>nameserver Hostname</code> &#8592; <code>ns2.sub.example.com.</code></p>
</li>
<li>
<p>un enregistrement de type <code>NS</code> avec une <code>Zone</code> &#8592; <code>sub.example.com.</code> et un <code>nameserver Hostname</code> &#8592; <code>ns3.example.com.</code> .</p>
<div class="paragraph">
<p>Ce dernier type d&#8217;enregistrement se nomme un Glue record pour faire le lien vers le serveur secondaire.</p>
</div>
</li>
<li>
<p>un enregistrement de type <code>A</code> avec un <code>Hostname</code> &#8592; ns3 et une <code>IP-address</code> &#8592; Adresse IP de votre routeur ADSL ou est connecté le Raspberry.</p>
</li>
<li>
<p>Si vous ne la connaissez pas, tapez dans un terminal texte:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>wget -qO- http://ipecho.net/plain<span class="tok-p">;</span> <span class="tok-nb">echo</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ce dernier enregistrement en complétant le Glue record fait le lien avec l&#8217;adresse IP de <code>sub.example.com</code></p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Si vous avez activé DNSSEC sur votre serveur DNS de <code>sub.example.com</code> vous devrez récupérer les entrées DS du champ <code>DNSSEC DS-Data for registry</code> de votre domaine <code>sub.example.com</code> et créer dans votre domaine <code>example.com</code> les deux entrées suivantes:</p>
<div class="ulist">
<ul>
<li>
<p>un enregistrement de type <code>DS</code> avec une <code>Zone</code> &#8592; <code>sub.example.com.</code> et un champ <code>data</code> contenant <code>xxxxx 7 1 &lt;votre_digest_recupérée&gt;</code></p>
</li>
<li>
<p>un enregistrement de type <code>DS</code> avec une <code>Zone</code> &#8592; <code>sub.example.com.</code> et un champ <code>data</code> contenant <code>xxxxx 7 2 &lt;votre_digest_recupérée&gt;</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Allez sur le site <a href="https://dnssec-debugger.verisignlabs.com/">DNSSEC Analyzer</a>.</p>
</li>
<li>
<p>Entrez votre nom de domaine <code>sub.example.com</code> et tapez sur "entrée".</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Le site doit afficher pour les différentes zones le statut des certificats. Tout doit être au vert.
Si ce n&#8217;est pas le cas, réessayer dans une heure. S&#8217;il y a encore des problèmes vérifiez votre configuration dans ISPConfig de votre domaine et de votre sous-domaine, chez votre registrar (rubrique DNSSEC) ou regardez les logs d&#8217;ISPConfig sur votre serveur pour y débusquer une erreur.</p>
</div>
</div>
<div class="sect2">
<h3 id="domain-site">9.6. Création d’un site web</h3>
<div class="paragraph">
<p>Dans la suite le site web sera nommé <code>example.com</code>.</p>
</div>
<div class="paragraph">
<p>Vous devez avoir avant tout défini le "record" DNS associé au site.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Aller dans "Sites"</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu "Website" pour définir un site web</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur "Add new website"</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Client:</code> &#8592; laisser vide ou mettre le client que vous avez créé.</p>
</li>
<li>
<p><code>IPv4-Address:</code> &#8592; mettre <code>*</code>. Si vous mettez votre adresse IPV4 vous allez rencontrer quelques disfonctionnements.</p>
</li>
<li>
<p><code>Domain:</code> &#8592; mettre <code>example.com</code></p>
</li>
<li>
<p><code>Auto-subdomain:</code> &#8592; sélectionner <code>wwww</code> ou <code>*</code> si l’on veut un certificat let’s encrypt wildcard</p>
</li>
<li>
<p><code>SSL:</code> &#8592; yes</p>
</li>
<li>
<p><code>Let’s Encrypt:</code> &#8592; yes</p>
</li>
<li>
<p><code>Php:</code> &#8592; Sélectionez <code>php-fpm</code></p>
</li>
<li>
<p>Sélectionnez éventuellement aussi les coches <code>Perl</code>, <code>Python</code>, <code>Ruby</code> en fonction des technologies déployées sur votre site. Cela est indiqué dans la procédure d&#8217;installation du site.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l’onglet <code>redirect</code> du même écran</p>
<div class="ulist">
<ul>
<li>
<p><code>SEO Redirect:</code> &#8592; Sélectionner <code>domain.tld &#8658;www.domain.tld</code></p>
</li>
<li>
<p><code>Rewrite http to https:</code> &#8592; yes</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l’onglet <code>Statistics</code> du même écran</p>
<div class="ulist">
<ul>
<li>
<p><code>Set Webstatistics password:</code> &#8592; saisissez un mot de passe</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; ressaisissez le mot de passe</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l’onglet <code>Backup</code> du même écran</p>
<div class="ulist">
<ul>
<li>
<p><code>Backup interval:</code> &#8592; saisir <code>weekly</code></p>
</li>
<li>
<p><code>Number of backup copies:</code> &#8592; saisir <code>1</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l&#8217;onglet <code>Options</code>, il peut être utile pour certains types de site qui sont des redirections d&#8217;autres sites (locaux, d&#8217;autres machines ou de container docker) de saisir dans la zone <code>Apache Directives:</code></p>
<div class="ulist">
<ul>
<li>
<p>Pour un site en HTTP (attention dans ce cas, ce site doit être local ou dans un container pour des raisons de sécurité) :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># yacht httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPassMatch</span> ^/(.+)/websocket ws://localhost[:port_number_if_any]/$1/websocket keepalive=On # If websocket is in use

<span class="tok-nb">ProxyPass</span> / http://localhost[:port_number_if_any]/[path_if_any]
<span class="tok-nb">ProxyPassReverse</span> / http://localhost[:port_number_if_any]/[path_if_any]

<span class="tok-nb">RedirectMatch</span> ^/$ https://www.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pour un site en HTTPS :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># redirect from server</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">SSLProxyEngine</span> <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">RequestHeader</span> set Front-End-Https <span class="tok-s2">&quot;On&quot;</span> # Comment this out if no https required
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPassMatch</span> ^/(.+)/websocket ws://localhost[:port_number_if_any]/$1/websocket keepalive=On # If websocket is in use
<span class="tok-nb">ProxyPass</span> / https://localhost[:port_number_if_any]/[path_if_any]
<span class="tok-nb">ProxyPassReverse</span> / https://localhost[:port_number_if_any]/[path_if_any]

<span class="tok-nb">RedirectMatch</span> ^/$ https://www.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Vous pouvez maintenant tester la qualité de la  connexion de votre site en allant sur: <a href="https://www.ssllabs.com/ssltest">SSL Server Test</a>. Saisissez votre nom de domaine et cliquez sur <code>Submit</code>. Votre site doit au moins être de <code>Grade A</code>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="subdomain-site">9.7. Création d’un Site Vhost</h3>
<div class="paragraph">
<p>Dans la suite le sous-domaine sera nommé "mail.example.com".</p>
</div>
<div class="paragraph">
<p>Vous devez avoir avant tout défini le "record" DNS associé au site.
Vous ne pouvez définir un sous-domaine que si vous avez défini le site web racine auparavant.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Aller dans "Sites"</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu "Subdomain(vhost)" pour définir un sous-domaine</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur "Add Subdomain" pour un nouveau sous domaine</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592;  saisir <code>mail</code></p>
</li>
<li>
<p><code>Domain:</code> &#8592; mettre <code>example.com</code></p>
</li>
<li>
<p><code>web folder:</code> &#8592; saisir <code>mail</code></p>
</li>
<li>
<p><code>Auto-subdomain:</code> &#8592; sélectionner <code>wwww</code> ou <code>*</code> si l’on veut un certificat let’s encrypt wildcard</p>
</li>
<li>
<p><code>SSL:</code> &#8592; yes</p>
</li>
<li>
<p><code>Let’s Encrypt:</code> &#8592; yes</p>
</li>
<li>
<p><code>Php:</code> &#8592; Sélectionez <code>php-fpm</code></p>
</li>
<li>
<p>Sélectionnez éventuellement aussi les coches <code>Perl</code>, <code>Python</code>, <code>Ruby</code> en fonction des technologies déployées sur votre site. Cela est indiqué dans la procédure d&#8217;installation du site.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l’onglet <code>redirect</code> du même écran</p>
<div class="ulist">
<ul>
<li>
<p><code>Rewrite http to https:</code> &#8592; yes</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l’onglet <code>Statistics</code> du même écran</p>
<div class="ulist">
<ul>
<li>
<p><code>Set Webstatistics password:</code> &#8592; <a href="#pass_gen">Saisissez un mot de passe généré</a></p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; Ressaisissez le mot de passe</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dans l&#8217;onglet <code>Options</code>, il peut être utile pour certains types de site qui sont des redirections d&#8217;autres sites (locaux, d&#8217;autres machines ou de container docker) de saisir dans la zone <code>Apache Directives:</code></p>
<div class="ulist">
<ul>
<li>
<p>Pour un site en HTTP (attention dans ce cas, ce site doit être local ou dans un container pour des raisons de sécurité) :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># yacht httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPassMatch</span> ^/(.+)/websocket ws://localhost[:port_number_if_any]/$1/websocket keepalive=On # If websocket is in use

<span class="tok-nb">ProxyPass</span> / http://localhost[:port_number_if_any]/[path_if_any]
<span class="tok-nb">ProxyPassReverse</span> / http://localhost[:port_number_if_any]/[path_if_any]

<span class="tok-nb">RedirectMatch</span> ^/$ https://sub.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Pour un site en HTTPS :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># redirect from server</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">SSLProxyEngine</span> <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">RequestHeader</span> set Front-End-Https <span class="tok-s2">&quot;On&quot;</span> # Comment this out if no https required
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPassMatch</span> ^/(.+)/websocket ws://localhost[:port_number_if_any]/$1/websocket keepalive=On # If websocket is in use
<span class="tok-nb">ProxyPass</span> / https://localhost[:port_number_if_any]/[path_if_any]
<span class="tok-nb">ProxyPassReverse</span> / https://localhost[:port_number_if_any]/[path_if_any]

<span class="tok-nb">RedirectMatch</span> ^/$ https://sub.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Vous pouvez maintenant tester la qualité de la  connexion de votre site en allant sur: <a href="https://www.ssllabs.com/ssltest">SSL Server Test</a>. Saisissez votre nom de domaine et cliquez sur <code>Submit</code>. Votre site doit au moins être de <code>Grade A</code>.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_associer_des_certificats_reconnu_à_vos_outils">10. Associer des certificats reconnu à vos outils</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Cette action est à effectuer une fois que vous avez créé votre domaine principal et que vous avez généré vos premiers certificats let&#8217;s encrypt dans ISPConfig, vous pouvez maintenant, affecter ce certificat aux services de base:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Vous devez avoir créé au préalable un site pour les domaines example.com et mail.example.com</p>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Liez le certificat d&#8217;ISPconfig avec celui du domaine crée.</p>
<div class="ulist">
<ul>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /usr/local/ispconfig/interface/ssl/
mv ispserver.crt ispserver.crt-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
mv ispserver.key ispserver.key-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
ln -s /etc/letsencrypt/live/example.com/fullchain.pem ispserver.crt <i class="conum" data-value="1"></i><b>(1)</b>
ln -s /etc/letsencrypt/live/example.com/privkey.pem ispserver.key <i class="conum" data-value="1"></i><b>(1)</b>
cat ispserver.<span class="tok-o">{</span>key,crt<span class="tok-o">}</span> &gt; ispserver.pem
chmod <span class="tok-m">600</span> ispserver.pem
systemctl restart apache2</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Liez le certificat Postfix et Dovecot avec celui de let&#8217;s encrypt</p>
<div class="ulist">
<ul>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc/postfix/
mv smtpd.cert smtpd.cert-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
mv smtpd.key smtpd.key-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
ln -s /etc/letsencrypt/live/mail.example.com/fullchain.pem smtpd.cert <i class="conum" data-value="1"></i><b>(1)</b>
ln -s /etc/letsencrypt/live/mail.example.com/privkey.pem smtpd.key <i class="conum" data-value="1"></i><b>(1)</b>
service postfix restart
service dovecot restart</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer &lt;example.com&gt; par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Liez le certificat pour Pureftd</p>
<div class="ulist">
<ul>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc/ssl/private/
mv pure-ftpd.pem pure-ftpd.pem-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
ln -s /usr/local/ispconfig/interface/ssl/ispserver.pem pure-ftpd.pem
chmod <span class="tok-m">600</span> pure-ftpd.pem
service pure-ftpd-mysql restart</code></pre>
</div>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Création d&#8217;un script de renouvellement automatique du fichier pem</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Installez incron. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install -y incron</code></pre>
</div>
</div>
</li>
<li>
<p>Créez le fichier d&#8217;exécution périodique. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/init.d/le_ispc_pem.sh</code></pre>
</div>
</div>
<div class="paragraph">
<p>et coller dans le fichier le code suivant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-c1">### BEGIN INIT INFO</span>
<span class="tok-c1"># Provides: LE ISPSERVER.PEM AUTO UPDATER</span>
<span class="tok-c1"># Required-Start: $local_fs $network</span>
<span class="tok-c1"># Required-Stop: $local_fs</span>
<span class="tok-c1"># Default-Start: 2 3 4 5</span>
<span class="tok-c1"># Default-Stop: 0 1 6</span>
<span class="tok-c1"># Short-Description: LE ISPSERVER.PEM AUTO UPDATER</span>
<span class="tok-c1"># Description: Update ispserver.pem automatically after ISPC LE SSL certs are renewed.</span>
<span class="tok-c1">### END INIT INFO</span>
<span class="tok-nb">cd</span> /usr/local/ispconfig/interface/ssl/
mv ispserver.pem ispserver.pem-<span class="tok-k">$(</span>date +<span class="tok-s2">&quot;%y%m%d%H%M%S&quot;</span><span class="tok-k">)</span>.bak
cat ispserver.<span class="tok-o">{</span>key,crt<span class="tok-o">}</span> &gt; ispserver.pem
chmod <span class="tok-m">600</span> ispserver.pem
chmod <span class="tok-m">600</span> /etc/ssl/private/pure-ftpd.pem
service pure-ftpd-mysql restart
service monit restart
service postfix restart
service dovecot restart
service apache2 restart
<span class="tok-nb">exit</span> <span class="tok-m">1</span></code></pre>
</div>
</div>
</li>
<li>
<p>Sauvez et quittez. Tapez ensuite:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod +x /etc/init.d/le_ispc_pem.sh
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;root&quot;</span> &gt;&gt; /etc/incron.allow
incrontab -e</code></pre>
</div>
</div>
<div class="paragraph">
<p>et ajoutez les lignes ci dessous dans le fichier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/etc/letsencrypt/archive/mail.example.com/ IN_MODIFY /etc/init.d/le_ispc_pem.sh <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remplacer mail.example.com par votre nom de domaine du mail.</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_surveillance_du_serveur_avec_munin_et_monit">11. Surveillance du serveur avec Munin et Monit</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_note_préliminaire">11.1. Note préliminaire</h3>
<div class="paragraph">
<p>Installez tout d&#8217;abord les paquets indispensables pour faire fonctionner Munin avec Apache puis activez le module fcgid:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install apache2 libcgi-fast-perl libapache2-mod-fcgid
a2enmod fcgid</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_munin">11.2. Installation et configuration de Munin</h3>
<div class="paragraph">
<p>Suivez les étapes ci-après:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Installer le paquet Munin:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install munin munin-node munin-plugins-extra logtail libcache-cache-perl</code></pre>
</div>
</div>
</li>
<li>
<p>Votre configuration de Munin va utiliser une base de données MariaDB. Vous devez activer quelques plugins. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc/munin/plugins
ln -s /usr/share/munin/plugins/mysql_ mysql_
ln -s /usr/share/munin/plugins/mysql_bytes mysql_bytes
ln -s /usr/share/munin/plugins/mysql_innodb mysql_innodb
ln -s /usr/share/munin/plugins/mysql_isam_space_ mysql_isam_space_
ln -s /usr/share/munin/plugins/mysql_queries mysql_queries
ln -s /usr/share/munin/plugins/mysql_slowqueries mysql_slowqueries
ln -s /usr/share/munin/plugins/mysql_threads mysql_threads</code></pre>
</div>
</div>
</li>
<li>
<p>Créez la base de données MariaDB de Munin. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql -p</code></pre>
</div>
</div>
</li>
<li>
<p>Tapez le mot de passe mysql de root , puis dans mysql tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-k">CREATE</span> <span class="tok-k">SCHEMA</span> <span class="tok-n">munin_innodb</span><span class="tok-p">;</span>
<span class="tok-k">USE</span> <span class="tok-n">munin_innodb</span>
<span class="tok-k">CREATE</span> <span class="tok-k">TABLE</span> <span class="tok-n">something</span> <span class="tok-p">(</span><span class="tok-n">anything</span> <span class="tok-kt">int</span><span class="tok-p">)</span> <span class="tok-k">ENGINE</span><span class="tok-o">=</span><span class="tok-n">InnoDB</span><span class="tok-p">;</span>
<span class="tok-k">GRANT</span> <span class="tok-k">SELECT</span> <span class="tok-k">ON</span> <span class="tok-n">munin_innodb</span><span class="tok-p">.</span><span class="tok-o">*</span> <span class="tok-k">TO</span> <span class="tok-s1">&#39;munin&#39;</span><span class="tok-nv">@&#39;localhost&#39;</span> <span class="tok-k">IDENTIFIED</span> <span class="tok-k">BY</span> <span class="tok-s1">&#39;munin&#39;</span><span class="tok-p">;</span>
<span class="tok-k">FLUSH</span> <span class="tok-k">PRIVILEGES</span><span class="tok-p">;</span>
<span class="tok-k">EXIT</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Editez ensuite le fichier de configuration de Munin. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/munin/munin.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Décommentez les lignes débutant par: <code>bdir</code>, <code>htmldir</code>, <code>logdir</code>, <code>rundir</code>, and <code>tmpldir</code>. Les valeurs par défaut sont correctes.</p>
</li>
<li>
<p>Munin utilisera l&#8217;adresse <code>munin.example.com</code>. Toujours dans le fichier de configuration de munin, remplacer la directive <code>[localhost.localdomain]</code> par <code>[munin.example.com]</code>.</p>
</li>
<li>
<p>Un fois les commentaires enlevés et la ligne modifiée, le fichier de configuration doit ressembler à celui-ci:</p>
<div class="listingblock">
<div class="content">
<pre># Example configuration file for Munin, generated by 'make build'
# The next three variables specifies where the location of the RRD
# databases, the HTML output, logs and the lock/pid files. They all
# must be writable by the user running munin-cron. They are all
# defaulted to the values you see here.
#
dbdir /var/lib/munin
htmldir /var/cache/munin/www
logdir /var/log/munin
rundir /var/run/munin
# Where to look for the HTML templates
#
tmpldir /etc/munin/templates
# Where to look for the static www files
#
#staticdir /etc/munin/static
# temporary cgi files are here. note that it has to be writable by
# the cgi user (usually nobody or httpd).
#
# cgitmpdir /var/lib/munin/cgi-tmp

# (Exactly one) directory to include all files from.
includedir /etc/munin/munin-conf.d
[...]
# a simple host tree
[munin.example.com] <i class="conum" data-value="1"></i><b>(1)</b>
 address 127.0.0.1
 use_node_name yes
[...]</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Activez Munin dans Apache. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2enconf munin</code></pre>
</div>
</div>
</li>
<li>
<p>Editez le fichier munin.conf d&#8217;Apache:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/apache2/conf-enabled/munin.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Nous allons maintenant activer le module Munin dans Apache et définir une authentification basique.</p>
</li>
<li>
<p>Modifiez le fichier pour qu&#8217;il ressemble à celui ci-dessous:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nb">ScriptAlias</span> <span class="tok-sx">/munin-cgi/munin-cgi-graph</span> <span class="tok-sx">/usr/lib/munin/cgi/munin-cgi-graph</span>
<span class="tok-nb">Alias</span> <span class="tok-sx">/munin/static/</span> <span class="tok-sx">/var/cache/munin/www/static/</span>

<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/var/cache/munin/www</span><span class="tok-nt">&gt;</span>
    <span class="tok-nb">Options</span> FollowSymLinks SymLinksIfOwnerMatch
    <span class="tok-nb">AuthUserFile</span> <span class="tok-sx">/etc/munin/munin-htpasswd</span>
    <span class="tok-nb">AuthName</span> <span class="tok-s2">&quot;Munin&quot;</span>
    <span class="tok-nb">AuthType</span> Basic
    <span class="tok-nb">Require</span> valid-user

<span class="tok-nt">&lt;/Directory&gt;</span>

<span class="tok-nt">&lt;Directory</span> <span class="tok-s">/usr/lib/munin/cgi</span><span class="tok-nt">&gt;</span>
    <span class="tok-nb">AuthUserFile</span> <span class="tok-sx">/etc/munin/munin-htpasswd</span>
    <span class="tok-nb">AuthName</span> <span class="tok-s2">&quot;Munin&quot;</span>
    <span class="tok-nb">AuthType</span> Basic
    <span class="tok-nb">Require</span> valid-user
    <span class="tok-nb">Options</span> FollowSymLinks SymLinksIfOwnerMatch
    <span class="tok-nt">&lt;IfModule</span> <span class="tok-s">mod_fcgid.c</span><span class="tok-nt">&gt;</span>
        <span class="tok-nb">SetHandler</span> fcgid-script
    <span class="tok-nt">&lt;/IfModule&gt;</span>
    <span class="tok-nt">&lt;IfModule</span> <span class="tok-s">!mod_fcgid.c</span><span class="tok-nt">&gt;</span>
        <span class="tok-nb">SetHandler</span> cgi-script
    <span class="tok-nt">&lt;/IfModule&gt;</span>
<span class="tok-nt">&lt;/Directory&gt;</span>

<span class="tok-c"># ***** SETTINGS FOR CGI/CRON STRATEGIES *****</span>

<span class="tok-c"># pick _one_ of the following lines depending on your &quot;html_strategy&quot;</span>
<span class="tok-c"># html_strategy: cron (default)</span>
<span class="tok-nb">Alias</span> <span class="tok-sx">/munin</span> <span class="tok-sx">/var/cache/munin/www</span>
<span class="tok-c"># html_strategy: cgi (requires the apache module &quot;cgid&quot; or &quot;fcgid&quot;)</span>
<span class="tok-c">#ScriptAlias /munin /usr/lib/munin/cgi/munin-cgi-html</span></code></pre>
</div>
</div>
</li>
<li>
<p>Créez ensuite le fichier de mot de passe de munin:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>htpasswd -c /etc/munin/munin-htpasswd admin</code></pre>
</div>
</div>
</li>
<li>
<p>Tapez <a href="#pass_gen">votre mot de passe généré</a></p>
</li>
<li>
<p>Redémarrez apache. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service apache2 restart</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez Munin. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service munin-node restart</code></pre>
</div>
</div>
</li>
<li>
<p>Attendez quelques minutes afin que Munin produise ses premiers fichiers de sortie. et allez ensuite sur l&#8217;URL: <a href="http://example.com/munin/" class="bare">http://example.com/munin/</a>.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_activez_les_plugins_de_munin">11.3. Activez les plugins de Munin</h3>
<div class="paragraph">
<p>Dans Debian 10, tous les plugins complémentaires sont déjà activés.Vous pouvez être tenté de vérifier:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pour vérifier que la configuration est correcte. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>munin-node-configure --suggest</code></pre>
</div>
</div>
</li>
<li>
<p>Une liste de plugins doit s&#8217;afficher à l&#8217;écran. La colonne <code>used</code> indique que le plugins est activé. La colonne <code>Suggestions</code> indique que le serveur fait fonctionner un service qui peut être monitoré par ce module. Il faut créer un lien symbolique du module de <code>/usr/share/munin/plugins</code> dans <code>/etc/munin/plugins</code> pour l&#8217;activer.</p>
</li>
<li>
<p>Par exemple pour activer les modules apache_*:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /etc/munin/plugins
ln -s /usr/share/munin/plugins/apache_accesses
ln -s /usr/share/munin/plugins/apache_processes
ln -s /usr/share/munin/plugins/apache_volume
rm /usr/share/munin/plugins/mysql_</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez ensuite le service Munin. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service munin-node restart</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installer_et_configurer_monit">11.4. Installer et configurer Monit</h3>
<div class="paragraph">
<p>Pour installer et configurer Monit, vous devez appliquer la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install monit</code></pre>
</div>
</div>
</li>
<li>
<p>Maintenant nous devons éditer le fichier <code>monitrc</code> qui définira les services que l&#8217;on souhaite monitorer. Il existe de nombreux exemples sur le web et vous pourrez trouver de nombreuses configuration sur <a href="http://mmonit.com/monit/documentation/" class="bare">http://mmonit.com/monit/documentation/</a>.</p>
</li>
<li>
<p>Editez le fichier monitrc. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>cp /etc/monit/monitrc /etc/monit/monitrc_orig
vi /etc/monit/monitrc</code></pre>
</div>
</div>
</li>
<li>
<p>Le fichier contient déjà de nombreux exemples. Nous configurer une surveillance de sshd, apache, mysql, proftpd, postfix, memcached, named, ntpd, mailman, amavisd, dovecot. Monit  sera activé sur le port 2812 et nous allons donner à l&#8217;utilisateur  admin un mot de passe. Le certificat HTTPS sera celui généré avec let&#8217;s encrypt pour le site ISPConfig. Collez le contenu ci dessous dans le fichier monitrc:</p>
<div class="listingblock">
<div class="content">
<pre>set daemon 60
set logfile syslog facility log_daemon
set mailserver localhost
set mail-format { from: monit@example.com } <i class="conum" data-value="2"></i><b>(2)</b>
set alert nom@example.com <i class="conum" data-value="2"></i><b>(2)</b>
set httpd port 2812 and
 SSL ENABLE
 PEMFILE /usr/local/ispconfig/interface/ssl/ispserver.pem
 allow admin:"my_password" <i class="conum" data-value="1"></i><b>(1)</b>

check process sshd with pidfile /var/run/sshd.pid
 start program "/usr/sbin/service ssh start"
 stop program "/usr/sbin/service ssh stop"
 if failed port 22 protocol ssh then restart
 if 5 restarts within 5 cycles then timeout

check process apache with pidfile /var/run/apache2/apache2.pid
 group www
 start program = "/usr/sbin/service apache2 start"
 stop program = "/usr/sbin/service apache2 stop"
 if failed host localhost port 80 protocol http
 and request "/monit/token" then restart
 if cpu is greater than 60% for 2 cycles then alert
 if cpu &gt; 80% for 5 cycles then restart
 if totalmem &gt; 500 MB for 5 cycles then restart
 if children &gt; 250 then restart
 if loadavg(5min) greater than 10 for 8 cycles then stop
 if 3 restarts within 5 cycles then timeout

# ---------------------------------------------------------------------------------------------
# NOTE: Replace example.pid with the pid name of your server, the name depends on the hostname
# ---------------------------------------------------------------------------------------------
check process mysql with pidfile /var/run/mysqld/mysqld.pid
 group database
 start program = "/usr/sbin/service mysql start"
 stop program = "/usr/sbin/service mysql stop"
 if failed host 127.0.0.1 port 3306 then restart
 if 5 restarts within 5 cycles then timeout

check process pureftpd with pidfile /var/run/pure-ftpd/pure-ftpd.pid
 start program = "/usr/sbin/service pure-ftpd-mysql start"
 stop program = "/usr/sbin/service pure-ftpd-mysql stop"
 if failed port 21 protocol ftp then restart
 if 5 restarts within 5 cycles then timeout

check process postfix with pidfile /var/spool/postfix/pid/master.pid
 group mail
 start program = "/usr/sbin/service postfix start"
 stop program = "/usr/sbin/service postfix stop"
 if failed port 25 protocol smtp then restart
 if 5 restarts within 5 cycles then timeout

check process memcached with pidfile /var/run/memcached/memcached.pid
 start program = "/usr/sbin/service memcached start"
 stop program = "/usr/sbin/service memcached stop"
 if failed host 127.0.0.1 port 11211 then restart

check process named with pidfile /var/run/named/named.pid
 start program = "/usr/sbin/service bind9 start"
 stop program = "/usr/sbin/service bind9 stop"
 if failed host 127.0.0.1 port 53 type tcp protocol dns then restart
 if failed host 127.0.0.1 port 53 type udp protocol dns then restart
 if 5 restarts within 5 cycles then timeout

check process ntpd with pidfile /var/run/ntpd.pid
 start program = "/usr/sbin/service ntp start"
 stop program = "/usr/sbin/service ntp stop"
 if failed host 127.0.0.1 port 123 type udp then restart
 if 5 restarts within 5 cycles then timeout

check process mailman with pidfile /var/run/mailman/mailman.pid
 group mail
 start program = "/usr/sbin/service mailman start"
 stop program = "/usr/sbin/service mailman stop"

check process amavisd with pidfile /var/run/amavis/amavisd.pid
 group mail
 start program = "/usr/sbin/service amavis start"
 stop program = "/usr/sbin/service amavis stop"
 if failed port 10024 protocol smtp then restart
 if 5 restarts within 5 cycles then timeout

check process dovecot with pidfile /var/run/dovecot/master.pid
 group mail
 start program = "/usr/sbin/service dovecot start"
 stop program = "/usr/sbin/service dovecot stop"
 if failed host localhost port 993 type tcpssl sslauto protocol imap then restart
 if 5 restarts within 5 cycles then timeout</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez my_password par <a href="#pass_gen">votre mot de passe généré</a></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacer example.com par votre domaine et <a href="mailto:nom@example.com">nom@example.com</a> par votre email</td>
</tr>
</table>
</div>
</li>
<li>
<p>La configuration est assez claire à lire. pour obtenir des précisions, référez vous à la documentation de monit <a href="http://mmonit.com/monit/documentation/monit.html" class="bare">http://mmonit.com/monit/documentation/monit.html</a>.</p>
</li>
<li>
<p>Redémarrez apache. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service apache2 restart</code></pre>
</div>
</div>
</li>
<li>
<p>Dans la configuration pour apache, la configuration indique que monit doit allez chercher sur le port 80 un fichier dans <code>/monit/token</code>. Nous devons donc créer ce fichier. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir /var/www/html/monit
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;hello&quot;</span> &gt; /var/www/html/monit/token</code></pre>
</div>
</div>
</li>
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service monit restart</code></pre>
</div>
</div>
</li>
<li>
<p>Pour monitorer le statut des process en ligne de commande, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>monit status</code></pre>
</div>
</div>
</li>
<li>
<p>Débloquez le port 2812 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 2812</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Maintenant naviguez sur le site <a href="https://example.com:2812/" class="bare">https://example.com:2812/</a></p>
</li>
<li>
<p>Rentrez le login <code>admin</code> et votre mot de passe <code>my_password</code>. Monit affiche alors les informations de monitoring du serveur.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_de_la_messagerie">12. Configuration de la messagerie</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation_de_lantispam_rspamd_à_la_place_d_amavis_new">12.1. Installation de l&#8217;antispam rspamd à la place d' Amavis-new</h3>
<div class="paragraph">
<p><code>rspamd</code> est réputé de meilleure qualité que <code>Amavis</code> dans la chasse aux spams. Vous pouvez décider de l&#8217;installer à la place d&#8217;Amavis. Cette installation reste optionnelle.</p>
</div>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez les paquets debian. tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install rspamd redis-server</code></pre>
</div>
</div>
</li>
<li>
<p>Loguez vous dans ISPConfig</p>
</li>
<li>
<p>Activer Rspamd dans ISPConfig</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez dans la rubrique <code>system</code> &#8594; menu <code>Server Config</code> &#8594; Sélectionnez votre serveur &#8594; Onglet <code>Mail</code></p>
</li>
<li>
<p>Dans le champ <code>Content Filter</code>, sélectionnez <code>Rspamd</code></p>
</li>
<li>
<p>Dans le champ <code>Rspamd Password</code>, tapez votre mot de passe</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
<li>
<p>Revenez dans la rubrique <code>system</code> &#8594; menu <code>Server Config</code> &#8594; Sélectionnez votre serveur &#8594; Onglet <code>Mail</code></p>
</li>
<li>
<p>Vous pouvez voir le mot de passe de connexion au serveur web Rspamd.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Activez l&#8217;apprentissage automatique</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;autolearn = true;&quot;</span> &gt; /etc/rspamd/local.d/classifier-bayes.conf
<span class="tok-nb">echo</span> <span class="tok-s1">&#39;backend = &quot;redis&quot;;&#39;</span> &gt;&gt; /etc/rspamd/local.d/classifier-bayes.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;new_schema = true;&quot;</span> &gt;&gt; /etc/rspamd/local.d/classifier-bayes.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;expire = 8640000;&quot;</span> &gt;&gt; /etc/rspamd/local.d/classifier-bayes.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Activez Redis dans la configuration de Rspamd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s1">&#39;servers = &quot;127.0.0.1&quot;;&#39;</span> &gt; /etc/rspamd/local.d/redis.conf
<span class="tok-nb">echo</span> <span class="tok-s1">&#39;enabled = true;&#39;</span> &gt;&gt; /etc/rspamd/local.d/redis.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Fixer des métriques assez élevées pour analyser les spams</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;actions {&quot;</span> &gt; /etc/rspamd/local.d/metrics.conf
<span class="tok-nb">echo</span> <span class="tok-s1">&#39;add_header = 5;&#39;</span> &gt;&gt; /etc/rspamd/local.d/metrics.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;greylist = 25;&quot;</span> &gt;&gt; /etc/rspamd/local.d/metrics.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;reject = 50;&quot;</span> &gt;&gt; /etc/rspamd/local.d/metrics.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;}&quot;</span> &gt;&gt; /etc/rspamd/local.d/metrics.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Augmentez la taille de l&#8217;historique de Rspamd, activez la compression.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;nrows = 2500;&quot;</span> &gt; /etc/rspamd/local.d/history_redis.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;compress = true;&quot;</span> &gt;&gt; /etc/rspamd/local.d/history_redis.conf
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;subject_privacy = false;&quot;</span> &gt;&gt; /etc/rspamd/local.d/history_redis.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Assignez un calcul automatique de réputation aux URLs</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s1">&#39;enabled = true;&#39;</span> &gt; /etc/rspamd/local.d/url_reputation.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Mettez à jour automatiquement les règles de filtre:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>echo 'enabled = true;' &gt; /etc/rspamd/local.d/rspamd_update.conf</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Enrichissez les headers des mails spams. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/rspamd/local.d/milter_headers.conf</code></pre>
</div>
</div>
</li>
<li>
<p>inserez le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span># local.d/milter_headers.conf:

# Options

# Add &quot;extended Rspamd headers&quot; (default false) (enables x-spamd-result, x-rspamd-server &amp; x-rspamd-queue-id routines)
extended_spam_headers = true;

# List of headers to be enabled for authenticated users (default empty)
# authenticated_headers = [&quot;authentication-results&quot;];

# List of headers to be enabled for local IPs (default empty)
local_headers = [&quot;x-spamd-bar&quot;];

# Set false to always add headers for local IPs (default true)
# skip_local = true;

# Set false to always add headers for authenticated users (default true)
# skip_authenticated = true;

# Routines to use- this is the only required setting (may be omitted if using extended_spam_headers)
use = [&quot;x-spamd-bar&quot;, &quot;x-spam-level&quot;, &quot;authentication-results&quot;];

# this is where we may configure our selected routines
routines {
  # settings for x-spamd-bar routine
  x-spamd-bar {
    # effectively disables negative spambar
    negative = &quot;&quot;;
  }
  # other routines...
}
custom {
  # user-defined routines: more on these later
}</code></pre>
</div>
</div>
</li>
<li>
<p>Créez un mot de passe. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>rspamadm pw</code></pre>
</div>
</div>
</li>
<li>
<p>Entrez <a href="#pass_gen">votre mot de passe généré</a>. Une hashphrase est générée.</p>
</li>
<li>
<p>Copiez la.</p>
</li>
<li>
<p>Remplacez celle déjà présente dans <code>/etc/rspamd/local.d/worker-controller.inc</code></p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/rspamd/local.d/worker-controller.inc</code></pre>
</div>
</div>
</li>
<li>
<p>Remplacez le texte entre guillemets sur la ligne <code>password = "$2$g95yw&#8230;&#8203;&#8230;&#8203;dq3c5byy";</code> par le texte copié.</p>
</li>
<li>
<p>Sauvez</p>
</li>
<li>
<p>Redémarrez Rspamd</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart rspamd</code></pre>
</div>
</div>
</li>
<li>
<p>Rendre le site rspamd accessible dans un host</p>
</li>
<li>
<p>Activez le module proxy dans apache</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>a2enmod proxy
systemctl restart apache2</code></pre>
</div>
</div>
</li>
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>rspamd</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de <code>sites</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>rspamd</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>rspamd</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># rspamd httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>
<span class="tok-nb">ProxyPass</span> / http://localhost:11334/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:11334/

<span class="tok-nb">RedirectMatch</span> ^/$ https://rspamd.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>en pointant sur le site <code>rspampd.example.com</code> , et en utilisant le mot de passe saisi plus haut vous pouvez accéder aux fonctions de l&#8217;outil.</p>
</li>
<li>
<p>Activer l&#8217;apprentissage par déplacement</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Couplé avec Dovecot, Rspamd nous propose de pouvoir apprendre également en fonction des actions des utilisateurs. Si un mail est déplacé vers le répertoire Junk, il sera appris comme tel et au contraire, s’il est sorti du répertoire Junk vers autre chose que la corbeille, il sera appris comme Ham.</p>
</li>
<li>
<p>Editez le fichier Dovecot.conf (remarques ISPConfig n&#8217;utilise pas aujourd&#8217;hui le contenu du répertoire conf.d). Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/dovecot/dovecot.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez dans le groupe plugin et le protocol imap déjà existants dans le fichier :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>plugin {
  sieve_plugins = sieve_imapsieve sieve_extprograms

  imapsieve_mailbox1_name = Junk
  imapsieve_mailbox1_causes = COPY
  imapsieve_mailbox1_before = file:/etc/dovecot/sieve/report-spam.sieve

  imapsieve_mailbox2_name = *
  imapsieve_mailbox2_from = Junk
  imapsieve_mailbox2_causes = COPY
  imapsieve_mailbox2_before = file:/etc/dovecot/sieve/report-ham.sieve

  sieve_pipe_bin_dir = /etc/dovecot/sieve

  sieve_global_extensions = +vnd.dovecot.pipe
}

protocol imap {
  mail_plugins = quota imap_quota imap_sieve
}</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez dovecot. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service dovecot restart</code></pre>
</div>
</div>
</li>
<li>
<p>Créez un répertoire sieve et éditez report-ham.sieve. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /etc/dovecot/sieve/
vi /etc/dovecot/sieve/report-ham.sieve</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>require [&quot;vnd.dovecot.pipe&quot;, &quot;copy&quot;, &quot;imapsieve&quot;, &quot;environment&quot;, &quot;variables&quot;];

if environment :matches &quot;imap.mailbox&quot; &quot;*&quot; {
set &quot;mailbox&quot; &quot;${1}&quot;;
}

if string &quot;${mailbox}&quot; &quot;Trash&quot; {
stop;
}

if environment :matches &quot;imap.email&quot; &quot;*&quot; {
set &quot;email&quot; &quot;${1}&quot;;
}

pipe :copy &quot;train-ham.sh&quot; [ &quot;${email}&quot; ];</code></pre>
</div>
</div>
</li>
<li>
<p>Editez report-spam.sieve. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/dovecot/sieve/report-spam.sieve</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>require [&quot;vnd.dovecot.pipe&quot;, &quot;copy&quot;, &quot;imapsieve&quot;, &quot;environment&quot;, &quot;variables&quot;];

if environment :matches &quot;imap.email&quot; &quot;*&quot; {
set &quot;email&quot; &quot;${1}&quot;;
}

pipe :copy &quot;train-spam.sh&quot; [ &quot;${email}&quot; ];</code></pre>
</div>
</div>
</li>
<li>
<p>Créez les scripts et rétablissez les droits et permissions. Compilez les règles. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;exec /usr/bin/rspamc learn_ham&quot;</span> &gt; /etc/dovecot/sieve/train-ham.sh
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;exec /usr/bin/rspamc learn_spam&quot;</span> &gt; /etc/dovecot/sieve/train-spam.sh
sievec /etc/dovecot/sieve/report-ham.sieve
sievec /etc/dovecot/sieve/report-spam.sieve
chmod +x /etc/dovecot/sieve/train-*
chown -R vmail:vmail /etc/dovecot/sieve</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez dovecot. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service dovecot restart</code></pre>
</div>
</div>
</li>
<li>
<p>Lorsque vous déplacer un mail du répertoire Inbox vers le répertoire Junk ou vice-versa, les fichiers <code>/var/log/mail.log</code> et <code>/var/log/rspamd/rspamd.log</code> doivent montrer les actions de recalcul des spams.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Enfin, vous pouvez désactiver amavisd si vous le souhaitez. tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl stop amavisd-new
systemctl disable amavisd-new</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_du_serveur_de_messagerie">12.2. Création du serveur de messagerie</h3>
<div class="paragraph">
<p>Pour créer un serveur de messagerie:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Assurez vous d&#8217;avoir créé le domaine DNS. Si ce n&#8217;est pas le cas déroulez tout d&#8217;abord la procédure de <a href="#domain-config">création de domaines</a></p>
</li>
<li>
<p>Aller dans la rubrique <code>Email</code>. Sélectionnez ensuite le menu <code>Domain</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Domain</code></p>
</li>
<li>
<p>Saisissez le nom de domaine.</p>
</li>
<li>
<p>Cliquez sur <code>DomainKeys Indentified Mail (DKIM)</code></p>
</li>
<li>
<p>Cliquez sur <code>enable DKIM</code></p>
</li>
<li>
<p>Cliquez sur <code>Generate DKIM Private-key</code></p>
</li>
<li>
<p>Une fois cela fait, retourner dans la gestion des <code>Records</code> de domaine et activer le type DMARC</p>
</li>
<li>
<p>Garder le paramétrage par défaut et sauvegardez.</p>
</li>
<li>
<p>Faites de même pour les enregistrements SPF mais sélectionnez le mécanisme softfail.</p>
</li>
<li>
<p>Votre serveur est créé et protégé Contre les spams (entrants et sortants).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_finaliser_la_sécurisation_de_votre_serveur_de_mail">12.3. Finaliser la sécurisation de votre serveur de mail</h3>
<div class="paragraph">
<p>Afin de mieux sécuriser votre serveur de mail, appliquez les opérations suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>editez le fichier main.cf</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/postfix/main.cf</code></pre>
</div>
</div>
</li>
<li>
<p>Rechercher <code>myhostname</code> et replacer le texte par:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">myhostname</span> <span class="tok-o">=</span> <span class="tok-s">mail.example.com </span><i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Remplacer <code>example.com</code> par votre nom de domaine.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Redémarrez Postfix. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service postfix restart</code></pre>
</div>
</div>
</li>
<li>
<p>Vous pouvez le tester en allant sur le site <a href="https://mxtoolbox.com/diagnostic.aspx">MxToolbox</a>.</p>
<div class="ulist">
<ul>
<li>
<p>Entrez le nom de host de votre serveur de mail: <code>mail.example.com</code> .</p>
</li>
<li>
<p>cliquez sur <code>test Email Server</code></p>
</li>
<li>
<p>Tout doit être correct sauf éventuellement le reverse DNS qui doit être configuré pour pointer vers <code>mail.example.com</code> .</p>
</li>
</ul>
</div>
</li>
<li>
<p>Testez votre email sur le site <a href="https://www.phishingscorecard.com/">Phishing Scoreboard</a></p>
<div class="ulist">
<ul>
<li>
<p>Entrez votre adresse mail: <code>admin@example.com</code></p>
</li>
<li>
<p>Entrez votre nom de domaine: <code>example.com</code></p>
</li>
<li>
<p>Entrez votre clé dkim: <code>default</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Enfin, vous pouvez tester votre statut de spammer potentiel en envoyant allant sur le site <a href="https://www.mail-tester.com/">Newsletter Spam test</a></p>
<div class="ulist">
<ul>
<li>
<p>suivez les instructions (envoi d&#8217;un email à l&#8217;adresse donnée)</p>
</li>
<li>
<p>le site vous donnera des informations intéressantes sur la configuration du serveur et des informations complémentaires liées au contenu du mail. Pour ces dernières ne pas en tenir compte.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_surveillance_du_statut_de_spammer">12.4. Surveillance du statut de Spammer</h3>
<div class="paragraph">
<p>Il est nécessaire aujourd&#8217;hui de surveiller le statut de votre serveur de mail et de vérifier notamment si votre configuration SPF, DKIM et DMARC est correctement comprise par les serveurs de mails les plus connus comme Gmail, Yahoo, Hotmail &#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Pour cela un peu de configuration est nécessaire.</p>
</div>
<div class="paragraph">
<p>En premier, il faut créer un compte:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez sur le site <a href="https://dmarcian.com">Dmarcian</a></p>
</li>
<li>
<p>Cliquez sur <code>Sign up Free</code></p>
</li>
<li>
<p>Choisissez votre région, <code>Europe</code> par exemple.</p>
</li>
<li>
<p>Enregistrez votre compte (mail, mot de passe) et votre nom de domaine <code>example.com</code></p>
</li>
<li>
<p>notez bien l&#8217;adresse email qui va vous être donnée par dmarcian de la forme <code>xyzabcd@ag.dmarcian.eu</code> pour la réception de messages de type abuse te de la forme <code>xyzabcd@fr.dmarcian.eu</code> pour des forensic. Notez bien ces deux adresses.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Ensuite, vous devez modifier votre configuration DMARC:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans <code>DNS</code> de votre serveur de domaine principal</p>
</li>
<li>
<p>Sélectionnez le menu <code>Zones</code> puis le domaine <code>example.com</code></p>
</li>
<li>
<p>Choisissez l&#8217;onglet <code>Records</code> et éditez l&#8217;entrée <code>TXT</code> nommée _dmarc</p>
</li>
<li>
<p>modifiez le champ <code>Text</code> avec : <code>v=DMARC1;p=reject;sp=quarantine;pct=100;rua=mailto:abuse@example.com;ruf=mailto:forensic@example.com</code></p>
</li>
<li>
<p>Allez ensuite dans <code>Email</code></p>
</li>
<li>
<p>Allez dans le menu <code>Email Forward</code></p>
</li>
<li>
<p>cliquez sur  <code>Add new Email Forward</code></p>
</li>
<li>
<p>Saisissez dans <code>Email</code> la valeur <code>abuse</code></p>
</li>
<li>
<p>Saisissez dans Destination Email sur 2 lignes l&#8217;adresse de votre mail de réception interne et l&#8217;adresse mail qui vous a été fournie par <code>dmarcian.com</code> pour l&#8217;adresse abuse ( de la forme <code>xyzabcd@ag.dmarcian.eu</code> )</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
<li>
<p>cliquez sur  <code>Add new Email Forward</code></p>
</li>
<li>
<p>Saisissez dans <code>Email</code> la valeur <code>forensic</code></p>
</li>
<li>
<p>Saisissez dans Destination Email sur 2 lignes l&#8217;adresse de votre mail de réception interne et l&#8217;adresse mail qui vous a été fournie par <code>dmarcian.com</code> pour l&#8217;adresse forensic ( de la forme <code>xyzabcd@fr.dmarcian.eu</code> )</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
<li>
<p>le site <code>dmarcian.com</code> va commencer à recevoir tous les comptes rendus de mails refusés par les destinataires de messagerie et élaborer des statistiques ainsi que des comptes rendus que vous pourrez consulter sur votre compte.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Il est intéressant de vérifier votre statut de spammer en vérifiant les différentes blacklist qui existent.</p>
</div>
<div class="paragraph">
<p>Pour cela allez sur le site <a href="https://mxtoolbox.com/blacklists.aspx">Email Blacklist Check</a> entrez votre nom de domaine <code>example.com</code> et cliquez sur le bouton <code>Blacklist Check</code>.</p>
</div>
<div class="paragraph">
<p>Tous les sites doivent indiquer que votre domaine n&#8217;est pas blacklisté.</p>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_lautoconfig_pour_thunderbird_et_android">12.5. Création de l’autoconfig pour Thunderbird et Android</h3>
<div class="paragraph">
<p>La procédure est utilisé par Thunderbird et Android pour configurer automatiquement les paramètres de la messagerie.</p>
</div>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>autoconfig</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>autoconfig</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>php-FPM</code></p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span>
<span class="tok-nb">AddType</span> application/x-httpd-php .php .php3 .php4 .php5 .xml

<span class="tok-nb">CheckSpelling</span> <span class="tok-k">On</span>
<span class="tok-nb">CheckCaseOnly</span> <span class="tok-k">Off</span></code></pre>
</div>
</div>
</li>
<li>
<p>Sauver.</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Dans le répertoire <code>/var/www/autoconfig.&lt;example.com&gt;/autoconfig/</code> créer un répertoire mail. Lui donner les permissions 755 et affecter les mêmes possesseurs que pour autres fichiers du répertoire. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/autoconfig.example.com <i class="conum" data-value="2"></i><b>(2)</b>
mkdir -p autoconfig/mail
chmod <span class="tok-m">755</span> autoconfig/mail
chown web1:client0 autoconfig/mail <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer web1:client0 par les permissions du répertoire <code>/var/www/autoconfig.example.com</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacez <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>A l’intérieur de ce répertoire, Editez un fichier <code>config-v1.1.xml</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi autoconfig/mail/config-v1.1.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Y coller:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-cp">&lt;?php</span>
<span class="tok-cp">header(&#39;Content-Type: application/xml&#39;);</span>
<span class="tok-cp">?&gt;</span>
<span class="tok-cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>

<span class="tok-nt">&lt;clientConfig</span> <span class="tok-na">version=</span><span class="tok-s">&quot;1.1&quot;</span><span class="tok-nt">&gt;</span>
 <span class="tok-nt">&lt;emailProvider</span> <span class="tok-na">id=</span><span class="tok-s">&quot;example.com&quot;</span><span class="tok-nt">&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-nt">&lt;domain&gt;</span>example.com<span class="tok-nt">&lt;/domain&gt;</span>  <i class="conum" data-value="1"></i><b>(1)</b>
   <span class="tok-nt">&lt;displayName&gt;</span>Example Mail<span class="tok-nt">&lt;/displayName&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
   <span class="tok-nt">&lt;displayShortName&gt;</span>Example<span class="tok-nt">&lt;/displayShortName&gt;</span> <i class="conum" data-value="3"></i><b>(3)</b>
   <span class="tok-nt">&lt;incomingServer</span> <span class="tok-na">type=</span><span class="tok-s">&quot;imap&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;hostname&gt;</span>mail.example.com<span class="tok-nt">&lt;/hostname&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
     <span class="tok-nt">&lt;port&gt;</span>993<span class="tok-nt">&lt;/port&gt;</span>
     <span class="tok-nt">&lt;socketType&gt;</span>SSL<span class="tok-nt">&lt;/socketType&gt;</span>
     <span class="tok-nt">&lt;authentication&gt;</span>password-cleartext<span class="tok-nt">&lt;/authentication&gt;</span>
     <span class="tok-nt">&lt;username&gt;</span>%EMAILADDRESS%<span class="tok-nt">&lt;/username&gt;</span>
   <span class="tok-nt">&lt;/incomingServer&gt;</span>
   <span class="tok-nt">&lt;incomingServer</span> <span class="tok-na">type=</span><span class="tok-s">&quot;pop3&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;hostname&gt;</span>mail.example.com<span class="tok-nt">&lt;/hostname&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
     <span class="tok-nt">&lt;port&gt;</span>995<span class="tok-nt">&lt;/port&gt;</span>
     <span class="tok-nt">&lt;socketType&gt;</span>SSL<span class="tok-nt">&lt;/socketType&gt;</span>
     <span class="tok-nt">&lt;authentication&gt;</span>password-cleartext<span class="tok-nt">&lt;/authentication&gt;</span>
     <span class="tok-nt">&lt;username&gt;</span>%EMAILADDRESS%<span class="tok-nt">&lt;/username&gt;</span>
   <span class="tok-nt">&lt;/incomingServer&gt;</span>
   <span class="tok-nt">&lt;outgoingServer</span> <span class="tok-na">type=</span><span class="tok-s">&quot;smtp&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;hostname&gt;</span>mail.example.com<span class="tok-nt">&lt;/hostname&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
     <span class="tok-nt">&lt;port&gt;</span>465<span class="tok-nt">&lt;/port&gt;</span>
     <span class="tok-nt">&lt;socketType&gt;</span>SSL<span class="tok-nt">&lt;/socketType&gt;</span>
     <span class="tok-nt">&lt;authentication&gt;</span>password-cleartext<span class="tok-nt">&lt;/authentication&gt;</span>
     <span class="tok-nt">&lt;username&gt;</span>%EMAILADDRESS%<span class="tok-nt">&lt;/username&gt;</span>
   <span class="tok-nt">&lt;/outgoingServer&gt;</span>
   <span class="tok-nt">&lt;outgoingServer</span> <span class="tok-na">type=</span><span class="tok-s">&quot;smtp&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;hostname&gt;</span>mail.example.com<span class="tok-nt">&lt;/hostname&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
     <span class="tok-nt">&lt;port&gt;</span>587<span class="tok-nt">&lt;/port&gt;</span>
     <span class="tok-nt">&lt;socketType&gt;</span>STARTTLS<span class="tok-nt">&lt;/socketType&gt;</span>
     <span class="tok-nt">&lt;authentication&gt;</span>password-cleartext<span class="tok-nt">&lt;/authentication&gt;</span>
     <span class="tok-nt">&lt;username&gt;</span>%EMAILADDRESS%<span class="tok-nt">&lt;/username&gt;</span>
   <span class="tok-nt">&lt;/outgoingServer&gt;</span>
 <span class="tok-nt">&lt;/emailProvider&gt;</span>
<span class="tok-nt">&lt;/clientConfig&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>mettre ici votre libellé long pour votre nom de messagerie</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>mettre ici un libellé court pour votre nom de messagerie</td>
</tr>
</table>
</div>
</li>
<li>
<p>Donner la permission en lecture seule et affecter les groupes d&#8217;appartenance. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">644</span> autoconfig/mail/config-v1.1.xml
chown web1:client0 autoconfig/mail/config-v1.1.xml <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer web1:client0 par les permissions du répertoire <code>/var/www/autoconfig.example.com</code></td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_dautodiscover_pour_outlook">12.6. Création d’autodiscover pour Outlook</h3>
<div class="paragraph">
<p>Outlook utilise un autre mécanisme pour se configurer automatiquement. Il est basé sur l&#8217;utilisation du nom de sous-domaine <code>autodiscover</code>.</p>
</div>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>autodiscover</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>autodiscover</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>php-FPM</code></p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-nb">CheckSpelling</span> <span class="tok-k">On</span>
<span class="tok-nb">CheckCaseOnly</span> <span class="tok-k">On</span>
<span class="tok-nb">RewriteEngine</span> <span class="tok-k">On</span>
<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-s2">&quot;/&quot;</span> http://autoconfig.example.com/ <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nb">ProxyPassReverse</span> <span class="tok-s2">&quot;/&quot;</span> http://autoconfig.example.com/ <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nb">RewriteRule</span> ^/ - [QSA,L]
<span class="tok-nb">RedirectMatch</span> ^/$ https://autoconfig.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Sauver.</p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Dans le répertoire <code>/var/www/autoconfig.&lt;example.com&gt;/autoconfig/</code>, créer un répertoire <code>Autodiscover</code>. Lui donner les permissions 755 et affecter les mêmes possesseurs que pour autres fichiers du répertoire. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/autoconfig.example.com <i class="conum" data-value="2"></i><b>(2)</b>
mkdir -p autoconfig/Autodiscover/
chmod <span class="tok-m">755</span> autoconfig/Autodiscover/
chown web1:client0 autoconfig/Autodiscover/ <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer web1:client0 par les permissions du répertoire <code>/var/www/autoconfig.example.com</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacez <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>A l’intérieur de ce répertoire, Editez un fichier <code>Autodiscover.xml</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi autoconfig/Autodiscover/Autodiscover.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Y coller:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="xml"><span></span><span class="tok-cp">&lt;?php</span>
<span class="tok-cp"> $raw = file_get_contents(&#39;php://input&#39;);</span>
<span class="tok-cp"> $matches = array();</span>
<span class="tok-cp"> preg_match(&#39;/&lt;EMailAddress&gt;(.*)&lt;\/EMailAddress&gt;/&#39;, $raw, $matches);</span>
<span class="tok-cp"> header(&#39;Content-Type: application/xml&#39;);</span>
<span class="tok-cp">?&gt;</span>
 <span class="tok-nt">&lt;Autodiscover</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://schemas.microsoft.com/exchange/autodiscover/responseschema/2006&quot;</span><span class="tok-nt">&gt;</span>
   <span class="tok-nt">&lt;Response</span> <span class="tok-na">xmlns=</span><span class="tok-s">&quot;http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a&quot;</span><span class="tok-nt">&gt;</span>
     <span class="tok-nt">&lt;User&gt;</span>
       <span class="tok-nt">&lt;DisplayName&gt;</span>Example Mail<span class="tok-nt">&lt;/DisplayName&gt;</span> <i class="conum" data-value="2"></i><b>(2)</b>
     <span class="tok-nt">&lt;/User&gt;</span>
     <span class="tok-nt">&lt;Account&gt;</span>
       <span class="tok-nt">&lt;AccountType&gt;</span>email<span class="tok-nt">&lt;/AccountType&gt;</span>
       <span class="tok-nt">&lt;Action&gt;</span>settings<span class="tok-nt">&lt;/Action&gt;</span>
       <span class="tok-nt">&lt;Protocol&gt;</span>
         <span class="tok-nt">&lt;Type&gt;</span>IMAP<span class="tok-nt">&lt;/Type&gt;</span>
         <span class="tok-nt">&lt;Server&gt;</span>mail.example.com<span class="tok-nt">&lt;/Server&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
         <span class="tok-nt">&lt;Port&gt;</span>993<span class="tok-nt">&lt;/Port&gt;</span>
         <span class="tok-nt">&lt;DomainRequired&gt;</span>off<span class="tok-nt">&lt;/DomainRequired&gt;</span>
         <span class="tok-nt">&lt;SPA&gt;</span>off<span class="tok-nt">&lt;/SPA&gt;</span>
         <span class="tok-nt">&lt;SSL&gt;</span>on<span class="tok-nt">&lt;/SSL&gt;</span>
         <span class="tok-nt">&lt;AuthRequired&gt;</span>on<span class="tok-nt">&lt;/AuthRequired&gt;</span>
         <span class="tok-nt">&lt;LoginName&gt;</span><span class="tok-cp">&lt;?php echo $matches[1]; ?&gt;</span><span class="tok-nt">&lt;/LoginName&gt;</span>
       <span class="tok-nt">&lt;/Protocol&gt;</span>
       <span class="tok-nt">&lt;Protocol&gt;</span>
         <span class="tok-nt">&lt;Type&gt;</span>SMTP<span class="tok-nt">&lt;/Type&gt;</span>
         <span class="tok-nt">&lt;Server&gt;</span>mail.example.com<span class="tok-nt">&lt;/Server&gt;</span> <i class="conum" data-value="1"></i><b>(1)</b>
         <span class="tok-nt">&lt;Port&gt;</span>465<span class="tok-nt">&lt;/Port&gt;</span>
         <span class="tok-nt">&lt;DomainRequired&gt;</span>off<span class="tok-nt">&lt;/DomainRequired&gt;</span>
         <span class="tok-nt">&lt;SPA&gt;</span>off<span class="tok-nt">&lt;/SPA&gt;</span>
         <span class="tok-nt">&lt;SSL&gt;</span>on<span class="tok-nt">&lt;/SSL&gt;</span>
         <span class="tok-nt">&lt;AuthRequired&gt;</span>on<span class="tok-nt">&lt;/AuthRequired&gt;</span>
         <span class="tok-nt">&lt;LoginName&gt;</span><span class="tok-cp">&lt;?php echo $matches[1]; ?&gt;</span><span class="tok-nt">&lt;/LoginName&gt;</span>
       <span class="tok-nt">&lt;/Protocol&gt;</span>
     <span class="tok-nt">&lt;/Account&gt;</span>
   <span class="tok-nt">&lt;/Response&gt;</span>
 <span class="tok-nt">&lt;/Autodiscover&gt;</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>mettre ici votre libellé long pour votre nom de messagerie</td>
</tr>
</table>
</div>
</li>
<li>
<p>Changez les permissions comme pour le répertoire</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">644</span> autoconfig/Autodiscover/Autodiscover.xml
chown web1:client0 autoconfig/Autodiscover/Autodiscover.xml <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer web1:client0 par les permissions du répertoire <code>/var/www/autoconfig.example.com</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>Pointer votre navigateur sur le site <a href="https://autodiscover.example.com/Autodiscover/Autodiscover.xml" class="bare">https://autodiscover.example.com/Autodiscover/Autodiscover.xml</a>.</p>
</li>
<li>
<p>Le contenu du fichier xml doit s&#8217;afficher</p>
</li>
<li>
<p>Vous pouvez faire aussi un test sur le <a href="https://testconnectivity.microsoft.com">Testeur de connectivité Microsoft</a>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>choisissez: <code>Découverte automatique Outlook</code></p>
</li>
<li>
<p>cliquez sur <code>suivant</code></p>
</li>
<li>
<p>Entrez votre adresse de courrier: <code>user@example.com</code>, un domain: <code>example\user</code>, un mot de passe tiré au hazard, Cochez les deux cases en dessous.</p>
</li>
<li>
<p>Cliquez sur <code>effectuer un test</code></p>
</li>
<li>
<p>Le résultat doit être: <code>Test de connectivité réussi</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_dune_boite_mail">12.7. Création d’une boite mail</h3>
<div class="paragraph">
<p>Pour créer une boite de messagerie:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Aller dans la rubrique <code>Email</code>. Sélectionnez ensuite le menu <code>Email Mailbox</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Mailbox</code></p>
</li>
<li>
<p>Remplissez les champs suivants:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Name:</code> &#8592; mettez votre prénom et votre nom</p>
</li>
<li>
<p><code>`Email:</code> &#8592; saisir le &lt;mail_name&gt; <code>mail_name@example.com</code></p>
</li>
<li>
<p><code>Password:</code> &#8592; <a href="#pass_gen">Saisissez un mot de passe généré</a> ou générez en un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password</code> &#8592; saisissez une deuxième fois votre mot de passe</p>
</li>
<li>
<p><code>Quota (0 for unlimited):</code> &#8592; mettez éventuellement un quota ou laissez 0 pour illimité.</p>
</li>
<li>
<p><code>Spamfilter:</code> &#8592; Sélectionnez <code>Normal</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Dans l’onglet Backup:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p><code>Backup interval:</code> Sélectionnez <code>Daily</code></p>
</li>
<li>
<p><code>Number of backup copies:</code> Sélectionnez 1</p>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Notez que si vous créez une adresse mail nommée <code>mail_name@example.com</code>, vous pouvez utilisez toutes les variantes (nommées tag) derrière le caractère "+". Ainsi <code>mail_name+nospam@example.com</code> sera bien redirigé vers votre boite et l&#8217;extension <code>+nospam</code> vous permettre de trier automatiquement les mails que vous ne voulez pas recevoir.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Il est possible de changer ce caractère spécial en le modifiant dans le fichier <code>/etc/postfix/main.cf</code> sur la ligne commençant par <code>recipient_delimiter</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_de_votre_client_de_messagerie">12.8. Configuration de votre client de messagerie.</h3>
<div class="paragraph">
<p>Saisir l&#8217;adresse mail et votre mot de passe doit suffire pour configurer automatiquement votre client de messagerie.</p>
</div>
<div class="paragraph">
<p>Si vous avez besoin de configurer votre client manuellement, voici les informations à saisir:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Paramètre</th>
<th class="tableblock halign-left valign-top">Valeur</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type de serveur</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">IMAP</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nom de serveur IMAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail.example.com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nom d&#8217;utilisateur IMAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:user@example.com">user@example.com</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port IMAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">993</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sécurité IMAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSL/TLS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentification IMAP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal Password</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nom de serveur SMTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">mail.example.com</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nom d&#8217;utilisateur SMTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><a href="mailto:user@example.com">user@example.com</a></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Port SMTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">465</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Sécurité SMTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SSL/TLS</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Authentification SMTP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Normal Password</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="_mise_en_oeuvre_du_site_web_de_webmail">12.9. Mise en oeuvre du site web de webmail</h3>
<div class="paragraph">
<p>On suppose que vous avez install roundcube lors de la procédure d&#8217;installation initiale et que vous avez déjà créé le host <code>mail.example.com</code> .</p>
</div>
<div class="paragraph">
<p>Il vous reste à appliquer la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>mail</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>mail</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># roundcube httpserver</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">SSLProxyEngine</span> <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">RequestHeader</span> set Front-End-Https <span class="tok-s2">&quot;On&quot;</span> # Comment this out if no https required
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyCheckPeerCN</span> <span class="tok-k">Off</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyCheckPeerName</span> <span class="tok-k">Off</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyVerify</span> <span class="tok-k">none</span> # Comment this out if no https required
<span class="tok-nb">ProxyPass</span> / https://localhost:8080/webmail/
<span class="tok-nb">ProxyPassReverse</span> / https://localhost:8080/webmail/

<span class="tok-nb">RedirectMatch</span> ^/$ https://mail.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>C&#8217;est fait, vous pouvez accéder à Roundcube directement sur <a href="https://mail.example.com" class="bare">https://mail.example.com</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_transfert_de_vos_boites_mails_imap">12.10. Transfert de vos boites mails IMAP</h3>
<div class="paragraph">
<p>Si vous faites une migration d&#8217;un ancien serveur vers un nouveau serveur vous souhaiterez probablement migrer aussi vos boites mail.</p>
</div>
<div class="paragraph">
<p>La procédure ci dessous est à appliquer pour chaque compte mail IMAP. Elle peut facilement être scriptée.</p>
</div>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Téléchargez imapsync du repository. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre>wget https://raw.githubusercontent.com/imapsync/imapsync/master/imapsync
chmod 755 imapsync</pre>
</div>
</div>
</li>
<li>
<p>Installez les packages perls éventuellement manquants:</p>
<div class="listingblock">
<div class="content">
<pre>apt install libregexp-common-perl libfile-tail-perl libsys-meminfo-perl libunicode-string-perl libmail-imapclient-perl libio-tee-perl libio-socket-inet6-perl libfile-copy-recursive-perl libencode-imaputf7-perl</pre>
</div>
</div>
</li>
<li>
<p>Créez deux fichiers temporaires qui contiennent les mots de passe du 1er et  2eme serveur. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre>echo "passwdsrc" &gt; secretsrc <i class="conum" data-value="1"></i><b>(1)</b>
echo "passwddst" &gt; secretdst <i class="conum" data-value="2"></i><b>(2)</b>
chmod 600 secretsrc
chmod 600 secretdst</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>passwdsrc est à remplacer par le mot de passe du compte sur le serveur source</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>passwddst est à remplacer par le mot de passe du compte sur le serveur destination</td>
</tr>
</table>
</div>
</li>
<li>
<p>Nous pouvons maintenant lancer la commande. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre>./imapsync --host1 imap.examplesrc.com --user1 usersrc@examplesrc.com --passfile1 secretsrc --host2 imap.exampledst.com --user2 userdst@exampledst.com --passfile2 secretdst</pre>
</div>
</div>
</li>
<li>
<p>Un fois la synchronisation effectuée, vous pouvez supprimer le fichier des mots de passe. tapez:</p>
<div class="listingblock">
<div class="content">
<pre>rm secretsrc
rm secretdst</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_de_docker_et_des_outils_associés">13. Installation de Docker et des outils associés</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le logiciel « Docker » est une technologie de conteneurisation qui permet la création et l&#8217;utilisation de conteneurs Linux.
En clair, Docker permet d&#8217;installer et de configurer rapidement toute une appli web complexe dans un environnement isolé et avec tout son échosystème de bibliothèques logicielles spécifiques.</p>
</div>
<div class="paragraph">
<p>Il est ainsi possible d&#8217;effectuer rapidement des installations, de suivre des mises à jours et d&#8217;isoler ces environnements du système principal.</p>
</div>
<div class="sect2">
<h3 id="_a_propos_des_raspberry_pi">13.1. A propos des Raspberry Pi</h3>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Les raspberry utilisent une architecture ARM, tous les containeurs ne seront pas forcément compatibles "out of the box" ( Exemple pour MySQL). Sur le <a href="https://hub.docker.com/">Docker Hub</a>, il faut choisir par un Raspberry Pi 4 en Ubuntu une architecture de type ARM64 et pour un Raspberry Pi 3 en Raspbian une architecture de type ARM.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_docker">13.2. Installation de Docker</h3>
<div class="paragraph">
<p>L&#8217;installation de Docker est relativement simple.</p>
</div>
<div class="paragraph">
<p>Il faut suivre les étapes suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Désinstallez les éventuelles anciennes versions de docker. tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt remove --purge docker docker-engine docker.io containerd runc <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>docker-engine n&#8217;existe pas dans une distribution ubuntu. C&#8217;est à enlever.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update
apt install apt-transport-https ca-certificates curl gnupg-agent software-properties-common
curl -fsSL https://download.docker.com/linux/debian/gpg <span class="tok-p">|</span> apt-key add -</code></pre>
</div>
</div>
</li>
<li>
<p>tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>lsb_release -cs</code></pre>
</div>
</div>
</li>
<li>
<p>Ici la version de votre distribution doit s&#8217;afficher.</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
pour des installations hybride d&#8217;une distribution debian, la version qui est proposée peut être la future SID ou la Testing pour lesquelles il n&#8217;existe pas obligatoirement de version installable de docker. Dans ce cas vous devrez sélectionner vous même la version de la distribution stable.
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Tapez (et remplacer éventuellement la commande $(lsb_release -cs) par le nom de votre distribution stable).  :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>add-apt-repository <span class="tok-s2">&quot;deb [arch=amd64] https://download.docker.com/linux/debian </span><span class="tok-k">$(</span>lsb_release -cs<span class="tok-k">)</span><span class="tok-s2"> stable&quot;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ici il faut remplacer l&#8217;architecture <code>amd64</code> par <code>arm64</code> pour un raspberry pi 4  ou par <code>armhf</code> pour un raspberry pi 3. De la même manière, remplacez debian par ubuntu si vous utilisez une distribution ubuntu/</td>
</tr>
</table>
</div>
</li>
<li>
<p>Une fois installé avec succès, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update</code></pre>
</div>
</div>
</li>
<li>
<p>Si vous obtenez une erreur c&#8217;est que vous avez ajouté un repository qui n&#8217;est pas suppporté par Docker. Vérifiez les fichier <code>/etc/apt/sources.list</code>.</p>
</li>
<li>
<p>Une fois mis à jour avec succès, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install docker-ce docker-ce-cli containerd.io</code></pre>
</div>
</div>
</li>
<li>
<p>vérifiez que votre installation de <code>Docker</code> est fonctionnelle. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker run hello-world</code></pre>
</div>
</div>
</li>
<li>
<p>Cette commande exécute un conteneur simple. Si aucune erreur n’apparaît c&#8217;est que l&#8217;installation est réussie.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_docker_compose">13.3. Installation de docker-compose</h3>
<div class="paragraph">
<p>Docker-compose est un outil qui aide à l&#8217;installation de plusieurs container de façon simultané. Il permet surtout de vérifier que l&#8217;échosystème installé interagit bien.</p>
</div>
<div class="paragraph">
<p>Il faut suivre les étapes suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez quelques paquets Debian de base. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install libffi-dev libssl-dev
apt install -y python3 python3-pip <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Pour Ubuntu, remplacez ces paquets par <code>python</code> et <code>python-pip</code></td>
</tr>
</table>
</div>
</li>
<li>
<p>Installez docker-compose :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pip3 install docker-compose</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_docker_swarm">13.4. Installation de docker swarm</h3>
<div class="paragraph">
<p>Docker contient nativement le mode Swarm afin de gérer un ensemble de Docker Engines.
Cette installation est optionnelle puisque l&#8217;on peut faire fonctionner Docker sans cette Option.</p>
</div>
<div class="paragraph">
<p>Il y a deux types de machines: les <strong>Managers</strong> et les <strong>Workers</strong>.</p>
</div>
<div class="paragraph">
<p>Les managers : Ce sont les nodes gestionnaires de votre cluster. Ils distribuent les tâches aux nodes workers et ils effectuent également les fonctions d&#8217;orchestration et de gestion.</p>
</div>
<div class="paragraph">
<p>Les workers : Ils vont exécuter les tâches confiées par les managers. Un agent s&#8217;exécute sur chaque nœud et rend compte des tâches qui lui sont affectées. Il informe ainsi les nodes managers de l&#8217;état des tâches affectées.</p>
</div>
<div class="paragraph">
<p>Il faut suivre les étapes suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker swarm init</code></pre>
</div>
</div>
</li>
<li>
<p>Le résultat de la commande donne la commande <code>docker swarm join</code> a exécuter sur un "worker"  pour lui faire rejoindre le "swarm". A noter que le "manager" que nous venons de creer est aussi un worker. De ce fait, un swarm peut être installé de façon standalone sur un VPS.</p>
</li>
<li>
<p>Vous pouvez maintenant vérifier l&#8217;état de votre cluster. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker node ls</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_choix_des_images_docker">13.5. Choix des images docker</h3>
<div class="paragraph">
<p>Les images docker sont accessibles sur le <a href="https://hub.docker.com/">Docker Hub</a>.</p>
</div>
<div class="paragraph">
<p>Mais voilà, c&#8217;est un peu la jungle. Un bon moyen de trouver des images à jour d&#8217;un point de vue sécurité et non compromises est de ne sélectionner que des images "Docker Certified" ou "Verified Publisher" ou "Official Images".</p>
</div>
<div class="paragraph">
<p>Du moins on est sûr que ces images ont été à minima vérifiées par les équipes Docker.</p>
</div>
<div class="paragraph">
<p>Pour mémoire: <strong>Le nombre de chargement d&#8217;une image n&#8217;est pas un gage de qualité !</strong></p>
</div>
<div class="paragraph">
<p>Si vous n&#8217;utilisez pas une image du type mentionné ci dessus, l&#8217;accès facile au fichier Dockerfile est un gage de qualité et de transparence. En tout cas, il vous sera facilement possible de regarder comment l&#8217;image est construite et quels sont les package dockers de base et si ces packages dockers de base sont récents et certifiés.</p>
</div>
<div class="paragraph">
<p>Pour les plateformes de type Raspberry, il faut bien vérifier que l&#8217;image docker que vous chargez est compatible de votre plateforme. Sur Docker Hub, vous devez allez sur l&#8217;onglet Tag de votre package et vérifier que le champ OS/ARCH contient bien votre plateforme.</p>
</div>
<div class="paragraph">
<p>Pour un Raspberry Pi 4 ce doit être: <code>Linux/arm64</code></p>
</div>
<div class="paragraph">
<p>Pour un Raspberry Pi 3 ce doit être: <code>Linux/arm</code></p>
</div>
<div class="paragraph">
<p>Par exemple pour les docker de <code>Yacht</code> et de <code>Portainer</code> décrits ci après, on peut voir que les containers sont multiplateforme et conviennent très bien pour de l&#8217;Intel ou de l&#8217;ARM.</p>
</div>
</div>
<div class="sect2">
<h3 id="_mise_à_jour_automatique_des_images">13.6. Mise à jour automatique des images</h3>
<div class="paragraph">
<p>Vos images docker peuvent être mise à jour automatiquement si vous les avez installés à partir du docker hub ou de n&#8217;importe quel autre repository compatible.</p>
</div>
<div class="paragraph">
<p>Un outil automatise cette mise à jour c&#8217;est <a href="https://github.com/pyouroboros/ouroboros">ouroboros</a>.</p>
</div>
<div class="paragraph">
<p>Pour l&#8217;installe, rien de plus simple:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker run -d --name ouroboros -e <span class="tok-nv">CLEANUP</span><span class="tok-o">=</span><span class="tok-nb">true</span> -e <span class="tok-nv">LATEST</span><span class="tok-o">=</span><span class="tok-nb">true</span> -e <span class="tok-nv">SELF_UPDATE</span><span class="tok-o">=</span><span class="tok-nb">true</span> --restart<span class="tok-o">=</span>always -v /var/run/docker.sock:/var/run/docker.sock pyouroboros/ouroboros</code></pre>
</div>
</div>
</li>
<li>
<p>Les options <code>CLEANUP</code>, <code>LATEST</code> et <code>SELF_UPDATE</code> sont respectivement pour effacer les anciennes images docker, coller les containeurs à la version <code>latest</code> du repository et effectuer une mise à jour automatique de ouroboros.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>La documentation de ouroboros est <a href="https://github.com/pyouroboros/ouroboros/wiki/Usage">ici</a>.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Ouroboros n&#8217;est plus maintenu depuis fin 2019. Une alternative est à trouver.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_yacht">13.7. Installation de Yacht</h3>
<div class="paragraph">
<p>Yacht est un outil d&#8217;administration de vos instances docker sous forme de site web. Yacht est très facile d&#8217;utilisation mais manque de possibilités du moins dans la version actuelle. Si vous souhaitez administrer de façon plus avancée vos instances docker, il est conseillé d&#8217;utiliser Portainer.</p>
</div>
<div class="paragraph">
<p>Yacht s’installe comme un conteneur docker pour simplifier son déploiement.</p>
</div>
<div class="paragraph">
<p>Pour la création du site web, il faut suivre les étapes suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans ISPConfig dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>yacht</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>yacht</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>yacht</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># yacht httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPass</span> / http://localhost:8061/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:8061/

<span class="tok-nb">RedirectMatch</span> ^/$ https://yacht.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Puis sur votre serveur, <a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker volume create yacht_data
docker run -d -p <span class="tok-m">8061</span>:8000 -v /var/run/docker.sock:/var/run/docker.sock --restart<span class="tok-o">=</span>always -v yacht_data:/config selfhostedpro/yacht</code></pre>
</div>
</div>
</li>
<li>
<p>Ouvrez un navigateur et pointez sur <a href="http://yacht.example.com" class="bare">http://yacht.example.com</a></p>
</li>
<li>
<p>L&#8217;utilisateur par défaut est login: <code>admin@yacht.local</code> et mot de passe: <code>pass</code>.</p>
</li>
<li>
<p>Une fois loggué, Cliquez sur l&#8217;utilisateur en haut à droite et <code>user</code>.</p>
</li>
<li>
<p>Cliquez sur <code>change password</code></p>
</li>
<li>
<p>Modifier votre Email de login et saisissez un nouveau mot de passe.</p>
</li>
<li>
<p>Cliquez ensuite sur <code>Templates</code> dans la barre vertical de gauche puis sur <code>New templates</code></p>
</li>
<li>
<p>Copiez la suggestion de template proposée.</p>
</li>
<li>
<p>Saisissez un titre <code>Yacht</code> dans le champ <code>Title</code> puis collez l&#8217;URL du json dans le champ <code>URL</code></p>
</li>
<li>
<p>Cliquez sur Submit.</p>
</li>
<li>
<p>Allez dans <code>Templates</code> &#8594; <code>View Templates</code>.</p>
</li>
<li>
<p>cliquez sur <code>Yacht</code>; vous avez maintenant accès à une foule de templates.</p>
</li>
<li>
<p>Vous pouvez maintenant administrer vos machines docker. Référez vous à la documentation de <a href="https://yacht.sh/Pages/dashboard/">Yacht</a> pour installer de nouvelles machines docker</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_portainer">13.8. Installation de Portainer</h3>
<div class="paragraph">
<p>Portainer est un outil d&#8217;administration de vos instances docker sous forme de site web. Portainer est plus complexe à utiliser que Yacht, mais offre cependant beaucoup plus de possibilités.</p>
</div>
<div class="paragraph">
<p>Portainer s’installe comme un conteneur docker pour simplifier son déploiement. Portainer gère une bonne partie des éléments de docker : conteneurs, images, volumes, réseaux, utilisateurs</p>
</div>
<div class="paragraph">
<p>Pour la création du site web, il faut suivre les étapes suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans ISPConfig dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>portainer</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>portainer</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>portainer</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># yacht httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPass</span> / http://localhost:9050/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:9050/

<span class="tok-nb">RedirectMatch</span> ^/$ https://portainer.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Puis sur votre serveur, <a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>docker volume create portainer_data
docker run -d -p <span class="tok-m">8060</span>:8000 -p <span class="tok-m">9050</span>:9000 --name<span class="tok-o">=</span>portainer --restart<span class="tok-o">=</span>always -v /var/run/docker.sock:/var/run/docker.sock -v portainer_data:/data portainer/portainer-ce</code></pre>
</div>
</div>
</li>
<li>
<p>Ouvrez un navigateur et pointez sur <a href="http://portainer.example.com" class="bare">http://portainer.example.com</a></p>
</li>
<li>
<p>Créez votre utilisateur de <code>admin</code> avec un mot de passe sécurisé.</p>
</li>
<li>
<p>Ajoutez un endpoint <code>Local</code></p>
</li>
<li>
<p>Vous pouvez maintenant administrer vos machines docker. Référez vous à la documentation de <a href="https://documentation.portainer.io/v2.0/stacks/create/">portainer</a> pour installer de nouvelles machines docker</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Portainer offre la possibilité d&#8217;installer des templates par défaut. Vous pouvez soit garder le repository par défault : <code><a href="https://raw.githubusercontent.com/portainer/templates/master/templates-2.0.json" class="bare">https://raw.githubusercontent.com/portainer/templates/master/templates-2.0.json</a></code> ou utiliser un autre repository comme: <code><a href="https://raw.githubusercontent.com/Qballjos/portainer_templates/master/Template/template.json" class="bare">https://raw.githubusercontent.com/Qballjos/portainer_templates/master/Template/template.json</a></code>:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>allez sur votre site web portainer.</p>
</li>
<li>
<p>puis dans le menu Settings</p>
</li>
<li>
<p>Dans la zone <code>App Templates</code> saisissez le repository de votre choix dans le champ <code>URL</code></p>
</li>
<li>
<p>Cliquez sur <code>Save Settings</code></p>
</li>
<li>
<p>retournez dans le menu <code>App Templates</code>; vos nouveau templates sont maintenant affichés.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_des_cms_joomla_et_concrete5">14. Installation des CMS Joomla et Concrete5</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Joomla est un CMS très connu écrit en PHP. Il est fréquemment mis à jour et inclut une foule de plugins
Concrete5 est un autre CMS assez connu  avec un design plus moderne.</p>
</div>
<div class="paragraph">
<p>L&#8217;installation s&#8217;effectue à 100% avec ISPConfig.
Dans la procédure ci dessous qui est taillée pour Joomla, vous pouvez l&#8217;appliquer à l&#8217;identique pour concrete5 en remplacant les textes joomla par concrete5.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_joomla">14.1. Création du site web de Joomla</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>joomla</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>joomla</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>joomla</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_lapplication_joomla">14.2. Création de l&#8217;application Joomla</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Update Packagelist</code>.</p>
</li>
<li>
<p>Cliquez sur <code>Update Packagelist</code></p>
</li>
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Available packages</code>.</p>
</li>
<li>
<p>Faites une recherche par <code>Name</code>. Tapez <code>joomla</code></p>
</li>
<li>
<p>Cliquez sur le package <code>joomla</code></p>
</li>
<li>
<p>Cliquez sur <code>Install this package</code></p>
</li>
<li>
<p>Remplissez tous les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Install location:</code> &#8592; choisissez votre domain (<code>example.com</code>) et laissez vide le chemin.</p>
</li>
<li>
<p><code>New database password</code> &#8592; gardez ce qui est remplit</p>
</li>
<li>
<p><code>Administrator&#8217;s login</code> &#8592; gardez ce qui est remplit: <code>admin</code></p>
</li>
<li>
<p><code>Password</code> et <code>Repeat Password</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Default site language:</code> &#8592; choisissez <code>French</code></p>
</li>
<li>
<p><code>I accept the license</code> &#8592; cochez la case</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Install</code></p>
</li>
<li>
<p>Pointez votre navigateur sur <a href="https://example.com/" class="bare">https://example.com/</a> et loguez vous <code>admin</code> avec votre mot de passe saisi, c&#8217;est fait !</p>
</li>
<li>
<p>N&#8217;oubliez pas d&#8217;administrer le site et de le mettre à jour avec la dernière version de Joomla.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_portail_wiki_mediawiki">15. Installation du portail wiki Mediawiki</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Mediawiki est le portail wiki mondialement connu et utilisé notamment pour le site wikipedia.</p>
</div>
<div class="paragraph">
<p>L&#8217;installation s&#8217;effectue à 100% avec ISPConfig.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_mediawiki">15.1. Création du site web de Mediawiki</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>mediawiki</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>mediawiki</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>mediawiki</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_lapplication_mediawiki">15.2. Création de l&#8217;application Mediawiki</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Update Packagelist</code>.</p>
</li>
<li>
<p>Cliquez sur <code>Update Packagelist</code></p>
</li>
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Available packages</code>.</p>
</li>
<li>
<p>Faites une recherche par <code>Name</code>. Tapez <code>mediawiki</code></p>
</li>
<li>
<p>Cliquez sur le package <code>mediawiki</code></p>
</li>
<li>
<p>Cliquez sur <code>Install this package</code></p>
</li>
<li>
<p>Remplissez tous les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Install location:</code> &#8592; choisissez votre domain (<code>example.com</code>) et laissez vide le chemin.</p>
</li>
<li>
<p><code>New database password</code> &#8592; gardez ce qui est remplit</p>
</li>
<li>
<p><code>Administrator&#8217;s login</code> &#8592; gardez ce qui est remplit: <code>admin</code></p>
</li>
<li>
<p><code>Password</code> et <code>Repeat Password</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Default site language:</code> &#8592; choisissez <code>French</code></p>
</li>
<li>
<p><code>I accept the license</code> &#8592; cochez la case</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Install</code></p>
</li>
<li>
<p>Pointez votre navigateur sur <a href="https://example.com/" class="bare">https://example.com/</a> et loguez vous <code>admin</code> avec votre mot de passe saisi, c&#8217;est fait !</p>
</li>
<li>
<p>N&#8217;oubliez pas d&#8217;administrer le site et de le mettre à jour avec la dernière version de Mediawiki.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_dun_gestionnaire_de_blog_wordpress">16. Installation d&#8217;un gestionnaire de Blog Wordpress</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Wordpress est un CMS très connu écrit en PHP. Il est fréquemment mis à jour.</p>
</div>
<div class="paragraph">
<p>L&#8217;installation s&#8217;effectue à 100% avec ISPConfig.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_wordpress">16.1. Création du site web de Wordpress</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>wordpress</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>wordpress</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>wordpress</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_lapplication_wordpress">16.2. Création de l&#8217;application Wordpress</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Update Packagelist</code>.</p>
</li>
<li>
<p>Cliquez sur <code>Update Packagelist</code></p>
</li>
<li>
<p>Allez dans la rubrique <code>Sites</code>, le menu <code>Available packages</code>.</p>
</li>
<li>
<p>Faites une recherche par <code>Name</code>. Tapez <code>wordpress</code></p>
</li>
<li>
<p>Cliquez sur le package <code>wordpress</code></p>
</li>
<li>
<p>Cliquez sur <code>Install this package</code></p>
</li>
<li>
<p>Remplissez tous les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Install location:</code> &#8592; choisissez votre domain (<code>example.com</code>) et laissez vide le chemin.</p>
</li>
<li>
<p><code>New database password</code> &#8592; gardez ce qui est remplit</p>
</li>
<li>
<p><code>Administrator&#8217;s login</code> &#8592; gardez ce qui est remplit: <code>admin</code></p>
</li>
<li>
<p><code>Password</code> et <code>Repeat Password</code> &#8592; Tapez <a href="#pass_gen">votre mot de passe généré</a></p>
</li>
<li>
<p><code>Default site language:</code> &#8592; choisissez <code>French</code></p>
</li>
<li>
<p><code>I accept the license</code> &#8592; cochez la case</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Install</code></p>
</li>
<li>
<p>Pointez votre navigateur sur <a href="https://&lt;example.com&gt;/" class="bare">https://&lt;example.com&gt;/</a> et loguez vous <code>admin</code> avec votre mot de passe saisi, c&#8217;est fait !</p>
</li>
<li>
<p>N&#8217;oubliez pas d&#8217;administrer le site et de le mettre à jour avec la dernière version de Wordpress.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_cms_micro_weber">17. Installation du CMS Micro Weber</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Microweber est un système de gestion de contenu et un constructeur de sites web Open Source. Il est basé sur le langage de programmation PHP et le framework web Laravel 5, utilisant le glisser-déposer et permettant aux utilisateurs de créer rapidement du contenu, tout en programmant et en gérant plusieurs affichages. Il dispose d&#8217;une fonction d&#8217;édition en direct qui permet aux utilisateurs de visualiser leurs modifications telles qu&#8217;elles apparaîtraient.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_microweber">17.1. Création du site web de Microweber</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>microweber</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>microweber</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>microweber</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_bases_de_données">17.2. Création des bases de données</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une base de données mysql. Aller dans le menu <code>Database</code> pour définir un utilisateur MariaDB</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>microweber</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; <a href="#pass_gen">Saisissez un mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; saisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données <code>microweber</code></p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxmicroweber</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_microweber">17.3. Installation de Microweber</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="command"><span></span>cd /var/www/microweber.example.com/microweber <i class="conum" data-value="1"></i><b>(1)</b>
wget https://raw.githubusercontent.com/microweber-dev/webinstall/master/webinstall.php</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Un fois téléchargé, faites pointer votre navigateur vers <a href="http://microweber.example.com/netinstall.php" class="bare">http://microweber.example.com/netinstall.php</a></p>
</li>
<li>
<p>Indique <code>.</code> comme répertoire d&#8217;installation et cliquez sur <code>Télécharger et décompresser Piwigo</code></p>
</li>
<li>
<p>Une fois le téléchargement terminé cliquez sur <code>Installer Microweber</code>. Rechargez la page si besoin.</p>
</li>
<li>
<p>Répondez aux questions suivantes:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hote</code> &#8592; Laissez <code>localhost</code></p>
</li>
<li>
<p><code>Utilisateur</code> &#8592; entrez <code>cxmicroweber</code>. x est le numéro de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>Mot de passe</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Nom de la Base de données</code> &#8592; entrez <code>cxmicroweber</code>. x est le numéro de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>Préfix des noms de tables</code> &#8592; Laissez le champ vide</p>
</li>
<li>
<p><code>Nom d&#8217;Utilisateur</code> &#8592; tapez <code>admin</code></p>
</li>
<li>
<p><code>Mot de passe</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Mot de passe [confirmer]</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Adresse e-mail</code> &#8592; Tapez votre adresse mail d&#8217;administrateur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tapez <code>Démarrer l&#8217;installation</code></p>
</li>
<li>
<p>Vous êtes redirigé sur le site Microweber ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_gestionnaire_de_photos_piwigo">18. Installation du gestionnaire de photos Piwigo</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Piwigo est une application web pour gérer votre collection de photos, et autres médias. Doté de puissantes fonctionnalités, il gère des galeries partout dans le monde. Elle est écrite en PHP et nécessite une base de données MySQL.</p>
</div>
<div class="paragraph">
<p>Piwigo était auparavant connu sous le nom PhpWebGallery.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_piwigo">18.1. Création du site web de Piwigo</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>piwigo</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>piwigo</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>piwigo</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_bases_de_données_2">18.2. Création des bases de données</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une base de données mysql. Aller dans le menu <code>Database</code> pour définir un utilisateur MariaDB</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>piwigo</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; saisir  <a href="#pass_gen">un mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; saisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données <code>piwigo</code></p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxpiwigo</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_piwigo">18.3. Installation de Piwigo</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez la commande suivante:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /var/www/piwigo.example.com/piwigo <i class="conum" data-value="1"></i><b>(1)</b>
wget http://piwigo.org/download/dlcounter.php?code=netinstall -O piwigo-netinstall.php</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Un fois téléchargé, faites pointer votre navigateur vers <a href="http://piwigo.example.com/piwigo-netinstall.php" class="bare">http://piwigo.example.com/piwigo-netinstall.php</a></p>
</li>
<li>
<p>Indique <code>.</code> comme répertoire d&#8217;installation et cliquez sur <code>Téléharger et décompresser Piwigo</code></p>
</li>
<li>
<p>Une fois le téléchargement terminé cliquez sur <code>Installer Piwigo</code>. Rechargez la page si besoin.</p>
</li>
<li>
<p>Répondez aux questions suivantes:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hote</code> &#8592; Laissez <code>localhost</code></p>
</li>
<li>
<p><code>Utilisateur</code> &#8592; entrez <code>cxpiwigo</code>. x est le numero de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>Mot de passe</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Nom de la Base de données</code> &#8592; entrez <code>cxpiwigo</code>. x est le numero de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>Préfix des noms de tables</code> &#8592; Laissez le champ vide</p>
</li>
<li>
<p><code>Nom d&#8217;Utilisateur</code> &#8592; tapez <code>admin</code></p>
</li>
<li>
<p><code>Mot de passe</code> &#8592; Tapez <a href="#pass_gen">votre mot de passe généré</a></p>
</li>
<li>
<p><code>Mot de passe [confirmer]</code> &#8592; Retapez votre mot de passe</p>
</li>
<li>
<p><code>Adresse e-mail</code> &#8592; Tapez votre adresse mail d&#8217;administrateur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Tapez <code>Démarrer l&#8217;installation</code></p>
</li>
<li>
<p>Vous êtes redirigé sur le site piwigo ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</p>
</li>
</ol>
</div></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_système_collaboratif_nextcloud">19. Installation du système collaboratif Nextcloud</h2>
<div class="sectionbody">
<div class="paragraph">
<p>NextCloud est un serveur d&#8217;hébergement et de partage de fichiers gratuit et open source, fork du projet ownCloud.
Il est très similaire aux autres systèmes de partage de fichiers des services comme Google Drive, Dropbox et iCloud ou Seafile.
NextCloud vous permet de stocker des fichiers, des documents, des photos, des films et des vidéos à partir de la centrale l&#8217;emplacement.
Avec NextCloud, vous pouvez partager des fichiers, des contacts et tout autre les médias avec vos amis et vos clients.
NextCloud s&#8217;intègre avec le courrier, calendrier, contacts et autres fonctionnalités qui aideront vos équipes à obtenir leur travail est plus rapide et plus facile.
Vous pouvez installer le client NextCloud sur un  ou plusieurs PC pour synchroniser les fichiers avec votre serveur Nextcloud.
Des clients sont disponibles pour la plupart des systèmes d&#8217;exploitation, y compris Windows, macOS, FreeBSD, et Linux.</p>
</div>
<div class="sect2">
<h3 id="_installation_initiale">19.1. Installation initiale</h3>
<div class="paragraph">
<p>NextCloud est écrit en PHP et utilise une base de données MariaDB pour stocker ses données.</p>
</div>
<div class="paragraph">
<p>Pour installer, Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez quelques paquets de base. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt-get install  php-cgi php-curl</code></pre>
</div>
</div>
</li>
<li>
<p>Une fois installé, éditez le fichier php.ini pour changer quelques limitations. Tapez:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>vi /etc/php/7.3/apache2/php.ini</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cherchez les champs ci dessous et changez les valeurs comme suit:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-na">memory_limit</span> <span class="tok-o">=</span> <span class="tok-s">512M</span>
<span class="tok-na">upload_max_filesize</span> <span class="tok-o">=</span> <span class="tok-s">500M</span>
<span class="tok-na">post_max_size</span> <span class="tok-o">=</span> <span class="tok-s">500M</span>
<span class="tok-na">max_execution_time</span> <span class="tok-o">=</span> <span class="tok-s">300</span>
<span class="tok-na">date.timezone</span> <span class="tok-o">=</span> <span class="tok-s">Asia/Kolkata</span></code></pre>
</div>
</div>
</li>
<li>
<p>Sauvez et redémarrez apache. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="command"><span></span>systemctl restart apache2</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_nextcloud">19.2. Création du site web de Nextcloud</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>nextcloud</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>nextcloud</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>nextcloud</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>PHP-FPM</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_bases_de_données_3">19.3. Création des bases de données</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une base de données mysql. Aller dans le menu <code>Database</code> pour définir un utilisateur MariaDB</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>nextcloud</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; saisir <a href="#pass_gen">un mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; saisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données <code>nextcloud</code></p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxnextcloud</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_nextcloud">19.4. Installation de Nextcloud</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez la commande suivante:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre>cd /var/www/nextcloud.example.com/nextcloud <i class="conum" data-value="1"></i><b>(1)</b>
wget https://download.nextcloud.com/server/installer/setup-nextcloud.php</pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Un fois téléchargé, faites pointer votre navigateur vers <a href="http://nextcloud.example.com/setup-nextcloud.php" class="bare">http://nextcloud.example.com/setup-nextcloud.php</a></p>
</li>
<li>
<p>Indique <code>.</code> comme répertoire d&#8217;installation et cliquez sur <code>Next</code></p>
</li>
<li>
<p>Une fois le téléchargement terminé cliquez sur <code>Next</code>. Rechargez la page si besoin.</p>
</li>
<li>
<p>Répondez aux questions suivantes:</p>
<div class="ulist">
<ul>
<li>
<p><code>Login Admin</code> &#8592; tapez <code>admin</code></p>
</li>
<li>
<p><code>Password Admin</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p>ouvrez <code>Stockage et base de données</code></p>
</li>
<li>
<p><code>Configurer la base de données</code> &#8592; cliquez sur <code>MariaDB</code></p>
</li>
<li>
<p><code>Utilisateur de la Base de données</code> &#8592; entrez <code>cxnextcloud</code>. x est le numero de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>Password de la Base de données</code> &#8592; Tapez votre mot de passe</p>
</li>
<li>
<p><code>Nom de la Base de données</code> &#8592; entrez <code>cxnextcloud</code>. x est le numéro de client; habituellement c&#8217;est 0</p>
</li>
<li>
<p><code>nom du serveur</code> &#8592; Laissez <code>Localhost</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Tapez <code>Next</code></p>
</li>
<li>
<p>Vous êtes redirigé sur le site nextcloud ou vous pourrez vous loguer et commencer à utiliser l&#8217;outil</p>
</li>
</ol>
</div></td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_gestionnaire_de_projet_gitea">20. Installation du gestionnaire de projet Gitea</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Gitea est un système simple d&#8217;hébergement de code basé sur Git. C&#8217;est un fork de Gogs.
Il montre des fonctionnalités similaires à gitlab ou github tout en gardant un code plus simple.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_gitea">20.1. Création du site web de Gitea</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>gitea</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>gitea</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>gitea</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># gitea httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPass</span> / http://localhost:3000/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:3000/

<span class="tok-nb">RedirectMatch</span> ^/$ https://gitea.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Créez un utilisateur <code>Gitea</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>adduser --system --disabled-password --group --shell /bin/bash --home /home/gitea gitea</code></pre>
</div>
</div>
</li>
<li>
<p>Créez la structure de répertoire de <code>Gitea</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /var/lib/gitea/<span class="tok-o">{</span>data,log<span class="tok-o">}</span> /etc/gitea /run/gitea</code></pre>
</div>
</div>
</li>
<li>
<p>Donnez les bonnes permissions aux répertoires. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chown -R gitea:gitea /var/lib/gitea
chown -R gitea:gitea /run/gitea
chown -R root:gitea /etc/gitea
chmod -R <span class="tok-m">750</span> /var/lib/gitea
chmod <span class="tok-m">770</span> /etc/gitea</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_bases_de_données_4">20.2. Création des bases de données</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une base de données mysql. Aller dans le menu <code>Database</code> pour définir un utilisateur MariaDB</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>gitea</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; <a href="#pass_gen">Saisissez un mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; saisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données <code>gitea</code></p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxgitea</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_téléchargez_et_installez_gitea">20.3. Téléchargez et installez Gitea</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Téléchargez gitea du <a href="https://dl.gitea.io/gitea/">site de chargement</a>. Tapez pour un système 64 bits:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>wget https://dl.gitea.io/gitea/master/gitea-master-linux-amd64 -O /usr/local/bin/gitea
chmod <span class="tok-m">755</span> /usr/local/bin/gitea</code></pre>
</div>
</div>
</li>
<li>
<p>Créez maintenant une entrée pour le launcher systemd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/gitea.service</code></pre>
</div>
</div>
</li>
<li>
<p>y Coller le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[Unit]</span>
<span class="tok-na">Description</span><span class="tok-o">=</span><span class="tok-s">Gitea (Git with a cup of tea)</span>
<span class="tok-na">After</span><span class="tok-o">=</span><span class="tok-s">syslog.target</span>
<span class="tok-na">After</span><span class="tok-o">=</span><span class="tok-s">network.target</span>
<span class="tok-na">Requires</span><span class="tok-o">=</span><span class="tok-s">mysqld.service</span>
<span class="tok-k">[Service]</span>
<span class="tok-na">Type</span><span class="tok-o">=</span><span class="tok-s">simple</span>
<span class="tok-na">User</span><span class="tok-o">=</span><span class="tok-s">gitea</span>
<span class="tok-na">Group</span><span class="tok-o">=</span><span class="tok-s">gitea</span>
<span class="tok-na">WorkingDirectory</span><span class="tok-o">=</span><span class="tok-s">/var/lib/gitea/</span>
<span class="tok-na">RuntimeDirectory</span><span class="tok-o">=</span><span class="tok-s">gitea</span>
<span class="tok-na">ExecStart</span><span class="tok-o">=</span><span class="tok-s">/usr/local/bin/gitea web -c /etc/gitea/app.ini</span>
<span class="tok-na">Restart</span><span class="tok-o">=</span><span class="tok-s">always</span>
<span class="tok-na">Environment</span><span class="tok-o">=</span><span class="tok-s">USER=gitea HOME=/home/gitea GITEA_WORK_DIR=/var/lib/gitea</span>
<span class="tok-k">[Install]</span>
<span class="tok-na">WantedBy</span><span class="tok-o">=</span><span class="tok-s">multi-user.target</span></code></pre>
</div>
</div>
</li>
<li>
<p>Recharge la base de systemd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl daemon-reload</code></pre>
</div>
</div>
</li>
<li>
<p>Activez et démarrez <code>Gitea</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl <span class="tok-nb">enable</span> gitea.service
systemctl start gitea.service</code></pre>
</div>
</div>
</li>
<li>
<p>Ouvrez votre navigateur sur l&#8217;url: <a href="https://gitea.example.com/install" class="bare">https://gitea.example.com/install</a> et remplissez les paramètres comme ci-après :</p>
<div class="ulist">
<ul>
<li>
<p><code>Type de base de données:</code> &#8592; Sélectionnez <code>MySQL</code></p>
</li>
<li>
<p><code>Nom d&#8217;utilisateur:</code> &#8592; Tapez <code>c0gitea</code></p>
</li>
<li>
<p><code>Mot de passe:</code> &#8592;  Tapez le mot de passe saisi lors de la création de la base</p>
</li>
<li>
<p><code>Nom de base de données:</code> &#8592; Tapez <code>c0gitea</code></p>
</li>
<li>
<p><code>Titre du site:</code> &#8592; mettez une titre de votre choix</p>
</li>
<li>
<p><code>Emplacement racine des dépôts:</code> &#8592; saisissez <code>/home/gitea/gitea-repositories</code></p>
</li>
<li>
<p><code>Répertoire racine Git LFS:</code> &#8592; Tapez <code>/var/lib/gitea/data/lfs</code></p>
</li>
<li>
<p><code>Exécuter avec le compte d&#8217;un autre utilisateur :</code> &#8592; Tapez <code>gitea</code></p>
</li>
<li>
<p><code>Domaine du serveur SSH:</code> &#8592; Tapez votre domaine. exemple : <code>gitea.example.com</code></p>
</li>
<li>
<p><code>Port du serveur SSH:</code> &#8592; Tapez 22</p>
</li>
<li>
<p><code>Port d&#8217;écoute HTTP de Gitea:</code> &#8592; Tapez 3000</p>
</li>
<li>
<p><code>URL de base de Gitea:</code> &#8592; Tapez l&#8217;URL de votre domaine. Exemple: <code><a href="https://gitea.example.com" class="bare">https://gitea.example.com</a></code></p>
</li>
<li>
<p><code>Chemin des fichiers log:</code> &#8592; Tapez  <code>/var/lib/gitea/log</code></p>
</li>
<li>
<p><code>Hôte SMTP:</code> &#8592; Tapez <code>localhost</code></p>
</li>
<li>
<p><code>Envoyer les e-mails en tant que:</code> &#8592; Tapez <code>gitea@gitea.example.com</code></p>
</li>
<li>
<p><code>Exiger la confirmation de l&#8217;e-mail lors de l&#8217;inscription:</code> &#8592; cochez la case</p>
</li>
<li>
<p><code>Activez les notifications par e-mail:</code> &#8592; cochez la case</p>
</li>
<li>
<p><code>Désactiver le formulaire d&#8217;inscription:</code> &#8592; cochez la case</p>
</li>
<li>
<p><code>Masquer les adresses e-mail par défaut:</code> &#8592; cochez la case</p>
</li>
</ul>
</div>
</li>
<li>
<p>Laissez le reste et cliquez sur <code>Install Gitea</code>.</p>
</li>
<li>
<p>Restreignez les permissions sur le fichier de configuration de gitea. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">750</span> /etc/gitea
chown root:gitea /etc/gitea/app.ini
chmod <span class="tok-m">640</span> /etc/gitea/app.ini</code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez <code>gitea</code>.</p>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart gitea.service</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_activer_une_connexion_ssh_dédiée">20.4. Activer une connexion SSH dédiée</h3>
<div class="paragraph">
<p>En option, vous pouvez avoir envie de dédier une connexion SSH pour Gitea:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Éditez le fichier de configuration. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/gitea/app.ini</code></pre>
</div>
</div>
</li>
<li>
<p>Trouvez les lignes suivantes et les remplacer dans le fichier. Chercher et remplacez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">START_SSH_SERVER</span> <span class="tok-o">=</span> <span class="tok-nb">true</span>
<span class="tok-nv">SSH_PORT</span> <span class="tok-o">=</span> <span class="tok-m">2222</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettez ici le numéro de port que vous souhaitez</td>
</tr>
</table>
</div>
</li>
<li>
<p>Débloquez le port 2222 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 2222</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Redémarrez <code>gitea</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart gitea.service</code></pre>
</div>
</div>
</li>
<li>
<p>Enjoy !</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_système_de_partage_de_fichiers_seafile">21. Installation du système de partage de fichiers Seafile</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Seafile est un système de partage de fichier simple et efficace écrit en Python. Il existe des clients de connexion pour Windows, Linux, Android, IOS.</p>
</div>
<div class="paragraph">
<p>Cette installation est optionnelle.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_seafile">21.1. Création du site web de Seafile</h3>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>seafile</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>seafile</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>seafile</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># Seafile configuration</span>

<span class="tok-nb">Alias</span> <span class="tok-sx">/media</span> {DOCROOT}/private/seafile/seafile-server-latest/seahub/media
<span class="tok-nb">RewriteEngine</span> <span class="tok-k">On</span>

<span class="tok-nt">&lt;Location</span> <span class="tok-s">/media</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Require</span> <span class="tok-k">all</span> granted
<span class="tok-nt">&lt;/Location&gt;</span>

<span class="tok-c"># seafile httpserver</span>
<span class="tok-c">#</span>
<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/seafhttp</span> http://localhost:8092
<span class="tok-nb">ProxyPassReverse</span> <span class="tok-sx">/seafhttp</span> http://localhost:8092
<span class="tok-nb">RewriteRule</span> ^/seafhttp - [QSA,L]

<span class="tok-c"># seahub</span>
<span class="tok-c">#</span>
<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>
<span class="tok-nb">ProxyPass</span> / http://localhost:8090/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:8090/</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_de_bases_de_données">21.2. Création de bases de données</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Loguez vous sur ISPConfig</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>seafile</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; Saisir <a href="#pass_gen">votre mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; Resaisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Aller dans le menu <code>Database</code> pour définir les bases de données</p>
</li>
<li>
<p>Appliquer l&#8217;opération ci après 3 fois d&#8217;affilée pour créer les trois bases suivantes: <code>ccnetdb</code>, <code>seafiledb</code>, <code>seahubdb</code></p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données</p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxseafile</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Les trois bases de données doivent apparaître dans la liste des bases</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_téléchargez_et_installez_seafile">21.3. Téléchargez et installez Seafile</h3>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Installez quelques paquets Debian complémentaires. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install python3 python3-setuptools python3-pip
pip3 install --timeout<span class="tok-o">=</span><span class="tok-m">3600</span> Pillow pylibmc captcha jinja2 sqlalchemy psd-tools django-pylibmc django-simple-captcha python3-ldap</code></pre>
</div>
</div>
</li>
<li>
<p>Je préfère faire tourner mes serveurs dans le répertoire privé plutôt que dans le répertoire web pour des questions de sécurité. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/seafile.example.com/private <i class="conum" data-value="1"></i><b>(1)</b>
mkdir seafile
<span class="tok-nb">cd</span> seafile
wget https://s3.eu-central-1.amazonaws.com/download.seadrive.org/seafile-server_7.1.3_x86-64.tar.gz
tar zxvf seafile-server_7.1.3_x86-64.tar.gz
mkdir installed
mv seafile-server_* installed
<span class="tok-nb">cd</span> seafile-server-*
./setup-seafile-mysql.sh
<span class="tok-nb">cd</span> ../..
chown -R web1:client0 seafile <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>choisissez le user et le groupe de votre site web. Ces informations sont consultables dans ISPConfig en consultant les informations du Web Domain&#8594;onglet <code>Options</code>&#8594;champs Linux User et Linux Group.</td>
</tr>
</table>
</div>
</li>
<li>
<p>A ce moment, vous devez répondre à un certain nombre de questions.</p>
</li>
<li>
<p>Choisissez le mode de configuration 2) pour indiquer vous même les informations sur les bases de données créées.</p>
</li>
<li>
<p>Vous devrez ensuite donner le nom d&#8217;utilisateur pour la base de données, le mot de passe ainsi que le nom des 3 bases de données.</p>
</li>
<li>
<p>Si tout est saisi correctement le programme doit donner une synthèse de ce qui a été configuré</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_lancement_initial">21.4. Lancement initial</h3>
<div class="paragraph">
<p>Nous allons effectuer un premier lancement du serveur Seafile:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>allez dans le répertoire contenant les configurations et éditez <code>gunicorn.conf</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/seafile.example.com/private/seafile/conf <i class="conum" data-value="1"></i><b>(1)</b>
vi gunicorn.conf</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Repèrez le texte <code>bind=</code> et mettez un numéro de port 8090 à la place de 8000. Comme ceci:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">bind</span> <span class="tok-o">=</span> <span class="tok-s2">&quot;127.0.0.1:8090&quot;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Editez le fichier <code>seafile.conf</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi seafile.conf</code></pre>
</div>
</div>
</li>
<li>
<p>mettez un port 8092 au lieu du port 8082 saisi pour l&#8217;entrée <code>fileserver</code>. Le fichier doit contenir ceci:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="ini"><span></span><span class="tok-k">[fileserver]</span>
<span class="tok-na">port</span> <span class="tok-o">=</span> <span class="tok-s">8092</span></code></pre>
</div>
</div>
</li>
<li>
<p>Editez le fichier <code>ccnet.conf</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi ccnet.conf</code></pre>
</div>
</div>
</li>
<li>
<p>modifier l&#8217;entrée SERVICE_URL. Le fichier doit contenir ceci:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nv">SERVICE_URL</span> <span class="tok-o">=</span> https://seafile.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Editez le fichier <code>seahub_settings.py</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi seahub_settings.py</code></pre>
</div>
</div>
</li>
<li>
<p>modifier l&#8217;entrée FILE_SERVER_ROOT. Le fichier doit contenir ceci:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-n">FILE_SERVER_ROOT</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;https://seafile.example.com/seafhttp&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Démarrez Seafile. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/seafile.example.com/private/seafile/seafile-server-latest <i class="conum" data-value="1"></i><b>(1)</b>
sudo -u web1 ./seafile.sh start <i class="conum" data-value="2"></i><b>(2)</b>
sudo -u web1 ./seahub.sh start <span class="tok-m">8090</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>remplacer le nom de user web1 par celui correspondant à celui du site web installé (indiqué dans le champ <code>Options</code>&#8594;`linux user` du web domain). (Si vous n&#8217;avez qu&#8217;un site, web1 est le bon).</td>
</tr>
</table>
</div>
</li>
<li>
<p>Débloquez le port 8090 et 8092 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://&lt;example.com&gt;:8080/" class="bare">https://&lt;example.com&gt;:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 8090 et 8092</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Faites pointer votre navigateur sur <a href="https://seafile.example.com" class="bare">https://seafile.example.com</a></p>
</li>
<li>
<p>La page de login de Seafile doit s&#8217;afficher</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_lancement_automatique_de_seafile">21.5. Lancement automatique de Seafile</h3>
<div class="paragraph">
<p>Afin de s&#8217;assurer que Seafile tourne en permanence, on doit créer un script de lancement automatique de Seafile:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créer un script de lancement automatique. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/www/seafile.example.com/private/seafile <i class="conum" data-value="1"></i><b>(1)</b>
touch startseafile.sh
chmod +x startseafile.sh
vi startseafile.sh</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettre à la place de <code>example.com</code> votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Coller le texte suivant de le fichier ouvert:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/bash</span>

<span class="tok-c1"># Change the value of &quot;seafile_dir&quot; to your path of seafile installation</span>
<span class="tok-nv">seafile_dir</span><span class="tok-o">=</span>/var/www/seafile.example.com/private/seafile <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nv">script_path</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">seafile_dir</span><span class="tok-si">}</span>/seafile-server-latest
<span class="tok-nv">seafile_init_log</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">seafile_dir</span><span class="tok-si">}</span>/logs/seafile.init.log
<span class="tok-nv">seahub_init_log</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">seafile_dir</span><span class="tok-si">}</span>/logs/seahub.init.log
<span class="tok-nv">seafgc_init_log</span><span class="tok-o">=</span><span class="tok-si">${</span><span class="tok-nv">seafile_dir</span><span class="tok-si">}</span>/logs/seafgc.init.log

<span class="tok-k">case</span> <span class="tok-s2">&quot;</span><span class="tok-nv">$1</span><span class="tok-s2">&quot;</span> in
start<span class="tok-o">)</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seafile.sh start &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafile_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seahub.sh start <span class="tok-m">8090</span> &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seahub_init_log</span><span class="tok-si">}</span>
<span class="tok-p">;;</span>
restart<span class="tok-o">)</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seafile.sh restart &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafile_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seahub.sh restart <span class="tok-m">8090</span> &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seahub_init_log</span><span class="tok-si">}</span>
<span class="tok-p">;;</span>
reload<span class="tok-o">)</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seahub.sh stop &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seahub_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seafile.sh stop &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafile_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seaf-gc.sh &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafgc_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seafile.sh start &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafile_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seahub.sh start <span class="tok-m">8090</span> &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seahub_init_log</span><span class="tok-si">}</span>
<span class="tok-p">;;</span>
stop<span class="tok-o">)</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seahub.sh stop &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seahub_init_log</span><span class="tok-si">}</span>
<span class="tok-si">${</span><span class="tok-nv">script_path</span><span class="tok-si">}</span>/seafile.sh stop &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">seafile_init_log</span><span class="tok-si">}</span>
<span class="tok-p">;;</span>
*<span class="tok-o">)</span>
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;Usage: /etc/init.d/seafile {start|stop|restart|reload}&quot;</span>
<span class="tok-nb">exit</span> <span class="tok-m">1</span>
<span class="tok-p">;;</span>
<span class="tok-k">esac</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer example.com par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Créer un job cron dans ISPConfig pour démarrer Seafile au démarrage</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez dans la rubrique <code>Sites</code> puis dans le menu <code>Cron Jobs</code>. Cliquez sur <code>Add cron Job</code>. Saisisssez les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Parent Website:</code> &#8592; mettre <code>example.com</code></p>
</li>
<li>
<p><code>Minutes:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Hours:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Days of month:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Months:</code> &#8592; mettre <code>@reboot</code></p>
</li>
<li>
<p><code>Days of week:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Command to run:</code> &#8592; mettre <code>/var/www/seafile.&lt;example.com&gt;/private/seafile/startseafile.sh start</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un second job cron dans ISPConfig pour redémarrer Seafile tous les jours</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez dans la rubrique <code>Sites</code> puis dans le menu <code>Cron Jobs</code>. Cliquez sur <code>Add cron Job</code>. Saisissez les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Parent Website:</code> &#8592; mettre <code>example.com</code></p>
</li>
<li>
<p><code>Minutes:</code> &#8592; mettre 45</p>
</li>
<li>
<p><code>Hours:</code> &#8592; mettre 20</p>
</li>
<li>
<p><code>Days of month:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Months:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Days of week:</code> &#8592; mettre *</p>
</li>
<li>
<p><code>Command to run:</code> &#8592; mettre <code>/var/www/seafile.&lt;example.com&gt;/private/seafile/startseafile.sh reload</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Arretez le serveur précédemment lancé en tant que root. Tapez:</p>
</li>
<li>
<p>Enjoy !</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_système_de_monitoring_grafana">22. Installation du système de monitoring Grafana</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Grafana est un logiciel de visualisation et d&#8217;analyse à code source ouvert. Il vous permet d&#8217;interroger, de visualiser, d&#8217;alerter et d&#8217;explorer vos mesures, quel que soit l&#8217;endroit où elles sont stockées. En clair, il vous fournit des outils pour transformer vos données de base de données de séries chronologiques (TSDB) en de magnifiques graphiques et visualisations.
Grafana s&#8217;appuie sur Prometheus afin d&#8217;obtenir des métriques.
Loki est aussi installé pour réaliser une analyse précise des fichiers de logs.</p>
</div>
<div class="paragraph">
<p>Cette installation est optionnelle puisque Munin est déjà installé sur votre système.</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_grafana">22.1. Création du site web de Grafana</h3>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>grafana</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>grafana</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>grafana</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># grafana httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPass</span> / http://localhost:3100/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:3100/

<span class="tok-nb">RedirectMatch</span> ^/$ https://grafana.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_grafana">22.2. Installation de Grafana</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">echo</span> <span class="tok-s2">&quot;deb https://packages.grafana.com/oss/deb stable main&quot;</span> &gt;&gt;/etc/apt/sources.list.d/grafana.list
wget -q -O - https://packages.grafana.com/gpg.key <span class="tok-p">|</span> sudo apt-key add -</code></pre>
</div>
</div>
</li>
<li>
<p>Installez les paquets. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt update
apt install grafana prometheus prometheus-mysqld-exporter prometheus-apache-exporter prometheus-bind-exporter prometheus-process-exporter</code></pre>
</div>
</div>
</li>
<li>
<p>Editez la configuration de Prometheus. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/prometheus/prometheus.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="yaml"><span></span>  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-s">&#39;prometheus&#39;</span>

    <span class="tok-c1"># Override the global default and scrape targets from this job every 5 seconds.</span>
    <span class="tok-nt">scrape_interval</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5s</span>
    <span class="tok-nt">scrape_timeout</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">5s</span>

    <span class="tok-c1"># metrics_path defaults to &#39;/metrics&#39;</span>
    <span class="tok-c1"># scheme defaults to &#39;http&#39;.</span>

    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9090&#39;</span><span class="tok-p tok-p-Indicator">]</span>

  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">node</span>
    <span class="tok-c1"># If prometheus-node-exporter is installed, grab stats about the local</span>
    <span class="tok-c1"># machine by default.</span>
    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9100&#39;</span><span class="tok-p tok-p-Indicator">]</span>

  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-master</span>
    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9119&#39;</span><span class="tok-p tok-p-Indicator">]</span>
        <span class="tok-nt">labels</span><span class="tok-p">:</span>
          <span class="tok-nt">alias</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">dns-master</span>

  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">apache</span>
    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9117&#39;</span><span class="tok-p tok-p-Indicator">]</span>

  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">process</span>
    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9256&#39;</span><span class="tok-p tok-p-Indicator">]</span>

  <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">job_name</span><span class="tok-p">:</span> <span class="tok-l tok-l-Scalar tok-l-Scalar-Plain">mysql</span>
    <span class="tok-nt">static_configs</span><span class="tok-p">:</span>
      <span class="tok-p tok-p-Indicator">-</span> <span class="tok-nt">targets</span><span class="tok-p">:</span> <span class="tok-p tok-p-Indicator">[</span><span class="tok-s">&#39;localhost:9104&#39;</span><span class="tok-p tok-p-Indicator">]</span></code></pre>
</div>
</div>
</li>
<li>
<p>Editez la configuration de <code>prometheus-process-exporter</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi etc/default/prometheus-process-exporter</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>ARGS=&quot;-procnames postgres,dovecot,apache2,sshd,php-fpm7.3,rspamd,named,mysqld&quot;</code></pre>
</div>
</div>
</li>
<li>
<p>Editez la configuration de <code>prometheus-mysqld-exporter</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi etc/default/prometheus-mysqld-exporter</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez les lignes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>ARGS=&#39;--config.my-cnf /etc/mysql/debian.cnf --collect.info_schema.tables.databases=&quot;*&quot; --collect.auto_increment.columns --collect.perf_schema.file_instances.filter=&quot;.*&quot; --collect.info_schema.tablestats&#39;</code></pre>
</div>
</div>
</li>
<li>
<p>Ajuster les permissions du fichier de conf de mysql pour donner l&#8217;accès à prometheus. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">644</span> /etc/mysql/debian.cnf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajustez la configuration de bind pour servir des statistiques. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/bind/named.conf</code></pre>
</div>
</div>
</li>
<li>
<p>Ajouter dans le fichier:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>statistics-channels {
  inet 127.0.0.1 port 8053 allow { 127.0.0.1; };
};</code></pre>
</div>
</div>
</li>
<li>
<p>Activez dans mysql quelques statistiques. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mysql -p</code></pre>
</div>
</div>
</li>
<li>
<p>tapez votre mot de passe root pour mysql. puis taper:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-k">INSTALL</span> <span class="tok-k">PLUGIN</span> <span class="tok-n">QUERY_RESPONSE_TIME_AUDIT</span> <span class="tok-k">SONAME</span> <span class="tok-s1">&#39;query_response_time.so&#39;</span><span class="tok-p">;</span>
<span class="tok-k">INSTALL</span> <span class="tok-k">PLUGIN</span> <span class="tok-n">QUERY_RESPONSE_TIME</span> <span class="tok-k">SONAME</span> <span class="tok-s1">&#39;query_response_time.so&#39;</span><span class="tok-p">;</span>
<span class="tok-k">INSTALL</span> <span class="tok-k">PLUGIN</span> <span class="tok-n">QUERY_RESPONSE_TIME_READ</span> <span class="tok-k">SONAME</span> <span class="tok-s1">&#39;query_response_time.so&#39;</span><span class="tok-p">;</span>
<span class="tok-k">INSTALL</span> <span class="tok-k">PLUGIN</span> <span class="tok-n">QUERY_RESPONSE_TIME_WRITE</span> <span class="tok-k">SONAME</span> <span class="tok-s1">&#39;query_response_time.so&#39;</span><span class="tok-p">;</span>
<span class="tok-k">SET</span> <span class="tok-k">GLOBAL</span> <span class="tok-n">query_response_time_stats</span><span class="tok-o">=</span><span class="tok-k">ON</span><span class="tok-p">;</span>
<span class="tok-k">SET</span> <span class="tok-k">GLOBAL</span> <span class="tok-n">userstat</span><span class="tok-o">=</span><span class="tok-k">ON</span><span class="tok-p">;</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez les services. Taper:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="mysql"><span></span><span class="tok-n">service</span> <span class="tok-n">prometheus</span> <span class="tok-k">restart</span>
<span class="tok-n">service</span> <span class="tok-n">prometheus</span><span class="tok-o">-</span><span class="tok-n">mysqld</span><span class="tok-o">-</span><span class="tok-n">exporter</span> <span class="tok-k">restart</span>
<span class="tok-n">service</span> <span class="tok-n">prometheus</span><span class="tok-o">-</span><span class="tok-k">process</span><span class="tok-o">-</span><span class="tok-n">exporter</span> <span class="tok-k">restart</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_loki">22.3. Installation et configuration de Loki</h3>
<div class="paragraph">
<p>Pour installer Loki, appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Allez sur le site de <a href="https://github.com/grafana/loki/releases">loki</a> et repérez la dernière version à charger.</p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /usr/local/bin
curl -fSL -o loki.gz https://github.com/grafana/loki/releases/download/v1.4.1/loki-linux-amd64.zip
gunzip loki.gz
chmod a+x loki</code></pre>
</div>
</div>
</li>
<li>
<p>Créez le fichier de configuration de loki</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/config-loki.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez le texte ci dessous dans le fichier</p>
<div class="listingblock">
<div class="content">
<pre>auth_enabled: false

server:
  http_listen_port: 3100
  log_level: "warn"

ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s
  chunk_idle_period: 5m
  chunk_retain_period: 30s

schema_config:
  configs:
  - from: 2010-01-01
    store: boltdb
    object_store: filesystem
    schema: v9
    index:
      prefix: index_
      period: 168h

storage_config:
  boltdb:
    directory: /tmp/loki/index

  filesystem:
    directory: /tmp/loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0

table_manager:
  chunk_tables_provisioning:
    inactive_read_throughput: 0
    inactive_write_throughput: 0
    provisioned_read_throughput: 0
    provisioned_write_throughput: 0
  index_tables_provisioning:
    inactive_read_throughput: 0
    inactive_write_throughput: 0
    provisioned_read_throughput: 0
    provisioned_write_throughput: 0
  retention_deletes_enabled: false
  retention_period: 0</pre>
</div>
</div>
</li>
<li>
<p>Débloquez le port 3100 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 3100</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Testez maintenant la configuration de Loki. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>loki -config.file /etc/config-loki.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Ouvrez un navigateur et visitez: <a href="http://example.com:3100/metrics" class="bare">http://example.com:3100/metrics</a></p>
</li>
<li>
<p>Maintenant arrêtez Loki en tapant <strong>CTRL-C</strong>.</p>
</li>
<li>
<p>Bloquez par sécurité le port 3100 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, Supprimer le port 3100</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Configurez un service Loki afin de le faire tourner en arrière plan. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/loki.service</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez le texte ci dessous et sauvez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[Unit]
Description=Loki service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/loki -config.file /etc/config-loki.yml

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</li>
<li>
<p>Maintenant lancez le service et vérifiez que tout est fonctionnel. Tapez:
Now start and check the service is running.</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo service loki start
sudo service loki status</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_et_configuration_de_promtail">22.4. Installation et configuration de Promtail</h3>
<div class="paragraph">
<p>Installez maintenant Promtail:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /usr/local/bin
curl -fSL -o promtail.gz https://github.com/grafana/loki/releases/download/v1.4.1/promtail-linux-amd64.zip
gunzip promtail.gz
chmod a+x promtail</code></pre>
</div>
</div>
</li>
<li>
<p>Créez la configuration de Promtail. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /var/log/journal
vi /etc/config-promtail.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Et ajoutez le texte suivant puis sauvez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://127.0.0.1:3100/api/prom/push

scrape_configs:
- job_name: system
  static_configs:
  - targets:
      - localhost
    labels:
      job: varlogs
      __path__: /var/log/{*.log,*/*.log}</code></pre>
</div>
</div>
</li>
<li>
<p>Débloquez le port 9080 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, ajoutez le port 9080</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>testez que Promtail fonctionne. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>promtail -config.file /etc/config-promtail.yml</code></pre>
</div>
</div>
</li>
<li>
<p>Ouvrez un navigateur et visitez: <a href="http://example.com:9080" class="bare">http://example.com:9080</a></p>
</li>
<li>
<p>Maintenant arrêtez Promtail en tapant <strong>CTRL-C</strong>.</p>
</li>
<li>
<p>Bloquez par sécurité le port 9080 dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open TCP ports:</code>, Supprimer le port 9080</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Configurez un service Promtail afin de le faire tourner en arrière plan. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/promtail.service</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez le texte ci dessous et sauvez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[Unit]
Description=Promtail service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/bin/promtail -config.file /etc/config-promtail.yml

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</li>
<li>
<p>Maintenant lancez le service et vérifiez que tout est fonctionnel. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>sudo service promtail start
sudo service promtail status</code></pre>
</div>
</div>
</li>
<li>
<p>Allez sur votre site grafana <a href="http://grafana.example.com" class="bare">http://grafana.example.com</a> et ajoutez une source de données de type loki</p>
</li>
<li>
<p>Mettez l&#8217;URL suivante: <a href="http://127.0.0.1:3100" class="bare">http://127.0.0.1:3100</a> . Laissez tout le reste tel quel.</p>
</li>
<li>
<p>vous pouvez maintenant explorer vos logs en utilisant le menu explore sur la gauche. Dans la zone texte "Log Labels" essayez ces examples un à un:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>{job=&quot;varlogs&quot;}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_du_système_de_backup_borgbackup">23. Installation du système de backup BorgBackup</h2>
<div class="sectionbody">
<div class="paragraph">
<p>BorgBackup est un système de backup simple mais offrant des fonctionnalités avancées telles que le backup incrémental, la déduplication de données, la compression, l&#8217;authentification, l&#8217;encryption.</p>
</div>
<div class="paragraph">
<p>Borg backup est un système de backup offsite. Cela signifie que vous devez avoir accès à un espace de stockage sur un autre site pour effectuer cette sauvegarde.</p>
</div>
<div class="paragraph">
<p>Pour le moment, BorgBackup n&#8217;utilise pas de mécanisme de type RClone et il n&#8217;est donc pas encore possible de sauvegarder sur google drive ou autres espaces partagés.</p>
</div>
<div class="sect2">
<h3 id="_introduction">23.1. Introduction</h3>
<div class="paragraph">
<p>BorgBackup permet de stocker des backups sur un serveur distant.
Nous nommerons le serveur sur lequel les sauvegardes seront stockées : serveur de stockage et identifié par &lt;storing_srv&gt;.
Nous nommerons le serveur qu&#8217;il faut sauvegarder: serveur sauvegardé et identifié par &lt;example.com&gt;</p>
</div>
</div>
<div class="sect2">
<h3 id="_installation_du_serveur_de_stockage">23.2. Installation du serveur de stockage</h3>
<div class="paragraph">
<p>Il est préférable pour des questions de sécurité de créer un compte utilisateur spécifique.</p>
</div>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install borgbackup</code></pre>
</div>
</div>
</li>
<li>
<p><a href="#pass_gen">Générez un mot de passe long</a></p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Sauvegardez précieusement ce mot de passe. Il vous sera indispensable pour récupérer vos backup après un crash du serveur. Sans celui-ci, impossible de récupérer votre installation !
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Créez un compte utilisateur. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>adduser borgbackup</code></pre>
</div>
</div>
</li>
<li>
<p>Copiez-collez le mot de passe généré lorsqu&#8217;il est demandé</p>
</li>
<li>
<p>se loguer comme <code>borgbackup</code></p>
</li>
<li>
<p>Créer un répertoire <code>~/.ssh</code> s&#8217;il n&#8217;existe pas. tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p <span class="tok-nv">$HOME</span>/.ssh
chmod <span class="tok-m">700</span> ~/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Allez dans le répertoire. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> ~/.ssh</code></pre>
</div>
</div>
</li>
<li>
<p>Générez vous clés. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh-keygen -t rsa</code></pre>
</div>
</div>
</li>
<li>
<p>Un ensemble de questions apparaît. Si un texte vous explique que le fichier existe déjà, arrêtez la procédure. Cela signifie que vous avez déjà créé une clé et que vous risquez de perdre la connexion à d&#8217;autres serveurs si vous en générez une nouvelle. Sinon, appuyez sur Entrée à chaque fois pour accepter les valeurs par défaut.</p>
</li>
<li>
<p>Créez maintenant le répertoire pour recevoir les sauvegardes</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span>
mkdir borgbackup
chmod <span class="tok-m">700</span> borgbackup</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_sur_le_serveur_sauvegardé">23.3. Installation sur le serveur sauvegardé</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install borgbackup</code></pre>
</div>
</div>
</li>
<li>
<p>Copiez la clé publique de root sur le &lt;storing_srv&gt;. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh-copy-id -i ~/.ssh/id_*.pub borgbackup@&lt;storing_srv&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Coller le mot de passe généré plus haut lorsqu&#8217;il est demandé</p>
</li>
<li>
<p>Affichez votre adresse IP. tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>wget -qO- http://ipecho.net/plain<span class="tok-p">;</span> <span class="tok-nb">echo</span></code></pre>
</div>
</div>
</li>
<li>
<p>Faites un essai de connexion en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ssh borgbackup@&lt;storing_srv&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>Aucun mot de passe ne doit être demandée et vous devez être connecté en tant que borgbackup sur le &lt;storing_srv&gt;</p>
</li>
<li>
<p>Si vous êtes très attaché à la sécurité, vous pouvez restreindre l&#8217;accès au seul serveur &lt;example.com&gt;. Tapez sur la ligne de commande du &lt;storing_srv&gt; :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi ~/.ssh/authorized_keys</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez en première ligne du fichier :</p>
<div class="listingblock">
<div class="content">
<pre>from="SERVERIPADDRESS",command="borg serve --restrict-to-path /home/borgbackup/borgbackup/",no-pty,no-agent-forwarding,no-port-forwarding,no-X11-forwarding,no-user-rc <i class="conum" data-value="1"></i><b>(1)</b></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez SERVERIPADDRESS par l&#8217;adresse IP affichée plus tôt.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Fusionnez cette ligne avec la suivante qui démarre par ssh en prenant bien garde de laissez un espace entre no-user-rc et ssh-rsa</p>
</li>
<li>
<p>Déconnectez vous en tapant :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">exit</span></code></pre>
</div>
</div>
</li>
<li>
<p>De retour sur le serveur &lt;example.com&gt;</p>
</li>
<li>
<p><a href="#pass_gen">Créez un mot de passe pour le dépot borg backup</a>.</p>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Sauvegardez précieusement ce mot de passe. Il vous sera indispensable pour récupérer vos backup après un crash du serveur. Sans celui-ci, impossible de récupérer votre installation !
</td>
</tr>
</table>
</div>
</li>
<li>
<p>Puis tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut</td>
</tr>
</table>
</div>
</li>
<li>
<p>Initialisez le dépot borg. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>borg init -e repokey-blake2 borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</code></pre>
</div>
</div>
</li>
<li>
<p>Tout est maintenant prêt pour faire un backup</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_effectuer_un_backup">23.4. Effectuer un backup</h3>
<div class="paragraph">
<p>Nous allons créer tout d&#8217;abord un script de backup pour sauvegarder tout le serveur sauf les répertoires système:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borgbackup.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insèrez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-nb">cd</span> / <span class="tok-o">&amp;&amp;</span> borg create --stats --progress --compress zstd borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::<span class="tok-sb">`</span>hostname<span class="tok-sb">`</span>-<span class="tok-sb">`</span>date +%Y-%m-%d-%H-%M-%S<span class="tok-sb">`</span> ./ --exclude<span class="tok-o">=</span>dev --exclude<span class="tok-o">=</span>proc --exclude<span class="tok-o">=</span>run --exclude<span class="tok-o">=</span>root/.cache/ --exclude<span class="tok-o">=</span>mnt/borgmount --exclude<span class="tok-o">=</span>sys --exclude<span class="tok-o">=</span>swapfile --exclude<span class="tok-o">=</span>tmp <span class="tok-o">&amp;&amp;</span> <span class="tok-nb">cd</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>si votre machine est assez puissante, vous pouvez remplacer l&#8217;algorithme de compression zstd par un algorithme lz4 (rapide) ou  lzma (très lent mais performant en taille).</td>
</tr>
</table>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgbackup.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant effectuer une première sauvegarde en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borgbackup.sh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_lister_les_backups">23.5. Lister les backups</h3>
<div class="paragraph">
<p>Nous allons créer un script de listage :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borglist.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insèrez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
borg list -v borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut.</td>
</tr>
</table>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borglist.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant lister vos backup en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borglist.sh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_vérifier_un_backup">23.6. Vérifier un backup</h3>
<div class="paragraph">
<p>Nous allons créer un script de vérification :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borgcheck.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insèrez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
borg check --progress borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::<span class="tok-nv">$1</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut.</td>
</tr>
</table>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgcheck.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant vérifier un de vos backup en tapant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borgcheck.sh &lt;nom_de_sauvegarde&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>le nom de sauvegarde est récupéré en utilisant la commande borglist.sh</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_restaurer_un_backup">23.7. Restaurer un backup</h3>
<div class="paragraph">
<p>Nous allons créer un script de montage sous forme de système de fichier :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borgmount.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
mkdir -p /mnt/borgbackup
<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
borg mount borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/ /mnt/borgbackup</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut.</td>
</tr>
</table>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgmount.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant monter vos backups et effectuer des opérations de fichiers. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borgmount.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Pour créer un script pour démonter les backups. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borgumount.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
umount /mnt/borgbackup
rmdir /mnt/borgbackup</code></pre>
</div>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgumount.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant demonter vos backups. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borgumount.sh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_supprimer_vos_vieux_backups">23.8. Supprimer vos vieux backups</h3>
<div class="paragraph">
<p>Nous allons créer un script de ménage des backups :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;example.com&gt;. </a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /usr/local/bin/borgprune.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insèrez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>

<span class="tok-c1"># Nettoyage des anciens backups</span>
<span class="tok-c1"># On conserve</span>
<span class="tok-c1"># - une archive par jour les 7 derniers jours,</span>
<span class="tok-c1"># - une archive par semaine pour les 4 dernières semaines,</span>
<span class="tok-c1"># - une archive par mois pour les 6 derniers mois.</span>


<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
borg prune --stats --progress borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/ --prefix <span class="tok-sb">`</span>hostname<span class="tok-sb">`</span>- --keep-daily<span class="tok-o">=</span><span class="tok-m">7</span> --keep-weekly<span class="tok-o">=</span><span class="tok-m">4</span> --keep-monthly<span class="tok-o">=</span><span class="tok-m">12</span> <i class="conum" data-value="2"></i><b>(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mot_passe doit être remplacé par celui généré plus haut.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Le nettoyage des sauvegardes va conserver 7 sauvegardes journalières, 4 à la semaine et 12 au mois</td>
</tr>
</table>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgprune.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez maintenant effectuer du ménage:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>/usr/local/bin/borgprune.sh</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_automatisez_votre_sauvegarde">23.9. Automatisez votre sauvegarde</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pour créer un script automatisé de backup. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /var/log/borg
vi /usr/local/bin/borgcron.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-ch">#!/bin/sh</span>
<span class="tok-c1">#</span>
<span class="tok-c1"># Script de sauvegarde.</span>
<span class="tok-c1">#</span>

<span class="tok-nb">set</span> -e

<span class="tok-nv">LOG_PATH</span><span class="tok-o">=</span>/var/log/borg/cron.log

/usr/local/bin/borgbackup.sh &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">LOG_PATH</span><span class="tok-si">}</span> <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span>
/usr/local/bin/borgprune.sh &gt;&gt; <span class="tok-si">${</span><span class="tok-nv">LOG_PATH</span><span class="tok-si">}</span> <span class="tok-m">2</span>&gt;<span class="tok-p">&amp;</span><span class="tok-m">1</span></code></pre>
</div>
</div>
</li>
<li>
<p>changez les permissions du script. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>chmod <span class="tok-m">700</span> /usr/local/bin/borgcron.sh</code></pre>
</div>
</div>
</li>
<li>
<p>vous pouvez ensuite planifier votre backup à 1h du matin. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>crontab -e</code></pre>
</div>
</div>
</li>
<li>
<p>Inserez ensuite le texte suivant:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre># Backup via Borg to backup server
00 01 * * * /usr/local/bin/borgcron.sh</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_restauration_durgence">23.10. Restauration d&#8217;urgence.</h3>
<div class="paragraph">
<p>En cas de crash du serveur, l’intérêt du backup offsite est de pouvoir remonter la dernière sauvegarde sans souci.
Pour cela il faut avoir un moyen de booter le serveur dans un mode rescue (boot du VPS en mode rescue, utilisation d&#8217;un clé USB bootable, boot réseau ou autre moyen).</p>
</div>
<div class="paragraph">
<p>On suppose dans ce qu&#8217;il suit que vous avez booté sur un linux de type debian ou ubuntu dont la version n&#8217;est pas la toute dernière et dans laquelle borg-backup n&#8217;est pas obligatoirement présent du moins dans un version suffisamment récente.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>loguez vous root sur votre serveur. A noter que, comme vous êtes en mode rescue, l&#8217;accès au mode est indiqué par votre hébergeur ou, si vous avez booté sur une clé USB en local, l&#8217;accès root s&#8217;effectue souvent avec une commande <code>sudo bash</code></p>
</li>
<li>
<p>Montez votre partition racine. Sur un VPS, la partition est souvent déjà montée dans le répertoire /mnt. Sur un PC c&#8217;est souvent /dev/sda1. Sur un Raspberry Pi cette partition est /dev/mmcblk0p7. Tapez la commande:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /mnt/root
mount /dev/mmcblk0p7 /mnt/root</code></pre>
</div>
</div>
</li>
<li>
<p>Installez borgbackup. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install python3-pip libssl-dev cython3 gcc g++ libpython3-dev libacl1-dev python3-llfuse
pip3 install borgbackup</code></pre>
</div>
</div>
</li>
<li>
<p>Si la compilation échoue, c&#8217;est qu&#8217;il manque des packages. lisez attentivement les logs et installez les packages manquant.</p>
</li>
<li>
<p>Munissez vous du mot de passe &lt;mot_passe&gt; des archives borg et tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /mnt/borgbackup
<span class="tok-nb">export</span> <span class="tok-nv">BORG_PASSPHRASE</span><span class="tok-o">=</span><span class="tok-s1">&#39;mot_passe&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
borg list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacez mot_passe par votre mot de passe de borg</td>
</tr>
</table>
</div>
</li>
<li>
<p>tapez le mot de passe du compte borgbackup.</p>
</li>
<li>
<p>la liste des sauvegardes est affichées à l&#8217;écran.</p>
</li>
<li>
<p>Choisissez l&#8217;archive qui vous convient et tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /mnt/root
borg extract --list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::&lt;votre_archive&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>tapez le mot de passe du compte borgbackup.</p>
</li>
<li>
<p>la restauration s&#8217;effectue et peut prendre des heures ! soyez patient.</p>
</li>
<li>
<p>il peut être nécessaire de réinstaller le bootloader (non utile sur VPS ou raspberry). Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /mnt/root
chroot . bash
mkdir -p dev proc run sys tmp
mount -t devtmpfs dev /dev
mount -t proc proc /proc
grub_install /dev/sda <i class="conum" data-value="1"></i><b>(1)</b>
umount /proc
umount /dev
sync
<span class="tok-nb">exit</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>tapez ici le nom de device de votre disque de boot</td>
</tr>
</table>
</div>
</li>
<li>
<p>Créez votre fichier de swap en suivant <a href="#swap_create">la
procédure</a>. Attention le fichier de swap doit être installé dans
<code>/mnt/root/swapfile</code></p>
</li>
<li>
<p>vous pouvez maintenant rebooter votre machine en mode normal.</p>
</li>
<li>
<p>une autre façon de remonter la sauvegarde est d&#8217;extraire un fichier tar.xz directement du serveur de stockage et de transférer cette archive sur la machine en mode rescue puis de décompresser. La commande de génération d&#8217;archive est:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>borg export-tar --list borgbackup@&lt;storing_srv&gt;:/home/borgbackup/borgbackup/::&lt;votre_archive&gt; restore.tar.xz</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_borgweb">23.11. Installation de Borgweb</h3>
<div class="paragraph">
<p>Borgweb existe en version officielle. Cette version n&#8217;a pas trop d&#8217;intéret pour nous étant donnée qu&#8217;elle n&#8217;interroge pas le serveur de stockage pour obtenir les informations des backups réalisés. Il existe un clone de repository qui implémente une fonctionnalité qui liste tous les backups effectués sur le serveur de stockage</p>
</div>
<div class="paragraph">
<p>Suivez la procédure suivante sur le serveur de stockage:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </a></p>
</li>
<li>
<p>Installez pip  pour python3 et NPM. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install python3-pip npm</code></pre>
</div>
</div>
</li>
<li>
<p>Installer le logiciel dans le répertoire <code>/var/lib/borgweb</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /var/lib/borgweb
<span class="tok-nb">cd</span> /var/lib/borgweb
git clone https://github.com/vche/borgweb.git</code></pre>
</div>
</div>
</li>
<li>
<p>Dans la version testée, le fichier <code>README.rst</code> est utilisé par l&#8217;installeur mais plus présent dans le repo. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> borgweb
touch README.rst</code></pre>
</div>
</div>
</li>
<li>
<p>Lancez l&#8217;installation. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pip3 install -e .
<span class="tok-nb">cd</span> js
npm install</code></pre>
</div>
</div>
</li>
<li>
<p>Editez la configuration. Comme la variable d&#8217;environnement <code>BORG_CONFIG</code> semble n&#8217;avoir aucun effet, éditez directement le fichier de configuration du repository. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/lib/borgweb/borgweb/borgweb
vi config.py</code></pre>
</div>
</div>
</li>
<li>
<p>Mettez ce texte dans le fichier édité:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="python"><span></span><span class="tok-k">class</span> <span class="tok-nc">Config</span><span class="tok-p">(</span><span class="tok-nb">object</span><span class="tok-p">):</span>
    <span class="tok-sd">&quot;&quot;&quot;This is the basic configuration class for BorgWeb.&quot;&quot;&quot;</span>

    <span class="tok-c1">#: builtin web server configuration</span>
    <span class="tok-n">HOST</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;127.0.0.1&#39;</span>  <span class="tok-c1"># use 0.0.0.0 to bind to all interfaces</span>
    <span class="tok-n">PORT</span> <span class="tok-o">=</span> <span class="tok-mi">5000</span>  <span class="tok-c1"># ports &lt; 1024 need root</span>
    <span class="tok-n">DEBUG</span><span class="tok-o">=</span><span class="tok-kc">False</span>

    <span class="tok-c1">#: borg / borgweb configuration</span>
    <span class="tok-n">LOG_DIR</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;/var/log/borg&#39;</span>
    <span class="tok-n">BORG_PATH</span><span class="tok-o">=</span><span class="tok-s2">&quot;/usr/bin/borg&quot;</span>

    <span class="tok-c1"># Repo status cache configuration. TTL in secs</span>
    <span class="tok-n">STATUS_CACHE_TTL</span><span class="tok-o">=</span><span class="tok-mi">43200</span>
    <span class="tok-n">STATUS_CACHE_PATH</span><span class="tok-o">=</span><span class="tok-s2">&quot;/tmp/borgweb.cache&quot;</span>

    <span class="tok-n">BACKUP_REPOS</span> <span class="tok-o">=</span> <span class="tok-p">{</span>
        <span class="tok-c1"># Repo  name</span>
        <span class="tok-s2">&quot;example.com&quot;</span><span class="tok-p">:</span> <span class="tok-p">{</span> <i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-c1"># Repo absolute path</span>
            <span class="tok-s2">&quot;repo_path&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;/home/borgbackup/borgbackup&quot;</span><span class="tok-p">,</span>

            <span class="tok-c1"># Repo logs absolute path, or relative to the main LOG_DIR</span>
            <span class="tok-s2">&quot;log_path&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;/var/log/borg/&quot;</span><span class="tok-p">,</span>

            <span class="tok-c1"># Repo password</span>
            <span class="tok-s2">&quot;repo_pwd&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;your_password&quot;</span><span class="tok-p">,</span> <i class="conum" data-value="1"></i><b>(1)</b>

            <span class="tok-c1"># Command/script to run to manually start a backup.</span>
            <span class="tok-c1"># If left empty or not specified, the backup won&#39;t be</span>
            <span class="tok-c1"># manually runnable</span>
            <span class="tok-s2">&quot;script&quot;</span><span class="tok-p">:</span> <span class="tok-s2">&quot;script&quot;</span><span class="tok-p">,</span>

            <span class="tok-c1"># Filled with discovered backups in the repo</span>
            <span class="tok-s2">&quot;backups&quot;</span><span class="tok-p">:</span> <span class="tok-p">[]</span>
        <span class="tok-p">}</span>
    <span class="tok-p">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Insérez ici le mot de passe du dépot Borg Backup</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Mettez ici le nom de votre domaine sauvegardé</td>
</tr>
</table>
</div>
</li>
<li>
<p>Créez un service <code>systemd</code>. Editez le fichier de service. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/borgweb.service</code></pre>
</div>
</div>
</li>
<li>
<p>Insérez dans le fichier le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>[Unit]
Description=Borgweb Daemon
After=syslog.target network.target

[Service]
WorkingDirectory=/var/lib/borgweb
User=root
Group=root
UMask=0002
Restart=on-failure
RestartSec=5
Type=simple
ExecStart=/usr/local/bin/borgweb
KillSignal=SIGINT
TimeoutStopSec=20
SyslogIdentifier=borgweb

[Install]
WantedBy=multi-user.target</code></pre>
</div>
</div>
</li>
<li>
<p>Recharge la base de systemd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl daemon-reload</code></pre>
</div>
</div>
</li>
<li>
<p>Activez et démarrez <code>borgweb</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl <span class="tok-nb">enable</span> borgweb.service
systemctl start borgweb.service</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_borgweb">23.12. Création du site web de Borgweb</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig de votre serveur de stockage &lt;storing_srv&gt;:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>borgweb</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>borgweb</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>borgweb</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-c"># borgweb httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nt">&lt;Location</span> <span class="tok-s">/</span><span class="tok-nt">&gt;</span>
    <span class="tok-nb">AllowOverride</span> AuthConfig
    <span class="tok-nb">AuthUserFile</span> <span class="tok-sx">/var/lib/borgweb/borgweb-htpasswd</span>
    <span class="tok-nb">AuthName</span> <span class="tok-s2">&quot;Borgweb&quot;</span>
    <span class="tok-nb">AuthType</span> Basic
    <span class="tok-nb">Require</span> valid-user

<span class="tok-nt">&lt;/Location&gt;</span>


<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># borgweb httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>
<span class="tok-nb">ProxyPass</span> / http://localhost:5000/
<span class="tok-nb">ProxyPassReverse</span> / http://localhost:5000/

<span class="tok-nb">RedirectMatch</span> ^/$ https://borgweb.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
<li>
<p><a href="#root_login">Loguez vous comme root sur &lt;storing_srv&gt;. </a></p>
</li>
<li>
<p>Créez ensuite le fichier de mot de passe de borgweb dans votre &lt;storing_srv&gt;:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>htpasswd -c /var/lib/borgweb/borgweb-htpasswd admin</code></pre>
</div>
</div>
</li>
<li>
<p>Tapez <a href="#pass_gen">votre mot de passe généré</a></p>
</li>
<li>
<p>Redémarrez apache. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>service apache2 restart</code></pre>
</div>
</div>
</li>
<li>
<p>Pointez votre navigateur sur <a href="https://borgweb.storing_srv" class="bare">https://borgweb.storing_srv</a> , un mot de passe vous est demandé. Tapez <code>admin</code> pour le user et le password saisi. Vous accédez aux informations de sauvegarde de votre site.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_dun_serveur_de_vpn_pritunl">24. Installation d&#8217;un serveur de VPN Pritunl</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Pritunl est un serveur VPN basé sur OpenVPN.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Printunl ne peut pas être installé sur une plateforme 32 bits et donc sur une distribution Raspbian.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_pritunl">24.1. Création du site web de Pritunl</h3>
<div class="paragraph">
<p>Appliquez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>pritunl</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>pritunl</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>pritunl</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># Pritunl httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">SSLProxyEngine</span> <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">RequestHeader</span> set Front-End-Https <span class="tok-s2">&quot;On&quot;</span> # Comment this out if no https required
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyCheckPeerCN</span> <span class="tok-k">Off</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyCheckPeerName</span> <span class="tok-k">Off</span> # Comment this out if no https required
<span class="tok-nb">SSLProxyVerify</span> <span class="tok-k">none</span> # Comment this out if no https required
<span class="tok-nb">ProxyPass</span> / https://localhost:8070/
<span class="tok-nb">ProxyPassReverse</span> / https://localhost:8070/

<span class="tok-nb">RedirectMatch</span> ^/$ https://pritunl.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_pritunl_sur_un_vps">24.2. Installation de Pritunl sur un VPS</h3>
<div class="paragraph">
<p>Veuillez suivre la procédure suivante si vous installer sur un serveur debian (pour le Raspberrypi voir le chapitre suivant):</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Ajoutez des repositories Debian. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tee /etc/apt/sources.list.d/mongodb-org.list <span class="tok-s">&lt;&lt; EOF</span>
<span class="tok-s">deb http://repo.mongodb.org/apt/debian buster/mongodb-org/4.2 main</span>
<span class="tok-s">EOF</span>
tee /etc/apt/sources.list.d/pritunl.list <span class="tok-s">&lt;&lt; EOF</span>
<span class="tok-s">deb http://repo.pritunl.com/stable/apt buster main</span>
<span class="tok-s">EOF</span>
apt-get install dirmngr
apt-key adv --keyserver hkp://keyserver.ubuntu.com --recv E162F504A20CDF15827F718D4B7C549A058F8B6B
apt-key adv --keyserver hkp://keyserver.ubuntu.com --recv 7568D9BB55FF9E5287D586017AE645C0CF8E292A
apt-get update
apt-get --assume-yes install pritunl mongodb-org</code></pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_de_pritunl_sur_un_raspberrypi">24.3. Installation de Pritunl sur un Raspberrypi</h3>
<div class="paragraph">
<p>Pritunl n&#8217;est pas installable avec une distribution Raspbian qui est uniquement 32 bits.
Veuillez suivre la procédure suivante si vous installer sur un Raspberrypi avec Ubuntu 64 bits:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Comme pritunl n&#8217;est pas nativement sur Ubuntu, il faut l&#8217;installer à la main. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>tee /etc/apt/sources.list.d/mongodb-org.list <span class="tok-s">&lt;&lt; EOF</span>
<span class="tok-s">deb http://repo.mongodb.org/apt/ubuntu bionic/mongodb-org/4.2 multiverse</span>
<span class="tok-s">EOF</span>
apt install dirmngr
apt-key adv --keyserver hkp://keyserver.ubuntu.com --recv E162F504A20CDF15827F718D4B7C549A058F8B6B
apt update
apt install mongodb-org golang
mkdir -p /var/lib/pritunl
<span class="tok-nb">cd</span> /var/lib/pritunl
<span class="tok-nb">export</span> <span class="tok-nv">GOPATH</span><span class="tok-o">=</span>/var/lib/pritunl
go get -u github.com/pritunl/pritunl-dns
go get -u github.com/pritunl/pritunl-web</code></pre>
</div>
</div>
</li>
<li>
<p>La compilation peut échouer, notamment si la version de go installée sur votre système est une 1.11 ou antérieure.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>tapez les commandes suivantes:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /var/lib/pritunl/src/github.com/pritunl/pritunl-web
git checkout b6b07a4fa422d666385e951dd25e24ec527636d1
go install
<span class="tok-nb">cd</span> /var/lib/pritunl/</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Liez cette version dans <code>/usr/local</code>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ln -s /var/lib/pritunl/bin/pritunl-dns /usr/local/bin/pritunl-dns
ln -s /var/lib/pritunl/bin/pritunl-web /usr/local/bin/pritunl-web</code></pre>
</div>
</div>
</li>
<li>
<p>Installer le logiciel pour python2. Comme il y a encore des problèmes de dépendances, Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>git clone https://github.com/pritunl/pritunl.git
apt install libpython2.7-dev libffi-dev
curl https://bootstrap.pypa.io/get-pip.py --output get-pip.py
python2 get-pip.py
rm get-pip.py
<span class="tok-nb">cd</span> pritunl
<span class="tok-nb">echo</span> <span class="tok-s2">&quot;jaraco.functools==2.0&quot;</span> &gt;&gt; requirements.txt
python2 setup.py build
pip2 install -r requirements.txt
python2 setup.py install</code></pre>
</div>
</div>
</li>
<li>
<p>Printunl s&#8217;installe dans <code>/usr/local/bin</code>. Il faut changer le fichier service. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/systemd/system/pritunl.service</code></pre>
</div>
</div>
</li>
<li>
<p>Changer <code>ExecStart=/usr/bin/pritunl start</code> par <code>ExecStart=/usr/local/bin/pritunl start</code></p>
</li>
<li>
<p>Rechargez les configs de systemd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl daemon-reload</code></pre>
</div>
</div>
<div class="paragraph">
<p>=== Configuration de Pritunl</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Votre service Pritunl est installé. Vous devez maintenant le configurer pour qu&#8217;il fonctionne:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Pritunl utilise en standard le port 80 et 443. Ces deux ports sont utilisés dans notre configuration par le serveur apache</p>
</li>
<li>
<p>On commence par arrêter apache. Tapez:</p>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Plus aucun site web ne sera servi. Danger donc.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl stop monit apache2</code></pre>
</div>
</div>
</li>
<li>
<p>Démarrez Mongodb ainsi que Pritunl. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl start mongod pritunl
systemctl <span class="tok-nb">enable</span> mongod pritunl</code></pre>
</div>
</div>
</li>
<li>
<p>pointez votre navigateur sur le site web de Pritunl: <a href="https://example.com" class="bare">https://example.com</a></p>
</li>
<li>
<p>Accepter le certificat non sécurisé. La page de setup de Pritunl s&#8217;affiche.</p>
</li>
<li>
<p>Obtenez la clé d&#8217;activation. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pritunl setup-key</code></pre>
</div>
</div>
</li>
<li>
<p>copier la clé dans la page web. Cliquez sur <code>Save</code></p>
</li>
<li>
<p>La page web s&#8217;affiche en erreur. Pas d&#8217;inquiétude à avoir.</p>
</li>
<li>
<p>Arrêtez le serveur Pritunl. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl stop pritunl</code></pre>
</div>
</div>
</li>
<li>
<p>Configurez le serveur pour qu&#8217;il n&#8217;utilise plus le port 80 et le port 443</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pritunl <span class="tok-nb">set</span> app.server_port <span class="tok-m">8070</span>
pritunl <span class="tok-nb">set</span> app.redirect_server <span class="tok-nb">false</span></code></pre>
</div>
</div>
</li>
<li>
<p>Redémarrez apache et pritunl</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl start apache2
systemctl start monit
systemctl start pritunl</code></pre>
</div>
</div>
</li>
<li>
<p>Pointez maintenant votre navigateur sur le site <a href="https://pritunl.example.com" class="bare">https://pritunl.example.com</a> . La page de login de pritunl doit s&#8217;afficher. Si ce n&#8217;est pas le cas, revérifier votre configuration de site web dans ISPConfig et que le port 8070 est bien activé.</p>
</li>
<li>
<p>Sur le serveur, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pritunl default-password</code></pre>
</div>
</div>
</li>
<li>
<p>Entrez dans la page web la valeur de <code>username</code> et de <code>password</code> affichés dans le terminal.</p>
</li>
<li>
<p>Une boite de dialogue <code>initial setup</code> s&#8217;affiche. Ne changez rien mais tapez votre mot de passe.</p>
</li>
<li>
<p>Vous êtes maintenant connecté sur le site web.</p>
</li>
<li>
<p>Cliquez sur l&#8217;onglet <code>Users</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>Add Organization</code></p>
</li>
<li>
<p>Entrez votre nom d&#8217;organisation. Par exemple <code>Personnel</code></p>
</li>
<li>
<p>Cliquez sur <code>Add</code></p>
</li>
<li>
<p>Cliquez sur <code>Add User</code></p>
</li>
<li>
<p>Remplissez les champs:</p>
<div class="ulist">
<ul>
<li>
<p>`Name: ` &#8592; Tapez votre nom de login (pas de caractère accentué pas d&#8217;espace)</p>
</li>
<li>
<p>`Select an organization: ` &#8592; sélectionnez votre organisation</p>
</li>
<li>
<p>`Email: ` &#8592; Tapez votre adresse Email</p>
</li>
<li>
<p><code>Pin:</code> &#8592; entrez votre code Pin (que des nombres; au moins 6 chiffres)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Add</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Allez sur l&#8217;onglet <code>Servers</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>Add Server</code></p>
</li>
<li>
<p>Remplissez les champs:</p>
<div class="ulist">
<ul>
<li>
<p><code>Name:</code> &#8592; donnez un nom à votre serveur (pas de caractère accentué pas d&#8217;espace)</p>
</li>
<li>
<p>laissez le reste tel quel mais notez bien le numéro de port UDP indiqué</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Add</code></p>
</li>
<li>
<p>Cliquez sur <code>Attach Organization</code></p>
</li>
<li>
<p>Sélectionnez le <code>server</code> et l' <code>organization</code>.</p>
</li>
<li>
<p>Cliquez sur <code>Attach</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Débloquez le port VPN dans votre firewall</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Allez sur le site ispconfig <a href="https://example.com:8080/" class="bare">https://example.com:8080/</a></p>
</li>
<li>
<p>Loguez-vous et cliquez sur la rubrique <code>System</code> et le menu <code>Firewall</code>. Cliquez sur votre serveur.</p>
</li>
<li>
<p>dans la rubrique <code>Open UDP ports:</code>, ajoutez le port UDP du VPN que vous avez noté.</p>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Retourner dans l&#8217;interface de Pritunl. retournez sur l&#8217;onglet <code>Servers</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>Start server</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Votre serveur de VPN est opérationnel.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_se_connecter_au_serveur_de_vpn">24.4. Se connecter au serveur de VPN</h3>
<div class="paragraph">
<p>Comme Pritunl est compatible OpenVPN n&#8217;importe quel logiciel compatible OpenVPN peut être utilisé.
Pritunl founit un <a href="https://client.pritunl.com/">client</a> compatible pour Linux, macOS, and Windows.</p>
</div>
<div class="paragraph">
<p>Pour se connecter à l&#8217;aide du client, vous devez charger un fichier de configuration qui est téléchargeable dans l&#8217;onglet utilisateur du serveur web.
Ce fichier est à importer dans le logiciel client de Pritunl.
Une fois fait, une compte apparaît dans le logiciel client. Vous pourrez vous connecter en cliquant sur le bouton <code>Connect</code> du compte utilisateur.</p>
</div>
</div>
<div class="sect2">
<h3 id="_réparer_une_base_pritunl">24.5. Réparer une base Pritunl</h3>
<div class="paragraph">
<p>Si jamais votre base est corrompue, vous pourrez la réparer en tapant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl stop pritunl
pritunl repair-database
systemctl start pritunl</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_mot_de_passe_perdu">24.6. Mot de passe perdu</h3>
<div class="paragraph">
<p>Vous pouvez re-générer un mot de passe en tapant:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>pritunl reset-password</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installation_dun_serveur_de_bureau_à_distance_guacamole">25. Installation d&#8217;un serveur de bureau à distance Guacamole</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache Guacamole est un logiciel opensource et une application web de bureau à distance qui vous permet d&#8217;accéder à vos machines de bureau par le biais d&#8217;un navigateur web. Il s&#8217;agit d&#8217;une appli web html5 qui prend en charge des protocoles standard comme VNC, RDP et SSH. Vous n&#8217;avez pas besoin d&#8217;installer et d&#8217;utiliser des logiciels ou des plugins sur le serveur. Avec Guacamole, vous pouvez facilement passer d&#8217;un bureau d&#8217;une machine à l&#8217;autre avec le même navigateur</p>
</div>
<div class="sect2">
<h3 id="_création_du_site_web_de_guacamole">25.1. Création du site web de Guacamole</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes Dans ISPConfig:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Allez dans la rubrique <code>DNS</code>, sélectionnez le menu <code>Zones</code>, Sélectionnez votre Zone, Allez dans l&#8217;onglet <code>Records</code>.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Cliquez sur <code>A</code> et saisissez:</p>
<div class="ulist">
<ul>
<li>
<p><code>Hostname:</code> &#8592; Tapez <code>guacamole</code></p>
</li>
<li>
<p><code>IP-Address:</code> &#8592; Double cliquez et sélectionnez l&#8217;adresse IP de votre serveur</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
<li>
<p>Créer un <a href="#subdomain-site">sub-domain (vhost)</a> dans le configurateur de sites.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Lui donner le nom <code>guacamole</code>.</p>
</li>
<li>
<p>Le faire pointer vers le web folder <code>guacamole</code>.</p>
</li>
<li>
<p>Activer let’s encrypt ssl</p>
</li>
<li>
<p>Activer <code>Fast CGI</code> pour PHP</p>
</li>
<li>
<p>Laisser le reste par défaut.</p>
</li>
<li>
<p>Dans l’onglet Options:</p>
</li>
<li>
<p>Dans la boite <code>Apache Directives:</code> saisir le texte suivant:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="apache"><span></span><span class="tok-nt">&lt;Proxy</span> <span class="tok-s">*</span><span class="tok-nt">&gt;</span>
<span class="tok-nb">Order</span> deny,allow
<span class="tok-nb">Allow</span> from <span class="tok-k">all</span>
<span class="tok-nt">&lt;/Proxy&gt;</span>

<span class="tok-nb">ProxyRequests</span> <span class="tok-k">Off</span>
<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/stats</span> !
<span class="tok-nb">ProxyPass</span> /.well-known/acme-challenge !

<span class="tok-c"># guacamole httpserver</span>
<span class="tok-c">#</span>

<span class="tok-nb">SetEnvIf</span> Authorization <span class="tok-s2">&quot;(.*)&quot;</span> HTTP_AUTHORIZATION=$1
<span class="tok-nb">ProxyPreserveHost</span>    <span class="tok-k">On</span>

<span class="tok-nb">ProxyPass</span> <span class="tok-sx">/guacamole</span> http://localhost:8085/guacamole
<span class="tok-nb">ProxyPassReverse</span> <span class="tok-sx">/guacamole</span> http://localhost:8085/guacamole

<span class="tok-nb">RedirectMatch</span> ^/$ https://guacamole.example.com <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>remplacer <code>example.com</code> par votre nom de domaine</td>
</tr>
</table>
</div>
</li>
<li>
<p>Cliquez sur <code>Save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_création_des_bases_de_données_5">25.2. Création des bases de données</h3>
<div class="paragraph">
<p>Appliquez les opérations suivantes dans ISPConfig :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Créez une base de données mysql. Aller dans le menu <code>Database</code> pour définir un utilisateur MariaDB</p>
</li>
<li>
<p>Aller dans la rubrique <code>Sites</code></p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Aller dans le menu <code>Database users</code> pour définir un utilisateur MariaDB</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Cliquez sur <code>Add new User</code> pour créer un nouvel utilisateur</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Database user:</code> &#8592;  saisir votre nom d&#8217;utilisateur <code>guacamole</code> par exemple</p>
</li>
<li>
<p><code>Database password:</code> &#8592; <a href="#pass_gen">Saisissez un mot de passe généré</a> ou en générer un en cliquant sur le bouton</p>
</li>
<li>
<p><code>Repeat Password:</code> &#8592; saisir de nouveau le mot de passe</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
<li>
<p>Cliquez sur <code>Add new Database</code> pour créer une nouvelle base de données</p>
</li>
<li>
<p>Saisissez les informations:</p>
<div class="ulist">
<ul>
<li>
<p><code>Site:</code> &#8592; sélectionner le site <code>example.com</code></p>
</li>
<li>
<p><code>Database name:</code> &#8592; Saisissez le nom de la base de données <code>guacamole</code></p>
</li>
<li>
<p><code>Database user:</code> &#8592; Saisir ici le nom d&#8217;utilisateur créé: <code>cxguacamole</code>. x: est le numéro de client.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>save</code></p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_installation_du_guacamole">25.3. Installation du Guacamole</h3>
<div class="paragraph">
<p>Suivez la procédure suivante:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>apt install gcc g++ libossp-uuid-dev libavcodec-dev libpango1.0-dev libssh2-1-dev libcairo2-dev libjpeg-dev libpng-dev libavutil-dev libavformat-dev libswscale-dev libvncserver-dev libssl-dev libvorbis-dev libwebp-dev freerdp2-dev libtelnet-dev libswscale-dev libossp-uuid-dev libwebsockets-dev libpulse-dev  mysql-java tomcat8 tomcat8-admin tomcat8-common tomcat8-user</code></pre>
</div>
</div>
</li>
<li>
<p>Sur Ubuntu, remplacer <code>mysql-java tomcat8 tomcat8-admin tomcat8-common tomcat8-user</code> par <code>libmariadb-java tomcat9 tomcat9-admin tomcat9-common tomcat9-user</code></p>
</li>
<li>
<p>Téléchargez la dernière version de Guacamole en allant sur le site web et en récupérant le <a href="https://guacamole.apache.org/releases/">lien de téléchargement</a>.</p>
</li>
<li>
<p>tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl -fSL -o guacamole-server.tar.gz <span class="tok-s1">&#39;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/1.2.0/source/guacamole-server-1.2.0.tar.gz&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
tar xfz guacamole-server.tar.gz
<span class="tok-nb">cd</span> guacamole-server-*</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>insérez ici l&#8217;adresse du package serveur à charger</td>
</tr>
</table>
</div>
</li>
<li>
<p>Lancez la configuration. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>./configure --with-init-dir<span class="tok-o">=</span>/etc/init.d</code></pre>
</div>
</div>
</li>
<li>
<p>Vous devez obtenir, à la fin de la configuration, une table de ce type:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>------------------------------------------------
guacamole-server version 1.2.0
------------------------------------------------

   Library status:

     freerdp2 ............ yes
     pango ............... yes
     libavcodec .......... yes
     libavformat.......... yes
     libavutil ........... yes
     libssh2 ............. yes
     libssl .............. yes
     libswscale .......... yes
     libtelnet ........... yes
     libVNCServer ........ yes
     libvorbis ........... yes
     libpulse ............ yes
     libwebsockets ....... yes
     libwebp ............. yes
     wsock32 ............. no

   Protocol support:

      Kubernetes .... yes
      RDP ........... yes
      SSH ........... yes
      Telnet ........ yes
      VNC ........... yes

   Services / tools:

      guacd ...... yes
      guacenc .... yes
      guaclog .... yes</code></pre>
</div>
</div>
</li>
<li>
<p>Si ce n&#8217;est pas le cas, c&#8217;est qu&#8217;une bibliothèque n&#8217;est pas installée correctement.</p>
</li>
<li>
<p>Lancez la compilation et l&#8217;installation. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>make
make install
ldconfig</code></pre>
</div>
</div>
</li>
<li>
<p>Activez le démon de gestion guacd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl <span class="tok-nb">enable</span> guacd
systemctl start guacd</code></pre>
</div>
</div>
</li>
<li>
<p>Téléchargez le dernier client <code>war</code> de Guacamole en allant sur le site web et en récupérant le <a href="https://guacamole.apache.org/releases/">lien de téléchargement</a>. Récupérez le lien puis tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /usr/local/share/guacamole
<span class="tok-nb">cd</span> /usr/local/share/guacamole
curl -fSL -o guacamole.war <span class="tok-s1">&#39;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/1.2.0/binary/guacamole-1.2.0.war&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
ln -s /usr/local/share/guacamole/guacamole.war /var/lib/tomcat8/webapps/ <i class="conum" data-value="2"></i><b>(2)</b>
systemctl restart tomcat8 <i class="conum" data-value="2"></i><b>(2)</b>
systemctl restart guacd</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>insérez ici l&#8217;adresse du war à charger</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>ou tomcat9 pour Ubuntu</td>
</tr>
</table>
</div>
</li>
<li>
<p>Editez le fichier server.xml. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/tomcat8/server.xml <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ou tomcat9 pour Ubuntu</td>
</tr>
</table>
</div>
</li>
<li>
<p>Chercher <code>Connector port="8080" protocol="HTTP/1.1</code> et remplacer partout le port <code>8080</code> par <code>8085</code></p>
</li>
<li>
<p>Créez les répertoires de configuration de guacamole. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>mkdir -p /etc/guacamole
mkdir -p /etc/guacamole/<span class="tok-o">{</span>extensions,lib<span class="tok-o">}</span></code></pre>
</div>
</div>
</li>
<li>
<p>Récupérez le driver mysql/mariadb pour java. Sur la plupart des Linux, il est présent dans <code>/usr/share/java</code>. Pour le copier, tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>ln -s /usr/share/java/mysql-connector-java.jar /etc/guacamole/lib/</code></pre>
</div>
</div>
</li>
<li>
<p>Il se peut que ce driver ne soit pas présent: allez sur le site <a href="https://dev.mysql.com/downloads/connector/j/">Mysql</a> et téléchargez la version Platform independant. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>curl -fSL -o mysql-java.tar.gz <span class="tok-s1">&#39;https://dev.mysql.com/get/Downloads/Connector-J/mysql-connector-java-8.0.21.tar.gz&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
tar xfz mysql-java.tar.gz
<span class="tok-nb">cd</span> mysql-connector-java-*
cp mysql-connector-java-*.jar /etc/guacamole/lib/mysql-connector-java.jar</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Collez ici le lien récupéré sur le site de Mysql.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Editez le fichier guacamole.properties. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>vi /etc/guacamole/guacamole.properties</code></pre>
</div>
</div>
</li>
<li>
<p>Ajoutez dans le fichier:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code><span></span>mysql-hostname: localhost
mysql-port: 3306
mysql-database: cxguacamole <i class="conum" data-value="1"></i><b>(1)</b>
mysql-username: cxguacamole <i class="conum" data-value="1"></i><b>(1)</b>
mysql-password: &lt;mot_de_passe&gt; <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettez ici le nom de la base de données, le nom de l&#8217;utilisateur de la base et son mot_de_passe tels qu&#8217;ils ont été saisis dans le chapitre de création de la base de données.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Vous devez maintenant télécharger les plugins mysql pour Guacamole. Allez sur le site web de guacamole et récupérez le <a href="https://guacamole.apache.org/releases/">lien de téléchargement de guacamole-auth-jdbc</a>. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> /tmp
curl -fSL -o guacamole-auth-jdbc.tar.gz <span class="tok-s1">&#39;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/1.2.0/binary/guacamole-auth-jdbc-1.2.0.tar.gz&#39;</span> <i class="conum" data-value="1"></i><b>(1)</b>
tar xfz guacamole-auth-jdbc.tar.gz
<span class="tok-nb">cd</span> guacamole-auth-jdbc-*/mysql
cp guacamole-auth-jdbc-mysql-*.jar /usr/local/share/guacamole/
ln -s /usr/local/share/guacamole/guacamole-auth-jdbc-mysql-*.jar /etc/guacamole/extensions</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>insérez ici l&#8217;adresse du fichier guacamole-auth-jdbc à charger</td>
</tr>
</table>
</div>
</li>
<li>
<p>Créez les tables de la base:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span><span class="tok-nb">cd</span> schema
cat *.sql <span class="tok-p">|</span> mysql -u cxguacamole -p cxguacamole <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>mettez derrière le <code>-u</code> le nom d&#8217;utilisateur de la base de données et derrière le <code>-p</code> le nom de la base de données. Un mot de passe vous sera demandé.</td>
</tr>
</table>
</div>
</li>
<li>
<p>Redémarrez tomcat et guacd. Tapez:</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>systemctl restart tomcat8 <i class="conum" data-value="1"></i><b>(1)</b>
systemctl restart guacd</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>ou mettre tomcat9 pour Ubuntu</td>
</tr>
</table>
</div>
</li>
<li>
<p>Allez sur le site de <code>guacamole.example.com</code></p>
</li>
<li>
<p>Loguez vous avec le compte: <code>guacadmin</code> et password: <code>guacadmin</code></p>
</li>
<li>
<p>Commencez par cliquez sur <code>guacadmin</code> &#8594; <code>paramètres</code> &#8594; <code>utilisateurs</code>&#8594; <code>Nouvel Utilisateur</code></p>
<div class="ulist">
<ul>
<li>
<p><code>Identifiant</code> &#8592; Tapez <code>admin</code></p>
</li>
<li>
<p><code>Mot de passe</code> &#8592; Tapez votre <a href="#pass_gen">mot de passe généré</a></p>
</li>
<li>
<p><code>Répétez mot de passe</code> &#8592; Retapez votre mot de passe</p>
</li>
<li>
<p><code>Permissions</code> &#8592; activer toutes les options</p>
</li>
</ul>
</div>
</li>
<li>
<p>Deconnectez vous et reconnectez vous avec le login <code>admin</code></p>
</li>
<li>
<p>cliquez sur <code>admin</code> &#8594; <code>paramètres</code> &#8594; <code>utilisateurs</code> &#8594; <code>guacadmin</code></p>
</li>
<li>
<p>Supprimez ce compte utilisateur</p>
</li>
<li>
<p>Si vous avez activé VNC. Cliquez sur <code>Admin</code> &#8594; <code>Paramètres</code> &#8594; <code>Utilisateurs</code> &#8594; <code>Connexions</code> &#8594; <code>Nouvelle Connexion</code></p>
<div class="ulist">
<ul>
<li>
<p><code>Nom</code> &#8592; Tapez <code>Local server VNC</code></p>
</li>
<li>
<p><code>Protocole</code> &#8592; Sélectionnez <code>VNC</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>Nom d’hôte</code> &#8592; Tapez <code>Localhost</code></p>
</li>
<li>
<p>Cochez <code>SFTP</code> &#8594; <code>Activer SFTP</code></p>
</li>
<li>
<p><code>SFTP</code> &#8594; <code>Nom d&#8217;hôte</code> &#8592; Tapez <code>Localhost</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>port</code> &#8592; Tapez <code>5900</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>Mot de passe</code> &#8592; Tapez votre mot de passe VNC de votre machine locale.</p>
</li>
<li>
<p><code>SFTP</code> &#8594; <code>Mot de passe</code> &#8592; Tapez un mot de passe sur votre Hôte</p>
</li>
</ul>
</div>
</li>
<li>
<p>Cliquez sur <code>Admin</code> &#8594; <code>Paramètres</code> &#8594; <code>Utilisateurs</code> &#8594; <code>Connexions</code> &#8594; <code>Nouvelle Connexion</code></p>
<div class="ulist">
<ul>
<li>
<p><code>Nom</code> &#8592; Tapez <code>Local server SSH</code></p>
</li>
<li>
<p><code>Protocole</code> &#8592; Sélectionnez <code>SSH</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>Nom d’hôte</code> &#8592; Tapez <code>Localhost</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>port</code> &#8592; Tapez <code>22</code></p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>Identifiant</code> &#8592; Tapez un login sur votre Hôte</p>
</li>
<li>
<p><code>Paramètres</code> &#8594; <code>Mot de passe</code> &#8592; Tapez votre mot de passe de compte</p>
</li>
<li>
<p>Cochez <code>SFTP</code> &#8594; <code>Activer SFTP</code></p>
</li>
<li>
<p><code>SFTP</code> &#8594; <code>File browser root directory</code> &#8592; Tapez <code>/</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Vous pouvez maintenant vérifier vos connexions en vous loguant avec l&#8217;un des deux profils.</p>
</li>
<li>
<p>l&#8217;appui simultané sur <code>SHIFT</code> <code>CTRL</code> <code>ALT</code> fait apparaître un menu pour effectuer des chargements de fichiers ou contrôler votre connexion</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_annexe">26. Annexe</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_installation_de_hestia">26.1. Installation de Hestia</h3>
<div class="paragraph">
<p>Hestia est basé sur VestaCP. C&#8217;est une alternative opensource et plus moderne de cet outiL.
La documentation est proposée ici: <a href="https://docs.hestiacp.com/" class="bare">https://docs.hestiacp.com/</a></p>
</div>
<div class="paragraph">
<p>Attention Hestia n&#8217;est pas compatible de Webmin dans le sens que webmin est incapable de lire et d&#8217;interpréter les fichiers créés par Hestia.</p>
</div>
<div class="paragraph">
<p>De même, Hestia est principalement compatible de PHP. Si vous utilisez des système web basés sur des applicatifs écrits en Python ou en Ruby, la configuration sera à faire à la main avec tous les problèmes de compatibilité que cela impose.</p>
</div>
<div class="paragraph">
<p>Pour installer:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="#root_login">Loguez vous comme root sur le serveur</a></p>
</li>
<li>
<p>Télécharger le package et lancez l’installeur</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>wget https://raw.githubusercontent.com/hestiacp/hestiacp/release/install/hst-install.sh</code></pre>
</div>
</div>
</li>
<li>
<p>Lancez l&#8217;installeur. Tapez :</p>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash"><span></span>bash hst-install.sh -g yes -o yes</code></pre>
</div>
</div>
</li>
<li>
<p>Si le système n&#8217;est pas compatible, HestiaCP vous le dira. Sinon,  il vous informe de la configuration qui sera installée. Tapez <code>Y</code> pour continuer.</p>
</li>
<li>
<p>Entrez votre adresse mail standard et indépendante du futur serveur qui sera installé. ce peut être une adresse gmail.com par exemple.</p>
</li>
</ol>
</div>
</li>
<li>
<p>Hestia est installé. Il est important de bien noter le mot de passe du compte admin de Hestia ainsi que le numéro de port du site web</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_dun_écran_3_5inch_rpi_lcd_a">26.2. Configuration d&#8217;un écran 3.5inch RPi LCD (A)</h3>
<div class="sect3">
<h4 id="_pour_commencer">26.2.1. Pour commencer</h4>
<div class="paragraph">
<p>Le RPi LCD peut être piloté de deux manières :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>installer le pilote sur votre
Raspbian OS.</p>
</li>
<li>
<p>utiliser le fichier image prêt à l&#8217;emploi ou lle pilote LCD est préinstallé.</p>
</li>
<li>
<p>Téléchargez la dernière image sur le site web de Raspberry Pi et écrivez-la sur la carte SD.</p>
</li>
<li>
<p>Connectez l&#8217;écran LCD RPi à Raspberry Pi et connectez le Pi au réseau.</p>
</li>
<li>
<p>Configurez votre Pi :</p>
<div class="literalblock">
<div class="content">
<pre>sudo raspi-config</pre>
</div>
</div>
</li>
<li>
<p>configurez ainsi :</p>
<div class="ulist">
<ul>
<li>
<p>Sélectionnez "Expand Filesystem".</p>
</li>
<li>
<p>Boot Option &#8594; Desktop Autologin (peut différer selon la révision Raspbian)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Ouvrez le terminal du Raspberry Pi (Vous devrez peut-être connecter un clavier et un écran LCD HDMI à Pi pour l&#8217;installation du pilote). Tapez:</p>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/waveshare/LCD-show.git
cd LCD-show/</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Note: Une connexion réseau est nécessaire lors de l&#8217;installation du pilote sur votre Pi, sinon l&#8217;installation ne fonctionnera pas correctement.</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>chmod +x LCD35-show
./LCD35-show</pre>
</div>
</div>
</li>
<li>
<p>Après le redémarrage du système, le RPi LCD est prêt à l&#8217;emploi.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_basculer_entre_laffichage_lcd_et_hdmi">26.2.2. Basculer entre l&#8217;affichage LCD et HDMI</h4>
<div class="paragraph">
<p>Une fois que l&#8217;écran LCD est activé, les paramètres par défaut pour HDMI sont modifiés. Si vous souhaitez utiliser un autre moniteur HDMI, veuillez exécuter la commande suivante :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>cd LCD-show/
./LCD-hdmi</pre>
</div>
</div>
<div class="paragraph">
<p>Cela permet de basculer le mode sur l&#8217;affichage LCD :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>chmod +x LCD35-show
./LCD35-show</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_paramètres_dorientation_de_lécran">26.2.3. Paramètres d&#8217;orientation de l&#8217;écran</h4>
<div class="paragraph">
<p>Une fois le pilote tactile installé, l&#8217;orientation de l&#8217;écran peut être définie par ces commandes :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Rotation de 0 degrés</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>cd LCD-show/
./LCD35-show 0</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Rotation de 90 degrés</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>cd LCD-show/
./LCD35-show 90</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Rotation de 180 degrés</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>cd LCD-show/
./LCD35-show 180</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Rotation de 270 degrés</p>
</li>
</ul>
</div>
<div class="literalblock">
<div class="content">
<pre>cd LCD-show/
./LCD35-show 270</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_calibrage_de_lécran_tactile">26.2.4. Calibrage de l&#8217;écran tactile</h4>
<div class="paragraph">
<p>Cet écran LCD peut être calibré à l&#8217;aide d&#8217;un programme appelé <code>xinput_calibrator</code> . Il n&#8217;est pas préinstallé sur le système d&#8217;exploitation Raspbian original. Vous devez donc le télécharger et installer le programme manuellement.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo apt-get install -y xinput-calibrator</pre>
</div>
</div>
<div class="paragraph">
<p>Entrez les commandes suivantes pour le calibrage de l&#8217;écran tactile :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo DISPLAY=:0.0 xinput_calibrator</pre>
</div>
</div>
<div class="paragraph">
<p>ou Sélectionnez Menu &#8594; Preferences &#8594; Calibrate Touchscreen.</p>
</div>
<div class="paragraph">
<p>Après l&#8217;exécution de ces commandes, l&#8217;écran LCD affiche une invite pour un calibrage en quatre points. Cliquez sur les points un par un pour terminer le calibrage tactile. Ensuite, les nouvelles données de calibrage seront affichées dans le terminal, comme indiqué ci-dessous. Veuillez obtenir ces données pour une utilisation ultérieure.</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Doing dynamic recalibration:
Setting new calibration data: 3919, 208, 236, 3913</pre>
</div>
</div>
<div class="paragraph">
<p>Tapez la commande suivante pour éditer 99-calibration.conf:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo nano /etc/X11/xorg.conf.d/99-calibration.conf</pre>
</div>
</div>
<div class="paragraph">
<p>Ensuite, les anciennes données d&#8217;étalonnage seront affichées dans le terminal :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Section "InputClass"
Identifier  "calibration"
MatchProduct    "ADS7846 Touchscreen"
Option  "Calibration"   "160 3723 3896 181"
Option  "SwapAxes"  "1"
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>Modifiez les données d&#8217;étalonnage en fonction des nouvelles données d&#8217;étalonnage affichées plus haut :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>Section "InputClass"
Identifier  "calibration"
MatchProduct    "ADS7846 Touchscreen"
Option  "Calibration"   "3919 208 236 3913"
Option  "SwapAxes"  "1"
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>Appuyez sur les touches Ctrl+X, et sélectionnez l&#8217;option Y pour enregistrer la modification.</p>
</div>
<div class="paragraph">
<p>La modification sera valide après le redémarrage du système. Entrez la commande suivante pour le redémarrage du système :</p>
</div>
<div class="literalblock">
<div class="content">
<pre>sudo reboot</pre>
</div>
</div>
<div class="paragraph">
<p><strong>Notices: En cas de toucher imprécis, veuillez procéder à un nouvel étalonnage de l&#8217;écran et redémarrer le système.</strong></p>
</div>
</div>
<div class="sect3">
<h4 id="_installer_un_clavier_virtuel">26.2.5. Installer un clavier virtuel</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Installer matchbox-keyboard</p>
<div class="literalblock">
<div class="content">
<pre>sudo apt-get install update
sudo apt-get install matchbox-keyboard
sudo nano /usr/bin/toggle-matchbox-keyboard.sh</pre>
</div>
</div>
</li>
<li>
<p>Copiez les commandes ci-dessous dans toggle-matchbox-keyboard.sh et sauvegardez.</p>
<div class="literalblock">
<div class="content">
<pre>#!/bin/bash
#This script toggle the virtual keyboard
PID=`pidof matchbox-keyboard`
if [ ! -e $PID ]; then
killall matchbox-keyboard
else
matchbox-keyboard -s 50 extended&amp;
fi</pre>
</div>
</div>
</li>
<li>
<p>Exécutez les commandes:</p>
<div class="literalblock">
<div class="content">
<pre>sudo chmod +x /usr/bin/toggle-matchbox-keyboard.sh
sudo mkdir /usr/local/share/applications
sudo nano /usr/local/share/applications/toggle-matchbox-keyboard.desktop</pre>
</div>
</div>
</li>
<li>
<p>Copiez les commandes ci-dessous dans toggle-matchbox-keyboard.desktop et sauvegardez.</p>
<div class="literalblock">
<div class="content">
<pre>[Desktop Entry]
Name=Toggle Matchbox Keyboard
Comment=Toggle Matchbox Keyboard`
Exec=toggle-matchbox-keyboard.sh
Type=Application
Icon=matchbox-keyboard.png
Categories=Panel;Utility;MB
X-MB-INPUT-MECHANSIM=True</pre>
</div>
</div>
</li>
<li>
<p>Exécutez les commandes ci dessous.</p>
<div class="paragraph">
<p><strong>NOTE: Notez que vous devez utiliser les droits d&#8217;utilisateur "Pi" au lieu de root pour exécuter cette commande</strong></p>
</div>
<div class="literalblock">
<div class="content">
<pre>nano ~/.config/lxpanel/LXDE-pi/panels/panel</pre>
</div>
</div>
</li>
<li>
<p>Trouvez la déclaration qui est similaire à celle ci-dessous : (Elle peut être différente dans une autre version)</p>
<div class="literalblock">
<div class="content">
<pre>Plugin {
  type = launchbar
  Config {
    Button {
      id=lxde-screenlock.desktop
    }
    Button {
      id=lxde-logout.desktop
    }
  }
}</pre>
</div>
</div>
</li>
<li>
<p>Ajoutez ces déclarations pour ajouter une option de bouton :</p>
<div class="literalblock">
<div class="content">
<pre>Button {
  id=/usr/local/share/applications/toggle-matchbox-keyboard.desktop
}</pre>
</div>
</div>
</li>
<li>
<p>redémarrez votre Raspberry Pi. Si le clavier virtuel est correctement installé, vous pouvez constater qu&#8217;il y a une icône de clavier sur la gauche de la barre</p>
<div class="literalblock">
<div class="content">
<pre>sudo reboot</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_ressources">26.2.6. Ressources</h4>
<div class="sect4">
<h5 id="_manuel_utilisateur">Manuel utilisateur</h5>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.waveshare.com/w/upload/1/1e/RPi_LCD_User_Manual_EN.pdf">RPiLCD User Manual</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_images">Images</h5>
<div class="paragraph">
<p>Description : si vous avez eu du mal à installer le pilote, essayez l&#8217;image avec le pilote préinstallé.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://drive.google.com/open?id=1xsvANujoImwVQvdf0n7IiUjP8BuCe2GK">RPi-35inch-LCD-(A)-Raspbian-180326.7z</a></p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_driver">Driver</h5>
<div class="paragraph">
<p>Le pilote peut être téléchargé sur github</p>
</div>
<div class="literalblock">
<div class="content">
<pre>git clone https://github.com/waveshare/LCD-show.git</pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fichiers_de_configuration_de_référence">Fichiers de configuration de référence</h5>
<div class="paragraph">
<p>/boot/cmdline.txt</p>
</div>
<div class="listingblock">
<div class="content">
<pre>dwc_otg.lpm_enable=0 console=tty1 console=ttyAMA0,115200 root=/dev/mmcblk0p7 rootfstype=ext4 elevator=deadline rootwait fbcon=map:10 fbcon=font:ProFont6x11 logo.nologo</pre>
</div>
</div>
<div class="paragraph">
<p>/boot/config.txt</p>
</div>
<div class="listingblock">
<div class="content">
<pre># For more options and information see
# http://www.raspberrypi.org/documentation/configuration/config-txt.md
# Some settings may impact device functionality. See link above for details

# uncomment if you get no picture on HDMI for a default "safe" mode
#hdmi_safe=1

# uncomment this if your display has a black border of unused pixels visible
# and your display can output without overscan
#disable_overscan=1

# uncomment the following to adjust overscan. Use positive numbers if console
# goes off screen, and negative if there is too much border
#overscan_left=16
#overscan_right=16
#overscan_top=16
#overscan_bottom=16

# uncomment to force a console size. By default it will be display's size minus
# overscan.
#framebuffer_width=1280
#framebuffer_height=720

# uncomment if hdmi display is not detected and composite is being output
hdmi_force_hotplug=1

# uncomment to force a specific HDMI mode (this will force VGA)
#hdmi_group=1
#hdmi_mode=1

# uncomment to force a HDMI mode rather than DVI. This can make audio work in
# DMT (computer monitor) modes
#hdmi_drive=2

# uncomment to increase signal to HDMI, if you have interference, blanking, or
# no display
#config_hdmi_boost=4

# uncomment for composite PAL
#sdtv_mode=2

#uncomment to overclock the arm. 700 MHz is the default.
#arm_freq=800

# Uncomment some or all of these to enable the optional hardware interfaces
dtparam=i2c_arm=on
#dtparam=i2s=on
dtparam=spi=on
enable_uart=1
# Uncomment this to enable the lirc-rpi module
#dtoverlay=lirc-rpi

# Additional overlays and parameters are documented /boot/overlays/README

# Enable audio (loads snd_bcm2835)
dtparam=audio=on
dtoverlay=tft35a
#dtoverlay=ads7846,cs=1,penirq=17,penirq_pull=2,speed=1000000,keep_vref_on=1,swapxy=1,pmax=255,xohms=60,xmin=200,xmax=3900,ymin=200,ymax=3900</pre>
</div>
</div>
<div class="paragraph">
<p>/etc/inittab</p>
</div>
<div class="paragraph">
<p>Ajouter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>#Spawn a getty on Raspberry Pi serial line
T0:23:respawn:/sbin/getty -L ttyAMA0 115200 vt100</pre>
</div>
</div>
<div class="paragraph">
<p>/usr/share/X11/xorg.conf/99-fbturbo.conf</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Section "Device"
        Identifier      "Allwinner A10/A13/A20 FBDEV"
        Driver          "fbturbo"
        Option          "fbdev" "/dev/fb1"

        Option          "SwapbuffersWait" "true"
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>/usr/share/X11/xorg.conf.d/40-libinput.conf
/usr/share/X11/xorg.conf.d/45-evdev.conf</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Section "InputClass"
        Identifier "libinput pointer catchall"
        MatchIsPointer "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
EndSection

Section "InputClass"
        Identifier "libinput keyboard catchall"
        MatchIsKeyboard "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
EndSection

Section "InputClass"
        Identifier "libinput touchpad catchall"
        MatchIsTouchpad "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
EndSection

Section "InputClass"
        Identifier "libinput touchscreen catchall"
        MatchIsTouchscreen "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
EndSection

Section "InputClass"
        Identifier "libinput tablet catchall"
        MatchIsTablet "on"
        MatchDevicePath "/dev/input/event*"
        Driver "libinput"
EndSection</pre>
</div>
</div>
<div class="paragraph">
<p>/etc/X11/xorg.conf.d/99-calibration.conf</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Section "InputClass"
        Identifier      "calibration"
        MatchProduct    "ADS7846 Touchscreen"
        Option  "Calibration"   "3936 227 268 3880"
        Option  "SwapAxes"      "1"
EndSection</pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.2<br>
Last updated 2021-01-24 20:21:44 +0100
</div>
</div>
</body>
</html>